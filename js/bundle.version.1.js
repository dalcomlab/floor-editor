var PlaceIn;(()=>{"use strict";var t={d:(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Editor:()=>St,EditorTools:()=>Bt});class s{constructor(){}get type(){return""}translate(t,e){}render(t){this.renderControl(t)}onMove(t,e){}renderControl(t){}createPointDragHandler(t,e,s){return null}createMoveDragHandler(t,e,s){return null}createExtendDragHandler(t,e,s){return null}createPointSelectionControl(){return null}createMoveSelectionControl(){return null}isPointInControl(t,e,s=0){return!1}}class o{static radiansToDegrees(t){return t*(180/Math.PI)}static degreesToRadians(t){return t*(Math.PI/180)}static angle(t,e,s,o){const i=this.radian(t,e,s,o);return this.radiansToDegrees(i)}static radian(t,e,s,o){return Math.atan2(o-e,s-t)}static radianInPoint(t,e){return this.radian(t.x,t.y,e.x,e.y)}static calculate3PointRadian(t,e,s,o,i,n){const r=this.radian(t,e,s,o);let a=this.radian(t,e,i,n)-r;return a<0&&(a+=2*Math.PI),a}static calculate3PointRadianInPoint(t,e,s){return this.calculate3PointRadian(t.x,t.y,e.x,e.y,s.x,s.y)}static calculate3PointDegrees(t,e,s,o,i,n){return this.radiansToDegrees(this.calculate3PointRadian(t,e,s,o,i,n))}static calculate3PointAngle(...t){let e,s,o,i,n,r;if(6===t.length)[e,s,o,i,n,r]=t;else{if(3!==t.length)throw new Error("올바른 인자를 제공하세요.");{const[a,h,l]=t;e=a.x,s=a.y,o=h.x,i=h.y,n=l.x,r=l.y}}const a=Math.atan2(i-s,o-e);let h=Math.atan2(r-s,n-e)-a;return h<0&&(h+=2*Math.PI),this.radiansToDegrees(h)}static distance(t,e,s,o){const i=s-t,n=o-e;return Math.sqrt(i**2+n**2)}static distanceInPoint(t,e){const s=e.x-t.x,o=e.y-t.y;return Math.sqrt(s**2+o**2)}static isBetween(t,e,s,o=!1){return o&&(t=Math.round(t),e=Math.round(e),s=Math.round(s)),t>=e&&t<=s||t>=s&&t<=e}static distancePoint(t,e,s){const o=Math.atan2(e.y-t.y,e.x-t.x),i=new n(0,0);return i.x=t.x-s*Math.cos(o),i.y=t.y-s*Math.sin(o),i}static rotate(t,e,s,o,i){const n=t-s,r=e-o;return[n*Math.cos(i)-r*Math.sin(i)+s,n*Math.sin(i)+r*Math.cos(i)+o]}static rotatePoint(t,e,s,o){const i=t.x-e,r=t.y-s,a=i*Math.cos(o)-r*Math.sin(o),h=i*Math.sin(o)+r*Math.cos(o);return new n(a+e,h+s)}static interceptPoint(t,e,s,o,i,r,a,h){const l=(t-s)*(r-h)-(e-o)*(i-a);if(0===l)return null;const c=((t-i)*(r-h)-(e-r)*(i-a))/l;if(c>0&&c<1&&-((t-s)*(e-r)-(e-o)*(t-i))/l>0){const l=new n(0,0);return l.x=Math.round(t+c*(s-t)),l.y=Math.round(e+c*(o-e)),this.isPointInBox(l.x,l.y,t,e,s,o)&&this.isPointInBox(l.x,l.y,i,r,a,h)?l:null}return null}static isPointInBox(t,e,s,o,i,n){let r=Math.min(s,i),a=Math.max(s,i),h=Math.min(o,n),l=Math.max(o,n);return r===a&&(r-=1,a+=1),h===l&&(h-=1,l+=1),t>=r&&t<=a&&e>=h&&e<=l}}class i{constructor(t,e){this.A=t,this.B=e}static createEquationFrom4Point(t,e,s,o){return s-t==0?new i("v",t):o-e==0?new i("h",e):new i((o-e)/(s-t),o-s*((o-e)/(s-t)))}static create(t,e,s,o){return s-t==0?new i("v",t):o-e==0?new i("h",e):new i((o-e)/(s-t),o-s*((o-e)/(s-t)))}closestPoint(t,e){if("v"===this.A)return{x:this.B,y:e};if("h"===this.A)return{x:t,y:this.B};const s=(this.A*e+t-this.A*this.B)/(this.A*this.A+1);return{x:s,y:this.A*s+this.B}}distance(t,e){const s=this.closestPoint(t,e);return Math.sqrt((t-s.x)**2+(e-s.y)**2)}createPerpendicularEquation(t,e){return"string"!=typeof this.A?new i(-1/this.A,e- -1/this.A*t):"h"===this.A?new i("v",t):"v"===this.A?new i("h",e):void 0}createMoveEquation(t,e){return"v"===this.A?new i("v",t):"h"===this.A?new i("h",e):new i(this.A,e-t*this.A)}intersection(t){let e=null;if(this.A===t.A&&(e=null),"v"===this.A&&"h"===t.A&&(e=new n(this.B,t.B)),"h"===this.A&&"v"===t.A&&(e=new n(t.B,this.B)),"h"===this.A&&"v"!==t.A&&"h"!==t.A&&(e=new n((this.B-t.B)/t.A,this.B)),"v"===this.A&&"v"!==t.A&&"h"!==t.A&&(e=new n(this.B,t.A*this.B+t.B)),"h"===t.A&&"v"!==this.A&&"h"!==this.A&&(e=new n((t.B-this.B)/this.A,t.B)),"v"===t.A&&"v"!==this.A&&"h"!==this.A&&(e=new n(t.B,this.A*t.B+this.B)),"h"!==this.A&&"v"!==this.A&&"v"!==t.A&&"h"!==t.A){const s=(t.B-this.B)/(this.A-t.A),o=this.A*s+this.B;e=new n(s,o)}return e}}class n{constructor(t,e){this.x=t,this.y=e}copy(){return new n(this.x,this.y)}copyFrom(t){t&&(this.x=t.x,this.y=t.y)}distance(t,e){return o.distance(this.x,this.y,t,e)}distanceTo(t){return o.distance(this.x,this.y,t.x,t.y)}static rotate(t,e,s,i){const r=[];for(const a of t){const t=o.rotate(a.x,a.y,e,s,i);r.push(new n(t[0],t[1]))}return r}}class r{constructor(){this.points=[]}addPoint(t){if(t){this.points.some((e=>e.x===t.x&&e.y===t.y))||this.points.push(t)}}}class a{constructor(t){this.points=t}get count(){return this.points.length}getBoundRect(){const t={minX:0,minY:0,maxX:0,maxY:0};if(0===this.points.length)return t;let e=this.points[0].x,s=this.points[0].y,o=this.points[0].x,i=this.points[0].y;for(let t=1;t<this.points.length;t++){const n=this.points[t];n.x<e&&(e=n.x),n.x>o&&(o=n.x),n.y<s&&(s=n.y),n.y>i&&(i=n.y)}return t.minX=e,t.maxX=o,t.minY=s,t.maxY=i,t}getCenterPoint(){let t=0,e=0;for(const s of this.points)t+=s.x,e+=s.y;const s=new n(t/this.points.length,e/this.points.length);if(!this.isPointInsideInclusive(s)){let t=this.points[0],e=o.distance(s.x,s.y,t.x,t.y);for(let i=1;i<this.points.length;i++){const n=o.distance(s.x,s.y,this.points[i].x,this.points[i].y);n<e&&(t=this.points[i],e=n)}return t.copy()}return s}getVisualCenterPoint(){const t=this.getBoundRect(),e=[],s=t.maxX-t.minX,o=t.maxY-t.minY,r=Math.floor(s/10),a=Math.floor(o/10);for(let s=0;s<10;s++)for(let s=0;s<10;s++){const o=t.minX+s*r,i=t.minY+s*a,h=new n(o,i);this.isPointInside(h)&&e.push(h)}let h=null,l=0;for(const t of e){let e=1/0;for(let s=0;s<this.points.length-1;s++){const o=i.create(this.points[s].x,this.points[s].y,this.points[s+1].x,this.points[s+1].y).distance(t.x,t.y);o<e&&(e=o)}l<e&&(h=t,l=e)}return h}add(t,e){this.points.push(new n(t,e))}addPoint(t){this.existPoint(t)||this.points.push(t)}existPoint(t){return this.points.some((e=>{return s=e,o=t,Math.floor(s.x)===Math.floor(o.x)&&Math.floor(s.y)===Math.floor(o.y);var s,o}))}first(){return this.count>1?this.points[0]:null}last(){return this.count>1?this.points[this.count-1]:null}rotate(t,e,s){for(const i of this.points){const n=o.rotate(i.x,i.y,t,e,s);i.x=n[0],i.y=n[1]}}contains(){let t,e;if(1===arguments.length&&"object"==typeof arguments[0]&&"x"in arguments[0]&&"y"in arguments[0])t=arguments[0].x,e=arguments[0].y;else{if(2!==arguments.length)throw new Error("Invalid arguments. Either provide (x, y) or a single Point object.");t=arguments[0],e=arguments[1]}let s=!1;for(let o=0,i=this.points.length-1;o<this.points.length;i=o++){if(this.points[o].x===t&&this.points[o].y===e)return!0;const n=this.points[o].x,r=this.points[o].y,a=this.points[i].x,h=this.points[i].y;r>e!=h>e&&t<(a-n)*(e-r)/(h-r)+n&&(s=!s)}return s}contains2(){let t,e;if(1===arguments.length&&"object"==typeof arguments[0]&&"x"in arguments[0]&&"y"in arguments[0])t=arguments[0].x,e=arguments[0].y;else{if(2!==arguments.length)throw new Error("Invalid arguments. Either provide (x, y) or a single Point object.");t=arguments[0],e=arguments[1]}let s=!1;for(let o=0,i=this.points.length-1;o<this.points.length;i=o++){if(this.points[o].x===t&&this.points[o].y===e)return!1;const n=this.points[o].x,r=this.points[o].y,a=this.points[i].x,h=this.points[i].y;r>e!=h>e&&t<(a-n)*(e-r)/(h-r)+n&&(s=!s)}return s}isPointInside(t,e=!1){let s=!1;const{x:o,y:i}=t;for(let t=0,e=this.points.length-1;t<this.points.length;e=t++){if(this.points[t].x===o&&this.points[t].y===i)return!1;const n=this.points[t].x,r=this.points[t].y,a=this.points[e].x,h=this.points[e].y;r>i!=h>i&&o<(a-n)*(i-r)/(h-r)+n&&(s=!s)}return s}isPointInsideInclusive(t){let e=!1;const{x:s,y:o}=t;for(let t=0,i=this.points.length-1;t<this.points.length;i=t++){if(this.points[t].x===s&&this.points[t].y===o)return!0;const n=this.points[t].x,r=this.points[t].y,a=this.points[i].x,h=this.points[i].y;r>o!=h>o&&s<(a-n)*(o-r)/(h-r)+n&&(e=!e)}return e}isPolygonInside(t){return t!==this&&t.points.every((t=>this.isPointInsideInclusive(t)))}isIncludePoint(t,e){for(const s of this.points)if(s.x===t&&s.y===e)return!0;return!1}isSamePolygon(t){if(this.points.length!==t.points.length)return!1;for(const e of t.points)if(!this.isIncludePoint(e.x,e.y))return!1;return!0}isIncludePolygon(t){for(const e of t.points)if(!this.contains(e.x,e.y))return!1;return!0}containsInPoint(t){return this.contains(t.x,t.y)}calculateArea(){const t=this.points.length;let e=0;for(let s=0;s<t;s++){const o=this.points[s],i=this.points[(s+1)%t];e+=o.x*i.y-i.x*o.y}return Math.abs(e)/2}static createOuterPolygon(t,e,s,i=0){const n=new a([]),r=o.distancePoint(t,e,i),h=o.distancePoint(e,t,i),l=o.distance(r.x,r.y,h.x,h.y),c=o.radian(r.x,r.y,h.x,h.y),d=s/2;return n.add(r.x,r.y-d),n.add(r.x,r.y+d),n.add(r.x+l,r.y+d),n.add(r.x+l,r.y-d),n.rotate(r.x,r.y,c),n}static isPointInPolygon(t,e,s){const o=new a([]);return o.points=t,o.contains(e,s)}}class h{constructor(){this.x=0,this.y=0}static createVector(t,e,s,o){const i=new h;return i.x=s-t,i.y=o-e,i}getLength(){return Math.sqrt(this.x**2+this.y**2)}static createVectorOfPoints(t,e){return this.createVector(t.x,t.y,e.x,e.y)}dotProduct(t){return this.x*t.x+this.y*t.y}static dotProductXY(t,e,s,o,i,n){const r=s-t,a=o-e,h=i-t,l=n-e,c=Math.sqrt(r*r+a*a);return r/c*h+a/c*l}static calculateAngle(t,e,s,o,i,n){const r=s-t,a=o-e,h=i-t,l=n-e,c=r*h+a*l,d=Math.sqrt(r*r+a*a)*Math.sqrt(h*h+l*l);if(0!==d){return Math.acos(c/d)}return null}static calculateAngle2(t,e,s,o,i,n){const r=s-t,a=o-e,h=i-t,l=n-e,c=Math.sqrt(r*r+a*a),d=Math.sqrt(h*h+l*l),u=r*h+a*l;let f=Math.acos(u/(c*d));return u<0&&(f=-f),f}static calculateAngle3(t,e,s,i,n,r){return o.radian(t,e,s,i)-o.radian(t,e,n,r)}}class l{constructor(){this.x=0,this.y=0,this.width=0,this.height=0}static create(t,e,s,o){const i=new l;return i.x=t,i.y=e,i.width=s,i.height=o,i}points(){return[new n(this.x,this.y),new n(this.x+this.width,this.y),new n(this.x+this.width,this.y+this.height),new n(this.x,this.y+this.height)]}getTopLeftPoint(){const t=Math.min(this.x,this.x+this.width),e=Math.min(this.y,this.y+this.height);return new n(t,e)}getTopRightPoint(){const t=Math.max(this.x,this.x+this.width),e=Math.min(this.y,this.y+this.height);return new n(t,e)}getBottomLeftPoint(){const t=Math.min(this.x,this.x+this.width),e=Math.max(this.y,this.y+this.height);return new n(t,e)}getBottomRightPoint(){const t=Math.max(this.x,this.x+this.width),e=Math.max(this.y,this.y+this.height);return new n(t,e)}segments(){const t=[];return t.push({x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y}),t.push({x1:this.x+this.width,y1:this.y,x2:this.x+this.width,y2:this.y+this.height}),t.push({x1:this.x+this.width,y1:this.y+this.height,x2:this.x,y2:this.y+this.height}),t.push({x1:this.x,y1:this.y+this.height,x2:this.x,y2:this.y}),t}isPointInRect(t){return t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height}translate(t,e){this.x+=t,this.y+=e}}class c extends s{constructor(t,e){super(),this.start=t,this.end=e,this.thick=10,this.color="#000000"}get length(){return o.distance(this.start.x,this.start.y,this.end.x,this.end.y)}isPointInControl(t,e,s=0){return this.createOuterPolygon(s).contains(t,e)}createOuterPolygon(t=0){return a.createOuterPolygon(this.start,this.end,this.thick,t)}}class d{onDragStart(t,e,s){}onDrag(t,e){}onDragStop(t,e){}onCancel(){}}class u{static Colors={Blue10:"#E5F2FF",Blue20:"#CCE4FF",Blue30:"#99CAFF",Blue40:"#66AFFF",Blue50:"#3395FF",Blue60:"#007AFF",Blue70:"#0062CC",Blue80:"#004999",Blue90:"#003166",Blue100:"#001833",BlueHover10:"#DAE6F2",BlueHover20:"#C2D9F2",BlueHover30:"#91C0F2",BlueHover40:"#61A6F2",BlueHover50:"#308EF2",BlueHover60:"#0D81FF",BlueHover70:"#0D6ACF",BlueHover80:"#0D529E",BlueHover90:"#0D3B6E",BlueHover100:"#0D243D",Purple10:"#F7EEFC",Purple20:"#EFDCF8",Purple30:"#DFBAF2",Purple40:"#CF97EB",Purple50:"#BF75E5",Purple60:"#AF52DE",Purple70:"#8C42B2",Purple80:"#693185",Purple90:"#462159",Purple100:"#23102C",PurpleHorver10:"#EBE2EF",PurpleHorver20:"#E3D1EC",PurpleHorver30:"#D4B1E6",PurpleHorver40:"#C58FDF",PurpleHorver50:"#B56FDA",PurpleHorver60:"#B35BE0",PurpleHorver70:"#924BB6",PurpleHorver80:"#713B8B",PurpleHorver90:"#4F2C61",PurpleHorver100:"#2E1C37",Cyan10:"#EAF7FC",Cyan20:"#D6EFFA",Cyan30:"#ADDEF5",Cyan40:"#84CEF0",Cyan50:"#5BBDEB",Cyan60:"#32ADE6",Cyan70:"#288AB8",Cyan80:"#1E688A",Cyan90:"#14455C",Cyan100:"#0A232E",CyanHover10:"#DEEBEF",CyanHover20:"#CBE3ED",CyanHover30:"#A4D3E9",CyanHover40:"#7DC4E4",CyanHover50:"#56B4DF",CyanHover60:"#3CB1E7",CyanHover70:"#3390BC",CyanHover80:"#297090",CyanHover90:"#204E64",CyanHover100:"#162E38",Teal10:"#EAF7F9",Teal20:"#D6EFF4",Teal30:"#ACDFE9",Teal40:"#83D0DD",Teal50:"#59C0D2",Teal60:"#30B0C7",Teal70:"#268D9F",Teal80:"#1D6A77",Teal90:"#134650",Teal100:"#0A2328",TealHover10:"#DEEBED",TealHover20:"#CBE3E8",TealHover30:"#A3D4DD",TealHover40:"#7CC6D2",TealHover50:"#55B6C7",TealHover60:"#3AB4CA",TealHover70:"#3193A4",TealHover80:"#28717E",TealHover90:"#1F4F59",TealHover100:"#162E33",Manneta10:"#FAE9F1",Manneta20:"#F6D4E3",Manneta30:"#EDA9C6",Manneta40:"#E37DAA",Manneta50:"#DA528D",Manneta60:"#D12771",Manneta70:"#A71F5A",Manneta80:"#7D1744",Manneta90:"#54102D",Manneta100:"#2A0817",MannetaHover10:"#EDDDE5",MannetaHover20:"#EAC9D8",MannetaHover30:"#E1A1BC",MannetaHover40:"#D877A1",MannetaHover50:"#CF4E86",MannetaHover60:"#D33278",MannetaHover70:"#AB2A62",MannetaHover80:"#83234D",MannetaHover90:"#5D1C38",MannetaHover100:"#351423",Red10:"#FFEBEA",Red20:"#FFD8D6",Red30:"#FFB1AC",Red40:"#FF8983",Red50:"#FF6259",Red60:"#FF3B30",Red70:"#CC2F26",Red80:"#99231D",Red90:"#661813",Red100:"#330C0A",RedHover10:"#F2DFDE",RedHover20:"#F2CDCB",RedHover30:"#F2A8A3",RedHover40:"#F2827C",RedHover50:"#F25D55",RedHover60:"#FF453A",RedHover70:"#CF3931",RedHover80:"#9E2E28",RedHover90:"#6E241F",RedHover100:"#3D1816",Green10:"#EBF9EE",Green20:"#D6F4DE",Green30:"#AEE9BD",Green40:"#85DD9B",Green50:"#5DD27A",Green60:"#34C759",Green70:"#2A9F47",Green80:"#1F7735",Green90:"#155024",Green100:"#0A2812",GreenHover10:"#DFEDE2",GreenHover20:"#CBE8D3",GreenHover30:"#A5DDB4",GreenHover40:"#7ED293",GreenHover50:"#58C774",GreenHover60:"#3ECA61",GreenHover70:"#35A450",GreenHover80:"#2A7E3F",GreenHover90:"#21592F",GreenHover100:"#16331E",Orange10:"#FFF4E5",Orange20:"#FFEACC",Orange30:"#FFD599",Orange40:"#FFBF66",Orange50:"#FFAA33",Orange60:"#FF9500",Orange70:"#CC7700",Orange80:"#995900",Orange90:"#663C00",Orange100:"#331E00",OrangeHover10:"#F2E8DA",OrangeHover20:"#F2DEC2",OrangeHover30:"#F2CA91",OrangeHover40:"#F2B561",OrangeHover50:"#F2A130",OrangeHover60:"#FF9A0D",OrangeHover70:"#CF7E0D",OrangeHover80:"#9E610D",OrangeHover90:"#6E460D",OrangeHover100:"#3D290D"};static get activeColor(){return"rgb(0,151,197)"}static get activeColor(){return"rgb(0,151,197)"}static get activeColorTransparent(){return"rgb(0, 151, 197, 0.5)"}static get selectColor(){return"rgba(0,151,197,0.5)"}}class f extends s{constructor(t,e){super(),this.start=t,this.end=e,this.height=15,this.padding=15,this.points=[],this.thick=1,this.strokeColor=u.activeColor,this.fillColor=u.activeColor,this.cursor=new n(0,0)}addPoint(t){t&&this.points.push(t)}render(t){let e=o.radianInPoint(this.start,this.end),s=this.createSegment();t.save();let i="right";e>=-Math.PI/2&&e<=Math.PI/2?(t.translate(this.start.x,this.start.y),h.calculateAngle3(this.start.x,this.start.y,this.end.x,this.end.y,this.cursor.x,this.cursor.y)<0&&(i="left")):(e-=Math.PI,t.translate(this.end.x,this.end.y),s.reverse(),h.calculateAngle3(this.end.x,this.end.y,this.start.x,this.start.y,this.cursor.x,this.cursor.y)<0&&(i="left")),t.rotate(e),this.renderRuler(t,s,i),t.restore()}renderRuler(t,e,s){t.lineWidth=this.thick,t.strokeStyle=this.strokeColor,t.fillStyle=this.fillColor,t.font="10px Arial";let o=0,i=-this.padding;"left"===s&&(i=4*this.padding);for(const s of e)this.renderSegment(t,o,i,s),this.renderArrow(t,o,i-this.height,"left"),this.renderArrow(t,o+s,i-this.height,"right"),s>20&&this.renderText(t,o,i,s),o+=s}renderSegment(t,e,s,o){t.beginPath(),t.moveTo(e,s-this.height),t.lineTo(e+o,s-this.height),t.moveTo(e,s),t.lineTo(e,s-2*this.height),t.moveTo(e+o,s),t.lineTo(e+o,s-2*this.height),t.stroke()}renderArrow(t,e,s,o){t.arrow(e,s,5,o)}renderText(t,e,s,o){const i=`${Math.round(o)} px`,n=t.measureText(i).width,r=e+(o-n)/2,a=s-this.height-10;t.fillStyle="white",t.fillRect(r-5,a-10,n+10,15),t.fillStyle=this.fillColor,t.fillText(i,r,a)}createSegment(){const t=this.getPoints(),e=[];for(let s=0;s<t.length-1;s++)e.push(o.distance(t[s].x,t[s].y,t[s+1].x,t[s+1].y));return e}getPoints(){const t=[this.start,...this.points,this.end].map((t=>({point:t,distance:Math.abs(t.distanceTo(this.start))})));return t.sort(((t,e)=>t.distance-e.distance)),t.map((t=>t.point))}}class g extends d{constructor(t,e,s,o){super(),this.floor=t,this.wall=e,this.fixedPoint=s,this.movePoint=o,this.originalMovePoint=this.movePoint.copy(),this.rotatedAngle=0,this.controls=[],this.ruler=new f(this.wall.start,this.wall.end),this.started=!1}onDragStart(t,e,s){t.addForegroundControl(this.ruler),this.started=!0}onDrag(t,e){if(this.started){const s=o.radianInPoint(this.fixedPoint,this.movePoint);this.movePoint.x=t,this.movePoint.y=e;const i=o.radianInPoint(this.fixedPoint,this.movePoint);this.rotate(i-s)}}rotate(t){this.rotatedAngle+=t;for(const e of this.controls)[e.start,e.end].map((e=>{const s=o.rotate(e.x,e.y,this.fixedPoint.x,this.fixedPoint.y,t);e.x=s[0],e.y=s[1]}))}onDragStop(t,e){if(this.started){this.started=!1;const t=this.wall.createOuterPolygon();for(const e of this.controls)t.containsInPoint(e.start)&&t.containsInPoint(e.end)||this.floor.removeControl(e)}this.floor.removeForegroundControl(this.ruler)}onCancel(){this.movePoint.copyFrom(this.originalMovePoint),this.rotate(-this.rotatedAngle),this.rotatedAngle=0,this.started=!1}}class p extends d{constructor(t,e,s){super(),this.floor=t,this.wall=e,this.handlers=[],this.equation=this.wall.createEquation();const{start:o,end:i}=this.wall;this.startPointEquation=this.equation.createPerpendicularEquation(o.x,o.y),this.endPointEquation=this.equation.createPerpendicularEquation(i.x,i.y),this.startCandidates=[],this.endCandidates=[],this.childs=s}addHandler(t){for(const e of t)this.handlers.push(e)}onDrag(t,e){this.equation=this.equation.createMoveEquation(t,e);const s=this.calculateStartPoint(t,e),o=this.calculateEndPoint(t,e);this.wall.start.copyFrom(s),this.wall.end.copyFrom(o);for(const t of this.handlers)t.onMove(this.floor,this.wall,this.equation);if(this.childs)for(const t of this.childs)t.start.copyFrom(this.equation.closestPoint(t.start.x,t.start.y)),t.end.copyFrom(this.equation.closestPoint(t.end.x,t.end.y))}calculateStartPoint(t,e){if(0===this.startCandidates.length)return this.equation.intersection(this.startPointEquation);if(1===this.startCandidates.length)return this.equation.intersection(this.startCandidates[0].equation);if(2===this.startCandidates.length){const t=this.equation.intersection(this.startCandidates[0].equation);if(o.isBetween(t.x,this.startCandidates[0].wall.start.x,this.startCandidates[0].wall.end.x)&&o.isBetween(t.y,this.startCandidates[0].wall.start.y,this.startCandidates[0].wall.end.y))return t;const e=this.equation.intersection(this.startCandidates[1].equation);if(o.isBetween(e.x,this.startCandidates[1].wall.start.x,this.startCandidates[1].wall.end.x)&&o.isBetween(e.y,this.startCandidates[1].wall.start.y,this.startCandidates[1].wall.end.y))return e}}calculateEndPoint(t,e){if(0===this.endCandidates.length)return this.equation.intersection(this.endPointEquation);if(1===this.endCandidates.length)return this.equation.intersection(this.endCandidates[0].equation);if(2===this.endCandidates.length){const t=this.equation.intersection(this.endCandidates[0].equation);if(o.isBetween(t.x,this.endCandidates[0].wall.start.x,this.endCandidates[0].wall.end.x)&&o.isBetween(t.y,this.endCandidates[0].wall.start.y,this.endCandidates[0].wall.end.y))return t;const e=this.equation.intersection(this.endCandidates[1].equation);if(o.isBetween(e.x,this.endCandidates[1].wall.start.x,this.endCandidates[1].wall.end.x)&&o.isBetween(e.y,this.endCandidates[1].wall.start.y,this.endCandidates[1].wall.end.y))return e}}}class y{constructor(t,e,s){this.follow=t,this.point=e,this.which=s}onMove(t,e,s){"start"===this.which?this.point.copyFrom(e.start):this.point.copyFrom(e.end)}}class x{constructor(t,e){this.follower=t,this.which=e,this.start=this.follower.start.copy(),this.end=this.follower.end.copy(),this.polygon=this.follower.createOuterPolygon()}onMove(t,e,s){const i=new n(0,0);"start"===this.which?i.copyFrom(e.start):i.copyFrom(e.end);const{start:r,end:a}=this.follower;if(this.isPointOnWall(i.x,i.y))this.restorePoints();else{o.distanceInPoint(r,i)>o.distanceInPoint(a,i)?this.changeEndPoint(i):this.changeStartPoint(i)}}changeStartPoint(t){this.follower.start.copyFrom(t)}changeEndPoint(t){this.follower.end.copyFrom(t)}restorePoints(){this.changeStartPoint(this.start),this.changeEndPoint(this.end)}isPointOnWall(t,e){return this.polygon.contains(t,e)}}class w{constructor(){this.followers=[]}addFollow(t,e){t&&this.followers.push({wall:t,point:e,equation:t.createEquation()})}onMove(t,e,s){const o=this.moveFollowers(e,s);this.removeFollowers(t,o)}moveFollowers(t,e){for(const s of this.followers){const i=e.intersection(s.equation);o.isBetween(i.x,t.start.x,t.end.x)&&o.isBetween(i.y,t.start.y,t.end.y)&&(s.point.x=i.x,s.point.y=i.y)}return[]}removeFollowers(t,e){for(const s of e)t.removeControl(s.wall),this.followers.splice(this.followers.indexOf(s),1)}}class m extends d{constructor(t,e,s){super(),this.fixedStart=t.copy(),this.fixedEnd=e.copy(),this.start=t,this.end=e,this.equation=s}onDragStart(t,e,s){this.startVector=h.createVector(e,s,this.start.x,this.start.y),this.endVector=h.createVector(e,s,this.end.x,this.end.y)}onDrag(t,e){this.startVector=h.createVector(t,e,this.fixedStart.x,this.fixedStart.y),this.endVector=h.createVector(t,e,this.fixedEnd.x,this.fixedEnd.y),this.startVector.dotProduct(this.endVector)<0||(this.start.x=this.fixedStart.x,this.start.y=this.fixedStart.y,this.end.x=this.fixedEnd.x,this.end.y=this.fixedEnd.y)}}class C extends s{constructor(t){super(),this.control=t}get type(){return"window-select"}render(t){this.control&&(t.save(),this.renderPoints(t,[this.control.start,this.control.end]),this.renderLines(t,[this.control.start,this.control.end]),t.restore())}renderPoints(t,e){t.fillStyle=u.activeColor;for(const s of e)t.circle(s.x,s.y,10),t.fill()}renderLines(t,e){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.closePath(),t.lineWidth=2,t.strokeStyle=u.selectColor,t.stroke()}}class v extends d{constructor(t){super(),this.control=t,this.startX=0,this.startY=0}onDragStart(t,e,s){this.started=!0,this.startX=e,this.startY=s}onDrag(t,e){const s=t-this.startX,o=e-this.startY;this.control.start.x+=s,this.control.start.y+=o,this.control.end.x+=s,this.control.end.y+=o,this.startX=t,this.startY=e}}class P extends c{constructor(t,e){super(t,e)}get type(){return"wall"}cutting(t,e,s){const o={x:this.end.x,y:this.end.y};this.end.x=e,this.end.y=s;t.createWall(e,s,o.x,o.y).thick=this.thick}createPointDragHandler(t,e,s){let o=null;return this.start.distance(e,s)<10?o=new g(t,this,this.end,this.start):this.end.distance(e,s)<10&&(o=new g(t,this,this.start,this.end)),o&&o.controls.push(...t.findControlsOnWall(this)),o}createExtendDragHandler(t,e,s){return this.isPointInControl(e,s)?new m(this.start,this.end):null}createMoveDragHandler(t,e,s){if(this.isPointInControl(e,s)){const e=new p(t,this,t.findControlsOnWall(this));return e.addHandler(this.createStartPointHandlers(t,e)),e.addHandler(this.createEndPointHandlers(t,e)),e.addHandler(this.createStartPointExtendHandlers(t,e)),e.addHandler(this.createEndPointExtendHandlers(t,e)),e.addHandler(this.createWallHandlers(t)),e}return null}createStartPointHandlers(t,e){const s=[],o=t.getConnectedWallsFromPoint(this,this.start,this.end);return 1===o.length&&(e.startPointEquation=o[0].wall.createEquation(),s.push(new y(o[0].wall,o[0].point,"start"))),s}createStartPointExtendHandlers(t,e){const s=[],o=t.getWallFromPoint(this,this.start);return o&&(e.startPointEquation=o.createEquation(),s.push(new x(o,"start"))),s}createEndPointExtendHandlers(t,e){const s=[],o=t.getWallFromPoint(this,this.end);return o&&(e.endPointEquation=o.createEquation(),s.push(new x(o,"end"))),s}createEndPointHandlers(t,e){const s=[],o=t.getConnectedWallsFromPoint(this,this.end,this.start);return 1===o.length&&(e.endPointEquation=o[0].wall.createEquation(),s.push(new y(o[0].wall,o[0].point,"end"))),s}createPointHandlers(t,e,s,o){const i=[];if(s)if(s.point)if(s.angle>175&&s.angle<185)if("start"===o){const e=new P(this.start.copy(),this.start.copy());e.thick=this.thick,t.walls.push(e),i.push(new y(e,e.end,o))}else{const e=new P(this.end.copy(),this.end.copy());e.thick=this.thick,t.walls.push(e),i.push(new y(e,e.end,o))}else"start"===o?e.startPointEquation=s.wall.createEquation():e.endPointEquation=s.wall.createEquation(),i.push(new y(s.wall,s.point,o));else"start"===o?e.startPointEquation=s.wall.createEquation():e.endPointEquation=s.wall.createEquation(),i.push(new x(s.wall,o));return i}createWallHandlers(t){const e=new w,s=t.getConnectedWallsFromWall(this);for(const t of s)e.addFollow(t.wall,t.point);return[e]}createPointSelectionControl(){return new C(this)}createMoveSelectionControl(){return new C(this)}createEquation(){return i.createEquationFrom4Point(this.start.x,this.start.y,this.end.x,this.end.y)}createPerpendicularEquation(t,e){if(1===arguments.length){const e=t;if(e instanceof n)return this.createEquation().createPerpendicularEquation(e.x,e.y)}else if(arguments.length>=2)return this.createEquation().createPerpendicularEquation(t,e);return null}distance(t,e){return this.createEquation().distance(t,e)}createClosestPoint(t,e){return this.createEquation().closestPoint(t,e)}createDistancePoint(t,e,s){const o=this.createEquation().closestPoint(t,e),i=Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x);return{x:o.x+s*Math.cos(i),y:o.y+s*Math.sin(i)}}isPointOnBoundary(t){const{start:e,end:s}=this,o=Math.min(e.x,s.x),i=Math.max(e.x,s.x),n=Math.min(e.y,s.y),r=Math.max(e.y,s.y);return t.x>=o&&t.x<=i&&t.y>=n&&t.y<=r}renderControl(t){t.save(),t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.closePath(),t.stroke(),t.restore()}}class b extends s{constructor(t){super(),this.room=t}get type(){return"room-move-select"}render(t){const{points:e}=this.room.polygon;e.length>0&&(t.save(),this.renderLines(t,e,15,"rgb(105,211,243)"),this.renderLines(t,e,5,"rgb(0,151,197)"),t.restore())}renderPoints(t,e){t.fillStyle=u.selectColor;for(const s of e)t.circle(s.x,s.y,10),t.fill()}renderLines(t,e,s,o){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.closePath(),t.lineWidth=s,t.strokeStyle=o,t.stroke()}}class A extends d{constructor(t){super(),this.points=t}addPoint(t){this.points.push(t)}onDragStart(t,e,s){}onDrag(t,e){for(const s of this.points)s.x=t,s.y=e}onDragStop(t,e){for(const s of this.points)s.x=t,s.y=e}}class E extends s{constructor(t,e){super(),this.polygon=new a(t),this.fillColor=null,this.label=e}get type(){return"room"}addPoint(t){this.polygon.addPoint(t)}render(t){const{points:e}=this.polygon;if(e.length>0){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.closePath(),this.fillColor&&(t.fillStyle=this.fillColor,t.fill());const s=this.polygon.getVisualCenterPoint();this.label&&s&&(t.font="10px Arial",t.fillStyle="#000000",t.text(s.x,s.y,this.label))}}contains(t,e){return this.polygon.contains(t,e)}createPointDragHandler(t,e,s){const i=[];for(const t of this.polygon.points){o.distance(t.x,t.y,e,s)<10&&i.push(t)}return i.length>0?new A(i):null}createMoveDragHandler(t,e,s){return this.isPointInControl(e,s)?new d:null}createPointSelectionControl(){return null}createMoveSelectionControl(){return new b(this)}isPointInControl(t,e,s){return this.polygon.contains(t,e)}}class D extends d{constructor(t,e,s,o){super(),this.floor=t,this.wall=e,this.point=o,this.control=s,this.ruler=new f(this.wall.start,this.wall.end),this.ruler.addPoint(s.start),this.ruler.addPoint(s.end),this.cancelSnapshot={wall:e,point:o.copy()},this.started=!1}onDragStart(t,e,s){this.floor.addForegroundControl(this.ruler),this.started=!0}onDrag(t,e){if(!this.started)return;const s=this.wall.createClosestPoint(t,e);this.wall.isPointOnBoundary(s)&&this.point.copyFrom(s)}onDragStop(t,e){this.started=!1,this.removeControlsUnderThreshold(10),this.floor.removeForegroundControl(this.ruler)}onCancel(){this.started=!1,this.point.copyFrom(this.cancelSnapshot.point)}removeControlsUnderThreshold(t){this.control.length<t&&this.floor.removeControl(this.control)}}class T extends d{constructor(t,e,s){super(),this.floor=t,this.wall=e,this.control=s,this.startVector=0,this.endVector=0,this.ruler=new f(this.wall.start,this.wall.end),this.ruler.addPoint(this.control.start),this.ruler.addPoint(this.control.end),this.cancelSnapshot={wall:e,start:s.start.copy(),end:s.end.copy()},this.started=!1,this.reverse=o.distanceInPoint(this.wall.start,this.control.start)>o.distanceInPoint(this.wall.start,this.control.end)}onDragStart(t,e,s){const o=this.wall.createClosestPoint(e,s);this.startVector=h.createVectorOfPoints(o,this.control.start),this.endVector=h.createVectorOfPoints(o,this.control.end),this.floor.addForegroundControl(this.ruler),this.started=!0,this.startX=e,this.startY=s}onDrag(t,e){if(!this.started)return;this.ruler.cursor.x=t,this.ruler.cursor.y=e;const s=this.floor.getClosestWallOnCoordinates(t,e);s&&(this.wall=s);let o=null,i=null;this.reverse?(o=this.wall.createDistancePoint(t,e,this.startVector.getLength()),i=this.wall.createDistancePoint(t,e,-this.endVector.getLength())):(o=this.wall.createDistancePoint(t,e,-this.startVector.getLength()),i=this.wall.createDistancePoint(t,e,this.endVector.getLength())),this.wall.isPointOnBoundary(o)&&this.wall.isPointOnBoundary(i)&&(this.updateRuler(this.wall.start,this.wall.end),this.updateControl(o,i))}onDragStop(t,e){this.started&&(this.started=!1),this.floor.removeForegroundControl(this.ruler)}onCancel(){this.started=!1,this.updateRuler(this.cancelSnapshot.wall.start,this.cancelSnapshot.wall.end),this.updateControl(this.cancelSnapshot.start,this.cancelSnapshot.end)}updateRuler(t,e){this.ruler.start=t,this.ruler.end=e}updateControl(t,e){this.control.start.copyFrom(t),this.control.end.copyFrom(e)}}class M extends d{constructor(t){super(),this.point=t}onDragStart(t,e,s){}onDrag(t,e){this.point.x=t,this.point.y=e}onDragStop(t,e){this.point.x=t,this.point.y=e}}class F extends d{constructor(t,e,s){super(),this.floor=t,this.wall=e,this.control=s,this.startVector=0,this.endVector=0,this.ruler=new f(this.wall.start,this.wall.end),this.ruler.addPoint(this.control.start),this.ruler.addPoint(this.control.end),this.cancelSnapshot={wall:e,start:s.start.copy(),end:s.end.copy()},this.started=!1,this.reverse=o.distanceInPoint(this.wall.start,this.control.start)>o.distanceInPoint(this.wall.start,this.control.end)}onDragStart(t,e,s){const o=this.wall.createClosestPoint(e,s);this.startVector=h.createVectorOfPoints(o,this.control.start),this.endVector=h.createVectorOfPoints(o,this.control.end),this.floor.addForegroundControl(this.ruler),this.started=!0,this.startX=e,this.startY=s}onDrag(t,e){if(!this.started)return;this.ruler.cursor.x=t,this.ruler.cursor.y=e;const s=this.floor.getClosestWallOnCoordinates(t,e);s&&(this.wall=s);let o=null,i=null;this.reverse?(o=this.wall.createDistancePoint(t,e,this.startVector.getLength()),i=this.wall.createDistancePoint(t,e,-this.endVector.getLength())):(o=this.wall.createDistancePoint(t,e,-this.startVector.getLength()),i=this.wall.createDistancePoint(t,e,this.endVector.getLength())),this.wall.isPointOnBoundary(o)&&this.wall.isPointOnBoundary(i)&&(this.updateRuler(this.wall.start,this.wall.end),this.updateControl(o,i))}onDragStop(t,e){this.started&&(this.started=!1),this.floor.removeForegroundControl(this.ruler)}onCancel(){this.started=!1,this.updateRuler(this.cancelSnapshot.wall.start,this.cancelSnapshot.wall.end),this.updateControl(this.cancelSnapshot.start,this.cancelSnapshot.end)}updateRuler(t,e){this.ruler.start=t,this.ruler.end=e}updateControl(t,e){this.control.start.copyFrom(t),this.control.end.copyFrom(e)}}class S extends s{constructor(){super(),this.x=0,this.y=0,this.text=null,this.background=null,this.color=null}get type(){return"tooltip"}render(t){if(!this.text)return;t.font="10px Arial bold";const e=t.measureText(this.text).width,s=parseInt(t.font);t.fillStyle=this.background?this.background:"rgba(255,59,48)",t.fillRect(this.x,this.y,e+10,s+10),t.fillStyle=this.color?this.color:"#ffffff",t.fillText(this.text,this.x+5,this.y+s+5)}}class B extends s{constructor(t){super(),this.door=t,this.tooltip=new S}get type(){return"door-select-control"}render(t){this.door&&(t.save(),this.renderPoints(t,[this.door.start,this.door.end,this.door.getControlPoint()]),t.restore(),this.door.length<10&&(this.tooltip.x=this.door.start.x,this.tooltip.y=this.door.start.y+10,this.tooltip.text="deleted",this.tooltip.render(t)))}renderPoints(t,e){t.fillStyle=u.activeColorTransparent;for(const s of e)t.circle(s.x,s.y,10),t.fill()}}class H extends d{constructor(t){super(),this.door=t,this.started=!1}onDragStart(t,e,s){this.started=!0}onDrag(t,e){if(!this.started)return;const s=this.calculateAngle(this.door.start.x,this.door.start.y,this.door.end.x,this.door.end.y,this.door.start.x,this.door.start.y,t,e);this.door.direction=s>=0&&s<=180?"right":"left";const i=o.distance(this.door.start.x,this.door.start.y,t,e),n=o.distance(this.door.end.x,this.door.end.y,t,e);this.door.hidge=i>n?"end":"start"}angle(t,e){return o.angle(this.door.start.x,this.door.start.y,t,e)}onDragStop(t,e){this.started&&(this.started=!1)}createVector(t,e,s,o){return{x:s-t,y:o-e}}dotProduct(t,e){return t.x*e.x+t.y*e.y}vectorMagnitude(t){return Math.sqrt(t.x*t.x+t.y*t.y)}calculateAngle(t,e,s,o,i,n,r,a){var h=this.createVector(t,e,s,o),l=this.createVector(i,n,r,a),c=Math.atan2(l.y,l.x)-Math.atan2(h.y,h.x);return this.radiansToDegreesInRange(c)}radiansToDegreesInRange(t){for(var e=t*(180/Math.PI);e<0;)e+=360;for(;e>=360;)e-=360;return e}}class R extends c{constructor(t,e){super(t,e),this.hidge="start",this.direction="right"}get type(){return"door"}get angle(){return o.radianInPoint(this.start,this.end)}getControlPoint(){const t=this.length,e=this.angle-270*Math.PI/180;let s=0,o=0;return"right"===this.direction?"start"===this.hidge?(s=this.start.x+t*Math.cos(e),o=this.start.y+t*Math.sin(e)):(s=this.end.x+t*Math.cos(e),o=this.end.y+t*Math.sin(e)):"start"===this.hidge?(s=this.start.x-t*Math.cos(e),o=this.start.y-t*Math.sin(e)):(s=this.end.x-t*Math.cos(e),o=this.end.y-t*Math.sin(e)),new n(s,o)}render(t){t.save(),t.lineWidth=1,t.translate(this.start.x,this.start.y),t.rotate(this.angle),this.renderRect(t),this.renderDoor(t),t.restore()}renderRect(t){const e=this.length,s=10/3,o=new Path2D;o.rect(0,-5,e,10);for(let t=0;t<3;t++)o.rect(5,s*t-5,e-10,s);t.fillStyle="#ffffff",t.strokeStyle="#000000",t.fill(o),t.stroke(o)}renderDoor(t){const e=this.length,s=new Path2D,o=Math.PI/2,i=Math.PI,n=0+e;"start"===this.hidge?"right"===this.direction?(s.arc(0,0,e,0,o,!1),s.moveTo(0,0),s.lineTo(0,e)):(s.arc(0,0,e,-o,0,!1),s.moveTo(0,0),s.lineTo(0,-e)):"right"===this.direction?(s.arc(n,0,e,o,i,!1),s.moveTo(n,0),s.lineTo(n,e)):(s.arc(n,0,e,i,-o,!1),s.moveTo(n,0),s.lineTo(n,-e)),t.stroke(s)}createPointDragHandler(t,e,s){const o=t.getWallsOnCoordinates(this.start.x,this.start.y);if(this.start.distance(e,s)<10)return 0===o.length?new M(this.start):new D(t,o[0],this,this.start);if(this.end.distance(e,s)<10)return 0===o.length?new M(this.end):new D(t,o[0],this,this.end);return this.getControlPoint().distance(e,s)<10?new H(this):null}createMoveDragHandler(t,e,s){if(this.isPointInControl(e,s)){const e=t.getWallsOnCoordinates(this.start.x,this.start.y);return e.length>0?new F(t,e[0],this):new v(this)}return null}createPointSelectionControl(){return new B(this)}createMoveSelectionControl(){return new B(this)}}class k extends s{constructor(t){super(),this.window=t,this.tooltip=new S}get type(){return"window-select-control"}render(t){this.window&&(t.save(),this.renderPoints(t,[this.window.start,this.window.end]),t.restore(),this.window.length<10&&(this.tooltip.x=this.window.start.x,this.tooltip.y=this.window.start.y+10,this.tooltip.text="deleted",this.tooltip.render(t)))}renderPoints(t,e){t.fillStyle=u.activeColorTransparent;for(const s of e)t.circle(s.x,s.y,10),t.fill()}}class O extends c{constructor(t,e){super(t,e)}get type(){return"window"}render(t){const e=o.radianInPoint(this.start,this.end),s=o.distanceInPoint(this.start,this.end),i=this.createWindowPath(s,10);t.save(),t.translate(this.start.x,this.start.y),t.rotate(e),t.lineWidth=1,t.strokeStyle="#000000",t.fillStyle="#ffffff",t.fill(i),t.stroke(i),t.restore()}createWindowPath(t,e){const s=e/3,o=new Path2D;o.rect(0,-5,t,e);for(let e=0;e<3;e++)o.rect(5,s*e-5,t-10,s);return o}createPointDragHandler(t,e,s){const o=t.getWallsOnCoordinates(this.start.x,this.start.y);return this.start.distance(e,s)<10?0===o.length?new M(this.start):new D(t,o[0],this,this.start):this.end.distance(e,s)<10?0===o.length?new M(this.end):new D(t,o[0],this,this.end):null}createMoveDragHandler(t,e,s){if(this.isPointInControl(e,s)){const e=t.getWallsOnCoordinates(this.start.x,this.start.y);return e.length>0?new T(t,e[0],this):new v(this)}return null}createPointSelectionControl(){return new k(this)}createMoveSelectionControl(){return new k(this)}}class I{constructor(t,e){this.point=new n(t,e),this.edges=[]}get x(){return this.point.x}set x(t){this.point.x=t}get y(){return this.point.y}set y(t){this.point.y=t}removeEdge(t){this.edges.splice(this.edges.indexOf(t),1)}}class W{constructor(){this.vertices=[]}addEdge(t,e,s,o){const[i,n,r,a]=[t,e,s,o].map(Math.floor),h=this.getVertexOrCreate(i,n),l=this.getVertexOrCreate(r,a);h.edges.push(l),l.edges.push(h)}getVertex(t,e){return this.vertices.find((s=>s.point.x===t&&s.point.y===e))}existEdge(t,e){const s=this.getVertex(t.x,t.y);return!!s&&s.edges.some((t=>t.x===e.x&&t.y===e.y))}removeVertex(t){this.vertices.splice(this.vertices.indexOf(t),1);for(let e of t.edges)e.removeEdge(t)}getVertexOrCreate(t,e){let s=this.getVertex(t,e);return s||(s=new I(t,e),this.vertices.push(s),s)}removeLeafVertex(){let t=[];do{t=[];for(const e of this.vertices)e.edges.length<=1&&t.push(e);for(const e of t)this.removeVertex(e)}while(t.length>0)}getAllPoints(){return this.vertices.map((t=>t.point))}}class V{static findPolygon(t){let e=[];t.vertices.forEach((s=>{s.edges.forEach((o=>{const i=new q;i.push(s),this.find(t,s,o,i),i.closed&&(t=>{const{points:s}=t;s.length<=2||e.some((e=>e.isSamePolygon(t)))||e.push(t)})(i.createPolygon())}))}));const s=t.getAllPoints();return e.filter((t=>!s.some((e=>t.isPointInside(e)))))}static find(t,e,s,o){if(!e||!s)return;o.push(s);let i=this.next(t,e,s,o);i!==o.first()?this.find(t,s,i,o):o.closed=!0}static next(t,e,s,o){const i=s.edges.filter((t=>t!==e&&!o.visited(t)));if(0===i.length)return null;if(1===i.length)return i[0];let n=null,r=1/0;for(const t of i){const o=this.ccw(e,s,t);o.value<r&&(n=t,r=o.value)}return n}static ccw(t,e,s){let o=t.x*e.y+e.x*s.y+s.x*t.y-e.x*t.y-s.x*e.y-t.x*s.y;return{value:o,isRight:()=>o>0,isLeft:()=>o<0}}}class q{constructor(){this.vertexes=[],this.closed=!1}get length(){return this.vertexes.length}first(){return this.vertexes.length>0?this.vertexes[0]:null}push(t){this.vertexes.push(t)}visited(t){return this.vertexes.includes(t,1)}createPolygon(){const t=this.vertexes.map((t=>t.point));return new a(t)}}class L{constructor(){this.rooms=[],this.walls=[],this.windows=[],this.doors=[],this.foregrounds=[]}clear(){this.rooms=[],this.walls=[],this.windows=[],this.doors=[],this.foregrounds=[]}load(t){this.clear(),t.rooms&&this.loadRooms(t.rooms),t.walls&&this.loadWalls(t.walls),t.windows&&this.loadWindows(t.windows),t.doors&&this.loadDoors(t.doors)}loadRooms(t){for(const e of t){const t=new E(e.points,e.name);this.rooms.push(t)}}loadWalls(t){for(const e of t){const{start:t,end:s}=e,o=new P(new n(t.x,t.y),new n(s.x,s.y));this.walls.push(o)}}loadWindows(t){for(const e of t){const{start:t,end:s}=e,o=new O(new n(t.x,t.y),new n(s.x,s.y));this.windows.push(o)}}loadDoors(t){for(const e of t){const{start:t,end:s}=e,o=new R(new n(t.x,t.y),new n(s.x,s.y));o.hidge=e.hidge,o.direction=e.direction,this.doors.push(o)}}render(t){this.renderFloor(t),this.renderForeground(t)}renderFloor(t){for(const e of this.rooms)e.render(t);for(const e of this.walls)e.render(t);for(const e of this.doors)e.render(t);for(const e of this.windows)e.render(t)}renderForeground(t){for(const e of this.foregrounds)e.render(t)}buildGraph(t){const e=(t,e,s)=>{for(const o of t)if(o.x===e&&o.y===s)return!0;return!1};for(const s of this.walls){let i=this.collectIntersectionPoints(s);i.sort(((t,e)=>o.distanceInPoint(s.start,t)-o.distanceInPoint(s.start,e))),e(i,s.start.x,s.start.y)||i.unshift(s.start),e(i,s.end.x,s.end.y)||i.push(s.end);for(let e=1;e<i.length;e++){const s=i[e-1],o=i[e];t.addEdge(s.x,s.y,o.x,o.y)}}return t}createRooms(t){const e=new W;this.buildGraph(e),e.removeLeafVertex();const s=V.findPolygon(e);this.rooms=s.map((e=>{let s=this.getRoom(e);return s||(s=new E(e.points,""),t&&(s=t.onCreate(s))),s}))}getRoom(t){return this.rooms.find((e=>e.polygon.isSamePolygon(t)))}getRoomIncludePoint(t){return this.rooms.find((e=>e.isPointInControl(t.x,t.y)))}collectIntersectionPoints(t){const e=t.createOuterPolygon();return this.walls.flatMap((s=>{if(t===s)return[];if(e.contains(s.start.x,s.start.y))return[s.start];if(e.contains(s.end.x,s.end.y))return[s.end];const i=o.interceptPoint(t.start.x,t.start.y,t.end.x,t.end.y,s.start.x,s.start.y,s.end.x,s.end.y);return i?[i]:[]}))}createWall(t,e,s,o){let i=this.findWall(t,e,s,o);return i||(i=new P(new n(t,e),new n(s,o)),this.walls.push(i)),i}findWall(t,e,s,o){for(const i of this.walls){const{start:n,end:r}=i;if(n.x===t&&n.y===e&&r.x===s&&r.y===o)return i;if(r.x===t&&r.y===e&&n.x===s&&n.y===o)return i}for(const i of this.walls){const n=i.createOuterPolygon(10);if(n.contains(t,e)&&n.contains(s,o))return i}return null}findControlsOnWall(t){const e=t.createOuterPolygon(),s=[];for(const t of this.doors)e.contains(t.start.x,t.start.y)&&e.contains(t.end.x,t.end.y)&&s.push(t);for(const t of this.windows)e.contains(t.start.x,t.start.y)&&e.contains(t.end.x,t.end.y)&&s.push(t);return s}removeControl(t){let e=this.walls.indexOf(t);if(-1!==e){this.walls.splice(e,1);for(const e of this.findControlsOnWall(t))this.removeControl(e)}e=this.windows.indexOf(t),-1!==e&&this.windows.splice(e,1),e=this.doors.indexOf(t),-1!==e&&this.doors.splice(e,1),e=this.rooms.indexOf(t),-1!==e&&this.rooms.splice(e,1)}getControlsOnCoordinates(t,e,s=null){const o=[];for(const i of this.getAllControls())i.isPointInControl(t,e)&&(s&&s(i),o.push(i));return o}getWallByPoint(t,e){const s=(t,e)=>Math.floor(t)===Math.floor(e),o=(t,e,o)=>s(t.start.x,e.x)&&s(t.start.y,e.y)&&s(t.end.x,o.x)&&s(t.end.y,o.y);for(const s of this.walls)if(o(s,t,e)||o(s,e,t))return s;return null}getWallsOnCoordinates(t,e,s=null){const o=[];for(const i of this.walls)i.isPointInControl(t,e)&&(s?s(i)&&o.push(i):o.push(i));return o}getWallFromPoint(t,e){const s=e=>t.start.x===e.x&&t.start.y===e.y||t.end.x===e.x&&t.end.y===e.y;for(const o of this.walls)if(t!==o&&!s(o.start)&&!s(o.end)&&o.isPointInControl(e.x,e.y))return o;return null}getClosestWallOnCoordinates(t,e){for(const s of this.walls)if(s.isPointInControl(t,e,10))return s;return null}cuttingRect(t,e,s,o){const i=l.create(t,e,s,o);for(const t of i.segments())this.cuttingLine(t.x1,t.y1,t.x2,t.y2);i.x-=1,i.y-=1,i.width+=2,i.height+=2;const n=[];for(const t of this.walls)i.isPointInRect(t.start)&&i.isPointInRect(t.end)&&n.push(t);for(const t of this.windows)i.isPointInRect(t.start)&&i.isPointInRect(t.end)&&n.push(t);for(const t of this.doors)i.isPointInRect(t.start)&&i.isPointInRect(t.end)&&n.push(t);for(const t of n)this.removeControl(t)}getConnectedWallsFromPoint(t,e,s){const i=[],n=h.createVectorOfPoints(e,s);for(const r of this.walls)if(r!==t){const{start:t,end:a}=r;o.distanceInPoint(t,e)<10?i.push({wall:r,point:t,angle:o.calculate3PointAngle(e,a,s),vector:h.createVectorOfPoints(t,a),dotProduct:n.dotProduct(h.createVectorOfPoints(t,a))}):o.distanceInPoint(a,e)<10&&i.push({wall:r,point:a,angle:o.calculate3PointAngle(e,t,s),vector:h.createVectorOfPoints(a,t),dotProduct:n.dotProduct(h.createVectorOfPoints(a,t))})}return i}getConnectedWallsFromWall(t){const e=e=>t.start.x===e.x&&t.start.y===e.y||t.end.x===e.x&&t.end.y===e.y,s=t.createOuterPolygon(5),o=[];for(const i of this.walls)if(i!==t){if(e(i.start)||e(i.end))continue;const{start:t,end:n}=i;s.contains(t)?o.push({wall:i,point:t}):s.contains(n)&&o.push({wall:i,point:n})}return o}cuttingLine(t,e,s,i){const n=[];for(const r of this.walls){const a=o.interceptPoint(t,e,s,i,r.start.x,r.start.y,r.end.x,r.end.y);a&&n.push({point:a,wall:r})}for(const t of n)t.wall.cutting(this,t.point.x,t.point.y)}addForegroundControl(t){t&&this.foregrounds.push(t)}removeForegroundControl(t){t&&(this.foregrounds=this.foregrounds.filter((e=>e!==t)))}getBoundRect(){const t={minX:0,minY:0,maxX:0,maxY:0};if(0===this.walls.length)return t;let e=this.walls[0].start.x,s=this.walls[0].start.y,o=this.walls[0].start.x,i=this.walls[0].start.y;for(const t of this.walls)[t.start,t.end].forEach((t=>{t.x<e&&(e=t.x),t.x>o&&(o=t.x),t.y<s&&(s=t.y),t.y>i&&(i=t.y)}));return t.minX=e,t.maxX=o,t.minY=s,t.maxY=i,t}getAllControls(){return[...this.doors,...this.windows,...this.walls,...this.rooms]}}class X{render(t){}}class Y extends X{constructor(t,e){super(),this.canvas=e,this.display=!t||!t.display||t.display,this.size=t&&t.size?t.size:100,this.color=t&&t.color?t.color:"#c2c1c1",this.thick=t&&t.thick?t.thick:1}render(t){if(this.display){t.save(),t.setTransform(1,0,0,1,0,0),t.beginPath(),t.strokeStyle=this.color,t.lineWidth=this.thick;for(let e=this.size;e<this.canvas.width;e+=this.size)t.moveTo(e,0),t.lineTo(e,this.canvas.height);for(let e=this.size;e<this.canvas.height;e+=this.size)t.moveTo(0,e),t.lineTo(this.canvas.width,e);t.stroke(),t.restore()}}}class G extends X{constructor(t,e=1,s=!1){super(),this.floor=t,this.alpha=e,this.displayVertex=s}render(t){t.save(),t.globalAlpha=this.alpha,this.floor.render(t),this.displayVertex&&this.renderVertex(t),t.restore()}renderVertex(t){const e=new r;for(const t of this.floor.walls)e.addPoint(t.start),e.addPoint(t.end);for(const s of e.points)t.beginPath(),t.arc(s.x,s.y,10,0,2*Math.PI),t.fillStyle="rgba(31,32,35,0.5)",t.fill()}}class z extends X{constructor(t){super(),this.floor=t}render(t){let e=1/0,s=1/0,o=-1/0,i=-1/0;for(const t of this.floor.walls){const{start:n,end:r}=t;e=Math.min(e,n.x,r.x),o=Math.max(o,n.x,r.x),s=Math.min(s,n.y,r.y),i=Math.max(i,n.y,r.y)}const n=50;this.renderLine(t,e,s-n,o,s-n),this.renderArrow(t,e,s-n,5,4),this.renderArrow(t,o,s-n,5,2),this.renderLine(t,o+n,s,o+n,i),this.renderArrow(t,o+n,s,5,1),this.renderArrow(t,o+n,i,5,3)}renderLine(t,e,s,o,i){t.beginPath(),t.strokeStyle="#666666",t.fillStyle="#666666",t.lineWidth=1,t.moveTo(e,s),t.lineTo(o,i),t.stroke()}renderArrow(t,e,s,o,i){switch(i){case 1:t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s+o),t.moveTo(e,s),t.lineTo(e+o,s+o),t.closePath(),t.stroke();break;case 2:t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.moveTo(e,s),t.lineTo(e-o,s+o),t.closePath(),t.stroke();break;case 3:t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.moveTo(e,s),t.lineTo(e+o,s-o),t.closePath(),t.stroke();break;case 4:t.beginPath(),t.moveTo(e,s),t.lineTo(e+o,s-o),t.moveTo(e,s),t.lineTo(e+o,s+o),t.closePath(),t.stroke()}}}class j{constructor(){this.clientX=0,this.clientY=0,this.snapX=0,this.snapY=0,this.x=0,this.y=0}}class N{constructor(t){this.handlers=[],this.snapToGrid=!0,this.context=t}addHandler(t){t&&this.handlers.push(t)}removeHandler(t){t&&(this.handlers=this.handlers.filter((e=>e!==t)))}onClick(t){for(const e of this.handlers)e.onClick(t)}onKeyDown(t,e){for(const s of this.handlers)s.onKeyDown(t,e)}onMouseDown(t){this.initEvent(t);for(const e of this.handlers)e.onMouseDown(t)}onMouseMove(t){this.initEvent(t);for(const e of this.handlers)e.onMouseMove(t)}onMouseUp(t){this.initEvent(t);for(const e of this.handlers)e.onMouseUp(t)}initEvent(t){const e=this.transformPoint(t.x,t.y),s=this.snapPoint(e);t.snapX=s.x,t.snapY=s.y,t.x=e.x,t.y=e.y}snap(t){return this.snapToGrid?10*Math.round(t/10):t}snapPoint(t){return{x:this.snap(t.x),y:this.snap(t.y)}}transformPoint(t,e){const s=this.context.getTransform(),o=s.e,i=s.f;return{x:t-o/s.a,y:e-i/s.d}}}class U{onCommandActive(t){}onCommandDeActive(t){}}class ${constructor(){}useSnap(){return!0}onClick(t){}onKeyDown(t,e){}onMouseDown(t){}onMouseMove(t){}onMouseUp(t){}}class K extends U{constructor(t){super(),this.handler=new J(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class J extends ${constructor(t){super(),this.editor=t,this.hanlders=[],this.canvasmovehandler=new Z(t),this.selectedControl=null}useSnap(){return!1}onKeyDown(t,e){if("Backspace"===t){for(const t of this.editor.floor.walls)t.selected&&this.editor.floor.removeControl(t);this.editor.render()}else if("Escape"===t){for(const t of this.hanlders)t.onCancel();this.editor.render()}}onMouseDown(t){this.editor.onSelect(t,null);const e=this.editor.floor;for(const s of e.getAllControls()){const o=s.createPointDragHandler(e,t.x,t.y);o&&(this.editor.addSelectControls([s.createPointSelectionControl()]),this.hanlders.push(o))}if(0===this.hanlders.length){this.editor.selectControl(null,t.x,t.y);for(const s of e.getAllControls()){const o=s.createMoveDragHandler(e,t.x,t.y);if(o){this.selectedControl=s,this.editor.setSelectControls([s.createMoveSelectionControl()]),this.hanlders.push(o);break}}}0===this.hanlders.length&&(this.editor.setSelectControls([]),this.editor.selectControl(null,t.x,t.y));for(const s of this.hanlders)s.onDragStart(e,t.x,t.y);0===this.hanlders.length&&this.canvasmovehandler.onDragStart(e,t.clientX,t.clientY),this.editor.render()}onMouseMove(t){for(const e of this.hanlders)e.onDrag(t.x,t.y);0===this.hanlders.length&&this.canvasmovehandler.onDrag(t.clientX,t.clientY),this.editor.render()}onMouseUp(t){for(const e of this.hanlders)e.onDragStop(t.x,t.y);0===this.hanlders.length?(this.editor.onSelect(t,null),this.canvasmovehandler.onDragStop(t.clientX,t.clientY)):(this.editor.onSelect(t,this.selectedControl),this.editor.onChangeFloor({updateRooms:!0})),this.selectedControl=null,this.hanlders=[],this.editor.setSelectControls([]),this.editor.render()}}class Z extends d{constructor(t){super(),this.editor=t,this.startX=0,this.startY=0,this.started=!1}onDragStart(t,e,s){this.startX=e,this.startY=s,this.started=!0}onDrag(t,e){if(this.started){if(this.editor){const s=t-this.startX,o=e-this.startY;this.editor.translate(s,o)}this.startX=t,this.startY=e}}onDragStop(t,e){this.started=!1}}class _ extends U{constructor(t,e){super(),this.handler=new Q(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Q extends ${constructor(t,e){super(),this.editor=t,this.control=new tt,this.started=!1,this.clear=e}onMouseDown(t){this.started=!0,this.control.initialize(t.snapX,t.snapY),this.editor.floor.addForegroundControl(this.control)}onMouseMove(t){this.started&&(this.control.move(t.snapX,t.snapY),this.editor.render())}onMouseUp(t){const e=this.editor.floor;if(e.removeForegroundControl(this.control),this.started){if(this.clear){const t=this.control.rect;e.cuttingRect(t.x,t.y,t.width,t.height)}for(const t of this.control.rect.segments())this.createWall(t);this.editor.render()}this.started=!1,this.editor.tools.select(),this.editor.onChangeFloor({updateRooms:!0})}createWall(t){let e=new P(new n(t.x1,t.y1),new n(t.x2,t.y2));e=this.editor.onCreate(e),e&&this.editor.floor.walls.push(e)}}class tt extends s{constructor(){super(),this.rect=new l,this.widthRuler=new f(this.start,this.end),this.heightRuler=new f(this.start,this.end)}initialize(t,e){this.rect.x=t,this.rect.y=e,this.rect.width=0,this.rect.height=0}move(t,e){this.rect.width=t-this.rect.x,this.rect.height=e-this.rect.y}render(t){t.save(),t.beginPath(),t.lineWidth=10,t.strokeStyle=u.activeColor,t.rect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),t.stroke(),t.closePath(),this.renderWidthRuler(t),this.renderHeightRuler(t),t.restore()}renderWidthRuler(t){this.widthRuler.start=this.rect.getTopLeftPoint(),this.widthRuler.end=this.rect.getTopRightPoint(),this.widthRuler.render(t)}renderHeightRuler(t){this.heightRuler.start=this.rect.getTopRightPoint(),this.heightRuler.end=this.rect.getBottomRightPoint(),this.heightRuler.render(t)}}class et extends s{constructor(){super(),this.point=new n(0,0),this.wall=null}get type(){return"wall-position-indicator"}render(t){if(this.wall){this.thick;const e=o.radianInPoint(this.wall.start,this.wall.end),s=new n(0,-this.wall.thick),i=new n(0,this.wall.thick);t.save(),t.translate(this.point.x,this.point.y),t.rotate(e),t.strokeStyle=u.activeColor,t.fillStyle=u.activeColor,t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(i.x,i.y),t.stroke(),t.arrow(s.x,s.y,8,"down"),t.arrow(i.x,i.y,8,"up"),t.restore()}}}class st extends U{constructor(t){super(),this.handler=new ot(t,{minimumLength:20})}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class ot extends ${constructor(t,e){super(),this.config=e,this.ruler=null,this.editor=t,this.wall=null,this.window=null,this.indicator=new et,this.editor.setSelectControls([this.indicator])}onMouseDown(t){let e=this.editor.floor.getControlsOnCoordinates(t.x,t.y,(t=>"wall"===t.type));if(e.length<=0)return;this.wall=e[0];const s=this.wall.createClosestPoint(t.x,t.y);this.window=new O(new n(s.x,s.y),new n(s.x,s.y)),this.ruler=new f(this.wall.start,this.wall.end),this.ruler.addPoint(this.window.start),this.ruler.addPoint(this.window.end),this.editor.setSelectControls([this.ruler])}onMouseMove(t){this.window?this.updateWindow(t.x,t.y):this.updateIndicator(t.x,t.y)}onMouseUp(t){this.window&&(this.editor.setSelectControls([]),this.window.length>this.config.minimumLength&&this.editor.floor.windows.push(this.window),this.wall=null,this.window=null,this.editor.render(),this.editor.tools.select(),this.editor.onChangeFloor())}updateWindow(t,e){const s=this.wall.createClosestPoint(t,e);this.wall.isPointOnBoundary(s)&&(this.window.end.x=s.x,this.window.end.y=s.y,this.editor.render(),this.window.render(this.editor.context))}updateIndicator(t,e){let s=this.editor.floor.getControlsOnCoordinates(t,e,(t=>"wall"===t.type));if(s.length<=0)return;const o=s[0].createClosestPoint(t,e);this.indicator.wall=s[0],this.indicator.point.x=o.x,this.indicator.point.y=o.y,this.editor.render()}}class it extends U{constructor(t){super(),this.handler=new nt(t,{minimumLength:20})}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class nt extends ${constructor(t,e){super(),this.editor=t,this.config=e,this.ruler=null,this.wall=null,this.door=null,this.indicator=new et,this.editor.setSelectControls([this.indicator])}onMouseDown(t){let e=this.editor.floor.getControlsOnCoordinates(t.x,t.y,(t=>"wall"===t.type));if(e.length<=0)return;this.wall=e[0];const s=this.wall.createClosestPoint(t.x,t.y);this.door=new R(new n(s.x,s.y),new n(s.x,s.y)),this.ruler=new f(this.wall.start,this.wall.end),this.ruler.addPoint(this.door.start),this.ruler.addPoint(this.door.end),this.editor.setSelectControls([this.ruler])}onMouseMove(t){this.door?this.updateDoor(t.x,t.y):this.updateIndicator(t.x,t.y)}onMouseUp(t){this.door&&(this.editor.setSelectControls([]),this.door.length>this.config.minimumLength&&this.editor.floor.doors.push(this.door),this.wall=null,this.door=null,this.render=null,this.editor.render(),this.editor.tools.select(),this.editor.onChangeFloor())}updateDoor(t,e){const s=this.wall.createClosestPoint(t,e);this.wall.isPointOnBoundary(s)&&(this.door.end.x=s.x,this.door.end.y=s.y,this.editor.render(),this.door.render(this.editor.context))}updateIndicator(t,e){let s=this.editor.floor.getControlsOnCoordinates(t,e,(t=>"wall"===t.type));if(s.length<=0)return;const o=s[0].createClosestPoint(t,e);this.indicator.wall=s[0],this.indicator.point.x=o.x,this.indicator.point.y=o.y,this.editor.render()}}class rt extends U{constructor(t){super(),this.handler=new at(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class at extends ${constructor(t){super(),this.editor=t,this.control=new ht(this),this.started=!0,this.start=new n(0,0),this.end=new n(0,0),this.cuttings=[]}onMouseDown(t){this.started=!0,this.start.x=t.x,this.start.y=t.y,this.end.x=t.x,this.end.y=t.y,this.editor.setSelectControls([this.control])}onMouseMove(t){this.end.x=t.x,this.end.y=t.y,this.started&&(this.createCutting(),this.editor.render())}onMouseUp(t){if(this.started){for(const t of this.cuttings)t.wall.cutting(this.editor.floor,t.point.x,t.point.y);this.started=!1,this.editor.render(),this.editor.tools.select(),this.cuttings=[]}this.editor.setSelectControls([])}createCutting(){this.cuttings=[];for(const t of this.editor.floor.walls){const e=o.interceptPoint(this.start.x,this.start.y,this.end.x,this.end.y,t.start.x,t.start.y,t.end.x,t.end.y);e&&this.cuttings.push({point:e,wall:t})}}}class ht{constructor(t){this.handler=t}render(t){t.save(),this.renderLine(t),this.renderCuttings(t),t.restore()}renderLine(t){t.lineWidth=1,t.strokeStyle=u.Colors.Red50,t.beginPath(),t.setLineDash([5,10]),t.moveTo(this.handler.start.x,this.handler.start.y),t.lineTo(this.handler.end.x,this.handler.end.y),t.closePath(),t.stroke(),t.setLineDash([])}renderCuttings(t){for(const e of this.handler.cuttings)t.fillStyle=u.Colors.Red50,t.beginPath(),t.arc(e.point.x,e.point.y,10,0,2*Math.PI),t.closePath(),t.fill()}}class lt extends U{constructor(t){super(),this.handler=new ct(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class ct extends ${constructor(t){super(),this.editor=t,this.creator=new dt,this.started=!1}onMouseDown(t){this.started=!0,this.creator.start.x=t.snapX,this.creator.start.y=t.snapY,this.editor.floor.addForegroundControl(this.creator)}onMouseMove(t){this.started&&(this.creator.end.x=t.snapX,this.creator.end.y=t.snapY,this.editor.render())}onMouseUp(t){if(this.started){const e=t.snapX,s=t.snapY;if(o.distance(this.creator.start.x,this.creator.start.y,e,s)>10){let t=new P(new n(this.creator.start.x,this.creator.start.y),new n(e,s));t=this.editor.onCreate(t),t&&this.editor.floor.walls.push(t)}this.editor.floor.removeForegroundControl(this.creator),this.editor.render(),this.editor.tools.select(),this.editor.onChangeFloor({updateRooms:!0})}this.started=!1}}class dt extends s{constructor(){super(),this.start=new n(0,0),this.end=new n(0,0),this.ruler=new f(this.start,this.end)}render(t){t.lineWidth=10,t.strokeStyle="#0097c5",t.line(this.start.x,this.start.y,this.end.x,this.end.y),this.ruler.render(t)}}class ut{static createLine(t){return(e,s,o,i)=>{t.beginPath(),t.moveTo(e,s),t.lineTo(o,i),t.closePath(),t.stroke()}}static createText(t){return(e,s,o)=>{const i=t.measureText(o).width;t.fillText(o,e-i/2,s)}}static createCircle(t){return(e,s,o)=>{t.beginPath(),t.arc(e,s,o,0,2*Math.PI),t.closePath()}}static createArrow(t){return(e,s,o,i)=>{switch(i){case"up":t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s+o),t.lineTo(e+o,s+o),t.closePath(),t.fill();break;case"right":t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.lineTo(e-o,s+o),t.closePath(),t.fill();break;case"down":t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.lineTo(e+o,s-o),t.closePath(),t.fill();break;case"left":t.beginPath(),t.moveTo(e,s),t.lineTo(e+o,s-o),t.lineTo(e+o,s+o),t.closePath(),t.fill()}}}}class ft extends s{constructor(){super(),this.start=null,this.end=null,this.thick=10}render(t){this.start&&this.end&&(t.lineWidth=this.thick,t.strokeStyle="rgba(255, 59, 48, 0.7)",t.line(this.start.x,this.start.y,this.end.x,this.end.y),t.circle(this.start.x,this.start.y,10),t.circle(this.end.x,this.end.y,10))}}class gt extends U{constructor(t){super(),this.handler=new pt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class pt extends ${constructor(t){super(),this.editor=t,this.control=null}useSnap(){return!1}onMouseDown(t){const e=this.findEraseControl(t.x,t.y);e&&(this.editor.floor.removeControl(e),this.hideControl(),this.editor.onChangeFloor({updateRooms:!0}))}onMouseMove(t){const e=this.findEraseControl(t.x,t.y);e?this.showControl(e.start,e.end):this.hideControl()}showControl(t,e){this.control||(this.control=new ft,this.editor.setSelectControls([this.control])),this.control.start===t&&this.control===e||(this.control.start=t,this.control.end=e,this.editor.render())}hideControl(){this.control&&(this.editor.setSelectControls([]),this.control=null,this.editor.render())}findEraseControl(t,e){const s=this.editor.floor.getControlsOnCoordinates(t,e);if(0===s.length)return null;if(1===s.length)return s[0];for(const t of s)if("wall"!==t.type)return t;return null}}class yt extends U{constructor(t,e){super(),this.editor=t,this.scale=e}onCommandActive(t){this.editor.scale+=this.scale,this.editor.context.setTransform(this.editor.scale,0,0,this.editor.scale,0,0),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class xt extends U{constructor(t){super(),this.editor=t}onCommandActive(t){this.editor.floor.clear(),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class wt{static importData(t,e,s){(new Ct).importData(t,e,new mt(s))}static exportData(t){}}class mt{constructor(t){this.config=t,this.defaultRoomFillColor="rgba(131,208,221,0.5)",this.create={room:!0,wall:!0,door:!0,window:!0},t.create&&(this.create.room=t.create.room??!0,this.create.wall=t.create.wall??!0,this.create.door=t.create.door??!0,this.create.window=t.create.window??!0)}getScale(){return this.config.scale??4}getRoomFillColor(t){return this.config&&this.config.room&&this.config.room.colors&&this.config.room.colors.length>t?this.config.room.colors[t]:this.defaultRoomFillColor}isCreateDoor(){return this.create.door}isCreateWindow(){return this.create.window}isCreateWall(){return this.create.wall}isCreateRoom(){return this.create.room}getWallThick(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.thick?e.thick:1}getWallColor(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.color?e.color:"#000000"}getRoomColor(t){const{themes:e}=this.config,s=e?.room.find((e=>e.category===t));return s?.color??null}getRoomLabel(t){const{themes:e}=this.config,s=e?.room.find((e=>e.category===t));return s?.label??null}}class Ct{constructor(){this.scale=4}importData(t,e,s){this.scale=s.getScale();for(const o of e)"STR"===o.type&&this.importSTR(t,o.categories,s);s.create.room&&t.createRooms(null);for(const o of e)"SPA"===o.type&&this.importSPA(t,o.categories,s)}importSTR(t,e,s){for(const o of e)0!==o.category&&1!==o.category&&2!==o.category&&3!==o.category||this.importObjectFromSTR(t,o.category,o.objects,s)}importObjectFromSTR(t,e,s,i){for(const r of s){if("line"===r.type){const s=r.data[0][0],a=r.data[0][1],h=r.data[1][0],l=r.data[1][1],c=new n(s*this.scale,a*this.scale),d=new n(h*this.scale,l*this.scale),u=o.distance(c.x,c.y,d.x,d.y);if(0!==e&&1!==e||!i.isCreateWall()){if(3===e&&i.isCreateDoor()){const e=new R(c,d);e.hidge=r.hinge??"start",e.direction=r.direction??"right",t.doors.push(e)}else if(2===e&&i.isCreateWindow()){const e=new O(c,d);t.windows.push(e)}}else if(u>0){const s=new P(c,d);s.thick=i.getWallThick(e),s.color=i.getWallColor(e),t.walls.push(s)}}r.type}}importSPA(t,e,s){for(const o of e)11!==o.category&&this.importObjectFromSPA(t,o.category,o.objects,s)}importObjectFromSPA(t,e,s,o){for(const i of s)if("Polygon"===i.type&&o.isCreateRoom()){const s=new a([]);for(const t of i.data)s.points.push(new n(t[0]*this.scale,t[1]*this.scale));const r=t.getRoomIncludePoint(s.getCenterPoint());r&&(r.label=o.getRoomLabel(e),r.fillColor=o.getRoomColor(e))}}}class vt extends U{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.history.index;e>0&&e-1>0&&(t.floor.load(JSON.parse(t.history.data[e-1])),t.history.index--,t.render()),this.editor.tools.select()}onCommandDeActive(t){}}class Pt extends U{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.history.index;e<t.history.data.length&&(t.floor.load(JSON.parse(t.history.data[e])),t.history.index++,t.render()),this.editor.tools.select()}onCommandDeActive(t){}}class bt extends U{constructor(t){super(),this.handler=new At(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class At extends ${constructor(t){super(),this.editor=t,this.started=!1}onMouseDown(t){}onMouseMove(t){}onMouseUp(t){}}class Et extends U{constructor(t){super()}onCommandActive(t){t.floor.rooms=[],t.render(),t.tools.select()}onCommandDeActive(t){}}class Dt extends U{constructor(t){super()}onCommandActive(t){const e=new W;t.floor.buildGraph(e),t.floor.createRooms(t),t.addSelectControls([new Tt(e)]),t.render(),t.tools.select()}onCommandDeActive(t){}}class Tt extends s{constructor(t){super(),this.graph=t}get type(){return"point-select"}render(t){t.save();for(const e of this.graph.vertices)this.renderVertex(t,e);t.restore()}renderVertex(t,e){t.fillStyle=u.activeColor,t.circle(e.x,e.y,10),t.fill(),t.font="12px bold Arial",t.fillStyle="black",t.text(e.x,e.y,`${e.edges.length}`),this.closestVertex&&(t.fillStyle="blue",t.circle(this.closestVertex.x,this.closestVertex.y,10),t.fill())}}class Mt{static applyOpacityToColor(t,e){return function(t,e){return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${e})`}(function(t){let e=parseInt(t.replace("#",""),16);return[e>>16&255,e>>8&255,255&e]}(t),e)}static isRGBorRGBA(t){return/^(rgb|rgba)/.test(t)}static toHexColor(t){if(!t)return t;let e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(\.\d+)?))?\)/);if(!e)return null;let s="";void 0!==e[4]&&(s=Math.round(255*parseFloat(e[4])).toString(16),1===s.length&&(s="0"+s));let o="#";for(let t=1;t<=3;t++){let s=parseInt(e[t],10).toString(16);1===s.length&&(s="0"+s),o+=s}return""!==s&&(o+=s),o}static reverseTransparent(t){if(!t)return t;let e=1;9===t.length&&(e=parseInt(t.slice(7,9),16)/255),e=1===e?.5:1;let s=Math.round(255*e).toString(16);return 1===s.length&&(s="0"+s),t.slice(0,7)+s}}class Ft{constructor(t,e,s){this.editor=t,this.control=null,this.document=e,this.creteColorToolbar(s),this.createLineToolbar(s),this.createWallToolbar(s),this.createDoorToolbar(s),this.createWindowToolbar(s),this.createRoomToolbar(s)}creteColorToolbar(t){this.toolbarColor=this.createToolbar(this.document);(t?.color??["#716a6c80","#d83d1b80","#ec912680","#1c8a4f80","#0082d180"]).forEach((t=>{this.addButtonToToolbar(this.toolbarColor,this.createColorButton(this.document,`${t}`,(()=>{this.changeColor(t),this.hideColorToolbar(),this.editor.render(),this.hide()})))})),this.document.body.appendChild(this.toolbarColor)}createLineToolbar(t){this.toolbarLine=this.createToolbar(this.document);(t?.thick??[1,5,10]).forEach((t=>{this.addButtonToToolbar(this.toolbarLine,this.createThickButton(this.document,t,(()=>{this.changeLine(t),this.hideLineToolbar(),this.editor.render(),this.hide()})))})),this.document.body.appendChild(this.toolbarLine)}createWallToolbar(t){this.toolbarWall=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarWall,this.createRemoveButton(this.document,(()=>{this.editor.floor.removeControl(this.getControl()),this.editor.render(),this.hide()}))),this.addButtonToToolbar(this.toolbarWall,this.createLineChoiceButton(this.document,(()=>{this.showLineToolbar(this.toolbarWall)}))),this.document.body.appendChild(this.toolbarWall)}createDoorToolbar(t){this.toolbarDoor=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarDoor,this.createRemoveButton(this.document,(()=>{this.editor.floor.removeControl(this.getControl()),this.editor.render(),this.hide()}))),this.document.body.appendChild(this.toolbarDoor)}createWindowToolbar(t){this.toolbarWindow=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarWindow,this.createRemoveButton(this.document,(()=>{this.editor.floor.removeControl(this.getControl()),this.editor.render(),this.hide()}))),this.document.body.appendChild(this.toolbarWindow)}increase(t,e){return t=parseFloat(t),isNaN(t)?t:t+e}createRoomToolbar(t){this.toolbarRoom=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarRoom,this.createRemoveButton(this.document,(()=>{this.editor.floor.removeControl(this.getControl()),this.editor.render(),this.hide()}))),this.addButtonToToolbar(this.toolbarRoom,this.createLineChoiceButton(this.document,(()=>{this.showLineToolbar(this.toolbarRoom)}))),this.addButtonToToolbar(this.toolbarRoom,this.createColorChoiceButton(this.document,(()=>{this.showColorToolbar(this.toolbarRoom)}))),this.addButtonToToolbar(this.toolbarRoom,this.createTransparentButton(this.document,(()=>{this.changeTransparent(),this.editor.render()}))),this.addButtonToToolbar(this.toolbarRoom,this.createRoomAreaText(this.document,"2000 ㎡","room-area")),this.document.body.appendChild(this.toolbarRoom)}hide(){this.getAllToolbar().forEach((t=>{t.style.display="none"}))}show(t,e,s){this.control=s,this.x=t,this.y=e;let o=null;if("wall"===s.type)o=this.toolbarWall;else if("door"===s.type)o=this.toolbarDoor;else if("window"===s.type)o=this.toolbarWindow;else if("room"===s.type){o=this.toolbarRoom;const t=o.querySelectorAll("p");if(t&&t.length>0){const e=this.control.polygon.calculateArea(),s=4e-4;t[0].textContent=`${Math.floor(e*s)} ㎡`}}if(o){o.style.display="flex";const s=o.offsetWidth/2,i=o.offsetHeight/2;o.style.left=t-s+"px",o.style.top=e-(i+50)+"px"}this.getAllToolbar().filter((t=>t!==o)).forEach((t=>{t.style.display="none"}))}showColorToolbar(t){this.hideLineToolbar();const{style:e}=this.toolbarColor;e.display="flex",e.left=t.style.left,e.top=`${this.increase(t.style.top,-60)}px`}hideColorToolbar(){this.toolbarColor.style.display="none"}showLineToolbar(t){this.hideColorToolbar();const{style:e}=this.toolbarLine;e.display="flex",e.left=t.style.left,e.top=`${this.increase(t.style.top,-60)}px`}hideLineToolbar(){this.toolbarLine.style.display="none"}addButtonToToolbar(t,e,s){e&&(s&&(t.id=s),t.appendChild(e))}getControl(){return this.control}createToolbar(t){const e=t.createElement("div");return Object.assign(e.style,{display:"flex",position:"absolute","flex-direction":"row",background:"#1f1f1f",boxShadow:"5px 5px 10px rgba(0, 0, 0, 0.5)",borderRadius:"10px",textAlign:"center",cursor:"pointer",overflow:"hidden","align-items":"center"}),e}createRemoveButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const i=t.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("xmlns","http://www.w3.org/2000/svg"),i.setAttribute("viewBox","0 0 448 512");const n=t.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("fill","#ffffff"),n.setAttribute("d","M135.2 17.7C140.6 6.8 151.7 0 163.8 0H284.2c12.1 0 23.2 6.8 28.6 17.7L320 32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 96 0 81.7 0 64S14.3 32 32 32h96l7.2-14.3zM32 128H416V448c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V128zm96 64c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16z"),i.appendChild(n),o.appendChild(i),s.appendChild(o),s}createSplitButton(t,e){const s=t.createElement("div");s.onclick=e,Object.assign(s.style,{display:"block",background:"#e74c3b",width:"25px",height:"25px",borderRadius:"50%",cursor:"pointer",padding:"5px",margin:"5px",overflow:"hidden"});const o=t.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("fill","none"),o.setAttribute("height","100%"),o.setAttribute("viewBox","0 0 24 24"),o.setAttribute("width","100%");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d","M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"),i.setAttribute("d","M12.5 2.75C12.5 2.33579 12.1642 2 11.75 2C11.3358 2 11 2.33579 11 2.75L11 21.25C11 21.6642 11.3358 22 11.75 22C12.1642 22 12.5 21.6642 12.5 21.25L12.5 2.75ZM2 6.25C2 5.00736 3.00736 4 4.25 4H10V20H4.25C3.00736 20 2 18.9926 2 17.75V6.25ZM19.25 20H13.5V4H19.25C20.4926 4 21.5 5.00736 21.5 6.25V17.75C21.5 18.9926 20.4926 20 19.25 20Z"),i.setAttribute("fill","none"),i.setAttribute("stroke","white"),o.appendChild(i),s.appendChild(o),s}createRoomAreaText(t,e){const s=t.createElement("p");return Object.assign(s.style,{display:"block",color:"#fff",padding:"5px",margin:"5px"}),s.contentText=e,s}createColorChoiceButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");return Object.assign(o.style,{display:"block",background:"radial-gradient(50% 50% at 50% 50%,#ffffff 0%,transparent 100%),conic-gradient(from 0deg at 50% 50%,#ff0000 0deg,#ffa800 47.73deg,#ffff00 79.56deg,#00ff00 121.33deg,#00ffff 180.99deg,#0000ff 238.67deg,#ff00ff 294.36deg,#ff0000 360deg),#c4c4c4",width:"25px",height:"25px",borderRadius:"50%"}),s.appendChild(o),s}createButtonContainer(t,e){const s=t.createElement("div");return s.addEventListener("mouseenter",(function(){s.style.backgroundColor="#ffffff80"})),s.addEventListener("mouseleave",(function(){s.style.backgroundColor=null})),s.onclick=e,Object.assign(s.style,{display:"flex",flexDirection:"row","align-items":"center",width:"25px",height:"25px",borderRadius:"50px",cursor:"pointer",padding:"5px",margin:"5px",overflow:"hidden"}),s}createLineChoiceButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const i=t.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("viewBox","0 0 12 12");const n=t.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("fill","#ffffff"),n.setAttribute("fill-opacity","1"),n.setAttribute("fill-rule","nonzero"),n.setAttribute("stroke","none"),n.setAttribute("d","M0 0h12v1H0V0zm0 4h12v2H0V4zm12 5H0v3h12V9z"),i.appendChild(n),o.appendChild(i),s.appendChild(o),s}createColorButton(t,e,s){const o=this.createButtonContainer(t,s),i=t.createElement("div");return Object.assign(i.style,{display:"block",background:`${e}`,width:"25px",height:"25px",borderRadius:"50%"}),o.appendChild(i),o}createTransparentButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",borderRadius:"50%"});const i=t.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("class","svg"),i.setAttribute("xmlns","http://www.w3.org/2000/svg"),i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("viewBox","1.5 1.5 14 14");const n=t.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("fill","#fff"),n.setAttribute("fill-opacity","1"),n.setAttribute("fill-rule","nonzero"),n.setAttribute("stroke","none"),n.setAttribute("d","M13.35 13.45c-.65.65-1.422 1.166-2.272 1.517-.85.352-1.76.533-2.679.533-.919 0-1.83-.18-2.678-.533-.85-.351-1.621-.867-2.271-1.517-.65-.65-1.166-1.422-1.518-2.271-.352-.85-.533-1.76-.533-2.679 0-.92.181-1.83.533-2.679.352-.849.868-1.62 1.518-2.27L8.4 8.5l4.95 4.949zm-9.9-9.9c.65-.65 1.42-1.166 2.27-1.517C6.57 1.68 7.48 1.5 8.4 1.5c.919 0 1.829.18 2.678.533.85.351 1.621.867 2.271 1.517.65.65 1.166 1.422 1.518 2.271.351.85.532 1.76.532 2.679 0 .92-.18 1.83-.532 2.679-.352.849-.868 1.62-1.518 2.27l-.71-.709c.558-.556 1-1.218 1.3-1.945.302-.728.457-1.508.457-2.295 0-.788-.155-1.567-.456-2.295-.301-.728-.743-1.389-1.3-1.946-.557-.556-1.218-.998-1.946-1.3-.727-.3-1.507-.456-2.295-.456-.787 0-1.567.155-2.294.456-.728.302-1.39.744-1.946 1.3l-.71-.709z"),i.appendChild(n),o.appendChild(i),s.appendChild(o),s}createThickButton(t,e,s){const o=this.createButtonContainer(t,s),i=t.createElement("div");return i.onclick=s,Object.assign(i.style,{display:"block",background:"white",width:"30px",height:`${e}px`,cursor:"pointer",overflow:"hidden"}),o.appendChild(i),o}getAllToolbar(){return[this.toolbarWall,this.toolbarDoor,this.toolbarWindow,this.toolbarRoom,this.toolbarColor,this.toolbarLine]}changeLine(t){if(this.control)if("wall"===this.control.type)this.control.thick=t;else if("room"===this.control.type){const{points:e}=this.control.polygon;for(let s=0;s<e.length;s++){const o=e[s],i=e[(s+1)%e.length],n=this.editor.floor.getWallByPoint(o,i);n&&(n.thick=t)}}}changeColor(t){this.control&&"room"===this.control.type&&(this.control.fillColor=t)}changeTransparent(){if(this.control&&"room"===this.control.type){let t=this.control.fillColor;Mt.isRGBorRGBA(t)&&(t=Mt.toHexColor(t)),t=Mt.reverseTransparent(t),this.control.fillColor=t}}}class St{constructor(){this.canvas=null,this.context=null,this.tools=new Bt(this),this.floor=new L,this.backgroudFloor=new L,this.renders=[],this.scale=1,this.toolbar=null,this.activeCommand=null,this.onSelectListener=null,this.eventController=new N,this.config=null,this.selects=[],this.history={index:-1,data:[]}}edit(t,e){if(this.config=e,window&&document){const s=document.querySelector(t);s&&(s.tabIndex=1,s.style.outline="none",this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.canvas.tabindex=2,this.canvas.style.outline="none",this.context=this.canvas.getContext("2d"),this.initializeCanvas(s,window),s.appendChild(this.canvas),this.renders.push(new Y(e.grid,this.canvas)),this.renders.push(new G(this.backgroudFloor,.1,!1)),this.renders.push(new G(this.floor,1,!1)),this.renders.push(new z(this.floor)),this.render(),this.canvas.focus()),this.toolbar=new Ft(this,document,e.toolbar),this.toolbar.hide()}}clear(){this.floor.clear(),this.backgroudFloor.clear(),this.selects=[]}load(t,e){this.clear(),wt.importData(this.floor,t,e),e.create=e.create??{room:!1,wall:!0,door:!1,window:!1},wt.importData(this.backgroudFloor,t,e);const s=this.floor.getBoundRect();this.resetTranslate(),this.translate(100-s.minX,100-s.minY),this.render()}export(){}initializeCanvas(t,e){if(e&&this.canvas&&this.context){this.context.line=ut.createLine(this.context),this.context.arrow=ut.createArrow(this.context),this.context.text=ut.createText(this.context),this.context.circle=ut.createCircle(this.context);const s=e.devicePixelRatio||1,o=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,i=s/o;if(this.scale=i,s!==o){const t=this.canvas.width,e=this.canvas.height;this.canvas.width=t*i,this.canvas.height=e*i,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.context.scale(i,i)}this.context.lineJoin="round",this.context.lineCap="square",this.context.imageSmoothingEnabled=!0,this.canvas.addEventListener("mousedown",(t=>{if(this.eventController){const e=new j;e.clientX=t.clientX,e.clientY=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,this.initEvent(e),this.eventController.onMouseDown(e)}})),this.canvas.addEventListener("mousemove",(t=>{if(this.eventController){const e=new j;e.clientX=t.clientX,e.clientY=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,this.initEvent(e),this.eventController.onMouseMove(e)}})),this.canvas.addEventListener("mouseup",(t=>{if(this.eventController){const e=new j;e.clientX=t.clientX,e.clientY=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,this.initEvent(e),this.eventController.onMouseUp(e)}})),this.canvas.addEventListener("click",(t=>{this.eventController&&this.eventController.onClick(t.button)})),t.addEventListener("keydown",(t=>{this.eventController&&this.eventController.onKeyDown(t.key,t.code)})),this.eventController.context=this.context}}translate(t,e){this.context.translate(t,e)}resetTranslate(){this.context.setTransform(1,0,0,1,0,0),this.context.scale(this.scale,this.scale)}initEvent(t){const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,o=this.canvas.height/e.height;t.x=(t.clientX-e.left)*s/this.scale,t.y=(t.clientY-e.top)*o/this.scale}addEventHandler(t){this.eventController.addHandler(t)}removeEventHandler(t){this.eventController.removeHandler(t)}selectControl(t,e,s){this.onSelectListener&&this.onSelectListener(t,e,s)}addSelectControl(t){t&&this.selects.push(t)}setSelectControls(t){t&&(this.selects=t)}addSelectControls(t){t&&this.selects.push(...t)}removeAllSelectControl(){this.selects=[]}render(){this.renderBackground();for(const t of this.renders)t.render(this.context);for(const t of this.selects)t.render(this.context)}renderBackground(){let t="#ffffff";this.config&&(t=this.config.background?this.config.background:"#ffffff"),this.context.save(),this.context.setTransform(1,0,0,1,0,0),this.context.fillStyle=t,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.restore()}onChangeFloor(t){t&&t.updateRooms&&this.floor.createRooms(this),this.history.data.push(JSON.stringify(this.floor)),this.history.index++}onCreate(t){if(!this.config)return t;if("wall"===t.type){if(this.config.oncreatewall)return this.config.oncreatewall(this.floor,t)}else if("door"===t.type){if(this.config.oncreatedoor)return this.config.oncreatedoor(this.floor,t)}else if("window"===t.type){if(this.config.oncreatewindow)return this.config.oncreatewindow(this.floor,t)}else if("room"===t.type&&this.config.oncreateroom)return this.config.oncreateroom(this.floor,t);return t}onSelect(t,e){e?this.toolbar.show(t.pageX,t.pageY,e):this.toolbar.hide(),this.config&&this.config.onselect&&this.config.onselect(this.floor,t.pageX,t.pageY,e)}}class Bt{constructor(t){this.editor=t}undo(){this.deActiveCommand(),this.editor.activeCommand=new vt(this.editor),this.activeCommand()}redo(){this.deActiveCommand(),this.editor.activeCommand=new Pt(this.editor),this.activeCommand()}select(){this.deActiveCommand(),this.editor.activeCommand=new K(this.editor),this.activeCommand()}createRoom(){this.deActiveCommand(),this.editor.activeCommand=new bt(this.editor),this.activeCommand()}createRooms(){this.deActiveCommand(),this.editor.activeCommand=new Dt(this.editor),this.activeCommand()}deleteRooms(){this.deActiveCommand(),this.editor.activeCommand=new Et(this.editor),this.activeCommand()}createWall(){this.deActiveCommand(),this.editor.activeCommand=new lt(this.editor),this.activeCommand()}createRectWall(t){this.deActiveCommand(),this.editor.activeCommand=new _(this.editor,t),this.activeCommand()}createDoor(){this.deActiveCommand(),this.editor.activeCommand=new it(this.editor),this.activeCommand()}createWindow(){this.deActiveCommand(),this.editor.activeCommand=new st(this.editor),this.activeCommand()}splitWall(){this.deActiveCommand(),this.editor.activeCommand=new rt(this.editor),this.activeCommand()}eraseObject(){this.deActiveCommand(),this.editor.activeCommand=new gt(this.editor),this.activeCommand()}zoomIn(){this.deActiveCommand(),this.editor.activeCommand=new yt(this.editor,.1),this.activeCommand()}zoomOut(){this.deActiveCommand(),this.editor.activeCommand=new yt(this.editor,-.1),this.activeCommand()}clear(){this.deActiveCommand(),this.editor.activeCommand=new xt(this.editor),this.activeCommand()}deActiveCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandDeActive(this.editor),this.editor.activeCommand=null}activeCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandActive(this.editor)}}PlaceIn=e})();
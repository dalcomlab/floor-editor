var PlaceIn;(()=>{"use strict";var t={d:(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Editor:()=>oe,EditorTools:()=>ne});class s{constructor(){}get type(){return""}translate(t,e,s){}duplicate(){return null}render(t){this.renderControl(t)}onMove(t,e){}renderControl(t){}getBoundRect(){const t=this.getPoints();return{minX:Math.min(...t.map((t=>t.x))),minY:Math.min(...t.map((t=>t.y))),maxX:Math.max(...t.map((t=>t.x))),maxY:Math.max(...t.map((t=>t.y)))}}getControlPointAtPoint(t){return this.getControlPoints().find((e=>e.distanceTo(t)<10))}getControlPointsAtPoint(t){return this.getControlPoints().filter((e=>e.distanceTo(t)<10))}getControlSegmentAtPoint(t){return this.getControlSegments().find((e=>e.isPointInSegment(t)))}getControlPolygonAtPoint(t){return this.getControlPolygons().find((e=>e.isPointInside(t)))}getControlPoints(){return this.getPoints()}getControlSegments(){return[]}getControlPolygons(){return[]}getPoints(){return[]}createPointDragHandler(t,e,s){return null}createMoveDragHandler(t,e,s){return null}createExtendDragHandler(t,e,s){return null}createPointSelectionControl(){return null}createMoveSelectionControl(){return null}isPointInControl(t,e,s=0){return!1}}class o{static radiansToDegrees(t){return t*(180/Math.PI)}static degreesToRadians(t){return t*(Math.PI/180)}static angle(t,e,s,o){const n=this.radian(t,e,s,o);return this.radiansToDegrees(n)}static radian(t,e,s,o){return Math.atan2(o-e,s-t)}static radianInPoint(t,e){return this.radian(t.x,t.y,e.x,e.y)}static calculate3PointRadian(t,e,s,o,n,i){const r=this.radian(t,e,s,o);let h=this.radian(t,e,n,i)-r;return h<0&&(h+=2*Math.PI),h}static calculate3PointRadianInPoint(t,e,s){return this.calculate3PointRadian(t.x,t.y,e.x,e.y,s.x,s.y)}static calculate3PointDegrees(t,e,s,o,n,i){return this.radiansToDegrees(this.calculate3PointRadian(t,e,s,o,n,i))}static calculate3PointAngle(...t){let e,s,o,n,i,r;if(6===t.length)[e,s,o,n,i,r]=t;else{if(3!==t.length)throw new Error("올바른 인자를 제공하세요.");{const[h,a,l]=t;e=h.x,s=h.y,o=a.x,n=a.y,i=l.x,r=l.y}}const h=Math.atan2(n-s,o-e);let a=Math.atan2(r-s,i-e)-h;return a<0&&(a+=2*Math.PI),this.radiansToDegrees(a)}static distance(t,e,s,o){const n=s-t,i=o-e;return Math.sqrt(n**2+i**2)}static distanceInPoint(t,e){const s=e.x-t.x,o=e.y-t.y;return Math.sqrt(s**2+o**2)}static isBetween(t,e,s,o=!1){return o&&(t=Math.round(t),e=Math.round(e),s=Math.round(s)),t>=e&&t<=s||t>=s&&t<=e}static distancePoint(t,e,s){const o=Math.atan2(e.y-t.y,e.x-t.x),i=new n(0,0);return i.x=t.x-s*Math.cos(o),i.y=t.y-s*Math.sin(o),i}static rotate(t,e,s,o,n){const i=t-s,r=e-o;return[i*Math.cos(n)-r*Math.sin(n)+s,i*Math.sin(n)+r*Math.cos(n)+o]}static rotatePoint(t,e,s,o){const i=t.x-e,r=t.y-s,h=i*Math.cos(o)-r*Math.sin(o),a=i*Math.sin(o)+r*Math.cos(o);return new n(h+e,a+s)}static interceptPoint(t,e,s,o,i,r,h,a){const l=(t-s)*(r-a)-(e-o)*(i-h);if(0===l)return null;const c=((t-i)*(r-a)-(e-r)*(i-h))/l;if(c>0&&c<1&&-((t-s)*(e-r)-(e-o)*(t-i))/l>0){const l=new n(0,0);return l.x=Math.round(t+c*(s-t)),l.y=Math.round(e+c*(o-e)),this.isPointInBox(l.x,l.y,t,e,s,o)&&this.isPointInBox(l.x,l.y,i,r,h,a)?l:null}return null}static isPointInBox(t,e,s,o,n,i){let r=Math.min(s,n),h=Math.max(s,n),a=Math.min(o,i),l=Math.max(o,i);return r===h&&(r-=1,h+=1),a===l&&(a-=1,l+=1),t>=r&&t<=h&&e>=a&&e<=l}}class n{constructor(t,e){this.x=t??0,this.y=e??0}copy(){return new n(this.x,this.y)}copyFrom(t){t&&(this.x=t.x,this.y=t.y)}distance(t,e){return o.distance(this.x,this.y,t,e)}distanceTo(t){return o.distance(this.x,this.y,t.x,t.y)}radianTo(t){return o.radian(this.x,this.y,t.x,t.y)}static rotate(t,e,s,i){const r=[];for(const h of t){const t=o.rotate(h.x,h.y,e,s,i);r.push(new n(t[0],t[1]))}return r}}class i{constructor(){this.points=[]}addPoint(t){if(t){this.points.some((e=>e.x===t.x&&e.y===t.y))||this.points.push(t)}}}class r{constructor(){this.x=0,this.y=0}static createVector(t,e,s,o){const n=new r;return n.x=s-t,n.y=o-e,n}getLength(){return Math.sqrt(this.x**2+this.y**2)}static createVectorOfPoints(t,e){return this.createVector(t.x,t.y,e.x,e.y)}dotProduct(t){return this.x*t.x+this.y*t.y}static dotProductXY(t,e,s,o,n,i){const r=s-t,h=o-e,a=n-t,l=i-e,c=Math.sqrt(r*r+h*h);return r/c*a+h/c*l}static calculateAngle(t,e,s,o,n,i){const r=s-t,h=o-e,a=n-t,l=i-e,c=r*a+h*l,d=Math.sqrt(r*r+h*h)*Math.sqrt(a*a+l*l);if(0!==d){return Math.acos(c/d)}return null}static calculateAngle2(t,e,s,o,n,i){const r=s-t,h=o-e,a=n-t,l=i-e,c=Math.sqrt(r*r+h*h),d=Math.sqrt(a*a+l*l),u=r*a+h*l;let g=Math.acos(u/(c*d));return u<0&&(g=-g),g}static calculateAngle3(t,e,s,n,i,r){return o.radian(t,e,s,n)-o.radian(t,e,i,r)}}class h{constructor(){this.x=0,this.y=0,this.width=0,this.height=0}static create(t,e,s,o){const n=new h;return n.x=t,n.y=e,n.width=s,n.height=o,n}points(){return[new n(this.x,this.y),new n(this.x+this.width,this.y),new n(this.x+this.width,this.y+this.height),new n(this.x,this.y+this.height)]}getTopLeftPoint(){const t=Math.min(this.x,this.x+this.width),e=Math.min(this.y,this.y+this.height);return new n(t,e)}getTopRightPoint(){const t=Math.max(this.x,this.x+this.width),e=Math.min(this.y,this.y+this.height);return new n(t,e)}getBottomLeftPoint(){const t=Math.min(this.x,this.x+this.width),e=Math.max(this.y,this.y+this.height);return new n(t,e)}getBottomRightPoint(){const t=Math.max(this.x,this.x+this.width),e=Math.max(this.y,this.y+this.height);return new n(t,e)}segments(){const t=[];return t.push({x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y}),t.push({x1:this.x+this.width,y1:this.y,x2:this.x+this.width,y2:this.y+this.height}),t.push({x1:this.x+this.width,y1:this.y+this.height,x2:this.x,y2:this.y+this.height}),t.push({x1:this.x,y1:this.y+this.height,x2:this.x,y2:this.y}),t}isPointInRect(t){return t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height}translate(t,e){this.x+=t,this.y+=e}}class a{constructor(t,e){this.A=t,this.B=e}static createEquationFrom4Point(t,e,s,o){return s-t==0?new a("v",t):o-e==0?new a("h",e):new a((o-e)/(s-t),o-s*((o-e)/(s-t)))}static create(t,e,s,o){return s-t==0?new a("v",t):o-e==0?new a("h",e):new a((o-e)/(s-t),o-s*((o-e)/(s-t)))}closestPoint(t,e){if("v"===this.A)return{x:this.B,y:e};if("h"===this.A)return{x:t,y:this.B};const s=(this.A*e+t-this.A*this.B)/(this.A*this.A+1);return{x:s,y:this.A*s+this.B}}getPointAtDistance(t,e,s,o){const i=this.closestPoint(s.x,s.y),r=Math.atan2(e.y-t.y,e.x-t.x);return new n(i.x+o*Math.cos(r),i.y+o*Math.sin(r))}distance(t,e){const s=this.closestPoint(t,e);return Math.sqrt((t-s.x)**2+(e-s.y)**2)}createPerpendicularEquation(t,e){return"string"!=typeof this.A?new a(-1/this.A,e- -1/this.A*t):"h"===this.A?new a("v",t):"v"===this.A?new a("h",e):void 0}createMoveEquation(t,e){return"v"===this.A?new a("v",t):"h"===this.A?new a("h",e):new a(this.A,e-t*this.A)}intersection(t){let e=null;if(this.A===t.A&&(e=null),"v"===this.A&&"h"===t.A&&(e=new n(this.B,t.B)),"h"===this.A&&"v"===t.A&&(e=new n(t.B,this.B)),"h"===this.A&&"v"!==t.A&&"h"!==t.A&&(e=new n((this.B-t.B)/t.A,this.B)),"v"===this.A&&"v"!==t.A&&"h"!==t.A&&(e=new n(this.B,t.A*this.B+t.B)),"h"===t.A&&"v"!==this.A&&"h"!==this.A&&(e=new n((t.B-this.B)/this.A,t.B)),"v"===t.A&&"v"!==this.A&&"h"!==this.A&&(e=new n(t.B,this.A*t.B+this.B)),"h"!==this.A&&"v"!==this.A&&"v"!==t.A&&"h"!==t.A){const s=(t.B-this.B)/(this.A-t.A),o=this.A*s+this.B;e=new n(s,o)}return e}}class l{constructor(t,e,s,o){this.start=t??new n,this.end=e??new n,this.thick=s??1,this.color=o??"#000000"}duplicate(){return new l(this.start.copy(),this.end.copy(),this.thick,this.color)}createEquation(){return a.create(this.start.x,this.start.y,this.end.x,this.end.y)}getPoints(){return[this.start,this.end]}get length(){return Math.sqrt(Math.pow(this.end.x-this.start.x,2)+Math.pow(this.end.y-this.start.y,2))}getClosestPoint(t,e){return this.createEquation().closestPoint(t,e)}isPointInSegment(t,e=1){const s=this.start.distanceTo(t),o=this.end.distanceTo(t);return s+o>=this.length-e&&s+o<=this.length+e}getPointAtDistance(t,e){const s=this.createEquation().closestPoint(t.x,t.y),o=Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x);return{x:s.x+e*Math.cos(o),y:s.y+e*Math.sin(o)}}getIntersectionPoint(t){const e=(t.end.y-t.start.y)*(this.end.x-this.start.x)-(t.end.x-t.start.x)*(this.end.y-this.start.y);if(0===e)return null;const s=((t.end.x-t.start.x)*(this.start.y-t.start.y)-(t.end.y-t.start.y)*(this.start.x-t.start.x))/e,o=((this.end.x-this.start.x)*(this.start.y-t.start.y)-(this.end.y-this.start.y)*(this.start.x-t.start.x))/e;if(s>=0&&s<=1&&o>=0&&o<=1){const t=this.start.x+s*(this.end.x-this.start.x),e=this.start.y+s*(this.end.y-this.start.y);return new n(t,e)}return null}}class c{constructor(t){this.points=t}get count(){return this.points.length}duplicate(){return this.points.map((t=>t.copy()))}getBoundRect(){const t={minX:0,minY:0,maxX:0,maxY:0};if(0===this.points.length)return t;let e=this.points[0].x,s=this.points[0].y,o=this.points[0].x,n=this.points[0].y;for(let t=1;t<this.points.length;t++){const i=this.points[t];i.x<e&&(e=i.x),i.x>o&&(o=i.x),i.y<s&&(s=i.y),i.y>n&&(n=i.y)}return t.minX=e,t.maxX=o,t.minY=s,t.maxY=n,t}getCenterPoint(){let t=0,e=0;for(const s of this.points)t+=s.x,e+=s.y;const s=new n(t/this.points.length,e/this.points.length);if(!this.isPointInsideInclusive(s)){let t=this.points[0],e=o.distance(s.x,s.y,t.x,t.y);for(let n=1;n<this.points.length;n++){const i=o.distance(s.x,s.y,this.points[n].x,this.points[n].y);i<e&&(t=this.points[n],e=i)}return t.copy()}return s}getVisualCenterPoint(){const t=this.getBoundRect(),e=[],s=t.maxX-t.minX,o=t.maxY-t.minY,i=Math.floor(s/10),r=Math.floor(o/10);for(let s=0;s<10;s++)for(let s=0;s<10;s++){const o=t.minX+s*i,h=t.minY+s*r,a=new n(o,h);this.isPointInside(a)&&e.push(a)}let h=null,l=0;for(const t of e){let e=1/0;for(let s=0;s<this.points.length-1;s++){const o=a.create(this.points[s].x,this.points[s].y,this.points[s+1].x,this.points[s+1].y).distance(t.x,t.y);o<e&&(e=o)}l<e&&(h=t,l=e)}return h}add(t,e){this.points.push(new n(t,e))}addPoint(t){this.existPoint(t)||this.points.push(t)}existPoint(t){return this.points.some((e=>{return s=e,o=t,Math.floor(s.x)===Math.floor(o.x)&&Math.floor(s.y)===Math.floor(o.y);var s,o}))}first(){return this.count>1?this.points[0]:null}last(){return this.count>1?this.points[this.count-1]:null}rotate(t,e,s){for(const n of this.points){const i=o.rotate(n.x,n.y,t,e,s);n.x=i[0],n.y=i[1]}}subtract(t){const e=[];for(let s=0;s<this.points.length;s++){const o=this.points[s],n=this.points[(s+1)%this.points.length],i=new l(o,n);0===s&&e.push({point:o,outside:!0});let r=t.getIntersectionPointsOfSegment(i);r.map((t=>(t.distance=t.distanceTo(o),t))),r=r.sort(((t,e)=>t.distance-e.distance)),e.push(...r.map((t=>({point:t,outside:!1})))),e.push({point:n,outside:!0})}this.points=e.map((t=>t.point))}contains(){let t,e;if(1===arguments.length&&"object"==typeof arguments[0]&&"x"in arguments[0]&&"y"in arguments[0])t=arguments[0].x,e=arguments[0].y;else{if(2!==arguments.length)throw new Error("Invalid arguments. Either provide (x, y) or a single Point object.");t=arguments[0],e=arguments[1]}let s=!1;for(let o=0,n=this.points.length-1;o<this.points.length;n=o++){if(this.points[o].x===t&&this.points[o].y===e)return!0;const i=this.points[o].x,r=this.points[o].y,h=this.points[n].x,a=this.points[n].y;r>e!=a>e&&t<(h-i)*(e-r)/(a-r)+i&&(s=!s)}return s}isPointInside(t,e=!1){let s=!1;const{x:o,y:n}=t;for(let t=0,e=this.points.length-1;t<this.points.length;e=t++){if(this.points[t].x===o&&this.points[t].y===n)return!1;const i=this.points[t].x,r=this.points[t].y,h=this.points[e].x,a=this.points[e].y;r>n!=a>n&&o<(h-i)*(n-r)/(a-r)+i&&(s=!s)}return s}isPointInsideInclusive(t){let e=!1;const{x:s,y:o}=t;for(let t=0,n=this.points.length-1;t<this.points.length;n=t++){if(this.points[t].x===s&&this.points[t].y===o)return!0;const i=this.points[t].x,r=this.points[t].y,h=this.points[n].x,a=this.points[n].y;r>o!=a>o&&s<(h-i)*(o-r)/(a-r)+i&&(e=!e)}return e}isPointsInside(t){const e=this.createSegments();for(const s of t){if(!(this.isPointInsideSegments(e,s)||this.isPointInside(s)))return!1}return!0}isPointInsideSegments(t,e){return t.some((t=>t.isPointInSegment(e)))}isIncludePoint(t,e){for(const s of this.points)if(s.x===t&&s.y===e)return!0;return!1}isSamePolygon(t){if(this.points.length!==t.points.length)return!1;for(const e of t.points)if(!this.isIncludePoint(e.x,e.y))return!1;return!0}containsInPoint(t){return this.contains(t.x,t.y)}calculateArea(){const t=this.points.length;let e=0;for(let s=0;s<t;s++){const o=this.points[s],n=this.points[(s+1)%t];e+=o.x*n.y-n.x*o.y}return Math.abs(e)/2}getPrevPoint(t){const{points:e}=this,s=e.indexOf(t);return e[(s-1+e.length)%e.length]}getNextPoint(t){const{points:e}=this,s=e.indexOf(t);return e[(s+1)%e.length]}createSegments(){const t=[],{points:e}=this;for(let s=0;s<e.length;s++){const o=e[s],n=e[(s+1)%e.length];t.push(new l(o,n))}return t}static createOuterPolygon(t,e,s,n=0){const i=new c([]),r=o.distancePoint(t,e,n),h=o.distancePoint(e,t,n),a=o.distance(r.x,r.y,h.x,h.y),l=o.radian(r.x,r.y,h.x,h.y),d=s/2;return i.add(r.x,r.y-d),i.add(r.x,r.y+d),i.add(r.x+a,r.y+d),i.add(r.x+a,r.y-d),i.rotate(r.x,r.y,l),i}getIntersectionPointsOfSegment(t){return this.createSegments().map((e=>e.getIntersectionPoint(t))).filter((t=>null!==t))}getIntersectionPointsOfPolygon(t){return t.createSegments().flatMap((t=>this.getIntersectionPointsOfSegment(t)))}}class d extends s{constructor(t,e){super(),this.start=t??new n(0,0),this.end=e??new n(0,0),this.thick=10,this.color="#000000"}get length(){return o.distance(this.start.x,this.start.y,this.end.x,this.end.y)}getControlSegments(){return[new l(this.start,this.end)]}getPoints(){return[this.start,this.end]}isPointInControl(t,e,s=0){return this.createOuterPolygon(s).contains(t,e)}createOuterPolygon(t=0){return c.createOuterPolygon(this.start,this.end,this.thick,t)}}class u{onDragStart(t,e,s){}onDrag(t,e){}onDragStop(t,e){}onCancel(){}}class g{static Colors={Blue10:"#E5F2FF",Blue20:"#CCE4FF",Blue30:"#99CAFF",Blue40:"#66AFFF",Blue50:"#3395FF",Blue60:"#007AFF",Blue70:"#0062CC",Blue80:"#004999",Blue90:"#003166",Blue100:"#001833",BlueHover10:"#DAE6F2",BlueHover20:"#C2D9F2",BlueHover30:"#91C0F2",BlueHover40:"#61A6F2",BlueHover50:"#308EF2",BlueHover60:"#0D81FF",BlueHover70:"#0D6ACF",BlueHover80:"#0D529E",BlueHover90:"#0D3B6E",BlueHover100:"#0D243D",Purple10:"#F7EEFC",Purple20:"#EFDCF8",Purple30:"#DFBAF2",Purple40:"#CF97EB",Purple50:"#BF75E5",Purple60:"#AF52DE",Purple70:"#8C42B2",Purple80:"#693185",Purple90:"#462159",Purple100:"#23102C",PurpleHorver10:"#EBE2EF",PurpleHorver20:"#E3D1EC",PurpleHorver30:"#D4B1E6",PurpleHorver40:"#C58FDF",PurpleHorver50:"#B56FDA",PurpleHorver60:"#B35BE0",PurpleHorver70:"#924BB6",PurpleHorver80:"#713B8B",PurpleHorver90:"#4F2C61",PurpleHorver100:"#2E1C37",Cyan10:"#EAF7FC",Cyan20:"#D6EFFA",Cyan30:"#ADDEF5",Cyan40:"#84CEF0",Cyan50:"#5BBDEB",Cyan60:"#32ADE6",Cyan70:"#288AB8",Cyan80:"#1E688A",Cyan90:"#14455C",Cyan100:"#0A232E",CyanHover10:"#DEEBEF",CyanHover20:"#CBE3ED",CyanHover30:"#A4D3E9",CyanHover40:"#7DC4E4",CyanHover50:"#56B4DF",CyanHover60:"#3CB1E7",CyanHover70:"#3390BC",CyanHover80:"#297090",CyanHover90:"#204E64",CyanHover100:"#162E38",Teal10:"#EAF7F9",Teal20:"#D6EFF4",Teal30:"#ACDFE9",Teal40:"#83D0DD",Teal50:"#59C0D2",Teal60:"#30B0C7",Teal70:"#268D9F",Teal80:"#1D6A77",Teal90:"#134650",Teal100:"#0A2328",TealHover10:"#DEEBED",TealHover20:"#CBE3E8",TealHover30:"#A3D4DD",TealHover40:"#7CC6D2",TealHover50:"#55B6C7",TealHover60:"#3AB4CA",TealHover70:"#3193A4",TealHover80:"#28717E",TealHover90:"#1F4F59",TealHover100:"#162E33",Manneta10:"#FAE9F1",Manneta20:"#F6D4E3",Manneta30:"#EDA9C6",Manneta40:"#E37DAA",Manneta50:"#DA528D",Manneta60:"#D12771",Manneta70:"#A71F5A",Manneta80:"#7D1744",Manneta90:"#54102D",Manneta100:"#2A0817",MannetaHover10:"#EDDDE5",MannetaHover20:"#EAC9D8",MannetaHover30:"#E1A1BC",MannetaHover40:"#D877A1",MannetaHover50:"#CF4E86",MannetaHover60:"#D33278",MannetaHover70:"#AB2A62",MannetaHover80:"#83234D",MannetaHover90:"#5D1C38",MannetaHover100:"#351423",Red10:"#FFEBEA",Red20:"#FFD8D6",Red30:"#FFB1AC",Red40:"#FF8983",Red50:"#FF6259",Red60:"#FF3B30",Red70:"#CC2F26",Red80:"#99231D",Red90:"#661813",Red100:"#330C0A",RedHover10:"#F2DFDE",RedHover20:"#F2CDCB",RedHover30:"#F2A8A3",RedHover40:"#F2827C",RedHover50:"#F25D55",RedHover60:"#FF453A",RedHover70:"#CF3931",RedHover80:"#9E2E28",RedHover90:"#6E241F",RedHover100:"#3D1816",Green10:"#EBF9EE",Green20:"#D6F4DE",Green30:"#AEE9BD",Green40:"#85DD9B",Green50:"#5DD27A",Green60:"#34C759",Green70:"#2A9F47",Green80:"#1F7735",Green90:"#155024",Green100:"#0A2812",GreenHover10:"#DFEDE2",GreenHover20:"#CBE8D3",GreenHover30:"#A5DDB4",GreenHover40:"#7ED293",GreenHover50:"#58C774",GreenHover60:"#3ECA61",GreenHover70:"#35A450",GreenHover80:"#2A7E3F",GreenHover90:"#21592F",GreenHover100:"#16331E",Orange10:"#FFF4E5",Orange20:"#FFEACC",Orange30:"#FFD599",Orange40:"#FFBF66",Orange50:"#FFAA33",Orange60:"#FF9500",Orange70:"#CC7700",Orange80:"#995900",Orange90:"#663C00",Orange100:"#331E00",OrangeHover10:"#F2E8DA",OrangeHover20:"#F2DEC2",OrangeHover30:"#F2CA91",OrangeHover40:"#F2B561",OrangeHover50:"#F2A130",OrangeHover60:"#FF9A0D",OrangeHover70:"#CF7E0D",OrangeHover80:"#9E610D",OrangeHover90:"#6E460D",OrangeHover100:"#3D290D"};static get activeColor(){return"rgb(0,151,197)"}static get activeColor(){return"rgb(0,151,197)"}static get activeColorTransparent(){return"rgb(0, 151, 197, 0.5)"}static get selectColor(){return"rgba(0,151,197,0.5)"}}class m extends s{constructor(t,e){super(),this.start=t,this.end=e,this.height=15,this.padding=15,this.points=[],this.thick=1,this.strokeColor=g.activeColor,this.fillColor=g.activeColor,this.cursor=new n(0,0)}addPoint(t){t&&this.points.push(t)}render(t){let e=o.radianInPoint(this.start,this.end),s=this.createSegment();t.save();let n="right";e>=-Math.PI/2&&e<=Math.PI/2?(t.translate(this.start.x,this.start.y),r.calculateAngle3(this.start.x,this.start.y,this.end.x,this.end.y,this.cursor.x,this.cursor.y)<0&&(n="left")):(e-=Math.PI,t.translate(this.end.x,this.end.y),s.reverse(),r.calculateAngle3(this.end.x,this.end.y,this.start.x,this.start.y,this.cursor.x,this.cursor.y)<0&&(n="left")),t.rotate(e),this.renderRuler(t,s,n),t.restore()}renderRuler(t,e,s){t.lineWidth=this.thick,t.strokeStyle=this.strokeColor,t.fillStyle=this.fillColor,t.font="10px Arial";let o=0,n=-this.padding;"left"===s&&(n=4*this.padding);for(const s of e)this.renderSegment(t,o,n,s),this.renderArrow(t,o,n-this.height,"left"),this.renderArrow(t,o+s,n-this.height,"right"),s>20&&this.renderText(t,o,n,s),o+=s}renderSegment(t,e,s,o){t.beginPath(),t.moveTo(e,s-this.height),t.lineTo(e+o,s-this.height),t.moveTo(e,s),t.lineTo(e,s-2*this.height),t.moveTo(e+o,s),t.lineTo(e+o,s-2*this.height),t.stroke()}renderArrow(t,e,s,o){t.arrow(e,s,5,o)}renderText(t,e,s,o){const n=`${Math.round(o)} px`,i=t.measureText(n).width,r=e+(o-i)/2,h=s-this.height-10;t.fillStyle="white",t.fillRect(r-5,h-10,i+10,15),t.fillStyle=this.fillColor,t.fillText(n,r,h)}createSegment(){const t=this.getSegmentPoints(),e=[];for(let s=0;s<t.length-1;s++)e.push(o.distance(t[s].x,t[s].y,t[s+1].x,t[s+1].y));return e}getSegmentPoints(){const t=[this.start,...this.points,this.end].map((t=>({point:t,distance:Math.abs(t.distanceTo(this.start))})));return t.sort(((t,e)=>t.distance-e.distance)),t.map((t=>t.point))}}class p extends u{constructor(t,e,s,o){super(),this.floor=t,this.wall=e,this.fixedPoint=s,this.movePoint=o,this.originalMovePoint=this.movePoint.copy(),this.rotatedAngle=0,this.controls=[],this.ruler=new m(this.wall.start,this.wall.end),this.started=!1}onDragStart(t,e,s){t.addForegroundControl(this.ruler),this.started=!0}onDrag(t,e){if(this.started){const s=o.radianInPoint(this.fixedPoint,this.movePoint);this.movePoint.x=t,this.movePoint.y=e;const n=o.radianInPoint(this.fixedPoint,this.movePoint);this.rotate(n-s)}}rotate(t){this.rotatedAngle+=t;for(const e of this.controls)[e.start,e.end].map((e=>{const s=o.rotate(e.x,e.y,this.fixedPoint.x,this.fixedPoint.y,t);e.x=s[0],e.y=s[1]}))}onDragStop(t,e){if(this.started){this.started=!1;const t=this.wall.createOuterPolygon();for(const e of this.controls)t.containsInPoint(e.start)&&t.containsInPoint(e.end)||this.floor.removeControl(e)}this.floor.removeForegroundControl(this.ruler)}onCancel(){this.movePoint.copyFrom(this.originalMovePoint),this.rotate(-this.rotatedAngle),this.rotatedAngle=0,this.started=!1}}class f extends u{constructor(t,e,s){super(),this.floor=t,this.wall=e,this.handlers=[],this.equation=this.wall.createEquation();const{start:o,end:n}=this.wall;this.startPointEquation=this.equation.createPerpendicularEquation(o.x,o.y),this.endPointEquation=this.equation.createPerpendicularEquation(n.x,n.y),this.startCandidates=[],this.endCandidates=[],this.childs=s}addHandler(t){for(const e of t)this.handlers.push(e)}onDrag(t,e){this.equation=this.equation.createMoveEquation(t,e);const s=this.calculateStartPoint(t,e),o=this.calculateEndPoint(t,e);this.wall.start.copyFrom(s),this.wall.end.copyFrom(o);for(const t of this.handlers)t.onMove(this.floor,this.wall,this.equation);if(this.childs)for(const t of this.childs)t.start.copyFrom(this.equation.closestPoint(t.start.x,t.start.y)),t.end.copyFrom(this.equation.closestPoint(t.end.x,t.end.y))}calculateStartPoint(t,e){if(0===this.startCandidates.length)return this.equation.intersection(this.startPointEquation);if(1===this.startCandidates.length)return this.equation.intersection(this.startCandidates[0].equation);if(2===this.startCandidates.length){const t=this.equation.intersection(this.startCandidates[0].equation);if(o.isBetween(t.x,this.startCandidates[0].wall.start.x,this.startCandidates[0].wall.end.x)&&o.isBetween(t.y,this.startCandidates[0].wall.start.y,this.startCandidates[0].wall.end.y))return t;const e=this.equation.intersection(this.startCandidates[1].equation);if(o.isBetween(e.x,this.startCandidates[1].wall.start.x,this.startCandidates[1].wall.end.x)&&o.isBetween(e.y,this.startCandidates[1].wall.start.y,this.startCandidates[1].wall.end.y))return e}}calculateEndPoint(t,e){if(0===this.endCandidates.length)return this.equation.intersection(this.endPointEquation);if(1===this.endCandidates.length)return this.equation.intersection(this.endCandidates[0].equation);if(2===this.endCandidates.length){const t=this.equation.intersection(this.endCandidates[0].equation);if(o.isBetween(t.x,this.endCandidates[0].wall.start.x,this.endCandidates[0].wall.end.x)&&o.isBetween(t.y,this.endCandidates[0].wall.start.y,this.endCandidates[0].wall.end.y))return t;const e=this.equation.intersection(this.endCandidates[1].equation);if(o.isBetween(e.x,this.endCandidates[1].wall.start.x,this.endCandidates[1].wall.end.x)&&o.isBetween(e.y,this.endCandidates[1].wall.start.y,this.endCandidates[1].wall.end.y))return e}}}class y{constructor(t,e,s){this.follow=t,this.point=e,this.which=s}onMove(t,e,s){"start"===this.which?this.point.copyFrom(e.start):this.point.copyFrom(e.end)}}class x{constructor(t,e){this.follower=t,this.which=e,this.start=this.follower.start.copy(),this.end=this.follower.end.copy(),this.polygon=this.follower.createOuterPolygon()}onMove(t,e,s){const i=new n(0,0);"start"===this.which?i.copyFrom(e.start):i.copyFrom(e.end);const{start:r,end:h}=this.follower;if(this.isPointOnWall(i.x,i.y))this.restorePoints();else{o.distanceInPoint(r,i)>o.distanceInPoint(h,i)?this.changeEndPoint(i):this.changeStartPoint(i)}}changeStartPoint(t){this.follower.start.copyFrom(t)}changeEndPoint(t){this.follower.end.copyFrom(t)}restorePoints(){this.changeStartPoint(this.start),this.changeEndPoint(this.end)}isPointOnWall(t,e){return this.polygon.contains(t,e)}}class w{constructor(){this.followers=[]}addFollow(t,e){t&&this.followers.push({wall:t,point:e,equation:t.createEquation()})}onMove(t,e,s){const o=this.moveFollowers(e,s);this.removeFollowers(t,o)}moveFollowers(t,e){for(const s of this.followers){const n=e.intersection(s.equation);o.isBetween(n.x,t.start.x,t.end.x)&&o.isBetween(n.y,t.start.y,t.end.y)&&(s.point.x=n.x,s.point.y=n.y)}return[]}removeFollowers(t,e){for(const s of e)t.removeControl(s.wall),this.followers.splice(this.followers.indexOf(s),1)}}class C extends u{constructor(t,e,s){super(),this.fixedStart=t.copy(),this.fixedEnd=e.copy(),this.start=t,this.end=e,this.equation=s}onDragStart(t,e,s){this.startVector=r.createVector(e,s,this.start.x,this.start.y),this.endVector=r.createVector(e,s,this.end.x,this.end.y)}onDrag(t,e){this.startVector=r.createVector(t,e,this.fixedStart.x,this.fixedStart.y),this.endVector=r.createVector(t,e,this.fixedEnd.x,this.fixedEnd.y),this.startVector.dotProduct(this.endVector)<0||(this.start.x=this.fixedStart.x,this.start.y=this.fixedStart.y,this.end.x=this.fixedEnd.x,this.end.y=this.fixedEnd.y)}}class v extends s{constructor(t){super(),this.control=t}get type(){return"window-select"}render(t){this.control&&(t.save(),this.renderPoints(t,[this.control.start,this.control.end]),this.renderLines(t,[this.control.start,this.control.end]),t.restore())}renderPoints(t,e){t.fillStyle=g.activeColor;for(const s of e)t.circle(s.x,s.y,10),t.fill()}renderLines(t,e){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.closePath(),t.lineWidth=2,t.strokeStyle=g.selectColor,t.stroke()}}class P extends d{constructor(t,e){super(t,e)}get type(){return"wall"}duplicate(){const t=new P(this.start.copy(),this.end.copy());return t.thick=this.thick,t.color=this.color,room}translate(t,e){this.start.x+=t,this.start.y+=e,this.end.x+=t,this.end.y+=e}cutting(t,e,s){const o={x:this.end.x,y:this.end.y};this.end.x=e,this.end.y=s;t.createWall(e,s,o.x,o.y).thick=this.thick}createPointDragHandler(t,e,s){let o=null;return this.start.distance(e,s)<10?o=new p(t,this,this.end,this.start):this.end.distance(e,s)<10&&(o=new p(t,this,this.start,this.end)),o?(o.controls.push(...t.findControlsOnWall(this)),[o]):null}createExtendDragHandler(t,e,s){return this.isPointInControl(e,s)?new C(this.start,this.end):null}createMoveDragHandler(t,e,s){if(this.isPointInControl(e,s)){const e=new f(t,this,t.findControlsOnWall(this));return e.addHandler(this.createStartPointHandlers(t,e)),e.addHandler(this.createEndPointHandlers(t,e)),e.addHandler(this.createStartPointExtendHandlers(t,e)),e.addHandler(this.createEndPointExtendHandlers(t,e)),e.addHandler(this.createWallHandlers(t)),[e]}return null}createStartPointHandlers(t,e){const s=[],o=t.getConnectedWallsFromPoint(this,this.start,this.end);return 1===o.length&&(e.startPointEquation=o[0].wall.createEquation(),s.push(new y(o[0].wall,o[0].point,"start"))),s}createStartPointExtendHandlers(t,e){const s=[],o=t.getWallFromPoint(this,this.start);return o&&(e.startPointEquation=o.createEquation(),s.push(new x(o,"start"))),s}createEndPointExtendHandlers(t,e){const s=[],o=t.getWallFromPoint(this,this.end);return o&&(e.endPointEquation=o.createEquation(),s.push(new x(o,"end"))),s}createEndPointHandlers(t,e){const s=[],o=t.getConnectedWallsFromPoint(this,this.end,this.start);return 1===o.length&&(e.endPointEquation=o[0].wall.createEquation(),s.push(new y(o[0].wall,o[0].point,"end"))),s}createPointHandlers(t,e,s,o){const n=[];if(s)if(s.point)if(s.angle>175&&s.angle<185)if("start"===o){const e=new P(this.start.copy(),this.start.copy());e.thick=this.thick,t.walls.push(e),n.push(new y(e,e.end,o))}else{const e=new P(this.end.copy(),this.end.copy());e.thick=this.thick,t.walls.push(e),n.push(new y(e,e.end,o))}else"start"===o?e.startPointEquation=s.wall.createEquation():e.endPointEquation=s.wall.createEquation(),n.push(new y(s.wall,s.point,o));else"start"===o?e.startPointEquation=s.wall.createEquation():e.endPointEquation=s.wall.createEquation(),n.push(new x(s.wall,o));return n}createWallHandlers(t){const e=new w,s=t.getConnectedWallsFromWall(this);for(const t of s)e.addFollow(t.wall,t.point);return[e]}createPointSelectionControl(){return new v(this)}createMoveSelectionControl(){return new v(this)}createEquation(){return a.createEquationFrom4Point(this.start.x,this.start.y,this.end.x,this.end.y)}createPerpendicularEquation(t,e){if(1===arguments.length){const e=t;if(e instanceof n)return this.createEquation().createPerpendicularEquation(e.x,e.y)}else if(arguments.length>=2)return this.createEquation().createPerpendicularEquation(t,e);return null}distance(t,e){return this.createEquation().distance(t,e)}createClosestPoint(t,e){return this.createEquation().closestPoint(t,e)}createDistancePoint(t,e,s){const o=this.createEquation().closestPoint(t,e),n=Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x);return{x:o.x+s*Math.cos(n),y:o.y+s*Math.sin(n)}}isPointOnBoundary(t){const{start:e,end:s}=this,o=Math.min(e.x,s.x),n=Math.max(e.x,s.x),i=Math.min(e.y,s.y),r=Math.max(e.y,s.y);return t.x>=o&&t.x<=n&&t.y>=i&&t.y<=r}renderControl(t){t.save(),t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.closePath(),t.stroke(),t.restore()}}class b extends s{constructor(t){super(),this.room=t}get type(){return"room-move-select"}render(t){const{points:e}=this.room.polygon;e.length>0&&(t.save(),this.renderLines(t,e,15,"rgba(0,151,197, 0.5)"),t.restore())}renderPoints(t,e){t.fillStyle=g.selectColor;for(const s of e)t.circle(s.x,s.y,10),t.fill()}renderLines(t,e,s,o){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.closePath(),t.lineWidth=s,t.strokeStyle=o,t.stroke()}}class S extends u{constructor(t,e){super(),this.room=t,this.startX=0,this.startY=0,this.started=!1,this.floor=null,this.children=e,this.selector=new b(t)}onDragStart(t,e,s){this.floor=t,this.startX=e,this.startY=s,this.started=!0,this.editor.addSelectControl(this.selector)}onDrag(t,e){if(this.started){const s=t-this.startX,o=e-this.startY;this.translateRoom(s,o),this.translateChildren(s,o),this.startX=t,this.startY=e}}translateRoom(t,e){this.room.translate(t,e)}translateChildren(t,e){this.children.forEach((s=>{s.translate(t,e)}))}onDragStop(t,e){this.editor.removeSelectControl(this.selector)}}class A extends u{constructor(t,e,s,o,n){super(),this.floor=t,this.handlers=[],this.start=e,this.end=s,this.equation=o,this.startPointEquation=this.equation.createPerpendicularEquation(e.x,e.y),this.endPointEquation=this.equation.createPerpendicularEquation(s.x,s.y),this.children=n,this.startX=0,this.startY=0,this.text=""}onDragStart(t,e,s){this.startX=e,this.startY=s}onDrag(t,e){this.equation=this.equation.createMoveEquation(t,e);const s=this.calculateStartPoint(),o=this.calculateEndPoint();this.start.copyFrom(s),this.end.copyFrom(o);const n=t-this.startX,i=e-this.startY;this.children.forEach((t=>t.translate(n,i))),this.startX=t,this.startY=e}calculateStartPoint(){return this.equation.intersection(this.startPointEquation)}calculateEndPoint(){return this.equation.intersection(this.endPointEquation)}}class T extends u{constructor(t,e,s,o){super(),this.editor=null,this.fixedPoint=e,this.movePoint=s,this.rotatedAngle=0,this.controls=o,this.ruler=new m(e,s),this.started=!1}onDragStart(t,e,s){this.editor.addSelectControl(this.ruler),this.started=!0}onDrag(t,e){if(this.started){const s=this.fixedPoint.radianTo(this.movePoint);this.movePoint.x=t,this.movePoint.y=e;const o=this.fixedPoint.radianTo(this.movePoint);this.rotate(o-s)}}rotate(t){this.rotatedAngle+=t;for(const e of this.controls)[e.start,e.end].map((e=>{const s=o.rotate(e.x,e.y,this.fixedPoint.x,this.fixedPoint.y,t);e.x=s[0],e.y=s[1]}))}onDragStop(t,e){this.started&&(this.started=!1),this.editor.removeSelectControl(this.ruler)}onCancel(){this.movePoint.copyFrom(this.originalMovePoint),this.rotate(-this.rotatedAngle),this.rotatedAngle=0,this.started=!1}}class E{static applyOpacityToColor(t,e){return function(t,e){return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${e})`}(function(t){let e=parseInt(t.replace("#",""),16);return[e>>16&255,e>>8&255,255&e]}(t),e)}static isRGBorRGBA(t){return/^(rgb|rgba)/.test(t)}static toHexColor(t){if(!t)return t;let e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(\.\d+)?))?\)/);if(!e)return null;let s="";void 0!==e[4]&&(s=Math.round(255*parseFloat(e[4])).toString(16),1===s.length&&(s="0"+s));let o="#";for(let t=1;t<=3;t++){let s=parseInt(e[t],10).toString(16);1===s.length&&(s="0"+s),o+=s}return""!==s&&(o+=s),o}static reverseTransparent(t){if(!t)return t;let e=1;9===t.length&&(e=parseInt(t.slice(7,9),16)/255),e=1===e?.5:1;let s=Math.round(255*e).toString(16);return 1===s.length&&(s="0"+s),t.slice(0,7)+s}static toTransparent(t){if(!t)return t;E.isRGBorRGBA(t)&&(t=E.toHexColor(t));let e=1;9===t.length&&(e=parseInt(t.slice(7,9),16)/255),1===e&&(e=.5);let s=Math.round(255*e).toString(16);return 1===s.length&&(s="0"+s),t.slice(0,7)+s}}class M extends s{constructor(t,e){super(),this.polygon=new c(t??[]),this.segments=this.polygon.createSegments(),this.fillColor=null,this.label=e,this.transparent=!0}get type(){return"room"}getControlSegments(){return this.segments}getControlPolygons(){return[this.polygon]}getPoints(){return this.polygon.points}addPoint(t){this.polygon.addPoint(t)}duplicate(){const t=new M(this.polygon.duplicate(),this.label);return t.fillColor=this.fillColor,t.label=this.label,t.transparent=this.transparent,t}translate(t,e){this.polygon.points.forEach((s=>{s.x+=t,s.y+=e}))}getControlsInsideRoom(t){const e=[];this.segments.forEach((s=>{const o=t.getControlsInsideSegment(s);o&&e.push(...o)}));let s=t.getControlsInsidePolygon(this.polygon);return s&&(s=s.filter((t=>t!==this)),e.push(...s)),e.filter(((t,s)=>e.indexOf(t)===s))}getControlsInsideSegment(t,e){return t.getControlsInsideSegment(e)}render(t){t.save(),this.renderSpace(t),this.renderLabel(t),this.renderSegment(t),t.restore()}renderSegment(t){if(!(this.segments.length<=0))for(const e of this.segments)e.thick>0&&(t.beginPath(),t.lineWidth=e.thick,t.strokeStyle=e.color,t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.closePath(),t.stroke())}renderSpace(t){const{points:e}=this.polygon;if(e.length>0&&this.fillColor){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.closePath(),t.fillStyle=this.transparent?E.toTransparent(this.fillColor):this.fillColor,t.fill()}}renderLabel(t){const e=this.polygon.getVisualCenterPoint();this.label&&e&&(t.font="10px Arial",t.fillStyle="#000000",t.text(e.x,e.y,this.label))}contains(t,e){return this.polygon.contains(t,e)}createPointDragHandler(t,e,s){let o=null;for(const t of this.polygon.points){if(t.distanceTo({x:e,y:s})<10){o=t;break}}if(o){const e=this.polygon.getPrevPoint(o),s=this.polygon.getNextPoint(o),n=this.getControlsInsideSegment(t,new l(e,o)),i=this.getControlsInsideSegment(t,new l(s,o));return[new T(t,e,o,n),new T(t,s,o.copy(),i)]}return null}getSegmentContainingPoint(t){for(const e of this.segments)if(e.isPointInSegment(t))return e;return null}createMoveDragHandler(t,e,s){const o=new n(e,s);for(const e of this.segments)if(e.isPointInSegment(o)){return[this.createMoveSegmentHandler(t,e),...this.createChildMoveSegmentHandlers(t,e)]}return this.isPointInControl(e,s)?[new S(this,this.getControlsInsideRoom(t))]:null}createMoveSegmentHandler(t,e){const s=new A(t,e.start,e.end,e.createEquation(),this.getControlsInsideSegment(t,e)),o=this.segments.indexOf(e),n=this.segments.length;return s.startPointEquation=this.segments[(o-1+n)%n].createEquation(),s.endPointEquation=this.segments[(o+1)%n].createEquation(),s.text="main",s}createChildMoveSegmentHandlers(t,e){const s=[];for(const o of t.getAllControls())if(o!==this)for(const n of o.getControlSegments())e.isPointInSegment(n.start)&&e.isPointInSegment(n.end)&&"room"===o.type&&s.push(o.createMoveSegmentHandler(t,n));return s.map((t=>(t.text="child",t)))}createPointSelectionControl(){return null}createMoveSelectionControl(){return new b(this)}isPointInControl(t,e,s){return this.polygon.contains(t,e)}isSegmentCollision(t){for(const e of this.segments)if(e.getIntersectionPoint(t))return!0;return!1}isCollision(t){const e=t.rooms.filter((t=>t!==this));for(const t of this.segments)for(const s of e)if(s.isSegmentCollision(t))return!0;return!1}}class D extends u{constructor(t){super(),this.control=t,this.startX=0,this.startY=0}onDragStart(t,e,s){this.started=!0,this.startX=e,this.startY=s}onDrag(t,e){const s=t-this.startX,o=e-this.startY;this.control.start.x+=s,this.control.start.y+=o,this.control.end.x+=s,this.control.end.y+=o,this.startX=t,this.startY=e}}class R extends u{constructor(t){super(),this.point=t}onDragStart(t,e,s){}onDrag(t,e){this.point.x=t,this.point.y=e}onDragStop(t,e){this.point.x=t,this.point.y=e}}class B extends s{constructor(){super(),this.x=0,this.y=0,this.text=null,this.background=null,this.color=null}get type(){return"tooltip"}render(t){if(!this.text)return;t.font="10px Arial bold";const e=t.measureText(this.text).width,s=parseInt(t.font);t.fillStyle=this.background?this.background:"rgba(255,59,48)",t.fillRect(this.x,this.y,e+10,s+10),t.fillStyle=this.color?this.color:"#ffffff",t.fillText(this.text,this.x+5,this.y+s+5)}}class F extends s{constructor(t){super(),this.door=t,this.tooltip=new B}get type(){return"door-select-control"}render(t){this.door&&(t.save(),this.renderPoints(t,[this.door.start,this.door.end,this.door.getControlPoint()]),t.restore(),this.door.length<10&&(this.tooltip.x=this.door.start.x,this.tooltip.y=this.door.start.y+10,this.tooltip.text="deleted",this.tooltip.render(t)))}renderPoints(t,e){t.fillStyle=g.activeColorTransparent;for(const s of e)t.circle(s.x,s.y,10),t.fill()}}class H extends u{constructor(t){super(),this.door=t,this.started=!1}onDragStart(t,e,s){this.started=!0}onDrag(t,e){if(!this.started)return;const s=this.calculateAngle(this.door.start.x,this.door.start.y,this.door.end.x,this.door.end.y,this.door.start.x,this.door.start.y,t,e);this.door.direction=s>=0&&s<=180?"right":"left";const n=o.distance(this.door.start.x,this.door.start.y,t,e),i=o.distance(this.door.end.x,this.door.end.y,t,e);this.door.hidge=n>i?"end":"start"}angle(t,e){return o.angle(this.door.start.x,this.door.start.y,t,e)}onDragStop(t,e){this.started&&(this.started=!1)}createVector(t,e,s,o){return{x:s-t,y:o-e}}dotProduct(t,e){return t.x*e.x+t.y*e.y}vectorMagnitude(t){return Math.sqrt(t.x*t.x+t.y*t.y)}calculateAngle(t,e,s,o,n,i,r,h){var a=this.createVector(t,e,s,o),l=this.createVector(n,i,r,h),c=Math.atan2(l.y,l.x)-Math.atan2(a.y,a.x);return this.radiansToDegreesInRange(c)}radiansToDegreesInRange(t){for(var e=t*(180/Math.PI);e<0;)e+=360;for(;e>=360;)e-=360;return e}}class k extends u{constructor(t,e,s,o){super(),this.floor=t,this.segment=e,this.point=o,this.control=s,this.ruler=new m(this.segment.start,this.segment.end),this.ruler.addPoint(s.start),this.ruler.addPoint(s.end),this.cancelSnapshot={segment:e,point:o.copy()},this.started=!1}onDragStart(t,e,s){this.floor.addForegroundControl(this.ruler),this.started=!0}onDrag(t,e){if(!this.started)return;const s=this.segment.getClosestPoint(t,e);s&&this.segment.isPointInSegment(s)&&this.point.copyFrom(s)}onDragStop(t,e){this.started=!1,this.removeControlsUnderThreshold(10),this.floor.removeForegroundControl(this.ruler)}onCancel(){this.started=!1,this.point.copyFrom(this.cancelSnapshot.point)}removeControlsUnderThreshold(t){this.control.length<t&&this.floor.removeControl(this.control)}}class I extends u{constructor(t,e,s){super(),this.floor=t,this.segment=e,this.control=s,this.startVector=0,this.endVector=0,this.ruler=new m(this.segment.start,this.segment.end),this.ruler.addPoint(this.control.start),this.ruler.addPoint(this.control.end),this.cancelSnapshot={segment:e,start:s.start.copy(),end:s.end.copy()},this.started=!1,this.reverse=o.distanceInPoint(this.segment.start,this.control.start)>o.distanceInPoint(this.segment.start,this.control.end)}onDragStart(t,e,s){const o=this.segment.getClosestPoint(e,s);this.startVector=r.createVectorOfPoints(o,this.control.start),this.endVector=r.createVectorOfPoints(o,this.control.end),this.floor.addForegroundControl(this.ruler),this.started=!0,this.startX=e,this.startY=s}onDrag(t,e){if(!this.started)return;const s=new n(t,e);this.ruler.cursor.x=t,this.ruler.cursor.y=e;const o=this.floor.getSegmentAtPoint(s);o&&(this.segment=o);const i=this.reverse?this.startVector.getLength():-this.startVector.getLength(),r=this.reverse?-this.endVector.getLength():this.endVector.getLength();let h=this.segment.getPointAtDistance(s,i),a=this.segment.getPointAtDistance(s,r);this.segment.isPointInSegment(h)&&this.segment.isPointInSegment(a)&&(this.updateRuler(this.segment.start,this.segment.end),this.updateControl(h,a))}onDragStop(t,e){this.started&&(this.started=!1),this.floor.removeForegroundControl(this.ruler)}onCancel(){this.started=!1,this.updateRuler(this.cancelSnapshot.segment.start,this.cancelSnapshot.segment.end),this.updateControl(this.cancelSnapshot.start,this.cancelSnapshot.end)}updateRuler(t,e){this.ruler.start=t,this.ruler.end=e}updateControl(t,e){this.control.start.copyFrom(t),this.control.end.copyFrom(e)}}class O extends d{constructor(t,e){super(t,e),this.hidge="start",this.direction="right"}get type(){return"door"}getPoints(){return[...super.getPoints(),this.getControlPoint()]}translate(t,e){this.start.x+=t,this.start.y+=e,this.end.x+=t,this.end.y+=e}duplicate(){const t=new O(this.start.copy(),this.end.copy());return t.hidge=this.hidge,t.direction=this.direction,t}get angle(){return o.radianInPoint(this.start,this.end)}getControlPoint(){const t=this.length,e=this.angle-270*Math.PI/180;let s=0,o=0;return"right"===this.direction?"start"===this.hidge?(s=this.start.x+t*Math.cos(e),o=this.start.y+t*Math.sin(e)):(s=this.end.x+t*Math.cos(e),o=this.end.y+t*Math.sin(e)):"start"===this.hidge?(s=this.start.x-t*Math.cos(e),o=this.start.y-t*Math.sin(e)):(s=this.end.x-t*Math.cos(e),o=this.end.y-t*Math.sin(e)),new n(s,o)}render(t){t.save(),t.lineWidth=1,t.translate(this.start.x,this.start.y),t.rotate(this.angle),this.renderRect(t),this.renderDoor(t),t.restore()}renderRect(t){const e=this.length,s=10/3,o=new Path2D;o.rect(0,-5,e,10);for(let t=0;t<3;t++)o.rect(5,s*t-5,e-10,s);t.fillStyle="#ffffff",t.strokeStyle="#000000",t.fill(o),t.stroke(o)}renderDoor(t){const e=this.length,s=new Path2D,o=Math.PI/2,n=Math.PI,i=0+e;"start"===this.hidge?"right"===this.direction?(s.arc(0,0,e,0,o,!1),s.moveTo(0,0),s.lineTo(0,e)):(s.arc(0,0,e,-o,0,!1),s.moveTo(0,0),s.lineTo(0,-e)):"right"===this.direction?(s.arc(i,0,e,o,n,!1),s.moveTo(i,0),s.lineTo(i,e)):(s.arc(i,0,e,n,-o,!1),s.moveTo(i,0),s.lineTo(i,-e)),t.stroke(s)}createPointDragHandler(t,e,s){const o=t.getSegmentAtPoint(this.start);if(this.start.distance(e,s)<10)return o?[new k(t,o,this,this.start)]:[new R(this.start)];if(this.end.distance(e,s)<10)return o?[new k(t,o,this,this.end)]:[new R(this.end)];return this.getControlPoint().distance(e,s)<10?[new H(this)]:null}createMoveDragHandler(t,e,s){if(this.isPointInControl(e,s)){const e=t.getSegmentAtPoint(this.start);return e?[new I(t,e,this)]:[new D(this)]}return null}createPointSelectionControl(){return new F(this)}createMoveSelectionControl(){return new F(this)}}class q extends s{constructor(t){super(),this.window=t,this.tooltip=new B}get type(){return"window-select-control"}render(t){this.window&&(t.save(),this.renderPoints(t,[this.window.start,this.window.end]),t.restore(),this.window.length<10&&(this.tooltip.x=this.window.start.x,this.tooltip.y=this.window.start.y+10,this.tooltip.text="deleted",this.tooltip.render(t)))}renderPoints(t,e){t.fillStyle=g.activeColorTransparent;for(const s of e)t.circle(s.x,s.y,10),t.fill()}}class W extends d{constructor(t,e){super(t,e)}get type(){return"window"}translate(t,e){this.start.x+=t,this.start.y+=e,this.end.x+=t,this.end.y+=e}duplicate(){return new W(this.start.copy(),this.end.copy())}render(t){const e=o.radianInPoint(this.start,this.end),s=o.distanceInPoint(this.start,this.end),n=this.createWindowPath(s,10);t.save(),t.translate(this.start.x,this.start.y),t.rotate(e),t.lineWidth=1,t.strokeStyle="#000000",t.fillStyle="#ffffff",t.fill(n),t.stroke(n),t.restore()}createWindowPath(t,e){const s=e/3,o=new Path2D;o.rect(0,-5,t,e);for(let e=0;e<3;e++)o.rect(5,s*e-5,t-10,s);return o}createPointDragHandler(t,e,s){const o=[],n=t.getSegmentAtPoint(this.start);return this.start.distance(e,s)<10?n?o.push(new k(t,n,this,this.start)):o.push(new R(this.start)):this.end.distance(e,s)<10&&(n?o.push(new k(t,n,this,this.end)):o.push(new R(this.end))),o}createMoveDragHandler(t,e,s){const o=[];if(this.isPointInControl(e,s)){const e=t.getSegmentAtPoint(this.start);e?o.push(new I(t,e,this)):o.push(new D(this))}return o}createPointSelectionControl(){return new q(this)}createMoveSelectionControl(){return new q(this)}}class X{constructor(t,e){this.point=new n(t,e),this.edges=[]}get x(){return this.point.x}set x(t){this.point.x=t}get y(){return this.point.y}set y(t){this.point.y=t}removeEdge(t){this.edges.splice(this.edges.indexOf(t),1)}}class Y{constructor(){this.vertices=[]}addEdge(t,e,s,o){const[n,i,r,h]=[t,e,s,o].map(Math.floor),a=this.getVertexOrCreate(n,i),l=this.getVertexOrCreate(r,h);a.edges.push(l),l.edges.push(a)}getVertex(t,e){return this.vertices.find((s=>s.point.x===t&&s.point.y===e))}existEdge(t,e){const s=this.getVertex(t.x,t.y);return!!s&&s.edges.some((t=>t.x===e.x&&t.y===e.y))}removeVertex(t){this.vertices.splice(this.vertices.indexOf(t),1);for(let e of t.edges)e.removeEdge(t)}getVertexOrCreate(t,e){let s=this.getVertex(t,e);return s||(s=new X(t,e),this.vertices.push(s),s)}removeLeafVertex(){let t=[];do{t=[];for(const e of this.vertices)e.edges.length<=1&&t.push(e);for(const e of t)this.removeVertex(e)}while(t.length>0)}getAllPoints(){return this.vertices.map((t=>t.point))}}class V{static findPolygon(t){let e=[];t.vertices.forEach((s=>{s.edges.forEach((o=>{const n=new L;n.push(s),this.find(t,s,o,n),n.closed&&(t=>{const{points:s}=t;s.length<=2||e.some((e=>e.isSamePolygon(t)))||e.push(t)})(n.createPolygon())}))}));const s=t.getAllPoints();return e.filter((t=>!s.some((e=>t.isPointInside(e)))))}static find(t,e,s,o){if(!e||!s)return;o.push(s);let n=this.next(t,e,s,o);n!==o.first()?this.find(t,s,n,o):o.closed=!0}static next(t,e,s,o){const n=s.edges.filter((t=>t!==e&&!o.visited(t)));if(0===n.length)return null;if(1===n.length)return n[0];let i=null,r=1/0;for(const t of n){const o=this.ccw(e,s,t);o.value<r&&(i=t,r=o.value)}return i}static ccw(t,e,s){let o=t.x*e.y+e.x*s.y+s.x*t.y-e.x*t.y-s.x*e.y-t.x*s.y;return{value:o,isRight:()=>o>0,isLeft:()=>o<0}}}class L{constructor(){this.vertexes=[],this.closed=!1}get length(){return this.vertexes.length}first(){return this.vertexes.length>0?this.vertexes[0]:null}push(t){this.vertexes.push(t)}visited(t){return this.vertexes.includes(t,1)}createPolygon(){const t=this.vertexes.map((t=>t.point));return new c(t)}}class z{constructor(){this.rooms=[],this.walls=[],this.windows=[],this.doors=[],this.outlines=[],this.foregrounds=[]}clear(){this.rooms=[],this.walls=[],this.windows=[],this.doors=[],this.foregrounds=[],this.outlines=[]}load(t){this.clear(),t.rooms&&this.loadRooms(t.rooms),t.walls&&this.loadWalls(t.walls),t.windows&&this.loadWindows(t.windows),t.doors&&this.loadDoors(t.doors)}loadRooms(t){for(const e of t)if(e.polygon&&e.polygon.points){const t=e.polygon.points.map((t=>new n(t.x,t.y))),s=new M(t,e.label);s.fillColor=e.fillColor,this.rooms.push(s)}}loadWalls(t){for(const e of t){const{start:t,end:s}=e,o=new P(new n(t.x,t.y),new n(s.x,s.y));this.walls.push(o)}}loadWindows(t){for(const e of t){const{start:t,end:s}=e,o=new W(new n(t.x,t.y),new n(s.x,s.y));this.windows.push(o)}}loadDoors(t){for(const e of t){const{start:t,end:s}=e,o=new O(new n(t.x,t.y),new n(s.x,s.y));o.hidge=e.hidge,o.direction=e.direction,this.doors.push(o)}}render(t){this.renderFloor(t),this.renderForeground(t)}renderFloor(t){for(const e of this.rooms)e.render(t);for(const e of this.walls)e.render(t);for(const e of this.outlines)e.render(t);for(const e of this.doors)e.render(t);for(const e of this.windows)e.render(t)}renderForeground(t){for(const e of this.foregrounds)e.render(t)}buildGraph(t){const e=(t,e,s)=>{for(const o of t)if(o.x===e&&o.y===s)return!0;return!1};for(const s of this.walls){let n=this.collectIntersectionPoints(s);n.sort(((t,e)=>o.distanceInPoint(s.start,t)-o.distanceInPoint(s.start,e))),e(n,s.start.x,s.start.y)||n.unshift(s.start),e(n,s.end.x,s.end.y)||n.push(s.end);for(let e=1;e<n.length;e++){const s=n[e-1],o=n[e];t.addEdge(s.x,s.y,o.x,o.y)}}for(const e of this.rooms)for(const s of e.segments)t.addEdge(s.start.x,s.start.y,s.end.x,s.end.y);return t}createRooms(t){const e=new Y;this.buildGraph(e),e.removeLeafVertex();const s=V.findPolygon(e);this.rooms=s.map((e=>{let s=this.getRoom(e);return s||(s=new M(e.points,""),t&&(s=t.onCreate(s))),s}))}getRoom(t){return this.rooms.find((e=>e.polygon.isSamePolygon(t)))}getRoomIncludePoint(t,e){return this.rooms.filter((t=>t!==e)).find((e=>e.isPointInControl(t.x,t.y)))}collectIntersectionPoints(t){const e=t.createOuterPolygon();return this.walls.flatMap((s=>{if(t===s)return[];if(e.contains(s.start.x,s.start.y))return[s.start];if(e.contains(s.end.x,s.end.y))return[s.end];const n=o.interceptPoint(t.start.x,t.start.y,t.end.x,t.end.y,s.start.x,s.start.y,s.end.x,s.end.y);return n?[n]:[]}))}createWall(t,e,s,o){let i=this.findWall(t,e,s,o);return i||(i=new P(new n(t,e),new n(s,o)),this.walls.push(i)),i}findWall(t,e,s,o){for(const n of this.walls){const{start:i,end:r}=n;if(i.x===t&&i.y===e&&r.x===s&&r.y===o)return n;if(r.x===t&&r.y===e&&i.x===s&&i.y===o)return n}for(const n of this.walls){const i=n.createOuterPolygon(10);if(i.contains(t,e)&&i.contains(s,o))return n}return null}findControlsOnWall(t){const e=t.createOuterPolygon(),s=[];for(const t of this.doors)e.contains(t.start.x,t.start.y)&&e.contains(t.end.x,t.end.y)&&s.push(t);for(const t of this.windows)e.contains(t.start.x,t.start.y)&&e.contains(t.end.x,t.end.y)&&s.push(t);return s}removeControl(t){let e=this.walls.indexOf(t);if(-1!==e){this.walls.splice(e,1);for(const e of this.findControlsOnWall(t))this.removeControl(e)}if(e=this.windows.indexOf(t),-1!==e&&this.windows.splice(e,1),e=this.doors.indexOf(t),-1!==e&&this.doors.splice(e,1),e=this.rooms.indexOf(t),-1!==e){this.rooms.splice(e,1);for(const e of t.getControlsInsideRoom(this))this.removeControl(e)}}getControlsInsideSegment(t){return[...this.windows,...this.doors,...this.walls].filter((e=>t.isPointInSegment(e.start)||t.isPointInSegment(e.end)))}getControlsInsidePolygon(t){return[...this.windows,...this.doors,...this.walls,...this.rooms].filter((e=>{const s=e.getPoints();return t.isPointsInside(s)}))}getControlsOnCoordinates(t,e,s=null){const o=[];for(const n of this.getAllControls())n.isPointInControl(t,e)&&(s&&s(n),o.push(n));return o}getSegmentAtPoint(t){const e=this.getSegments();return e&&0!==e.length?e.find((e=>e.isPointInSegment(t))):null}getSegments(){const t=[];return t.push(...this.rooms.flatMap((t=>[...t.segments]))),t}getWallByPoint(t,e){const s=(t,e)=>Math.floor(t)===Math.floor(e),o=(t,e,o)=>s(t.start.x,e.x)&&s(t.start.y,e.y)&&s(t.end.x,o.x)&&s(t.end.y,o.y);for(const s of this.walls)if(o(s,t,e)||o(s,e,t))return s;return null}getWallsOnCoordinates(t,e,s=null){const o=[];for(const n of this.walls)n.isPointInControl(t,e)&&(s?s(n)&&o.push(n):o.push(n));return o}getWallFromPoint(t,e){const s=e=>t.start.x===e.x&&t.start.y===e.y||t.end.x===e.x&&t.end.y===e.y;for(const o of this.walls)if(t!==o&&!s(o.start)&&!s(o.end)&&o.isPointInControl(e.x,e.y))return o;return null}getClosestWallOnCoordinates(t,e){for(const s of this.walls)if(s.isPointInControl(t,e,10))return s;return null}cuttingRect(t,e,s,o){const n=h.create(t,e,s,o);for(const t of n.segments())this.cuttingLine(t.x1,t.y1,t.x2,t.y2);n.x-=1,n.y-=1,n.width+=2,n.height+=2;const i=[];for(const t of this.walls)n.isPointInRect(t.start)&&n.isPointInRect(t.end)&&i.push(t);for(const t of this.windows)n.isPointInRect(t.start)&&n.isPointInRect(t.end)&&i.push(t);for(const t of this.doors)n.isPointInRect(t.start)&&n.isPointInRect(t.end)&&i.push(t);for(const t of i)this.removeControl(t)}getConnectedWallsFromPoint(t,e,s){const n=[],i=r.createVectorOfPoints(e,s);for(const h of this.walls)if(h!==t){const{start:t,end:a}=h;o.distanceInPoint(t,e)<10?n.push({wall:h,point:t,angle:o.calculate3PointAngle(e,a,s),vector:r.createVectorOfPoints(t,a),dotProduct:i.dotProduct(r.createVectorOfPoints(t,a))}):o.distanceInPoint(a,e)<10&&n.push({wall:h,point:a,angle:o.calculate3PointAngle(e,t,s),vector:r.createVectorOfPoints(a,t),dotProduct:i.dotProduct(r.createVectorOfPoints(a,t))})}return n}getConnectedWallsFromWall(t){const e=e=>t.start.x===e.x&&t.start.y===e.y||t.end.x===e.x&&t.end.y===e.y,s=t.createOuterPolygon(5),o=[];for(const n of this.walls)if(n!==t){if(e(n.start)||e(n.end))continue;const{start:t,end:i}=n;s.contains(t)?o.push({wall:n,point:t}):s.contains(i)&&o.push({wall:n,point:i})}return o}cuttingLine(t,e,s,n){const i=[];for(const r of this.walls){const h=o.interceptPoint(t,e,s,n,r.start.x,r.start.y,r.end.x,r.end.y);h&&i.push({point:h,wall:r})}for(const t of i)t.wall.cutting(this,t.point.x,t.point.y)}addForegroundControl(t){t&&this.foregrounds.push(t)}removeForegroundControl(t){t&&(this.foregrounds=this.foregrounds.filter((e=>e!==t)))}getBoundRect(){let t={minX:0,minY:0,maxX:0,maxY:0};const e=this.getAllControls();return 0===e.length||e.forEach(((e,s)=>{const o=e.getBoundRect();0===s?t=o:(t.minX=Math.min(t.minX,o.minX),t.minY=Math.min(t.minY,o.minY),t.maxX=Math.max(t.maxX,o.maxX),t.maxY=Math.min(t.maxY,o.maxY))})),t}getAllControls(){return[...this.doors.slice().reverse(),...this.windows.slice().reverse(),...this.walls.slice().reverse(),...this.rooms.slice().reverse()]}}class G{render(t){}}class j extends G{constructor(t,e){super(),this.canvas=e,this.display=!t||!t.display||t.display,this.size=t&&t.size?t.size:100,this.color=t&&t.color?t.color:"#c2c1c1",this.thick=t&&t.thick?t.thick:1}render(t){if(this.display){t.save(),t.setTransform(1,0,0,1,0,0),t.beginPath(),t.strokeStyle=this.color,t.lineWidth=this.thick;for(let e=this.size;e<this.canvas.width;e+=this.size)t.moveTo(e,0),t.lineTo(e,this.canvas.height);for(let e=this.size;e<this.canvas.height;e+=this.size)t.moveTo(0,e),t.lineTo(this.canvas.width,e);t.stroke(),t.restore()}}}class N extends G{constructor(t,e=1,s=!1){super(),this.floor=t,this.alpha=e,this.displayVertex=s}render(t){t.save(),t.globalAlpha=this.alpha,this.floor.render(t),this.displayVertex&&this.renderVertex(t),t.restore()}renderVertex(t){const e=new i;for(const t of this.floor.walls)e.addPoint(t.start),e.addPoint(t.end);for(const s of e.points)t.beginPath(),t.arc(s.x,s.y,10,0,2*Math.PI),t.fillStyle="rgba(31,32,35,0.5)",t.fill()}}class U extends G{constructor(t){super(),this.floor=t}render(t){let e=1/0,s=1/0,o=-1/0,n=-1/0;for(const t of this.floor.getAllControls()){const i=t.getBoundRect();e=Math.min(e,i.minX),s=Math.min(s,i.minY),o=Math.max(o,i.maxX),n=Math.max(n,i.maxY)}const i=50;this.renderLine(t,e,s-i,o,s-i),this.renderArrow(t,e,s-i,5,4),this.renderArrow(t,o,s-i,5,2),this.renderLine(t,o+i,s,o+i,n),this.renderArrow(t,o+i,s,5,1),this.renderArrow(t,o+i,n,5,3)}renderLine(t,e,s,o,n){t.beginPath(),t.strokeStyle="#666666",t.fillStyle="#666666",t.lineWidth=1,t.moveTo(e,s),t.lineTo(o,n),t.stroke()}renderArrow(t,e,s,o,n){switch(n){case 1:t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s+o),t.moveTo(e,s),t.lineTo(e+o,s+o),t.closePath(),t.stroke();break;case 2:t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.moveTo(e,s),t.lineTo(e-o,s+o),t.closePath(),t.stroke();break;case 3:t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.moveTo(e,s),t.lineTo(e+o,s-o),t.closePath(),t.stroke();break;case 4:t.beginPath(),t.moveTo(e,s),t.lineTo(e+o,s-o),t.moveTo(e,s),t.lineTo(e+o,s+o),t.closePath(),t.stroke()}}}class ${constructor(){this.clientX=0,this.clientY=0,this.snapX=0,this.snapY=0,this.x=0,this.y=0}}class K{constructor(t){this.handlers=[],this.snapToGrid=!0,this.context=t}addHandler(t){t&&this.handlers.push(t)}removeHandler(t){t&&(this.handlers=this.handlers.filter((e=>e!==t)))}onClick(t){for(const e of this.handlers)e.onClick(t)}onKeyDown(t,e){for(const s of this.handlers)s.onKeyDown(t,e)}onMouseDown(t){this.initEvent(t);for(const e of this.handlers)e.onMouseDown(t)}onMouseMove(t){this.initEvent(t);for(const e of this.handlers)e.onMouseMove(t)}onMouseUp(t){this.initEvent(t);for(const e of this.handlers)e.onMouseUp(t)}initEvent(t){const e=this.transformPoint(t.x,t.y),s=this.snapPoint(e);t.snapX=s.x,t.snapY=s.y,t.x=e.x,t.y=e.y}snap(t){return this.snapToGrid?15*Math.round(t/15):t}snapPoint(t){return{x:this.snap(t.x),y:this.snap(t.y)}}transformPoint(t,e){const s=this.context.getTransform(),o=s.e,n=s.f;return{x:t-o/s.a,y:e-n/s.d}}}class J{onCommandActive(t){}onCommandDeActive(t){}}class _{constructor(){}useSnap(){return!0}onClick(t){}onKeyDown(t,e){}onMouseDown(t){}onMouseMove(t){}onMouseUp(t){}}class Q extends s{constructor(t,e){super(),this.points=t??[],this.color=e??"rgb(0, 151, 197, 0.7)"}get type(){return"point-select"}render(t){t.save(),this.renderPoints(t),t.restore()}renderPoints(t){t.fillStyle=this.color;for(const e of this.points)t.circle(e.x,e.y,10),t.fill()}}class Z extends s{constructor(t,e,s){super(),this.segments=t??[],this.thick=e??15,this.color=s??"rgb(0, 151, 197, 0.7)"}get type(){return"segment-select"}render(t){t.save(),this.renderSegments(t),t.restore()}renderSegments(t){if(!(this.segments.length<=0))for(const e of this.segments)e.thick>0&&(t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.closePath(),t.stroke())}}class tt extends s{constructor(t,e,s){super(),this.polygons=t??[],this.thick=e??15,this.color=s??"rgb(0, 151, 197, 0.7)"}get type(){return"polygon-select"}render(t){t.save(),this.renderPolygons(t),t.restore()}renderPolygons(t){if(!(this.polygons.length<=0))for(const e of this.polygons){const{points:s}=e;if(s.length>0){t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let e=1;e<s.length;e++)t.lineTo(s[e].x,s[e].y);t.closePath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.stroke()}}}}class et extends J{constructor(t){super(),this.handler=new st(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class st extends _{constructor(t){super(),this.editor=t,this.hanlders=[],this.canvasmovehandler=new ot(t),this.selectedControl=null,this.started=!1,this.downX=0,this.downY=0}useSnap(){return!1}onKeyDown(t,e){if("Backspace"===t){for(const t of this.editor.floor.walls)t.selected&&this.editor.floor.removeControl(t);this.editor.render()}else if("Escape"===t){this.editor.hideToolbar();for(const t of this.hanlders)t.onCancel();this.editor.render()}}onMouseDown(t){this.started=!0,this.editor.hideToolbar(),this.editor.onSelect(t,null),this.downX=t.x,this.downY=t.y;const e=this.editor.floor;for(const s of e.getAllControls()){const o=s.createPointDragHandler(e,t.snapX,t.snapY);o&&o.length>0&&(this.selectedControl=s,o.forEach((t=>t.editor=this.editor)),this.hanlders.push(...o))}if(0===this.hanlders.length){this.editor.selectControl(null,t.x,t.y);for(const s of e.getAllControls()){const o=s.createMoveDragHandler(e,t.x,t.y);if(o&&o.length>0){o.forEach((t=>t.editor=this.editor)),this.selectedControl=s,this.hanlders.push(...o);break}}}0===this.hanlders.length&&(this.editor.setSelectControls([]),this.editor.selectControl(null,t.x,t.y));for(const s of this.hanlders)s.onDragStart(e,t.x,t.y);0===this.hanlders.length&&this.canvasmovehandler.onDragStart(e,t.clientX,t.clientY),this.editor.render()}onMouseMove(t){const e=new n(t.x,t.y);if(this.started){for(const e of this.hanlders)e.onDrag(t.x,t.y);0===this.hanlders.length&&this.canvasmovehandler.onDrag(t.clientX,t.clientY),this.editor.render()}else for(const t of this.editor.floor.getAllControls()){const s=t.getControlPointAtPoint(e);if(s)return this.editor.setSelectControls([new Q([s])]),void this.editor.render();const o=t.getControlSegmentAtPoint(e);if(o)return this.editor.setSelectControls([new Z([o])]),void this.editor.render();const n=t.getControlPolygonAtPoint(e);if(n)return this.editor.setSelectControls([new tt([n])]),void this.editor.render()}}onMouseUp(t){this.started=!1;for(const e of this.hanlders)e.onDragStop(t.x,t.y);0===this.hanlders.length?(this.editor.onSelect(t,null),this.canvasmovehandler.onDragStop(t.clientX,t.clientY)):(this.editor.onSelect(t,this.selectedControl),this.editor.onChangeFloor({updateRooms:!0})),Math.abs(this.downX-t.x)<2&&Math.abs(this.downY-t.y)<2&&this.editor.showToolbar(t,this.selectedControl),this.selectedControl=null,this.hanlders=[],this.editor.setSelectControls([]),this.editor.render()}}class ot extends u{constructor(t){super(),this.editor=t,this.startX=0,this.startY=0,this.started=!1}onDragStart(t,e,s){this.startX=e,this.startY=s,this.started=!0}onDrag(t,e){if(this.started){if(this.editor){const s=t-this.startX,o=e-this.startY;this.editor.translate(s,o)}this.startX=t,this.startY=e}}onDragStop(t,e){this.started=!1}}class nt extends J{constructor(t,e){super(),this.handler=new it(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class it extends _{constructor(t,e){super(),this.editor=t,this.control=new rt,this.started=!1,this.clear=e}onMouseDown(t){this.started=!0,this.control.initialize(t.snapX,t.snapY),this.editor.floor.addForegroundControl(this.control)}onMouseMove(t){this.started&&(this.control.move(t.snapX,t.snapY),this.editor.render())}onMouseUp(t){const e=this.editor.floor;if(e.removeForegroundControl(this.control),this.started){if(this.clear){const t=this.control.rect;e.cuttingRect(t.x,t.y,t.width,t.height)}for(const t of this.control.rect.segments())this.createWall(t);this.editor.render()}this.started=!1,this.editor.tools.select(),this.editor.onChangeFloor({updateRooms:!0})}createWall(t){let e=new P(new n(t.x1,t.y1),new n(t.x2,t.y2));e=this.editor.onCreate(e),e&&this.editor.floor.walls.push(e)}}class rt extends s{constructor(){super(),this.rect=new h,this.widthRuler=new m(this.start,this.end),this.heightRuler=new m(this.start,this.end)}initialize(t,e){this.rect.x=t,this.rect.y=e,this.rect.width=0,this.rect.height=0}move(t,e){this.rect.width=t-this.rect.x,this.rect.height=e-this.rect.y}render(t){t.save(),t.beginPath(),t.lineWidth=10,t.strokeStyle=g.activeColor,t.rect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),t.stroke(),t.closePath(),this.renderWidthRuler(t),this.renderHeightRuler(t),t.restore()}renderWidthRuler(t){this.widthRuler.start=this.rect.getTopLeftPoint(),this.widthRuler.end=this.rect.getTopRightPoint(),this.widthRuler.render(t)}renderHeightRuler(t){this.heightRuler.start=this.rect.getTopRightPoint(),this.heightRuler.end=this.rect.getBottomRightPoint(),this.heightRuler.render(t)}}class ht extends s{constructor(){super(),this.point=new n(0,0),this.wall=null}get type(){return"wall-position-indicator"}render(t){if(this.wall){this.thick;const e=o.radianInPoint(this.wall.start,this.wall.end),s=new n(0,-this.wall.thick),i=new n(0,this.wall.thick);t.save(),t.translate(this.point.x,this.point.y),t.rotate(e),t.strokeStyle=g.activeColor,t.fillStyle=g.activeColor,t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(i.x,i.y),t.stroke(),t.arrow(s.x,s.y,8,"down"),t.arrow(i.x,i.y,8,"up"),t.restore()}}}class at extends J{constructor(t){super(),this.handler=new lt(t,{minimumLength:20})}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class lt extends _{constructor(t,e){super(),this.config=e,this.ruler=null,this.editor=t,this.segment=null,this.window=null,this.indicator=new ht,this.editor.setSelectControls([this.indicator])}onMouseDown(t){if(this.segment=this.editor.floor.getSegmentAtPoint({x:t.x,y:t.y}),!this.segment)return;const e=this.segment.getClosestPoint(t.x,t.y);this.window=new W(new n(e.x,e.y),new n(e.x,e.y)),this.ruler=new m(this.segment.start,this.segment.end),this.ruler.addPoint(this.window.start),this.ruler.addPoint(this.window.end),this.editor.setSelectControls([this.ruler])}onMouseMove(t){this.window?this.updateWindow(t.x,t.y):this.updateIndicator(t.x,t.y)}onMouseUp(t){this.window&&(this.editor.setSelectControls([]),this.window.length>this.config.minimumLength&&this.editor.floor.windows.push(this.window),this.segment=null,this.window=null,this.editor.render(),this.editor.tools.select(),this.editor.onChangeFloor())}updateWindow(t,e){const s=this.segment.getClosestPoint(t,e);this.segment.isPointInSegment(s)&&(this.window.end.x=s.x,this.window.end.y=s.y,this.editor.render(),this.window.render(this.editor.context))}updateIndicator(t,e){const s=this.editor.floor.getSegmentAtPoint({x:t,y:e});if(!s)return;const o=s.getClosestPoint(t,e);this.indicator.wall=this.segment,this.indicator.point.x=o.x,this.indicator.point.y=o.y,this.editor.render()}}class ct extends J{constructor(t){super(),this.handler=new dt(t,{minimumLength:20})}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class dt extends _{constructor(t,e){super(),this.editor=t,this.config=e,this.ruler=null,this.segment=null,this.door=null,this.indicator=new ht,this.editor.setSelectControls([this.indicator])}onMouseDown(t){if(this.segment=this.editor.floor.getSegmentAtPoint({x:t.x,y:t.y}),!this.segment)return;const e=this.segment.getClosestPoint(t.x,t.y);this.door=new O(new n(e.x,e.y),new n(e.x,e.y)),this.ruler=new m(this.segment.start,this.segment.end),this.ruler.addPoint(this.door.start),this.ruler.addPoint(this.door.end),this.editor.setSelectControls([this.ruler])}onMouseMove(t){this.door?this.updateDoor(t.x,t.y):this.updateIndicator(t.x,t.y)}onMouseUp(t){this.door&&(this.editor.setSelectControls([]),this.door.length>this.config.minimumLength&&this.editor.floor.doors.push(this.door),this.wall=null,this.door=null,this.render=null,this.editor.render(),this.editor.tools.select(),this.editor.onChangeFloor())}updateDoor(t,e){const s=this.segment.getClosestPoint(t,e);this.segment.isPointInSegment(s)&&(this.door.end.x=s.x,this.door.end.y=s.y,this.editor.render(),this.door.render(this.editor.context))}updateIndicator(t,e){}}class ut extends J{constructor(t){super(),this.handler=new gt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class gt extends _{constructor(t){super(),this.editor=t,this.control=new mt(this),this.started=!0,this.start=new n(0,0),this.end=new n(0,0),this.cuttings=[]}onMouseDown(t){this.started=!0,this.start.x=t.x,this.start.y=t.y,this.end.x=t.x,this.end.y=t.y,this.editor.setSelectControls([this.control])}onMouseMove(t){this.end.x=t.x,this.end.y=t.y,this.started&&(this.createCutting(),this.editor.render())}onMouseUp(t){if(this.started){for(const t of this.cuttings)t.wall.cutting(this.editor.floor,t.point.x,t.point.y);this.started=!1,this.editor.render(),this.editor.tools.select(),this.cuttings=[]}this.editor.setSelectControls([])}createCutting(){this.cuttings=[];for(const t of this.editor.floor.walls){const e=o.interceptPoint(this.start.x,this.start.y,this.end.x,this.end.y,t.start.x,t.start.y,t.end.x,t.end.y);e&&this.cuttings.push({point:e,wall:t})}}}class mt{constructor(t){this.handler=t}render(t){t.save(),this.renderLine(t),this.renderCuttings(t),t.restore()}renderLine(t){t.lineWidth=1,t.strokeStyle=g.Colors.Red50,t.beginPath(),t.setLineDash([5,10]),t.moveTo(this.handler.start.x,this.handler.start.y),t.lineTo(this.handler.end.x,this.handler.end.y),t.closePath(),t.stroke(),t.setLineDash([])}renderCuttings(t){for(const e of this.handler.cuttings)t.fillStyle=g.Colors.Red50,t.beginPath(),t.arc(e.point.x,e.point.y,10,0,2*Math.PI),t.closePath(),t.fill()}}class pt extends J{constructor(t){super(),this.handler=new ft(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class ft extends _{constructor(t){super(),this.editor=t,this.creator=new yt,this.started=!1}onMouseDown(t){this.started=!0,this.creator.start.x=t.snapX,this.creator.start.y=t.snapY,this.editor.floor.addForegroundControl(this.creator)}onMouseMove(t){this.started&&(this.creator.end.x=t.snapX,this.creator.end.y=t.snapY,this.editor.render())}onMouseUp(t){if(this.started){const e=t.snapX,s=t.snapY;if(o.distance(this.creator.start.x,this.creator.start.y,e,s)>10){let t=new P(new n(this.creator.start.x,this.creator.start.y),new n(e,s));t=this.editor.onCreate(t),t&&this.editor.floor.walls.push(t)}this.editor.floor.removeForegroundControl(this.creator),this.editor.render(),this.editor.tools.select(),this.editor.onChangeFloor({updateRooms:!0})}this.started=!1}}class yt extends s{constructor(){super(),this.start=new n(0,0),this.end=new n(0,0),this.ruler=new m(this.start,this.end)}render(t){t.lineWidth=10,t.strokeStyle="#0097c5",t.line(this.start.x,this.start.y,this.end.x,this.end.y),this.ruler.render(t)}}class xt{static createLine(t){return(e,s,o,n)=>{t.beginPath(),t.moveTo(e,s),t.lineTo(o,n),t.closePath(),t.stroke()}}static createText(t){return(e,s,o)=>{const n=t.measureText(o).width;t.fillText(o,e-n/2,s)}}static createCircle(t){return(e,s,o)=>{t.beginPath(),t.arc(e,s,o,0,2*Math.PI),t.closePath()}}static createArrow(t){return(e,s,o,n)=>{switch(n){case"up":t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s+o),t.lineTo(e+o,s+o),t.closePath(),t.fill();break;case"right":t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.lineTo(e-o,s+o),t.closePath(),t.fill();break;case"down":t.beginPath(),t.moveTo(e,s),t.lineTo(e-o,s-o),t.lineTo(e+o,s-o),t.closePath(),t.fill();break;case"left":t.beginPath(),t.moveTo(e,s),t.lineTo(e+o,s-o),t.lineTo(e+o,s+o),t.closePath(),t.fill()}}}}class wt extends s{constructor(){super(),this.start=null,this.end=null,this.thick=10}render(t){this.start&&this.end&&(t.lineWidth=this.thick,t.strokeStyle="rgba(255, 59, 48, 0.7)",t.line(this.start.x,this.start.y,this.end.x,this.end.y),t.circle(this.start.x,this.start.y,10),t.circle(this.end.x,this.end.y,10))}}class Ct extends J{constructor(t){super(),this.handler=new vt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class vt extends _{constructor(t){super(),this.editor=t,this.control=null}useSnap(){return!1}onMouseDown(t){const e=this.findEraseControl(t.x,t.y);e&&(this.editor.floor.removeControl(e),this.hideControl(),this.editor.onChangeFloor({updateRooms:!0}))}onMouseMove(t){const e=this.findEraseControl(t.x,t.y);e?this.showControl(e.start,e.end):this.hideControl()}showControl(t,e){this.control||(this.control=new wt,this.editor.setSelectControls([this.control])),this.control.start===t&&this.control===e||(this.control.start=t,this.control.end=e,this.editor.render())}hideControl(){this.control&&(this.editor.setSelectControls([]),this.control=null,this.editor.render())}findEraseControl(t,e){const s=this.editor.floor.getControlsOnCoordinates(t,e);if(0===s.length)return null;if(1===s.length)return s[0];for(const t of s)if("wall"!==t.type)return t;return null}}class Pt extends J{constructor(t,e){super(),this.editor=t,this.scale=e}onCommandActive(t){this.editor.scale+=this.scale,this.editor.context.setTransform(this.editor.scale,0,0,this.editor.scale,0,0),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class bt extends J{constructor(t){super(),this.editor=t}onCommandActive(t){this.editor.floor.clear(),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class St extends s{constructor(t){super(),this.segments=t??[]}get type(){return"outline"}addSegment(t){t&&this.segments.push(t)}render(t){this.segments.length<=0||(t.save(),this.renderLines(t,10,"#000000"),t.restore())}renderLines(t,e,s){for(const o of this.segments)t.lineWidth=e,t.strokeStyle=s,t.beginPath(),t.moveTo(o.start.x,o.start.y),t.lineTo(o.end.x,o.end.y),t.closePath(),t.stroke()}renderText(t){t.font="30px bold Arial",t.fillStyle="red",this.segments.forEach(((e,s)=>{const o=(e.start.x+e.end.x)/2,n=(e.start.y+e.end.y)/2;t.text(o,n,`${s}`)}))}renderBackground(t){t.beginPath(),t.moveTo(this.segments[0].x,this.segments[0].y),this.segments.forEach(((e,s)=>{s>0&&t.lineTo(e.end.x,e.end.y)})),t.closePath();const e=this.createPinstripeCanvas();t.fillStyle=t.createPattern(e,"repeat"),t.fill()}fillWithPattern(t,e){const s=t.getContext("2d",{antialias:!1,depth:!1}),o=t.width,n=t.height;if(!o||!n)throw new Error("progressCanvas's width/height falsy.");return s.fillStyle=s.createPattern(e,"repeat"),s.fillRect(0,0,o,n),t}createPinstripeCanvas(){const t=document.createElement("canvas"),e=t.getContext("2d",{antialias:!0}),s=90,o=90;return t.width=s,t.height=o,e.fillStyle="#B4645D",e.beginPath(),e.moveTo(0,22.5),e.lineTo(22.5,0),e.lineTo(0,0),e.lineTo(0,22.5),e.fill(),e.beginPath(),e.moveTo(s,22.5),e.lineTo(22.5,o),e.lineTo(0,o),e.lineTo(0,67.5),e.lineTo(67.5,0),e.lineTo(s,0),e.lineTo(s,22.5),e.fill(),e.beginPath(),e.moveTo(s,67.5),e.lineTo(67.5,o),e.lineTo(s,o),e.lineTo(s,67.5),e.fill(),t}}class At{static importData(t,e,s){(new Et).importData(t,e,new Tt(s))}static exportData(t){}}class Tt{constructor(t){this.config=t,this.defaultRoomFillColor="rgba(131,208,221,0.5)",this.create={room:!0,wall:!0,door:!0,window:!0},t.create&&(this.create.room=t.create.room??!0,this.create.wall=t.create.wall??!0,this.create.door=t.create.door??!0,this.create.window=t.create.window??!0)}getScale(){return this.config.scale??4}getRoomFillColor(t){return this.config&&this.config.room&&this.config.room.colors&&this.config.room.colors.length>t?this.config.room.colors[t]:this.defaultRoomFillColor}isCreateDoor(){return this.create.door}isCreateWindow(){return this.create.window}isCreateWall(){return this.create.wall}isCreateRoom(){return this.create.room}getWallThick(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.thick?e.thick:1}getWallColor(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.color?e.color:"#000000"}getRoomColor(t){const{themes:e}=this.config,s=e?.room.find((e=>e.category===t));return s?.color??null}getRoomLabel(t){const{themes:e}=this.config,s=e?.room.find((e=>e.category===t));return s?.label??null}}class Et{constructor(){this.scale=4}importData(t,e,s){this.scale=s.getScale();for(const o of e)"SPA"===o.type&&this.importSPA(t,o.categories,s);for(const o of e)"STR"===o.type&&this.importSTR(t,o.categories,s)}importSTR(t,e,s){for(const o of e)0!==o.category&&1!==o.category&&2!==o.category&&3!==o.category||this.importObjectFromSTR(t,o.category,o.objects,s)}importObjectFromSTR(t,e,s,i){const r=new St;for(const h of s){if("line"===h.type){const s=h.data[0][0],a=h.data[0][1],c=h.data[1][0],d=h.data[1][1],u=new n(s*this.scale,a*this.scale),g=new n(c*this.scale,d*this.scale);o.distance(u.x,u.y,g.x,g.y);if(0!==e&&1!==e||!i.isCreateWall()){if(3===e&&i.isCreateDoor()){const e=new O(u,g);e.hidge=h.hinge??"start",e.direction=h.direction??"right",t.doors.push(e)}else if(2===e&&i.isCreateWindow()){const e=new W(u,g);t.windows.push(e)}}else 0===e&&r.addSegment(new l(u,g))}h.type}t.outlines.push(r)}importSPA(t,e,s){for(const o of e)11!==o.category&&this.importObjectFromSPA(t,o.category,o.objects,s)}importObjectFromSPA(t,e,s,o){for(const i of s)if("Polygon"===i.type&&o.isCreateRoom()){const s=[];for(const t of i.data)s.push(new n(t[0]*this.scale,t[1]*this.scale));const r=new M(s,"");r&&(r.label=o.getRoomLabel(e),r.fillColor=o.getRoomColor(e),t.rooms.push(r))}}}class Mt extends J{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.history.index;e>0&&e-1>0&&(t.floor.load(JSON.parse(t.history.data[e-1])),t.history.index--,t.render()),this.editor.tools.select()}onCommandDeActive(t){}}class Dt extends J{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.history.index;e<t.history.data.length&&(t.floor.load(JSON.parse(t.history.data[e])),t.history.index++,t.render()),this.editor.tools.select()}onCommandDeActive(t){}}class Rt extends J{constructor(t,e){super(),this.handler=new Bt(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Bt extends _{constructor(t,e){super(),this.editor=t,this.control=new Ft,this.started=!1,this.config=e}onMouseDown(t){this.started=!0,this.control.initialize(t.snapX,t.snapY),this.editor.setSelectControls([this.control])}onMouseMove(t){this.started&&(this.control.move(t.snapX,t.snapY),this.editor.render())}onMouseUp(t){if(this.editor.setSelectControls([]),this.started){const t=new M(this.control.rect.points(),"");this.config&&(t.label=this.config.label,t.fillColor=this.config.color,t.category=this.config.category),this.editor.floor.rooms.push(t),this.editor.render()}this.started=!1,this.editor.tools.select(),this.editor.onChangeFloor({updateRooms:!0})}}class Ft extends s{constructor(){super(),this.rect=new h,this.widthRuler=new m(this.start,this.end),this.heightRuler=new m(this.start,this.end)}initialize(t,e){this.rect.x=t,this.rect.y=e,this.rect.width=0,this.rect.height=0}move(t,e){this.rect.width=t-this.rect.x,this.rect.height=e-this.rect.y}render(t){t.save(),t.beginPath(),t.lineWidth=10,t.strokeStyle=g.activeColor,t.rect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),t.stroke(),t.closePath(),this.renderWidthRuler(t),this.renderHeightRuler(t),t.restore()}renderWidthRuler(t){this.widthRuler.start=this.rect.getTopLeftPoint(),this.widthRuler.end=this.rect.getTopRightPoint(),this.widthRuler.render(t)}renderHeightRuler(t){this.heightRuler.start=this.rect.getTopRightPoint(),this.heightRuler.end=this.rect.getBottomRightPoint(),this.heightRuler.render(t)}}class Ht extends J{constructor(t){super()}onCommandActive(t){t.floor.rooms=[],t.render(),t.tools.select()}onCommandDeActive(t){}}class kt extends J{constructor(t){super()}onCommandActive(t){const e=new Y;t.floor.buildGraph(e),t.floor.createRooms(t),t.addSelectControls([new It(e)]),t.render(),t.tools.select()}onCommandDeActive(t){}}class It extends s{constructor(t){super(),this.graph=t}get type(){return"point-select"}render(t){t.save();for(const e of this.graph.vertices)this.renderVertex(t,e);t.restore()}renderVertex(t,e){t.fillStyle=g.activeColor,t.circle(e.x,e.y,10),t.fill(),t.font="12px bold Arial",t.fillStyle="black",t.text(e.x,e.y,`${e.edges.length}`),this.closestVertex&&(t.fillStyle="blue",t.circle(this.closestVertex.x,this.closestVertex.y,10),t.fill())}}class Ot{constructor(t,e,s){this.editor=t,this.control=null,this.document=e,this.createChangeRoomToolbar(s),this.createCreateRoomToolbar(s),this.createColorToolbar(s),this.createLineToolbar(s),this.createMainContextToolbar(s),this.createWallToolbar(s),this.createDoorToolbar(s),this.createWindowToolbar(s),this.createRoomToolbar(s)}createChangeRoomToolbar(t){this.toolbarChangeRoom=this.createToolbar(this.document),[{category:0,label:"다목적공간",color:"#d83d1b"},{category:12,label:"거실",color:"#ec9126"},{category:13,label:"침실",color:"#e9ba1f"},{category:14,label:"주방",color:"#1c8a4f"},{category:15,label:"현관",color:"#0e88e0"},{category:16,label:"발코니",color:"#8639eb"},{category:17,label:"화장실",color:"#f5bfbb"},{category:19,label:"드레스룸",color:"#f2c997"},{category:21,label:"기타",color:"#f3df9e"}].forEach((t=>{const e=this.createLabelButton(this.document,t.label,(()=>{this.changeColor(t.color),this.changeLabel(t.label),this.editor.render(),this.hide()}));e.style.backgroundColor=t.color,this.addButtonToToolbar(this.toolbarChangeRoom,e)})),this.document.body.appendChild(this.toolbarChangeRoom)}createCreateRoomToolbar(t){this.toolbarCreateRoom=this.createToolbar(this.document),[{category:0,label:"다목적공간",color:"#d83d1b"},{category:12,label:"거실",color:"#ec9126"},{category:13,label:"침실",color:"#e9ba1f"},{category:14,label:"주방",color:"#1c8a4f"},{category:15,label:"현관",color:"#0e88e0"},{category:16,label:"발코니",color:"#8639eb"},{category:17,label:"화장실",color:"#f5bfbb"},{category:19,label:"드레스룸",color:"#f2c997"},{category:21,label:"기타",color:"#f3df9e"}].forEach((t=>{const e=this.createLabelButton(this.document,t.label,(()=>{this.editor.tools.createRoom(t),this.hide()}));e.style.backgroundColor=t.color,this.addButtonToToolbar(this.toolbarCreateRoom,e)})),this.document.body.appendChild(this.toolbarCreateRoom)}createColorToolbar(t){this.toolbarColor=this.createToolbar(this.document);(t?.color??["#716a6c80","#d83d1b80","#ec912680","#1c8a4f80","#0082d180"]).forEach((t=>{this.addButtonToToolbar(this.toolbarColor,this.createColorButton(this.document,`${t}`,(()=>{this.changeColor(t),this.hideColorToolbar(),this.editor.render(),this.hide()})))})),this.document.body.appendChild(this.toolbarColor)}createLineToolbar(t){this.toolbarLine=this.createToolbar(this.document);(t?.thick??[1,5,10]).forEach((t=>{this.addButtonToToolbar(this.toolbarLine,this.createThickButton(this.document,t,(()=>{this.changeLine(t),this.hideLineToolbar(),this.editor.render(),this.hide()})))})),this.document.body.appendChild(this.toolbarLine)}createMainContextToolbar(t){this.toolbarMainContext=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarMainContext,this.createRoomCreateButton(this.document,(()=>{this.showSubToolbar(this.toolbarMainContext,this.toolbarCreateRoom)}))),this.addButtonToToolbar(this.toolbarMainContext,this.createWindowCreateButton(this.document,(()=>{this.editor.tools.createWindow()}))),this.addButtonToToolbar(this.toolbarMainContext,this.createDoorCreateButton(this.document,(()=>{this.editor.tools.createDoor()}))),this.document.body.appendChild(this.toolbarMainContext)}createWallToolbar(t){this.toolbarWall=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarWall,this.createRemoveButton(this.document,(()=>{this.editor.floor.removeControl(this.getControl()),this.editor.setSelectControls([]),this.editor.render(),this.hide()}))),this.addButtonToToolbar(this.toolbarWall,this.createLineChoiceButton(this.document,(()=>{this.showLineToolbar(this.toolbarWall)}))),this.document.body.appendChild(this.toolbarWall)}createDoorToolbar(t){this.toolbarDoor=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarDoor,this.createRemoveButton(this.document,(()=>{this.editor.setSelectControls([]),this.editor.floor.removeControl(this.getControl()),this.editor.render(),this.hide()}))),this.document.body.appendChild(this.toolbarDoor)}createWindowToolbar(t){this.toolbarWindow=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarWindow,this.createRemoveButton(this.document,(()=>{this.editor.floor.removeControl(this.getControl()),this.editor.setSelectControls([]),this.editor.render(),this.hide()}))),this.document.body.appendChild(this.toolbarWindow)}increase(t,e){return t=parseFloat(t),isNaN(t)?t:t+e}createRoomToolbar(t){this.toolbarRoom=this.createToolbar(this.document),this.addButtonToToolbar(this.toolbarRoom,this.createRemoveButton(this.document,(()=>{this.editor.floor.removeControl(this.getControl()),this.editor.setSelectControls([]),this.editor.render(),this.hide()}))),this.addButtonToToolbar(this.toolbarRoom,this.createDuplicateButton(this.document,(()=>{this.editor.tools.duplicate([this.getControl().duplicate()]),this.editor.render(),this.hide()}))),this.addButtonToToolbar(this.toolbarRoom,this.createRoomChoiceButton(this.document,(()=>{this.showSubToolbar(this.toolbarRoom,this.toolbarChangeRoom)}))),this.addButtonToToolbar(this.toolbarRoom,this.createLineChoiceButton(this.document,(()=>{this.showLineToolbar(this.toolbarRoom)}))),this.addButtonToToolbar(this.toolbarRoom,this.createColorChoiceButton(this.document,(()=>{this.showColorToolbar(this.toolbarRoom)}))),this.addButtonToToolbar(this.toolbarRoom,this.createTransparentButton(this.document,(()=>{this.changeTransparent(),this.editor.render()}))),this.addButtonToToolbar(this.toolbarRoom,this.createRoomAreaText(this.document,"2000 ㎡","room-area")),this.document.body.appendChild(this.toolbarRoom)}hide(){this.getAllToolbar().forEach((t=>{t.style.display="none"}))}show(t,e,s){this.control=s,this.x=t,this.y=e;let o=null;if(s){if("wall"===s.type)o=this.toolbarWall;else if("door"===s.type)o=this.toolbarDoor;else if("window"===s.type)o=this.toolbarWindow;else if("room"===s.type){const i=s.getSegmentContainingPoint(new n(t,e));if(i)this.control=i,o=this.toolbarWall;else{o=this.toolbarRoom;let t=o.querySelectorAll("#room-area");if(t&&t.length>0){const e=this.control.polygon.calculateArea(),s=4e-4;t[0].textContent=`${Math.floor(e*s)} ㎡`}t=o.querySelectorAll("#room-label"),t&&t.length>0&&(t[0].textContent=this.control.label)}}}else o=this.toolbarMainContext;if(o){o.style.display="flex";const s=o.offsetWidth/2,n=o.offsetHeight/2;o.style.left=t-s+"px",o.style.top=e-(n+50)+"px"}this.getAllToolbar().filter((t=>t!==o)).forEach((t=>{t.style.display="none"}))}showColorToolbar(t){this.hideLineToolbar();const{style:e}=this.toolbarColor;e.display="flex",e.left=t.style.left,e.top=`${this.increase(t.style.top,-60)}px`}hideColorToolbar(){this.toolbarColor.style.display="none"}showToolbar(t,e,s){this.getAllToolbar().forEach((t=>{t.style.display="none"})),s.style.display="flex",s.style.left=t,s.style.top=e}showLineToolbar(t){this.hideColorToolbar();const{style:e}=this.toolbarLine;e.display="flex",e.left=t.style.left,e.top=`${this.increase(t.style.top,-60)}px`}showLabelToolbar(t){}showSubToolbar(t,e){const{style:s}=e;s.display="flex",s.left=t.style.left,s.top=`${this.increase(t.style.top,-60)}px`}hideLineToolbar(){this.toolbarLine.style.display="none"}addButtonToToolbar(t,e,s){e&&(s&&(t.id=s),t.appendChild(e))}getControl(){return this.control}createToolbar(t){const e=t.createElement("div");return Object.assign(e.style,{display:"flex",position:"absolute","flex-direction":"row",background:"#1f1f1f",boxShadow:"5px 5px 10px rgba(0, 0, 0, 0.5)",borderRadius:"10px",textAlign:"center",cursor:"pointer","align-items":"center",zIndex:9999}),e}createRemoveButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const n=t.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("viewBox","0 0 448 512");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("fill","#ffffff"),i.setAttribute("d","M135.2 17.7C140.6 6.8 151.7 0 163.8 0H284.2c12.1 0 23.2 6.8 28.6 17.7L320 32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 96 0 81.7 0 64S14.3 32 32 32h96l7.2-14.3zM32 128H416V448c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V128zm96 64c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16z"),n.appendChild(i),o.appendChild(n),s.appendChild(o),s}createDuplicateButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const n=t.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("viewBox","0 0 448 512");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("fill","#ffffff"),i.setAttribute("d","M384 336H192c-8.8 0-16-7.2-16-16V64c0-8.8 7.2-16 16-16l140.1 0L400 115.9V320c0 8.8-7.2 16-16 16zM192 384H384c35.3 0 64-28.7 64-64V115.9c0-12.7-5.1-24.9-14.1-33.9L366.1 14.1c-9-9-21.2-14.1-33.9-14.1H192c-35.3 0-64 28.7-64 64V320c0 35.3 28.7 64 64 64zM64 128c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64H256c35.3 0 64-28.7 64-64V416H272v32c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16H96V128H64z"),n.appendChild(i),o.appendChild(n),s.appendChild(o),s}createRoomAreaText(t,e){const s=t.createElement("p");return s.id="room-area",Object.assign(s.style,{display:"block",color:"#fff",padding:"5px",margin:"5px"}),s.textContent=e,s}createTextButton(t,e,s){const o=t.createElement("p");return Object.assign(o.style,{display:"block",color:"#fff",padding:"5px",margin:"5px"}),o.textContent=e,o.onclick=s,o}createColorChoiceButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");return Object.assign(o.style,{display:"block",background:"radial-gradient(50% 50% at 50% 50%,#ffffff 0%,transparent 100%),conic-gradient(from 0deg at 50% 50%,#ff0000 0deg,#ffa800 47.73deg,#ffff00 79.56deg,#00ff00 121.33deg,#00ffff 180.99deg,#0000ff 238.67deg,#ff00ff 294.36deg,#ff0000 360deg),#c4c4c4",width:"25px",height:"25px",borderRadius:"50%"}),s.appendChild(o),s}createButtonContainer(t,e){const s=t.createElement("div");let o=null;return s.addEventListener("mouseenter",(()=>{o=s.style.backgroundColor,s.style.backgroundColor="#ffffff80"})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor=o})),s.onclick=e,Object.assign(s.style,{display:"flex",flexDirection:"row","align-items":"center",width:"25px",height:"25px",borderRadius:"50px",cursor:"pointer",padding:"5px",margin:"5px",overflow:"hidden"}),s}createRoomChoiceButton(t,e){const s=this.createButtonContainer(t,e),o=this.createTextButton(t,"발코니");return s.style.width="100px",o.id="room-label",s.appendChild(o),s}createRoomCreateButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const n=t.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("viewBox","0 0 448 512");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("fill","#ffffff"),i.setAttribute("d","M384 80c8.8 0 16 7.2 16 16V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16H384zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64z"),n.appendChild(i),o.appendChild(n),s.appendChild(o),s}createWindowCreateButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const n=t.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("viewBox","0 0 512 512");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("fill","#ffffff"),i.setAttribute("d","M.3 89.5C.1 91.6 0 93.8 0 96V224 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64V224 96c0-35.3-28.7-64-64-64H64c-2.2 0-4.4 .1-6.5 .3c-9.2 .9-17.8 3.8-25.5 8.2C21.8 46.5 13.4 55.1 7.7 65.5c-3.9 7.3-6.5 15.4-7.4 24zM48 224H464l0 192c0 8.8-7.2 16-16 16L64 432c-8.8 0-16-7.2-16-16l0-192z"),n.appendChild(i),o.appendChild(n),s.appendChild(o),s}createDoorCreateButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const n=t.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("viewBox","0 0 576 512");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("fill","#ffffff"),i.setAttribute("d","M96 64c0-35.3 28.7-64 64-64H416c35.3 0 64 28.7 64 64V448h64c17.7 0 32 14.3 32 32s-14.3 32-32 32H432 144 32c-17.7 0-32-14.3-32-32s14.3-32 32-32H96V64zM384 288a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"),n.appendChild(i),o.appendChild(n),s.appendChild(o),s}createLineChoiceButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",padding:"5px",borderRadius:"50%"});const n=t.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("viewBox","0 0 12 12");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("fill","#ffffff"),i.setAttribute("fill-opacity","1"),i.setAttribute("fill-rule","nonzero"),i.setAttribute("stroke","none"),i.setAttribute("d","M0 0h12v1H0V0zm0 4h12v2H0V4zm12 5H0v3h12V9z"),n.appendChild(i),o.appendChild(n),s.appendChild(o),s}createColorButton(t,e,s){const o=this.createButtonContainer(t,s),n=t.createElement("div");return Object.assign(n.style,{display:"block",background:`${e}`,width:"25px",height:"25px",borderRadius:"50%"}),o.appendChild(n),o}createLabelButton(t,e,s){const o=this.createButtonContainer(t,s);o.style.width=null;const n=t.createElement("p");return Object.assign(n.style,{display:"block",color:"#fff",padding:"5px",margin:"5px",whiteSpace:"nowrap"}),n.textContent=e,o.appendChild(n),o}createTransparentButton(t,e){const s=this.createButtonContainer(t,e),o=t.createElement("div");Object.assign(o.style,{display:"block",width:"25px",height:"25px",borderRadius:"50%"});const n=t.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("class","svg"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("viewBox","1.5 1.5 14 14");const i=t.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("fill","#fff"),i.setAttribute("fill-opacity","1"),i.setAttribute("fill-rule","nonzero"),i.setAttribute("stroke","none"),i.setAttribute("d","M13.35 13.45c-.65.65-1.422 1.166-2.272 1.517-.85.352-1.76.533-2.679.533-.919 0-1.83-.18-2.678-.533-.85-.351-1.621-.867-2.271-1.517-.65-.65-1.166-1.422-1.518-2.271-.352-.85-.533-1.76-.533-2.679 0-.92.181-1.83.533-2.679.352-.849.868-1.62 1.518-2.27L8.4 8.5l4.95 4.949zm-9.9-9.9c.65-.65 1.42-1.166 2.27-1.517C6.57 1.68 7.48 1.5 8.4 1.5c.919 0 1.829.18 2.678.533.85.351 1.621.867 2.271 1.517.65.65 1.166 1.422 1.518 2.271.351.85.532 1.76.532 2.679 0 .92-.18 1.83-.532 2.679-.352.849-.868 1.62-1.518 2.27l-.71-.709c.558-.556 1-1.218 1.3-1.945.302-.728.457-1.508.457-2.295 0-.788-.155-1.567-.456-2.295-.301-.728-.743-1.389-1.3-1.946-.557-.556-1.218-.998-1.946-1.3-.727-.3-1.507-.456-2.295-.456-.787 0-1.567.155-2.294.456-.728.302-1.39.744-1.946 1.3l-.71-.709z"),n.appendChild(i),o.appendChild(n),s.appendChild(o),s}createThickButton(t,e,s){const o=this.createButtonContainer(t,s),n=t.createElement("div");return n.onclick=s,Object.assign(n.style,{display:"block",background:"white",width:"30px",height:`${e}px`,cursor:"pointer",overflow:"hidden"}),o.appendChild(n),o}getAllToolbar(){return[this.toolbarMainContext,this.toolbarWall,this.toolbarDoor,this.toolbarWindow,this.toolbarRoom,this.toolbarColor,this.toolbarLine,this.toolbarChangeRoom,this.toolbarCreateRoom]}changeLine(t){this.control&&("room"===this.control.type?this.control.segments.forEach((e=>e.thick=t)):this.control.thick=t)}changeColor(t){this.control&&"room"===this.control.type&&(this.control.fillColor=t)}changeLabel(t){this.control&&"room"===this.control.type&&(this.control.label=t)}changeTransparent(){this.control&&"room"===this.control.type&&(this.control.transparent=!this.control.transparent)}}class qt extends J{constructor(t,e){super(),this.handler=new Wt(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Wt extends _{constructor(t,e){super(),this.editor=t,this.control=new Xt,e&&(this.control.thick=e.thick??10),this.started=!1,this.start=new n(0,0),this.end=new n(0,0)}onKeyDown(t,e){"Escape"===t&&(this.editor.setSelectControls([]),this.started=!1,this.editor.tools.select(),this.editor.render())}onMouseDown(t){this.started=!0,this.editor.setSelectControls([this.control]),this.start.x=t.x,this.start.y=t.y}onMouseMove(t){if(this.started){this.end.x=t.x,this.end.y=t.y;const e=t=>{const e=Math.min(this.start.x,this.end.x),s=Math.max(this.start.x,this.end.x),o=Math.min(this.start.y,this.end.y),n=Math.max(this.start.y,this.end.y);return t.x>=e&&t.x<=s&&t.y>=o&&t.y<=n};this.control.start=this.start,this.control.end=this.end,this.control.segments=[];for(const t of this.editor.floor.getSegments())e(t.start)&&e(t.end)&&this.control.segments.push(t);this.editor.render()}}onMouseUp(t){if(this.editor.setSelectControls([]),this.started){for(const t of this.control.segments)t.thick=10;this.editor.render()}this.started=!1}}class Xt extends s{constructor(){super(),this.segments=[],this.thick=15,this.color="rgb(0, 151, 197, 0.7)",this.start=null,this.end=null}render(t){t.save(),this.renderSegments(t),this.renderRectangle(t),t.restore()}renderSegments(t){if(!(this.segments.length<=0))for(const e of this.segments)e.thick>0&&(t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.closePath(),t.stroke())}renderRectangle(t){const e=Math.min(this.start.x,this.end.x),s=Math.max(this.start.x,this.end.x),o=Math.min(this.start.y,this.end.y),n=Math.max(this.start.y,this.end.y);t.beginPath(),t.lineWidth=1,t.strokeStyle="#ff0000",t.rect(e,o,s-e,n-o),t.closePath(),t.stroke()}}class Yt extends J{constructor(t){super(),this.handler=new Vt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Vt extends _{constructor(t){super(),this.editor=t,this.control=new zt,this.segment=new Lt,this.started=!1,this.start=new n(0,0),this.end=new n(0,0)}onKeyDown(t,e){"Escape"===t&&this.finishAndCreateRooms()}onMouseDown(t){this.started=!0,this.editor.setSelectControls([this.control,this.segment]),0===this.control.segments.length&&(this.segment.start.x=t.snapX,this.segment.start.y=t.snapY,this.segment.end.x=t.snapX,this.segment.end.y=t.snapY)}onMouseMove(t){this.segment.end.x=t.snapX,this.segment.end.y=t.snapY,this.editor.render()}onMouseUp(t){this.segment.length()<10?this.finishAndCreateRooms():(this.control.addSegment(this.segment.start,this.segment.end),this.segment.start.x=this.segment.end.x,this.segment.start.y=this.segment.end.y)}finishAndCreateRooms(){this.editor.setSelectControls([]);const t=this.control.createRooms();t&&this.editor.floor.rooms.push(...t),this.editor.tools.select(),this.editor.render()}}class Lt extends s{constructor(){super(),this.start=new n(0,0),this.end=new n(0,0),this.thick=15,this.color="rgb(0, 151, 197, 0.7)"}render(t){t.save(),t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.closePath(),t.stroke(),t.restore()}length(){return this.start.distanceTo(this.end)}}class zt extends s{constructor(){super(),this.segments=[],this.segment=null,this.thick=15,this.color="rgb(0, 151, 197, 0.7)"}addSegment(t,e){t&&e&&this.segments.push(new l(t.copy(),e.copy()))}render(t){t.save(),this.renderSegments(t),t.restore()}renderSegments(t){if(!(this.segments.length<=0))for(const e of this.segments)e.thick>0&&(t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.closePath(),t.stroke())}hasPoint(t){for(const e of this.segments)if(e.start.distanceTo(t)<10||e.end.distanceTo(t)<10)return!0;return!1}createRooms(){const t=new Y;this.buildGraph(t),t.removeLeafVertex();return V.findPolygon(t).map((t=>{const e=new M(t.points.map((t=>new n(t.x,t.y))),"");return e.fillColor=g.activeColor,e}))}buildGraph(t){const e=(t,e,s)=>{for(const o of t)if(o.x===e&&o.y===s)return!0;return!1};for(const s of this.segments){let n=this.collectIntersectionPoints(s);n.sort(((t,e)=>o.distanceInPoint(s.start,t)-o.distanceInPoint(s.start,e))),e(n,s.start.x,s.start.y)||n.unshift(s.start),e(n,s.end.x,s.end.y)||n.push(s.end);for(let e=1;e<n.length;e++){const s=n[e-1],o=n[e];t.addEdge(s.x,s.y,o.x,o.y)}}return t}collectIntersectionPoints(t){const e=[];for(const s of this.segments){if(s===t)continue;const n=t.isPointInSegment(s.start),i=t.isPointInSegment(s.end);if(n&&e.push(s.start),i&&e.push(s.end),!i&&!i){const n=o.interceptPoint(t.start.x,t.start.y,t.end.x,t.end.y,s.start.x,s.start.y,s.end.x,s.end.y);n&&e.push(n)}}return e}}class Gt extends J{constructor(t){super(),this.handler=new jt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class jt extends _{constructor(t){super(),this.editor=t,this.control=new Ut,this.segment=new Nt,this.started=!1,this.start=new n(0,0),this.end=new n(0,0)}onKeyDown(t,e){"Escape"===t&&this.createOutline()}onMouseDown(t){this.started=!0,this.editor.setSelectControls([this.control,this.segment]),0===this.control.segments.length&&(this.segment.start.x=t.snapX,this.segment.start.y=t.snapY,this.segment.end.x=t.snapX,this.segment.end.y=t.snapY)}onMouseMove(t){this.segment.end.x=t.snapX,this.segment.end.y=t.snapY,this.editor.render()}onMouseUp(t){this.segment.length()<10?this.createOutline():(this.control.addSegment(this.segment.start,this.segment.end),this.segment.start.x=this.segment.end.x,this.segment.start.y=this.segment.end.y)}createOutline(){this.editor.setSelectControls([]);const t=this.control.createOutline();t&&this.editor.floor.outlines.push(t),this.editor.tools.select(),this.editor.render()}}class Nt extends s{constructor(){super(),this.start=new n(0,0),this.end=new n(0,0),this.thick=15,this.color="rgb(0, 151, 197, 0.7)"}render(t){t.save(),t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.closePath(),t.stroke(),t.restore()}length(){return this.start.distanceTo(this.end)}}class Ut extends s{constructor(){super(),this.segments=[],this.segment=null,this.thick=10,this.color="rgb(0, 151, 197, 0.7)"}addSegment(t,e){t&&e&&this.segments.push(new l(t.copy(),e.copy()))}render(t){t.save(),this.renderSegments(t),t.restore()}renderSegments(t){if(!(this.segments.length<=0))for(const e of this.segments)e.thick>0&&(t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.closePath(),t.stroke())}createOutline(){return new St(this.segments)}}class $t extends J{constructor(t,e){super(),this.handler=new Kt(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Kt extends _{constructor(t,e){super(),this.editor=t,this.controls=e,this.control=new Jt(this.controls),this.editor.setSelectControls([this.control]),this.started=!1,this.start=new n(0,0)}onMouseDown(t){}onMouseMove(t){if(this.started){const e=t.snapX-this.start.x,s=t.snapY-this.start.y;this.controls.forEach((t=>t.translate(e,s))),this.start.x=t.snapX,this.start.y=t.snapY,this.editor.render()}else this.started=!0,this.start.x=t.snapX,this.start.y=t.snapY}onMouseUp(t){for(const t of this.controls)"room"===t.type?this.editor.floor.rooms.push(t):"window"===t.type?this.editor.floor.windows.push(t):"door"===t.type?this.editor.floor.doors.push(t):"wall"===t.type&&this.editor.floor.walls.push(t);this.editor.setSelectControls([]),this.editor.tools.select()}}class Jt extends s{constructor(t){super(),this.controls=t}render(t){t.save(),t.globalAlpha=.5;for(const e of this.controls)e.render(t);t.restore()}}class _t extends J{constructor(t){super(),this.handler=new Qt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Qt extends _{constructor(t){super(),this.editor=t,this.control=new Zt,this.started=!1}onMouseDown(t){this.started=!0,this.editor.setSelectControls([this.control]),this.control.start.x=t.snapX,this.control.start.y=t.snapY,this.control.room=this.getRoomAtPoint(this.control.start)}onMouseMove(t){this.started&&this.control.room&&(this.control.end.x=t.snapX,this.control.end.y=t.snapY,this.editor.render())}onMouseUp(t){this.started=!0}getRoomAtPoint(t){return this.editor.floor.rooms.find((e=>e.isPointInControl(t.x,t.y)))}}class Zt extends s{constructor(){super(),this.room=null,this.segment=new l}get start(){return this.segment.start}get end(){return this.segment.end}render(t){t.save(),t.beginPath(),t.lineWidth=1,t.strokeStyle=g.activeColor,t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.closePath(),t.stroke();const e=this.createIntersectionPoints();for(const s of e)t.beginPath(),t.arc(s.x,s.y,5,0,2*Math.PI),t.fillStyle=g.activeColor,t.fill(),t.closePath();t.restore()}createIntersectionPoints(){const t=[];for(const e of this.room.segments){const s=e.getIntersectionPoint(this.segment);s&&t.push(s)}return t}}class te extends J{constructor(t){super(),this.handler=new ee(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class ee extends _{constructor(t){super(),this.editor=t,this.control=new se,this.started=!1}onKeyDown(t,e){"Escape"===t&&(this.started=!1,this.editor.setSelectControls([]))}onMouseDown(t){this.started=!0,this.editor.setSelectControls([this.control]),this.control.start.x=t.snapX,this.control.start.y=t.snapY}onMouseMove(t){this.started&&(this.control.end.x=t.snapX,this.control.end.y=t.snapY,this.editor.render())}onMouseUp(t){this.started&&(this.editor.setSelectControls([]),this.createRooms()),this.started=!1}createRooms(){this.editor.setSelectControls([]);const t=this.control.createRooms(this.editor.floor);t&&this.editor.floor.rooms.push(t),this.editor.tools.select(),this.editor.render()}}class se extends s{constructor(){super(),this.start=new n,this.end=new n,this.thick=15,this.color="rgb(0, 151, 197, 0.7)"}render(t){t.save(),this.renderRectangle(t),t.restore()}renderRectangle(t){const e=Math.min(this.start.x,this.end.x),s=Math.max(this.start.x,this.end.x),o=Math.min(this.start.y,this.end.y),n=Math.max(this.start.y,this.end.y);t.beginPath(),t.lineWidth=10,t.strokeStyle=g.activeColor,t.rect(e,o,s-e,n-o),t.closePath(),t.stroke()}createRooms(t){const e=this.createRectPolygon();return t.rooms.forEach((t=>{e.subtract(t.polygon)})),new M(e.points)}createRectPolygon(){const t=Math.min(this.start.x,this.end.x),e=Math.max(this.start.x,this.end.x),s=Math.min(this.start.y,this.end.y),o=Math.max(this.start.y,this.end.y);return new c([new n(t,s),new n(e,s),new n(e,o),new n(t,o)])}}class oe{constructor(){this.canvas=null,this.context=null,this.tools=new ne(this),this.floor=new z,this.backgroudFloor=new z,this.renders=[],this.scale=1,this.toolbar=null,this.activeCommand=null,this.onSelectListener=null,this.eventController=new K,this.config=null,this.selects=[],this.history={index:-1,data:[]}}edit(t,e){if(this.config=e,window&&document){const s=document.querySelector(t);s&&(s.tabIndex=1,s.style.outline="none",this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.canvas.tabindex=2,this.canvas.style.outline="none",this.context=this.canvas.getContext("2d"),this.initializeCanvas(s,window),s.appendChild(this.canvas),this.renders.push(new j(e.grid,this.canvas)),this.renders.push(new N(this.backgroudFloor,.1,!1)),this.renders.push(new N(this.floor,1,!1)),this.renders.push(new U(this.floor)),this.render(),this.canvas.focus()),this.toolbar=new Ot(this,document,e.toolbar),this.toolbar.hide()}}clear(){this.floor.clear(),this.backgroudFloor.clear(),this.selects=[]}load(t,e){this.clear(),At.importData(this.floor,t,e),e.create=e.create??{room:!1,wall:!0,door:!1,window:!1},At.importData(this.backgroudFloor,t,e);const s=this.floor.getBoundRect();this.resetTranslate(),this.translate(100-s.minX,100-s.minY),this.render()}loadFloor(t){this.floor.load(JSON.parse(t)),this.render()}saveFloor(){return JSON.stringify(this.floor,null,2)}initializeCanvas(t,e){if(e&&this.canvas&&this.context){this.context.line=xt.createLine(this.context),this.context.arrow=xt.createArrow(this.context),this.context.text=xt.createText(this.context),this.context.circle=xt.createCircle(this.context);const s=e.devicePixelRatio||1,o=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,n=s/o;if(this.scale=n,s!==o){const t=this.canvas.width,e=this.canvas.height;this.canvas.width=t*n,this.canvas.height=e*n,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.context.scale(n,n)}this.context.lineJoin="round",this.context.lineCap="square",this.context.imageSmoothingEnabled=!0,this.canvas.addEventListener("mousedown",(t=>{if(this.eventController){const e=new $;e.clientX=t.clientX,e.clientY=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,this.initEvent(e),this.eventController.onMouseDown(e)}})),this.canvas.addEventListener("mousemove",(t=>{if(this.eventController){const e=new $;e.clientX=t.clientX,e.clientY=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,this.initEvent(e),this.eventController.onMouseMove(e)}})),this.canvas.addEventListener("mouseup",(t=>{if(this.eventController){const e=new $;e.clientX=t.clientX,e.clientY=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,this.initEvent(e),this.eventController.onMouseUp(e)}})),this.canvas.addEventListener("click",(t=>{if(this.eventController){const e=new $;e.clientX=t.clientX,e.clientY=t.clientY,e.pageX=t.pageX,e.pageY=t.pageY,this.initEvent(e),this.eventController.onClick(e.button)}})),t.addEventListener("keydown",(t=>{this.eventController&&this.eventController.onKeyDown(t.key,t.code)})),this.eventController.context=this.context}}translate(t,e){this.context.translate(t,e)}resetTranslate(){this.context.setTransform(1,0,0,1,0,0),this.context.scale(this.scale,this.scale)}initEvent(t){const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,o=this.canvas.height/e.height;t.x=(t.clientX-e.left)*s/this.scale,t.y=(t.clientY-e.top)*o/this.scale}addEventHandler(t){this.eventController.addHandler(t)}removeEventHandler(t){this.eventController.removeHandler(t)}selectControl(t,e,s){this.onSelectListener&&this.onSelectListener(t,e,s)}addSelectControl(t){t&&this.selects.push(t)}removeSelectControl(t){this.selects=this.selects.filter((e=>e!==t))}setSelectControls(t){t&&(this.selects=t)}addSelectControls(t){t&&this.selects.push(...t)}removeAllSelectControl(){this.selects=[]}render(){this.renderBackground();for(const t of this.renders)t.render(this.context);for(const t of this.selects)t&&t.render(this.context)}renderBackground(){let t="#ffffff";this.config&&(t=this.config.background?this.config.background:"#ffffff"),this.context.save(),this.context.setTransform(1,0,0,1,0,0),this.context.fillStyle=t,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.restore()}onChangeFloor(t){t&&t.updateRooms,this.history.data.push(JSON.stringify(this.floor)),this.history.index++}onCreate(t){if(!this.config)return t;if("wall"===t.type){if(this.config.oncreatewall)return this.config.oncreatewall(this.floor,t)}else if("door"===t.type){if(this.config.oncreatedoor)return this.config.oncreatedoor(this.floor,t)}else if("window"===t.type){if(this.config.oncreatewindow)return this.config.oncreatewindow(this.floor,t)}else if("room"===t.type&&this.config.oncreateroom)return this.config.oncreateroom(this.floor,t);return t}onSelect(t,e){this.config&&this.config.onselect&&this.config.onselect(this.floor,t.pageX,t.pageY,e)}showToolbar(t,e){this.toolbar.show(t.pageX,t.pageY,e)}hideToolbar(){this.toolbar.hide()}}class ne{constructor(t){this.editor=t}undo(){this.deActiveCommand(),this.editor.activeCommand=new Mt(this.editor),this.activeCommand()}redo(){this.deActiveCommand(),this.editor.activeCommand=new Dt(this.editor),this.activeCommand()}select(){this.deActiveCommand(),this.editor.activeCommand=new et(this.editor),this.activeCommand()}createRoom(t){this.deActiveCommand(),this.editor.activeCommand=new Rt(this.editor,t),this.activeCommand()}splitRoom(){this.deActiveCommand(),this.editor.activeCommand=new _t(this.editor),this.activeCommand()}createPolygonRoom(){this.deActiveCommand(),this.editor.activeCommand=new Yt(this.editor),this.activeCommand()}createIntersectionRoom(){this.deActiveCommand(),this.editor.activeCommand=new te(this.editor),this.activeCommand()}createOutline(){this.deActiveCommand(),this.editor.activeCommand=new Gt(this.editor),this.activeCommand()}createRooms(){this.deActiveCommand(),this.editor.activeCommand=new kt(this.editor),this.activeCommand()}deleteRooms(){this.deActiveCommand(),this.editor.activeCommand=new Ht(this.editor),this.activeCommand()}createWall(){this.deActiveCommand(),this.editor.activeCommand=new pt(this.editor),this.activeCommand()}createRectWall(t){this.deActiveCommand(),this.editor.activeCommand=new nt(this.editor,t),this.activeCommand()}createDoor(){this.deActiveCommand(),this.editor.activeCommand=new ct(this.editor),this.activeCommand()}createWindow(){this.deActiveCommand(),this.editor.activeCommand=new at(this.editor),this.activeCommand()}changeLine(t){this.deActiveCommand(),this.editor.activeCommand=new qt(this.editor,{thick:t}),this.activeCommand()}splitWall(){this.deActiveCommand(),this.editor.activeCommand=new ut(this.editor),this.activeCommand()}eraseObject(){this.deActiveCommand(),this.editor.activeCommand=new Ct(this.editor),this.activeCommand()}zoomIn(){this.deActiveCommand(),this.editor.activeCommand=new Pt(this.editor,.1),this.activeCommand()}zoomOut(){this.deActiveCommand(),this.editor.activeCommand=new Pt(this.editor,-.1),this.activeCommand()}clear(){this.deActiveCommand(),this.editor.activeCommand=new bt(this.editor),this.activeCommand()}duplicate(t){this.deActiveCommand(),this.editor.activeCommand=new $t(this.editor,t),this.activeCommand()}deActiveCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandDeActive(this.editor),this.editor.activeCommand=null}activeCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandActive(this.editor)}}PlaceIn=e})();
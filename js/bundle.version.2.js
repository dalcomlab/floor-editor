// 2024.07.16
var PlaceIn;(()=>{"use strict";var t={d:(e,n)=>{for(var s in n)t.o(n,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:n[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Editor:()=>Ee});class n{static arrow(t,e,n,s,o){switch(o){case"up":t.beginPath(),t.moveTo(e,n),t.lineTo(e-s,n+s),t.lineTo(e+s,n+s),t.closePath(),t.fill();break;case"right":t.beginPath(),t.moveTo(e,n),t.lineTo(e-s,n-s),t.lineTo(e-s,n+s),t.closePath(),t.fill();break;case"down":t.beginPath(),t.moveTo(e,n),t.lineTo(e-s,n-s),t.lineTo(e+s,n-s),t.closePath(),t.fill();break;case"left":t.beginPath(),t.moveTo(e,n),t.lineTo(e+s,n-s),t.lineTo(e+s,n+s),t.closePath(),t.fill()}}static circle(t,e,n,s,o=!0){t.beginPath(),t.arc(e,n,s,0,2*Math.PI),t.closePath(),o?t.fill():t.stroke()}}class s{render(t){}static createRender(t){const e=new o;e.addRender(new i(t.config.backgroundColor,t.canvas)),e.addRender(new r(t,t.config.grid,t.canvas));const n=t.floorManager;return n.floors.forEach((t=>{n.getCurrentFloor()!==t&&e.addRender(new h(t,{alpha:.1,visible:{room:!1,wall:!1,outline:!0,door:!1,window:!1}}))})),n.floors.forEach((t=>{n.getCurrentFloor()===t&&e.addRender(new h(t))})),e.addRender(new l(n.getCurrentFloor())),e.addRender(new a(t)),e}}class o{constructor(){this.renders=[]}addRender(t){this.renders.push(t)}render(t,e){for(const n of this.renders)n.render(t,e)}}class i extends s{constructor(t,e){super(),this.canvas=e,this.backgroundColor=t??"#ffffff"}render(t,e){e.save(),e.setTransform(1,0,0,1,0,0),e.fillStyle=this.backgroundColor,e.fillRect(0,0,this.canvas.width,this.canvas.height),e.restore()}}class r extends s{constructor(t,e,n){super(),this.editor=t,this.canvas=n,this.display=e?.display??!0,this.size=e?.size??50,this.color=e?.color??"#c2c1c1",this.thick=e?.thick??1}render(t,e){const n=t=>t*(1/e.getTransform().a);if(this.display){e.save();const t=this.getTransform(e);e.setTransform(t.scaleX,0,0,t.scaleY,0,0),e.strokeStyle=this.color,e.lineWidth=this.thick;const s=n(this.canvas.width),o=n(this.canvas.height),i=n(t.translateX),r=n(t.translateY);let h=i%this.size,l=r%this.size,a=s+this.size,c=o+this.size;h-=this.size,l-=this.size;for(let t=h;t<a;t+=this.size)e.beginPath(),e.moveTo(t,l),e.lineTo(t,c),e.closePath(),e.stroke();for(let t=l;t<c;t+=this.size)e.beginPath(),e.moveTo(h,t),e.lineTo(a,t),e.closePath(),e.stroke();e.restore()}}getTransform(t){const e=t.getTransform();return{scaleX:e.a,scaleY:e.d,translateX:e.e,translateY:e.f}}}class h extends s{constructor(t,e){super(),this.floor=t,this.config=e}render(t,e){e.save(),this.config&&this.config.alpha&&(e.globalAlpha=this.config.alpha),this.floor.render(t,e,this.config),e.restore()}}class l extends s{constructor(t){super(),this.floor=t}render(t,e){let n=1/0,s=1/0,o=-1/0,i=-1/0;for(const t of this.floor.getAllControls()){const e=t.getBoundRect();n=Math.min(n,e.minX),s=Math.min(s,e.minY),o=Math.max(o,e.maxX),i=Math.max(i,e.maxY)}const r=50;this.renderLine(e,n,s-r,o,s-r),this.renderArrow(e,n,s-r,5,"left"),this.renderArrow(e,o,s-r,5,"right"),this.renderLine(e,o+r,s,o+r,i),this.renderArrow(e,o+r,s,5,"up"),this.renderArrow(e,o+r,i,5,"down")}renderLine(t,e,n,s,o){t.beginPath(),t.strokeStyle="#666666",t.fillStyle="#666666",t.lineWidth=1,t.moveTo(e,n),t.lineTo(s,o),t.stroke()}renderArrow(t,e,s,o,i){n.arrow(t,e,s,o,i)}}class a extends s{constructor(t){super(),this.editor=t}render(t,e){for(const n of this.editor.selects)n&&n.render(t,e)}}class c{constructor(t,e){this.x=t??0,this.y=e??0}translate(t,e){this.x+=t,this.y+=e}copy(){return new c(this.x,this.y)}copyFrom(t){t&&(this.x=t.x,this.y=t.y)}distanceTo(t){const e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e**2+n**2)}isEqualTo(t){return Math.floor(this.x)===Math.floor(t.x)&&Math.floor(this.y)===Math.floor(t.y)}}class d{constructor(){this.clientX=0,this.clientY=0,this.snapX=0,this.snapY=0,this.offsetX=0,this.offsetY=0,this.x=0,this.y=0}}class u{constructor(t){this.handlers=[],this.snapToGrid=!0,this.editor=t,this.downPoint=new c}initialize(t,e,n){if(n){const e=e=>{const s=new d;s.clientX=e?.clientX,s.clientY=e?.clientY,s.pageX=e?.pageX,s.pageY=e?.pageY;const o=n.getBoundingClientRect(),i=n.width/o.width,r=n.height/o.height;return s.x=(s.clientX-o.left)*i/t.transform.currentScaleX,s.y=(s.clientY-o.top)*r/t.transform.currentScaleY,s.x=s.x-t.transform.unscaledTranslateX,s.y=s.y-t.transform.unscaledTranslateY,s};n.onmousedown=t=>{const n=e(t);this.onMouseDown(n)},n.onmousemove=t=>{const n=e(t);this.onMouseMove(n)},n.onmouseup=t=>{const n=e(t);this.onMouseUp(n)},n.oncontextmenu=t=>{t.preventDefault();const n=e(t);this.onContextMenu(n)},document.addEventListener("mouseup",(t=>{n.onmouseup(t)})),n.ontouchstart=t=>{t.preventDefault();const e=t.touches[0];n.onmousedown(e)},n.ontouchmove=t=>{t.preventDefault();const e=t.touches[0];n.onmousemove(e)},n.ontouchend=t=>{t.preventDefault();const e=t.changedTouches[0];n.onmouseup(e)}}e&&e.addEventListener("keydown",(t=>{this.onKeyDown(t)}))}addHandler(t){t&&this.handlers.push(t)}removeHandler(t){t&&(this.handlers=this.handlers.filter((e=>e!==t)))}onClick(t){for(const e of this.handlers)e.onClick(t)}onKeyDown(t){(t=>(t.ctrlKey||t.metaKey)&&!t.shiftKey&&"z"===t.key)(t)?(t.preventDefault(),this.editor.tools.undo()):(t=>(t.ctrlKey||t.metaKey)&&("y"===t.key||t.shiftKey&&"z"===t.key))(t)?(t.preventDefault(),this.editor.tools.redo()):this.handlers.forEach((e=>e.onKeyDown(t.key,t.code)))}onMouseDown(t){this.downPoint.x=t.clientX,this.downPoint.y=t.clientY,this.initEvent(t);for(const e of this.handlers)e.onMouseDown(t)}onMouseMove(t){this.initEvent(t);for(const e of this.handlers)e.onMouseMove(t)}onMouseUp(t){this.initEvent(t);for(const e of this.handlers)e.onMouseUp(t)}onContextMenu(t){this.initEvent(t);for(const e of this.handlers)e.onContextMenu(t)}initEvent(t){const e=this.snapPoint(t);t.snapX=e.x,t.snapY=e.y,t.offsetX=t.clientX-this.downPoint.x,t.offsetY=t.clientY-this.downPoint.y}snap(t){return this.snapToGrid?15*Math.round(t/15):t}snapPoint(t){return{x:this.snap(t.x),y:this.snap(t.y)}}}class g{static createLine(t){return(e,n,s,o)=>{t.beginPath(),t.moveTo(e,n),t.lineTo(s,o),t.closePath(),t.stroke()}}static createText(t){return(e,n,s)=>{t.measureText(s).width;t.fillText(s,e,n)}}static createCircle(t){return(e,n,s)=>{t.beginPath(),t.arc(e,n,s,0,2*Math.PI),t.closePath()}}static createArrow(t){return(e,n,s,o)=>{switch(o){case"up":t.beginPath(),t.moveTo(e,n),t.lineTo(e-s,n+s),t.lineTo(e+s,n+s),t.closePath(),t.fill();break;case"right":t.beginPath(),t.moveTo(e,n),t.lineTo(e-s,n-s),t.lineTo(e-s,n+s),t.closePath(),t.fill();break;case"down":t.beginPath(),t.moveTo(e,n),t.lineTo(e-s,n-s),t.lineTo(e+s,n-s),t.closePath(),t.fill();break;case"left":t.beginPath(),t.moveTo(e,n),t.lineTo(e+s,n-s),t.lineTo(e+s,n+s),t.closePath(),t.fill()}}}}class m{static create(t,e){const n=document.createElement(t);return n&&e&&Object.assign(n.style,e),n}}class f{constructor(t){this.element=m.create("div"),this.element.style.display="flex",this.element.style.position="absolute",this.element.style.flexDirection="row",this.element.style.backgroundColor="#1f1f1f",this.element.style.boxShadow="5px 5px 10px rgba(0, 0, 0, 0.5)",this.element.style.borderRadius="10px",this.element.style.textAlign="center",this.element.style.cursor="pointer",this.element.style.alignItems="center",this.element.style.padding="5px",this.element.style.zIndex="9999",this.buttons=new Map,t?t.appendChild(this.element):document.body.appendChild(this.element)}addButton(t,e){return e&&(e.toolbar=this,this.element.appendChild(e.element),this.buttons.set(t,e)),e}getButton(t){return this.buttons.get(t)}hide(){this.element.style.display="none",this.collapse()}hideAllButtons(){this.buttons.forEach(((t,e)=>{t.hide()}))}collapse(){this.buttons.forEach(((t,e)=>{t.collapse()}))}show(t,e){this.collapse();const{style:n}=this.element;n.display="flex",n.left=t+"px",n.top=e+"px";const s=this.getAbsoluteBoundingClientRect(),o=window.innerWidth;s.right>o&&(t=o-s.width,n.left=`${t}px`)}show2(t,e){this.collapse();const{style:n}=this.element;n.display="flex",n.left=t+"px",n.top=e+"px";const s=this.element.getBoundingClientRect(),o=s.left+s.width,i=window.innerWidth;o>i&&(t-=o-i,n.left=`${t}px`)}getAbsoluteBoundingClientRect(){const t=this.element.getBoundingClientRect();let e=t.left+document.documentElement.scrollLeft,n=t.left+t.width,s=t.top+document.documentElement.scrollTop,o=s+t.height;return{top:s,bottom:o,left:e,right:n,width:Math.abs(n-e),height:Math.abs(o-s)}}}class p{constructor(t){this.element=document.createElement("div"),this.element.style.id="tooltip",this.element.style.display="flex",this.element.style.flexDirection="row",this.element.style.alignItems="center",this.element.style.position="absolute",this.element.style.backgroundColor="#1f1f1f",this.element.style.borderRadius="10%",this.element.appendChild(this.createLabelElement()),t?t.appendChild(this.element):document.body.appendChild(this.element)}createLabelElement(){return this.text=document.createElement("p"),this.text.style.color="#ffffff",this.text.style.paddingLeft="10px",this.text.style.paddingRight="10px",this.text.style.fontSize="10px",this.text.style.whiteSpace="nowrap",this.text.textContent="",this.text}show(t,e,n){n?(this.changeLabel(n),this.moveCenter(t,e)):this.hide()}moveCenter(t,e){this.element.style.display="flex";const n=this.element.getBoundingClientRect();this.element.style.left=t-n.width/2+"px",this.element.style.top=e+"px"}changeLabel(t){this.text.style.color="white",this.text.textContent=t}hide(){this.element.style.display="none"}}class x{static create(t){t??={};const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width",t.width??"100%"),e.setAttribute("height",t.width??"100%"),e.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.viewBox&&e.setAttribute("viewBox",t.viewBox);const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("fill",t.fill??"#ffffff"),n.setAttribute("d",t.d??""),e.appendChild(n),e}}class y{constructor(t,e,n){this.element=m.create("div",n),this.element.style.display="flex",this.element.style.flexDirection="row",this.element.style.alignItems="center",this.element.style.width="20px",this.element.style.height="20px",this.element.style.borderRadius="50px",this.element.style.cursor="pointer",this.element.style.padding="5px",this.element.style.margin="5px 10px 5px 5px",this.element.style.overflow="hidden",this.element.style.minWidth="max-content",this.element.style.maxWidth="max-content",this.tooltipText="",this.tooltip=new p(this.element,"tooltip"),this.tooltip.hide(),this.element.onmouseenter=()=>{this.onMouseEnter()},this.onClick=e,this.element.onmouseleave=()=>{this.onMouseLeave()},this.element.onclick=()=>{this.fireOnClick()}}setTooltipText(t){this.tooltipText=t}appendChild(t){this.element.appendChild(t)}hide(){this.element.style.display="none"}show(){this.element.style.display="flex"}expand(){}collapse(){}onMouseEnter(){this.backgroundColor=this.element.style.backgroundColor,this.element.style.backgroundColor="#ffffff80";const t=this.element.getBoundingClientRect(),e=this.element.offsetLeft+t.width/2;this.tooltip.show(e,60,this.tooltipText)}onMouseLeave(){this.element.style.backgroundColor=this.backgroundColor,this.tooltip.hide()}fireOnClick(){this.toolbar?.collapse(),this.onClick&&this.onClick()}getAbsoluteBoundingClientRect(){const t=this.element.getBoundingClientRect();let e=t.left+document.documentElement.scrollLeft,n=t.left+t.width,s=t.top+document.documentElement.scrollTop,o=s+t.height;return{top:s,bottom:o,left:e,right:n,width:Math.abs(n-e),height:Math.abs(o-s)}}addSvgIcon(t){const e=x.create(t);this.appendChild(e)}}class C extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 512 512",d:"M.3 89.5C.1 91.6 0 93.8 0 96V224 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64V224 96c0-35.3-28.7-64-64-64H64c-2.2 0-4.4 .1-6.5 .3c-9.2 .9-17.8 3.8-25.5 8.2C21.8 46.5 13.4 55.1 7.7 65.5c-3.9 7.3-6.5 15.4-7.4 24zM48 224H464l0 192c0 8.8-7.2 16-16 16L64 432c-8.8 0-16-7.2-16-16l0-192z"}),this.setTooltipText("창문 생성")}}class w extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 576 512",d:"M96 64c0-35.3 28.7-64 64-64H416c35.3 0 64 28.7 64 64V448h64c17.7 0 32 14.3 32 32s-14.3 32-32 32H432 144 32c-17.7 0-32-14.3-32-32s14.3-32 32-32H96V64zM384 288a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"}),this.setTooltipText("문 생성")}}class v{static#t=[{category:0,label:"다목적공간",color:"#d83d1b"},{category:12,label:"거실",color:"#ec9126"},{category:13,label:"침실",color:"#e9ba1f"},{category:14,label:"주방",color:"#1c8a4f"},{category:15,label:"현관",color:"#0e88e0"},{category:16,label:"발코니",color:"#8639eb"},{category:17,label:"화장실",color:"#f5bfbb"},{category:19,label:"드레스룸",color:"#f2c997"},{category:21,label:"기타",color:"#f3df9e"}];static get roomTypes(){return this.#t}}class P extends y{constructor(t){super(t),this.text=m.create("p",{display:"block",color:"#ffffff",padding:"5px",margin:"5px"}),this.appendChild(this.text),this.element.style.width=null,this.roomToolbar=this.#e(this.element),this.roomToolbar.hide(),this.setTooltipText("방 유형 변경")}#e(t){const e=new f(t);return v.roomTypes.forEach((n=>{e.addButton(0,new S(t,n)).onClick=()=>{this.hide(),this.onClick&&this.onClick(n)}})),e}setLabel(t){this.text.textContent=t}expand(){const t=this.element.offsetLeft;this.roomToolbar.show2(t,-70)}collapse(){this.roomToolbar.hide()}fireOnClick(){this.toolbar?.collapse(),this.expand()}}class S extends y{constructor(t,e,n){super(t,(()=>{n&&n(e)})),this.room=e,this.element.style.width=null,this.element.style.backgroundColor=this.room.color;const s=m.create("p",{display:"block",color:"#fff",padding:"5px",margin:"5px",whiteSpace:"nowrap"});s.textContent=this.room.label,this.element.appendChild(s)}}class T extends y{constructor(t){super(t,null,null),this.element.style.width=null,this.element.onmouseenter=null,this.element.onmouseleave=null,this.separator=m.create("div3",{width:"1px",minWidth:"1px",height:"100%",backgroundColor:"gray",margin:"2px 2px"}),this.element.appendChild(this.separator)}}class b extends y{#n=!1;constructor(t,e,n){super(t,null,null),this.#n=n,this.#s(n),this.#o(e)}get checked(){return this.#n}set checked(t){this.#n=t,this.input.checked=t}#s(t){this.input=m.create("input",{display:"block",padding:"5px",margin:"5px",transform:"scale(1.5)"}),this.input.type="radio",this.input.checked=t,this.element.appendChild(this.input)}#o(t){this.element.style.width=null,this.label=m.create("p",{display:"block",color:"#fff",padding:"5px",margin:"5px",whiteSpace:"nowrap"}),this.element.onmouseenter=null,this.element.onmouseleave=null,this.label.textContent=t,this.element.appendChild(this.label)}}class A extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 448 512",d:"M384 80c8.8 0 16 7.2 16 16V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16H384zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64z"}),this.setTooltipText("방 생성"),this.roomToolbar=this.#e(this.element),this.roomToolbar.hide()}#e(t){const e=new f(t),n=e.addButton(0,new b(t,"방 만들기",!0)),s=e.addButton(1,new b(t,"빈공간 채우기",!1));return n.onClick=()=>{n.checked=!n.checked,s.checked=!n.checked},s.onClick=()=>{s.checked=!s.checked,n.checked=!s.checked},e.addButton(2,new T(t)),v.roomTypes.forEach((n=>{e.addButton(3,new S(t,n)).onClick=()=>{this.hide(),this.onClick&&(n.isFind=e.getButton(1).checked,this.onClick(n))}})),e}expand(){const t=this.element.offsetLeft;this.roomToolbar.show2(t,-70)}collapse(){this.roomToolbar.hide()}fireOnClick(){this.toolbar?.collapse(),this.expand()}}class O extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 448 512",d:"M135.2 17.7C140.6 6.8 151.7 0 163.8 0H284.2c12.1 0 23.2 6.8 28.6 17.7L320 32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 96 0 81.7 0 64S14.3 32 32 32h96l7.2-14.3zM32 128H416V448c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V128zm96 64c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16z"}),this.setTooltipText("삭제")}}class D extends y{constructor(t,e,n){super(t,(()=>{this.expand()}),n),this.addSvgIcon({viewBox:"0 0 12 12",d:"M0 0h12v1H0V0zm0 4h12v2H0V4zm12 5H0v3h12V9z"}),this.setTooltipText("두께 변경"),this.thickToolbar=this.createThickToolbar(this.element,e),this.thickToolbar.hide()}createThickToolbar(t,e){const n=new f(t);return[1,5,10].forEach((s=>{n.addButton(0,new E(t,s,(t=>{this.hide(),this.toolbar?.hide(),e&&e(s)})))})),n}hide(){this.element.style.display="none",this.collapse()}expand(){const t=this.element.offsetLeft;this.thickToolbar.show2(t,-70)}collapse(){this.thickToolbar.hide()}}class E extends y{constructor(t,e,n){super(t,null),this.thick=e,this.onChangeThick=n;const s=m.create("div",{display:"block",backgroundColor:"white",width:"100%",height:`${this.thick}px`});this.element.appendChild(s)}onClick(){this.onChangeThick?.(this.thick)}}class M extends y{constructor(t){super(t);const e=m.create("div");e.style.display="block",e.style.background="radial-gradient(50% 50% at 50% 50%,#ffffff 0%,transparent 100%),conic-gradient(from 0deg at 50% 50%,#ff0000 0deg,#ffa800 47.73deg,#ffff00 79.56deg,#00ff00 121.33deg,#00ffff 180.99deg,#0000ff 238.67deg,#ff00ff 294.36deg,#ff0000 360deg),#c4c4c4",e.style.width="radial-gradient(50% 50% at 50% 50%,#ffffff 0%,transparent 100%),conic-gradient(from 0deg at 50% 50%,#ff0000 0deg,#ffa800 47.73deg,#ffff00 79.56deg,#00ff00 121.33deg,#00ffff 180.99deg,#0000ff 238.67deg,#ff00ff 294.36deg,#ff0000 360deg),#c4c4c4",e.style.width="20px",e.style.height="20px",e.style.borderRadius="50%",this.appendChild(e),this.setTooltipText("색상 변경"),this.colorToolbar=this.createColorToolbar(this.element),this.colorToolbar.hide()}createColorToolbar(t){const e=new f(t);return["#ffffff","#121213","#717171","#d83d1b","#ec9126","#e9ba1f","#1c8a4f","#0e88e0","#8639eb"].forEach((n=>{e.addButton(0,new R(t,n)).onClick=()=>{this.hide(),this.onClick&&this.onClick(n)}})),e}expand(){const t=this.element.offsetLeft;this.colorToolbar.show2(t,-70)}collapse(){this.colorToolbar.hide()}fireOnClick(){this.toolbar?.collapse(),this.expand()}}class R extends y{constructor(t,e){super(t);const n=m.create("div",{display:"block",background:e,width:"20px",height:"20px",borderRadius:"50%"});this.appendChild(n)}}class B extends y{constructor(t){super(t),this.text=m.create("p",{display:"block",color:"#ffffff",padding:"5px",margin:"5px"}),this.appendChild(this.text)}setLabel(t){this.text.textContent=t}}class H extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 448 512",d:"M432 256c0 17.7-14.3 32-32 32L48 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l352 0c17.7 0 32 14.3 32 32z"}),this.setTooltipText("벽 생성")}}class F{constructor(t,e){this.editor=t,this.control=null,this.container=e,this.TOOLBAR_BUTTONS={REMOVE:0,CREATE_WALL:1,CREATE_WINDOW:2,CREATE_DOOR:3,CREATE_ROOM:4,CHANGE_ROOM:5,CHANGE_THICK:6,CHANGE_COLOR:7,MEASURE:8,FIND_ROOM:9},this.toolbar=this.createToolbar()}createToolbar(){const t=new f(this.container);return t.addButton(this.TOOLBAR_BUTTONS.REMOVE,new O(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_WALL,new H(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_WINDOW,new C(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_DOOR,new w(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_ROOM,new A(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CHANGE_ROOM,new P(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CHANGE_THICK,new D(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CHANGE_COLOR,new M(this.container)),t.addButton(this.TOOLBAR_BUTTONS.MEASURE,new B(this.container)),t.getButton(this.TOOLBAR_BUTTONS.REMOVE).onClick=()=>{if(this.control){const t=this.editor.getCurrentFloor();t.removeControl(this.control),t.fireOnChange(),this.editor.setSelectControls([]),this.editor.render()}this.toolbar.hide()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_WALL).onClick=()=>{this.editor.tools.createWall(),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_WINDOW).onClick=()=>{this.editor.tools.createWindow(),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_DOOR).onClick=()=>{this.editor.tools.createDoor(),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_ROOM).onClick=t=>{this.editor.tools.createRoom(t),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CHANGE_ROOM).onClick=t=>{this.control.label=t.label,this.control.fillColor=t.color,this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CHANGE_THICK).onClick=()=>{this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CHANGE_COLOR).onClick=t=>{this.control.fillColor=t,this.toolbar.hide(),this.editor.render()},t.hide(),t}hide(){this.toolbar?.hide()}show(t,{control:e,segment:n}){this.control=e;const s=new c(t.x,t.y);this.initToolbar({control:e,segment:n},s);const o=this.container.getBoundingClientRect(),i=this.toolbar.element.offsetWidth/2,r=this.toolbar.element.offsetHeight/2,h=t.clientX-o.left-i,l=t.clientY-o.top-(r+50);this.toolbar?.show(h,l)}initToolbar({control:t,segment:e},n){t||e?t&&"door"===t.type?this.initToolbarOnDor(t,n):t&&"window"===t.type?this.initToolbarOnWindow(t,n):t&&"room"===t.type?this.initToolbarOnRoom(t,n):e?this.initToolbarOnWall(t,n):this.initToolbarOnFloor():this.initToolbarOnFloor()}initToolbarOnFloor(t,e){this.toolbar.hideAllButtons(),this.showCreateRoomButton()}initToolbarOnRoom(t,e){const n=t.findSegmentAtPoint(this.editor,e);if(n)this.initToolbarOnWall(n.segment,e);else{this.toolbar.hideAllButtons();const e=t.polygon.calculateArea(),n=4e-4;this.showRemoveButton(),this.showCreateRoomButton(),this.showCreateWallButton(),this.showChangeRoomButton(t.label),this.showChangeColorButton(),this.showMeasureButton(`${Math.floor(e*n)} ㎡`)}}initToolbarOnWindow(t,e){this.toolbar.hideAllButtons(),this.showRemoveButton()}initToolbarOnDor(t,e){this.toolbar.hideAllButtons(),this.showRemoveButton()}initToolbarOnWall(t,e){this.toolbar.hideAllButtons(),this.showCreateWindowButton(),this.showCreateDoorButton()}showRemoveButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.REMOVE).show()}showCreateWallButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_WALL).show()}showCreateDoorButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_DOOR).show()}showCreateWindowButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_WINDOW).show()}showCreateRoomButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_ROOM).show()}showFindRoomButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.FIND_ROOM).show()}showChangeRoomButton(t){const e=this.toolbar.getButton(this.TOOLBAR_BUTTONS.CHANGE_ROOM);e.setLabel(t),e.show()}showChangeColorButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CHANGE_COLOR).show()}showMeasureButton(t){const e=this.toolbar.getButton(this.TOOLBAR_BUTTONS.MEASURE);e.show(),e.setLabel(t)}}class k extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M48.5 224H40c-13.3 0-24-10.7-24-24V72c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2L98.6 96.6c87.6-86.5 228.7-86.2 315.8 1c87.5 87.5 87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3c-62.2-62.2-162.7-62.5-225.3-1L185 183c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8H48.5z"})}}class I extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"})}}class X extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM184 296c0 13.3 10.7 24 24 24s24-10.7 24-24V232h64c13.3 0 24-10.7 24-24s-10.7-24-24-24H232V120c0-13.3-10.7-24-24-24s-24 10.7-24 24v64H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h64v64z"})}}class Y extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM136 184c-13.3 0-24 10.7-24 24s10.7 24 24 24H280c13.3 0 24-10.7 24-24s-10.7-24-24-24H136z"})}}class W extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"})}}class N extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 24 24",d:"M5.09,5.091h6.047h2.591v4.317h-0.861c-0.003-1.727-1.064-2.59-2.594-2.59H9.41v10.363c0,0.863,1.727,0.863,2.59,0.863  v0.864H4.228v-0.864c0.862,0,2.59,0,2.59-0.863V6.819H5.955c-1.531,0-2.592,0.863-2.594,2.59H2.5V5.091H5.09z M14.59,13.728h6.91V12  h-6.91V13.728z"})}}class z extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"-5 -10 34 34",d:"M20,1.001V6h-0.996C19,4.001,17.77,3,16,3h-4v18c0,1.001,2,1.001,3,1.001v0.998H5v-0.998c1,0,3,0,3-1.001V3H4  C2.229,3,1,4.001,0.996,6H0V1.001h3h14H20z M24,12h-3V9h-2v3h-3v1.999h3v3h2v-3h3V12z"})}}class L extends f{constructor(t,e){super(e),this.element.style.top="30px",this.element.style.left="50px",this.element.style.flexDirection="column",this.addButton(0,new k(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.undo()},this.addButton(1,new I(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.redo()},this.addButton(2,new X(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.zoomIn()},this.addButton(3,new W(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.zoomDefault()},this.addButton(4,new Y(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.zoomOut()},this.addButton(5,new z(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.increaseTextSize()},this.addButton(6,new N(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.decreaseTextSize()}}}class V{constructor(t){this.undoQueue=[],this.redoQueue=[],this.maxQueueSize=100,t&&(this.maxQueueSize=t.maxQueueSize??100)}clear(){this.undoQueue=[],this.redoQueue=[]}push(t){this.undoQueue.push(t),this.undoQueue.length>this.maxQueueSize&&this.undoQueue.shift()}undo(){return this.undoQueue.length>0&&this.redoQueue.push(this.undoQueue.pop()),this.undoQueue.length>0?this.undoQueue[this.undoQueue.length-1]:null}redo(){if(this.redoQueue.length>0){const t=this.redoQueue.pop();return this.undoQueue.push(t),t}return null}}class _{constructor(){this.defaultScaleX=1,this.defaultScaleY=1,this.currentScaleX=1,this.currentScaleY=1,this.translateX=0,this.translateY=0}get unscaledTranslateX(){return 0===this.translateX?this.translateX:this.translateX/this.currentScaleX}get unscaledTranslateY(){return 0===this.translateY?this.translateY:this.translateY/this.currentScaleY}clear(){this.currentScaleX=1,this.currentScaleY=1,this.translateX=0,this.translateY=0}from(t){const e=t.getTransform();e&&(this.currentScaleX=e.a,this.currentScaleY=e.d,this.translateX=e.e,this.translateY=e.f)}applyDefaultScale(t){t.setTransform(1,0,0,1,0,0),t.scale(this.defaultScaleX,this.defaultScaleY),this.currentScaleX=this.defaultScaleX,this.currentScaleY=this.defaultScaleY,t.translate(this.unscaledTranslateX,this.unscaledTranslateY)}resetTransform(t){t.setTransform(1,0,0,1,0,0),t.scale(this.defaultScaleX,this.defaultScaleY)}}class j{constructor(){}get type(){return""}translate(t,e,n){}duplicate(){return null}render(t,e){}getBoundRect(){const t=this.getPoints();return{minX:Math.min(...t.map((t=>t.x))),minY:Math.min(...t.map((t=>t.y))),maxX:Math.max(...t.map((t=>t.x))),maxY:Math.max(...t.map((t=>t.y)))}}getSegments(){return[]}getConnectableSegments(){return[]}getPoints(){return[]}hitPoint(t,e){return null}hitSegment(t,e){return null}hitControl(t,e){return null}createPointHandler(t,e){return null}createSegmentHandler(t,e){return null}createControlHandler(t,e){return null}isPointInControl(t){return!1}isPointInSegment(t){return!1}isSegmentInControl(t){return!1}}class G{constructor(t,e,n,s){this.start=t??new c,this.end=e??new c,this.thick=n??1,this.color=s??"#000000"}isEqualTo(t){return!!t&&(!(!this.start.isEqualTo(t.start)||!this.end.isEqualTo(t.end))||!(!this.start.isEqualTo(t.end)||!this.end.isEqualTo(t.start)))}translate(t,e){this.start.x+=t,this.start.y+=e,this.end.x+=t,this.end.y+=e}getMidPoint(){const t=(this.start.x+this.end.x)/2,e=(this.start.y+this.end.y)/2;return new c(t,e)}duplicate(){return new G(this.start.copy(),this.end.copy(),this.thick,this.color)}crossProductToStart(t){const e=this.end.x-this.start.x,n=this.end.y-this.start.y,s=t.x-this.start.x;return e*(t.y-this.start.y)-n*s}isParallel(t){if(!t)return!1;const e=this.toVector(),n=t.toVector(),s=e.x*n.y-e.y*n.x;return Math.abs(s)<Number.EPSILON}toVector(t){return{x:t?Math.floor(this.end.x)-Math.floor(this.start.x):Math.floor(this.start.x)-Math.floor(this.end.x),y:t?Math.floor(this.end.y)-Math.floor(this.start.y):Math.floor(this.start.y)-Math.floor(this.end.y)}}getPoints(){return[this.start,this.end]}get length(){return Math.sqrt(Math.pow(this.end.x-this.start.x,2)+Math.pow(this.end.y-this.start.y,2))}get angle(){return Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x)}getNearestPointOnSegment(t){return this.getNearestPoint(t,!0)}getNearestPointOnLine(t){return this.getNearestPoint(t,!1)}getNearestPoint(t,e){const n=this.end.x-this.start.x,s=this.end.y-this.start.y,o=n*n+s*s;if(0===o)return new c(this.start.x,this.start.y);const i=((t.x-this.start.x)*n+(t.y-this.start.y)*s)/o,r=new c;return i<0&&e?(r.x=this.start.x,r.y=this.start.y):i>1&&e?(r.x=this.end.x,r.y=this.end.y):(r.x=this.start.x+i*n,r.y=this.start.y+i*s),r}isPointBetween(t){const e={x:t.x-this.start.x,y:t.y-this.start.y},n={x:this.end.x-this.start.x,y:this.end.y-this.start.y},s=(t,e)=>t.x*e.x+t.y*e.y,o=s(e,n);if(o<Number.EPSILON)return!1;return!(o-s(n,n)>-Number.EPSILON)}isPointInSegment(t,e=1){const n=this.start.distanceTo(t),s=this.end.distanceTo(t);return n+s>=this.length-e&&n+s<=this.length+e}getPointAtDistance(t,e){const n=this.getNearestPointOnSegment(t),s=Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x);return new c(n.x+e*Math.cos(s),n.y+e*Math.sin(s))}getOffsetPointFromStart(t){const e=Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x),n=this.start.x+t*Math.cos(e),s=this.start.y+t*Math.sin(e);return new c(n,s)}getIntersectionPoint(t){if(!t)return null;if(this.start.isEqualTo(t.start)||this.start.isEqualTo(t.end)||this.end.isEqualTo(t.start)||this.end.isEqualTo(t.end))return null;const e=(t.end.y-t.start.y)*(this.end.x-this.start.x)-(t.end.x-t.start.x)*(this.end.y-this.start.y);if(0===e)return null;const n=((t.end.x-t.start.x)*(this.start.y-t.start.y)-(t.end.y-t.start.y)*(this.start.x-t.start.x))/e,s=((this.end.x-this.start.x)*(this.start.y-t.start.y)-(this.end.y-this.start.y)*(this.start.x-t.start.x))/e;if(n>=0&&n<=1&&s>=0&&s<=1){const t=this.start.x+n*(this.end.x-this.start.x),e=this.start.y+n*(this.end.y-this.start.y);return new c(t,e)}return null}getIntersectionPointOnSegment(t){return this.getIntersectionPointOnVector(t.start,t.end)}getIntersectionPointOnVector(t,e){const n=e.x-t.x,s=e.y-t.y,o=this.end.x-this.start.x,i=this.end.y-this.start.y,r=n*i-s*o;if(0===r)return null;const h=(o*(t.y-this.start.y)-i*(t.x-this.start.x))/r,l=(t.y,this.start.y,t.x,this.start.x,t.x+h*n),a=t.y+h*s;return new c(l,a)}isRightDirection(){return this.angle>=-Math.PI/2&&this.angle<=Math.PI/2}isLeftDirection(){return!this.isRightDirection()}isVertical(){return this.start.x===this.end.x}isHorizontal(){return this.start.y===this.end.y}makeVerticalOrHorizontal(t=5){Math.abs(this.start.x-this.end.y)<t&&(this.end.x=this.start.x),Math.abs(this.start.y-this.end.y)<t&&(this.end.y=this.start.y)}toString(){return`(${this.start.x}, ${this.start.y})-(${this.end.x}, ${this.end.y})`}}class U{constructor(t,e){this.points=t?Array.isArray(t)?t:[t]:[],this.color=e??"rgb(0, 151, 197, 0.7)"}render(t,e){e.save(),this.#i(e),e.restore()}#i(t){t.fillStyle=this.color;for(const e of this.points)t.circle(e.x,e.y,10),t.fill()}}class q{constructor(t,e,n,s,o){this.segment=t,this.thick=s??5,this.color=o??"rgb(0, 151, 197, 0.7)",this.point=e,this.angle=n,this.text="벽 이동"}render(t,e){this.point&&(e.save(),this.#r(e),this.#h(e),e.restore())}#r(t){this.segment.thick>0&&(t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(this.segment.start.x,this.segment.start.y),t.lineTo(this.segment.end.x,this.segment.end.y),t.closePath(),t.stroke())}#h(t){this.#l(t),this.#a(t)}#l(t){const e=this.segment.getNearestPointOnSegment(this.point);e&&(t.save(),t.fillStyle="black",t.translate(e.x,e.y),t.rotate(this.segment.angle),n.arrow(t,0,15,5,"down"),n.arrow(t,0,-15,5,"up"),t.restore())}#a(t){const e=t.measureText(this.text).width+10,n=this.point.x,s=this.point.y+30;t.fillStyle="black",t.fillRect(n-e/2,s-7.5,e,15),t.fillStyle="white",t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,n,s)}}class Q{useSnap(){return!0}onDragStart(t,e){}onDrag(t,e){}onDragStop(t,e){}onCancel(){}}class K{static Colors={Blue10:"#E5F2FF",Blue20:"#CCE4FF",Blue30:"#99CAFF",Blue40:"#66AFFF",Blue50:"#3395FF",Blue60:"#007AFF",Blue70:"#0062CC",Blue80:"#004999",Blue90:"#003166",Blue100:"#001833",BlueHover10:"#DAE6F2",BlueHover20:"#C2D9F2",BlueHover30:"#91C0F2",BlueHover40:"#61A6F2",BlueHover50:"#308EF2",BlueHover60:"#0D81FF",BlueHover70:"#0D6ACF",BlueHover80:"#0D529E",BlueHover90:"#0D3B6E",BlueHover100:"#0D243D",Purple10:"#F7EEFC",Purple20:"#EFDCF8",Purple30:"#DFBAF2",Purple40:"#CF97EB",Purple50:"#BF75E5",Purple60:"#AF52DE",Purple70:"#8C42B2",Purple80:"#693185",Purple90:"#462159",Purple100:"#23102C",PurpleHorver10:"#EBE2EF",PurpleHorver20:"#E3D1EC",PurpleHorver30:"#D4B1E6",PurpleHorver40:"#C58FDF",PurpleHorver50:"#B56FDA",PurpleHorver60:"#B35BE0",PurpleHorver70:"#924BB6",PurpleHorver80:"#713B8B",PurpleHorver90:"#4F2C61",PurpleHorver100:"#2E1C37",Cyan10:"#EAF7FC",Cyan20:"#D6EFFA",Cyan30:"#ADDEF5",Cyan40:"#84CEF0",Cyan50:"#5BBDEB",Cyan60:"#32ADE6",Cyan70:"#288AB8",Cyan80:"#1E688A",Cyan90:"#14455C",Cyan100:"#0A232E",CyanHover10:"#DEEBEF",CyanHover20:"#CBE3ED",CyanHover30:"#A4D3E9",CyanHover40:"#7DC4E4",CyanHover50:"#56B4DF",CyanHover60:"#3CB1E7",CyanHover70:"#3390BC",CyanHover80:"#297090",CyanHover90:"#204E64",CyanHover100:"#162E38",Teal10:"#EAF7F9",Teal20:"#D6EFF4",Teal30:"#ACDFE9",Teal40:"#83D0DD",Teal50:"#59C0D2",Teal60:"#30B0C7",Teal70:"#268D9F",Teal80:"#1D6A77",Teal90:"#134650",Teal100:"#0A2328",TealHover10:"#DEEBED",TealHover20:"#CBE3E8",TealHover30:"#A3D4DD",TealHover40:"#7CC6D2",TealHover50:"#55B6C7",TealHover60:"#3AB4CA",TealHover70:"#3193A4",TealHover80:"#28717E",TealHover90:"#1F4F59",TealHover100:"#162E33",Manneta10:"#FAE9F1",Manneta20:"#F6D4E3",Manneta30:"#EDA9C6",Manneta40:"#E37DAA",Manneta50:"#DA528D",Manneta60:"#D12771",Manneta70:"#A71F5A",Manneta80:"#7D1744",Manneta90:"#54102D",Manneta100:"#2A0817",MannetaHover10:"#EDDDE5",MannetaHover20:"#EAC9D8",MannetaHover30:"#E1A1BC",MannetaHover40:"#D877A1",MannetaHover50:"#CF4E86",MannetaHover60:"#D33278",MannetaHover70:"#AB2A62",MannetaHover80:"#83234D",MannetaHover90:"#5D1C38",MannetaHover100:"#351423",Red10:"#FFEBEA",Red20:"#FFD8D6",Red30:"#FFB1AC",Red40:"#FF8983",Red50:"#FF6259",Red60:"#FF3B30",Red70:"#CC2F26",Red80:"#99231D",Red90:"#661813",Red100:"#330C0A",RedHover10:"#F2DFDE",RedHover20:"#F2CDCB",RedHover30:"#F2A8A3",RedHover40:"#F2827C",RedHover50:"#F25D55",RedHover60:"#FF453A",RedHover70:"#CF3931",RedHover80:"#9E2E28",RedHover90:"#6E241F",RedHover100:"#3D1816",Green10:"#EBF9EE",Green20:"#D6F4DE",Green30:"#AEE9BD",Green40:"#85DD9B",Green50:"#5DD27A",Green60:"#34C759",Green70:"#2A9F47",Green80:"#1F7735",Green90:"#155024",Green100:"#0A2812",GreenHover10:"#DFEDE2",GreenHover20:"#CBE8D3",GreenHover30:"#A5DDB4",GreenHover40:"#7ED293",GreenHover50:"#58C774",GreenHover60:"#3ECA61",GreenHover70:"#35A450",GreenHover80:"#2A7E3F",GreenHover90:"#21592F",GreenHover100:"#16331E",Orange10:"#FFF4E5",Orange20:"#FFEACC",Orange30:"#FFD599",Orange40:"#FFBF66",Orange50:"#FFAA33",Orange60:"#FF9500",Orange70:"#CC7700",Orange80:"#995900",Orange90:"#663C00",Orange100:"#331E00",OrangeHover10:"#F2E8DA",OrangeHover20:"#F2DEC2",OrangeHover30:"#F2CA91",OrangeHover40:"#F2B561",OrangeHover50:"#F2A130",OrangeHover60:"#FF9A0D",OrangeHover70:"#CF7E0D",OrangeHover80:"#9E610D",OrangeHover90:"#6E460D",OrangeHover100:"#3D290D"};static get activeColor(){return"rgb(0,151,197)"}static get activeColor(){return"rgb(0,151,197)"}static get primaryRedColor(){return K.Colors.Red50}static get primaryRed50Color(){return this.primaryRedColor+"80"}static get primaryOrangeColor(){return K.Colors.Orange50}static get primaryOrange50Color(){return K.Colors.Orange50+"80"}static get activeColorTransparent(){return"rgb(0, 151, 197, 0.5)"}static get selectColor(){return"rgba(0,151,197,0.5)"}}class ${constructor(t){this.x=t?.x??0,this.y=t?.y??0,this.width=t?.width??0,this.height=t?.height??0,this.color=t?.color??K.activeColor,this.text=t?.text??""}render(t,e){e.save(),e.lineWidth=1,e.strokeStyle=this.color,e.fillStyle=this.color,this.#c(e),this.#d(e),this.#u(e),this.#g(e),e.restore()}#c(t){t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x,this.y+this.height),t.moveTo(this.x+this.width,this.y),t.lineTo(this.x+this.width,this.y+this.height),t.closePath(),t.stroke()}#d(t){t.beginPath(),t.moveTo(this.x,this.y+this.height/2),t.lineTo(this.x+this.width,this.y+this.height/2),t.closePath(),t.stroke()}#u(t){n.arrow(t,this.x,this.y+this.height/2,5,"left"),n.arrow(t,this.x+this.width,this.y+this.height/2,5,"right")}#g(t){const e=t.measureText(this.text).width+10,n=this.x+this.width/2,s=this.y-this.height/2;t.fillRect(n-e/2,s-7.5,e,15),t.fillStyle="white",t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,n,s)}}class J{static get unitMeter(){return 10}static get unitPixel(){return 50}static meterToPixel(t){return Math.floor(t/J.unitMeter*J.unitPixel)}static pixelToMeter(t){return Math.floor(t/J.unitPixel*J.unitMeter)}}class Z{constructor(t){t?(this.segments=Array.isArray(t)?t:[t],this.segments=this.segments.filter((t=>null!==t))):this.segments=[],this.mininumSize=0}getFirstSegment(){return this.segments[0]}render(t,e){if(!(this.segments.length<=0)){e.save(),this.rotateContext(e,this.segments[0]);for(const n of this.createMeasures())n.render(t,e);e.restore()}}rotateContext(t,e){e.isRightDirection()?(t.translate(e.start.x,e.start.y),t.rotate(e.angle)):(t.translate(e.end.x,e.end.y),t.rotate(Math.PI+e.angle))}createMeasures(){const t=[];let e=this.getSortedPoints();this.segments[0].isLeftDirection()&&(e=e.reverse());let n=0;for(let s=0;s<e.length-1;s++){const o=e[s],i=e[s+1],r=o.distanceTo(i);if(r>this.mininumSize){const e=new $({x:n,y:-30,width:r,height:15,text:`${J.pixelToMeter(r).toFixed(2)} m`});t.push(e)}n+=r}return t}getSortedPoints(){const t=[];for(const e of this.segments)t.push(e.start,e.end);const e=t[0];return t.sort(((t,n)=>t.distanceTo(e)-n.distanceTo(e))),t}}class tt extends Q{constructor(t,e,n){super(),this.segment=t,this.point=n,this.control=e,this.render=new Z([this.segment,this.control.segment]),this.cancelSnapshot={segment:t,point:n.copy()}}onDragStart(t,e){t.addSelectControl(this.render)}onDrag(t,e){if(this.segment){const t=this.segment.getNearestPointOnSegment(e);this.point.copyFrom(t)}else this.point.copyFrom(e)}onDragStop(t,e){this.removeControlsUnderThreshold(10),t.removeSelectControl(this.render)}onCancel(){this.started=!1,this.point.copyFrom(this.cancelSnapshot.point)}removeControlsUnderThreshold(t){this.control.length<t&&this.floor.removeControl(this.control)}}class et{constructor(t){this.renders=t?Array.isArray(t)?t:[t]:[]}addRender(t){t&&this.renders.push(t)}render(t,e){for(const n of this.renders)n&&n.render(t,e)}}class nt extends Q{constructor(t){super(),this.control=t,this.render=new Z,this.started=!1,this.leftLength=0,this.rightLength=0}onDragStart(t,e){t.getCurrentFloor().findNearestSegmentAtPoint(e)&&(this.leftLength=e.distanceTo(this.control.start),this.rightLength=e.distanceTo(this.control.end),t.addSelectControl(this.render),this.started=!0)}onDrag(t,e){if(!this.started)return;const n=t.getCurrentFloor().findNearestSegmentAtPoint(e);if(n&&n.segment){const t=new G;this.calculateDotProductBetweenSegmentAndControl(n.segment,this.control)<0?(t.start=n.segment.getPointAtDistance(e,this.leftLength),t.end=n.segment.getPointAtDistance(e,-this.rightLength)):(t.start=n.segment.getPointAtDistance(e,-this.leftLength),t.end=n.segment.getPointAtDistance(e,this.rightLength)),n.segment.isPointInSegment(t.start)&&n.segment.isPointInSegment(t.end)&&(this.render.segments=[n.segment,this.control],this.updateControl(t.start,t.end))}}onDragStop(t,e){t.removeSelectControl(this.render),this.started=!1}calculateDotProductBetweenSegmentAndControl(t,e){const n=t.end.x-t.start.x,s=t.end.y-t.start.y;return n*(e.end.x-e.start.x)+s*(e.end.y-e.end.y)}onCancel(){this.isDragging=!1,this.updateControl(this.cancelSnapshot.start,this.cancelSnapshot.end)}updateControl(t,e){this.control.start.copyFrom(t),this.control.end.copyFrom(e)}}class st extends j{constructor(t=new c,e=new c){super(),this.segment=new G(t,e),this.thick=10,this.color="#000000"}get start(){return this.segment.start}set start(t){this.segment.start=t}get end(){return this.segment.end}set end(t){this.segment.end=t}translate(t,e){this.segment.translate(t,e)}getPoints(){return[this.start,this.end]}getSegments(){return[this.segment]}getConnectableSegments(){return[]}hitPoint(t,e){let n=this.findHitPoint(t,e);return n?{point:n.point,render:new U(n.point)}:null}findHitPoint(t,e){const{start:n,end:s}=this.segment,o=n.distanceTo(e),i=s.distanceTo(e);return o<10?{point:n}:i<10?{point:s}:null}hitSegment(t,e){const n=this.findHitSegment(t,e);return n?{segment:n.segment,render:new et([new q(n.segment),new Z(n.segment)])}:null}findHitSegment(t,e){return this.segment.isPointInSegment(e)?{segment:this.segment}:null}createPointHandler(t,e){const n=this.hitPoint(t,e);if(!n)return null;const s=t.getCurrentFloor().findSegmentAtPoint(n.point);return{control:this,handler:new tt(s,this,n.point),point:n.point}}createSegmentHandler(t,e){return this.isPointInControl(e)?{control:this,segment:this.segment,handler:new nt(this)}:null}get length(){return this.segment.length}isPointInControl(t){return this.segment.isPointInSegment(t)}isPointInSegment(t){return this.isPointInControl(t)}isSegmentInControl(t){return this.isPointInControl(t.start)&&this.isPointInControl(t.end)}}class ot extends Q{constructor(t){super(),this.controls=[],this.offset=null,this.controls=t?Array.isArray(t)?t:[t]:[]}onDragStart(t,e){this.offset=e.copy()}onDrag(t,e){this.moveControls(e)}onDragStop(t,e){this.moveControls(e)}moveControls(t){const e=t.x-this.offset.x,n=t.y-this.offset.y;this.controls.forEach((t=>{t.translate(e,n)})),this.offset=t.copy()}}class it extends Q{constructor(t,e){super(),this.control=t,this.handler=e,this.render=new rt}onDragStart(t,e){const n=this.findPointOnSegment(t,e);this.render.update(n),this.handler?.onDragStart(t,n.point),t.addSelectControl(this.render)}onDrag(t,e){const n=this.findPointOnSegment(t,e);this.render.update(n),this.handler?.onDrag(t,n.point)}onDragStop(t,e){const n=this.findPointOnSegment(t,e);this.render.update(n),this.handler?.onDragStop(t,n.point),t.removeSelectControl(this.render)}findPointOnSegment(t,e){const n=t.getCurrentFloor().findSegmentAtPoint(e,(t=>t!==this.control));return n?{segment:n,point:n.getNearestPointOnSegment(e)}:{segment:null,point:e}}}class rt{constructor(){this.measure=new Z}update({segment:t,point:e}){t?t.isRightDirection()?this.measure.segments=[new G(t.start,e),new G(e,t.end)]:this.measure.segments=[new G(t.end,e),new G(e,t.start)]:this.measure.segments=[]}render(t,e){this.measure&&this.measure.render(t,e)}}class ht extends Q{constructor(t,e){super(),this.segment=t,this.rotates=[];for(const t of e)this.rotates.push({control:t,start:this.segment.start.distanceTo(t.start),end:this.segment.start.distanceTo(t.end)})}onDragStart(t,e){this.started=!0}onDrag(t,e){for(const{control:t,start:e,end:n}of this.rotates)t.start=this.segment.getOffsetPointFromStart(e),t.end=this.segment.getOffsetPointFromStart(n)}onDragStop(t,e){this.started&&(this.started=!1)}onCancel(){this.started=!1}}class lt extends Q{constructor(...t){super(),this.handlers=t??[]}addHandler(t){t&&this.handlers.push(t)}onDragStart(t,e){this.handlers.forEach((n=>{n.onDragStart(t,e)}))}onDrag(t,e){this.handlers.forEach((n=>{n.onDrag(t,e)}))}onDragStop(t,e){this.handlers.forEach((n=>{n.onDragStop(t,e)}))}}class at extends Q{constructor(t,e){super(),this.measure=new Z(t,e)}onDragStart(t,e){t.addSelectControl(this.measure)}onDragStop(t,e){t.removeSelectControl(this.measure)}}class ct extends Q{constructor(t,e){super(),this.wall=t,this.point=e}onDragStart(t,e){}onDrag(t,e){this.point.x=e.x,this.point.y=e.y}onDragStop(t,e){this.wall.split(t)}}class dt extends st{constructor(t,e){super(t,e),this.thick=1}get type(){return"wall"}getConnectableSegments(){return[this.segment]}duplicate(){const t=new dt(this.start.copy(),this.end.copy());return t.thick=this.thick,t.color=this.color,t}render(t,e){e.save(),e.beginPath(),e.lineWidth=this.thick,e.strokeStyle=this.color,e.moveTo(this.start.x,this.start.y),e.lineTo(this.end.x,this.end.y),e.closePath(),e.stroke(),e.restore()}createPointHandler(t,e){const n=this.hitPoint(t,e);if(!n)return null;const s=t.getCurrentFloor(),o=new lt;return o.addHandler(new it(this,new ct(this,n.point))),o.addHandler(new ht(this.segment,this.getAllWindowAndDoorOnSegment(s))),o.addHandler(new at(this.segment)),{control:this,handler:o,point:n.point}}createSegmentHandler(t,e){if(!this.isPointInControl(e))return null;const n=t.getCurrentFloor(),s=new lt;return s.addHandler(new ot(this)),s.addHandler(new ht(this.segment,this.getAllWindowAndDoorOnSegment(n))),s.addHandler(new at(this.segment)),{control:this,segment:this.segment,handler:s}}getAllWindowAndDoorOnSegment(t){return t.getControlsInsideSegment(this.segment).filter((t=>"window"===t.type||"door"===t.type))}split(t){this.splitRooms(t),this.addWalls(t)}splitRooms(t){const e=[],n=[],s=t.getCurrentFloor();for(const t of s.getRooms()){const s=t.split(this.segment);s.length>0&&(n.push(...s),e.push(t))}for(const t of e)s.removeRoom(t);for(const t of n)s.addRoom(t)}addWalls(t){const e=t.getCurrentFloor(),n=[this.segment.start,...this.findIntersectionPoints(t),this.segment.end];for(let t=0;t<n.length-1;t++){const s=n[t],o=n[t+1];if(!e.isSegmentInSegment(new G(s,o))){const t=new dt(s.copy(),o.copy());t.thick=10,e.addWall(t)}}}findIntersectionPoints(t){const e=t.getCurrentFloor(),n=[];for(const t of e.getRooms())n.push(...t.findIntersectionPoints(this.segment));return n.sort(((t,e)=>t.distanceTo(this.segment.start)-e.distanceTo(this.segment.start))),n}}class ut{static applyOpacityToColor(t,e){return function(t,e){return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${e})`}(function(t){let e=parseInt(t.replace("#",""),16);return[e>>16&255,e>>8&255,255&e]}(t),e)}static isRGBorRGBA(t){return/^(rgb|rgba)/.test(t)}static toHexColor(t){if(!t)return t;let e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(\.\d+)?))?\)/);if(!e)return null;let n="";void 0!==e[4]&&(n=Math.round(255*parseFloat(e[4])).toString(16),1===n.length&&(n="0"+n));let s="#";for(let t=1;t<=3;t++){let n=parseInt(e[t],10).toString(16);1===n.length&&(n="0"+n),s+=n}return""!==n&&(s+=n),s}static reverseTransparent(t){if(!t)return t;let e=1;9===t.length&&(e=parseInt(t.slice(7,9),16)/255),e=1===e?.5:1;let n=Math.round(255*e).toString(16);return 1===n.length&&(n="0"+n),t.slice(0,7)+n}static toTransparent(t){if(!t)return t;ut.isRGBorRGBA(t)&&(t=ut.toHexColor(t));let e=1;9===t.length&&(e=parseInt(t.slice(7,9),16)/255),1===e&&(e=.5);let n=Math.round(255*e).toString(16);return 1===n.length&&(n="0"+n),t.slice(0,7)+n}}class gt{constructor(t){this.points=t??[]}setPoints(t){this.points=t??[]}get count(){return this.points.length}duplicate(){return this.points.map((t=>t.copy()))}getBoundRect(){const t={minX:0,minY:0,maxX:0,maxY:0};if(0===this.points.length)return t;let e=this.points[0].x,n=this.points[0].y,s=this.points[0].x,o=this.points[0].y;for(let t=1;t<this.points.length;t++){const i=this.points[t];i.x<e&&(e=i.x),i.x>s&&(s=i.x),i.y<n&&(n=i.y),i.y>o&&(o=i.y)}return t.minX=e,t.maxX=s,t.minY=n,t.maxY=o,t}getCenterPoint(){let t=0,e=0;for(const n of this.points)t+=n.x,e+=n.y;const n=new c(t/this.points.length,e/this.points.length);if(!this.isPointInside(n)){let t=this.points[0],e=n.distanceTo(t);for(let s=1;s<this.points.length;s++){const o=n.distanceTo(this.points[s]);o<e&&(t=this.points[s],e=o)}return t.copy()}return n}getVisualCenterPoint(){const t=this.generateGridPoints(this.getBoundRect(),10);return this.findCenterPoint(t,this.createSegments())}generateGridPoints(t,e){const n=this.getCenterPoint(),s=[],o=t.maxX-t.minX,i=t.maxY-t.minY,r=Math.floor(o/e),h=Math.floor(i/e);for(let o=0;o<e;o++)for(let i=0;i<e;i++){const e=t.minX+i*r,l=t.minY+o*h,a=new c(e,l);this.isPointInside(a)&&(s.push(a),a.radius=n.distanceTo(a))}return s}findCenterPoint(t,e){let n=null;for(const n of t){let t=1/0;for(const s of e){const e=s.getNearestPointOnSegment(n),o=n.distanceTo(e);t=Math.min(o,t)}n.distance=t}for(const e of t)n?n.distance===e.distance?n.radius>e.radius&&(n=e):n.distance<e.distance&&(n=e):n=e;return n}addPoint(t){this.existPoint(t)||this.points.push(t)}insertPoint(t,e){const n=this.points.indexOf(e);return-1!==n&&(this.points.splice(n+1,0,t),!0)}existPoint(t){return this.points.some((e=>{return n=e,s=t,Math.floor(n.x)===Math.floor(s.x)&&Math.floor(n.y)===Math.floor(s.y);var n,s}))}first(){return this.count>1?this.points[0]:null}isPointInside(t){let e=!1;const{x:n,y:s}=t;for(let t=0,o=this.points.length-1;t<this.points.length;o=t++){const i=this.points[t].x,r=this.points[t].y,h=this.points[o].x,l=this.points[o].y;r>s!=l>s&&n<(h-i)*(s-r)/(l-r)+i&&(e=!e)}return e}isPointsInside(t){const e=this.createSegments();for(const n of t){if(!(this.isPointInsideSegments(e,n)||this.isPointInside(n)))return!1}return!0}isPointInsideSegments(t,e){return t.some((t=>t.isPointInSegment(e)))}isPolygonContained(t){return this.isPointsInside(t.points)}calculateArea(){const t=this.points.length;let e=0;for(let n=0;n<t;n++){const s=this.points[n],o=this.points[(n+1)%t];e+=s.x*o.y-o.x*s.y}return Math.abs(e)/2}getPrevPoint(t){const{points:e}=this,n=e.indexOf(t);return e[(n-1+e.length)%e.length]}getNextPoint(t){const{points:e}=this,n=e.indexOf(t);return e[(n+1)%e.length]}createSegments(){const t=[],{points:e}=this;for(let n=0;n<e.length;n++){const s=e[n],o=e[(n+1)%e.length];t.push(new G(s,o))}return t}removeSamePoints(){const t=[];for(let e=0;e<this.points.length-1;e++){const n=this.points[e],s=this.points[e+1];n.distanceTo(s)<5&&t.push(n)}return this.points=this.points.filter((e=>!t.includes(e))),t.length}removeCollinearPoints(){const t=[];for(let e=0;e<this.points.length-2;e++){const n=this.points[e],s=this.points[e+1],o=this.points[e+2];this.isCollinear(n,s,o)&&(t.push(s),e++)}return this.points=this.points.filter((e=>!t.includes(e))),t.length}isCollinear(t,e,n){return(t.y-e.y)*(t.x-n.x)==(t.y-n.y)*(t.x-e.x)}}class mt extends Q{constructor(t,e){super(),this.segment=t,this.config=e??{},this.start=new c,this.segment.makeVerticalOrHorizontal()}onDragStart(t,e){this.start.x=e.x,this.start.y=e.y}onDrag(t,e){const n=e.x-this.start.x,s=e.y-this.start.y;this.config.onTransform?this.config.onTransform(n,s,e):this.segment.translate(n,s),this.start.x=e.x,this.start.y=e.y}onDragStop(t,e){this.config.onDragStop?.(this.segment)}}class ft extends Q{constructor(t,e){super(),this.point=t,"function"==typeof e&&(this.onDone=e)}onDragStart(t,e){}onDrag(t,e){this.point.x=e.x,this.point.y=e.y}onDragStop(t,e){this.onDone&&this.onDone(this.point)}}class pt{constructor(t,e,n){this.polygons=t?Array.isArray(t)?t:[t]:[],this.thick=e??15,this.color=n??"rgb(0, 151, 197, 0.7)"}render(t,e){e.save(),this.#m(e),e.restore()}#m(t){if(!(this.polygons.length<=0))for(const e of this.polygons){const{points:n}=e;if(n.length>0){t.beginPath(),t.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++)t.lineTo(n[e].x,n[e].y);t.closePath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.stroke()}}}}class xt{constructor(t){this.config=t??{},this.angle=this.config.angle??0,this.point=this.config.point??new c,this.color=K.primaryRedColor,this.text="벽 분리"}render(t,e){this.point&&(this.#f(e),this.#p(e),this.#x(e))}#p(t){t.save(),t.fillStyle=this.color,n.circle(t,this.point.x,this.point.y,5,!0),t.restore()}#f(t){t.save(),t.fillStyle=this.color,t.translate(this.point.x,this.point.y),t.rotate(this.angle),n.arrow(t,0,15,5,"down"),n.arrow(t,0,-15,5,"up"),t.restore()}#x(t){const e=t.measureText(this.text).width+10,n=this.point.x,s=this.point.y+30;t.fillStyle="black",t.fillRect(n-e/2,s-7.5,e,15),t.fillStyle="white",t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,n,s)}}class yt extends j{constructor(t){super(),this.polygon=new gt(t??[]),this.segments=this.polygon.createSegments()}get type(){return"polygon"}setPoints(t){this.polygon.setPoints(t),this.segments=this.polygon.createSegments()}hitPoint(t,e){let n=this.findVertexPoint(t,e);return n?{point:n.point,render:new U(n.point)}:(n=this.findDividePoint(t,e),n?{point:n.point,render:new xt({point:n.point,angle:n.segment.angle})}:null)}findVertexPoint(t,e){const n=this.polygon.points.find((t=>t.distanceTo(e)<10));return n?{point:n}:null}findDividePoint(t,e){if(this.isWindowOrDoorExist(t,e))return null;const n=this.segments.find((t=>t.length>50&&t.getMidPoint().distanceTo(e)<10));return n?{point:n.getMidPoint(),segment:n}:null}isWindowOrDoorExist(t,e){return t.getCurrentFloor().findControlsAtPoint(e,(t=>"window"===t.type||"door"===t.type)).length>0}divideSegment(t,e){this.polygon.insertPoint(e,t.start),this.segments=this.polygon.createSegments()}hitSegment(t,e){const n=this.findSegmentAtPoint(t,e);if(!n)return null;const s=new et;return s.addRender(new q(n.segment,e)),s.addRender(new Z(n.segment)),{segment:n.segment,render:s}}hitControl(t,e){return this.isPointInControl(e)?{control:this,render:new pt(this.polygon)}:null}findSegmentAtPoint(t,e){const n=this.segments.find((t=>t.isPointInSegment(e)));return n?{segment:n}:null}getSegments(){return this.segments}getConnectableSegments(){return this.segments}getPoints(){return this.polygon.points}addPoint(t){this.polygon.addPoint(t)}translate(t,e){this.polygon.points.forEach((n=>{n.x+=t,n.y+=e}))}isPointInControl(t){return!!this.polygon.points.some((e=>e.isEqualTo(t)))||this.polygon.isPointInside(t)}isPointInSegment(t){for(const e of this.segments)if(e.isPointInSegment(t,0))return!0;return!1}isSegmentInControl(t){if(!(this.isPointInSegment(t.start)&&this.isPointInSegment(t.end)||this.isPointInSegment(t.start)&&this.isPointInSegment(t.end)))return!1;const e=this.findIntersectionPoints(t);for(let t=0;t<e.length-1;t++){const n=e[t],s=e[t+1];if(!this.isPointInControl(new c((n.x+s.x)/2,(n.y+s.y)/2)))return!1}return!0}findIntersectionPoints(t){const e=[];for(const n of this.segments){const s=n.getIntersectionPoint(t);s&&e.push(s)}return e}createPointHandler(t,e){let n=this.findVertexPoint(t,e);if(n||(n=this.findDividePoint(t,e),n&&this.divideSegment(n.segment,n.point)),n){const e=t.getCurrentFloor();if(e){const t=this.polygon.getPrevPoint(n.point),s=this.polygon.getNextPoint(n.point),o=new G(t,n.point),i=new G(s,n.point),r=e.getControlsInsideSegment(o),h=e.getControlsInsideSegment(i),l=new lt;return l.addHandler(new ft(n.point,(()=>{(this.polygon.removeSamePoints()>0||this.polygon.removeCollinearPoints()>0)&&(this.segments=this.polygon.createSegments())}))),l.addHandler(new ht(o,r)),l.addHandler(new ht(i,h)),{control:this,handler:l,point:n.point}}}return null}createSegmentHandler(t,e){const n=this.findAdjacentSegmentsAtPoint(e);if(!n)return null;const s=new lt;return s.addHandler(this.createMoveSegmentHandler(t,n.segment)),s.addHandler(this.createMoveCollinearControlHandler(t,n.segment)),s.addHandler(this.createMoveCollinearSegmentHandler(t,n.segment)),s.addHandler(new at(n.prevSegment)),s.addHandler(new at(n.segment)),s.addHandler(new at(n.nextSegment)),{control:this,segment:n.segment,handler:s}}createMoveSegmentHandler(t,e){const n={},s=this.segments.indexOf(e),o=this.segments.length;n.onDragStop=()=>{this.polygon.removeSamePoints()>0&&(this.segments=this.polygon.createSegments())};const i=this.segments[(s-1+o)%o].duplicate(),r=this.segments[(s+1)%o].duplicate();return n.onTransform=(t,n,s)=>{e.translate(t,n),e.start.copyFrom(i.getIntersectionPointOnSegment(e)),e.end.copyFrom(r.getIntersectionPointOnSegment(e)),e.isVertical()?(e.start.x=s.x,e.end.x=s.x):e.isHorizontal()&&(e.start.y=s.y,e.end.y=s.y)},new mt(e,n)}insertPoint(t,e){this.polygon.insertPoint(t,e)&&(this.segments=this.polygon.createSegments())}createMoveCollinearControlHandler(t,e){const n=t.getCurrentFloor().getControlsInsideSegment(e);return new ht(e,n)}createMoveCollinearSegmentHandler(t,e){const n=t.getCurrentFloor(),s=(t,n)=>{t.copyFrom(e.getNearestPointOnLine(t)),n.copyFrom(e.getNearestPointOnLine(n))},o=new lt;for(const t of n.getAllControls())if(t!==this&&"room"===t.type)for(const i of t.getSegments()){let{start:r,end:h}=i;if(e.isPointInSegment(r)&&e.isPointInSegment(h))s(r,h),o.addHandler(t.createMoveSegmentHandler(n,i));else{const l=e.isParallel(i);(e.isPointInSegment(r)||e.isPointInSegment(h))&&l&&(s(r,h),o.addHandler(t.createMoveSegmentHandler(n,i)))}}return o}findAdjacentSegmentsAtPoint(t){const e=this.segments.length;for(let n=0;n<e;n++){const s=this.segments[n],o=this.segments[(n-1+e)%e],i=this.segments[(n+1)%e];if(s.isPointInSegment(t))return{prevSegment:o,segment:s,nextSegment:i}}return null}}class Ct{constructor(t,e,n){this.config=n??{},this.room=t,this.holes=e??[],this.config.room??={},this.config.holes??={},this.config.room.color??=K.activeColorTransparent,this.config.room.thick??=15}render(t,e){e.save();const{color:n,thick:s}=this.config.room;this.#y(e,this.room,n,s),this.#C(e),e.restore()}#y(t,e,n,s){if(!e)return;const{points:o}=e.polygon;if(o.length>0){t.beginPath(),t.moveTo(o[0].x,o[0].y);for(let e=1;e<o.length;e++)t.lineTo(o[e].x,o[e].y);t.closePath(),t.strokeStyle=n,t.lineWidth=s,t.stroke()}}#C(t){const{color:e,thick:n}=this.config.room;for(const s of this.holes)this.#y(t,s,e,n)}}class wt{constructor(t){t&&this.build(t)}build(t){t=this.removeDuplicates(t),this.root=this.buildTree(t,0)}removeDuplicates(t){return[...new Set(t.map((t=>JSON.stringify([t.x,t.y]))))].map((t=>JSON.parse(t))).map((t=>new c(t[0],t[1])))}buildTree(t,e){if(0===t.length)return null;const n=e%2;t.sort(((t,e)=>t[0===n?"x":"y"]-e[0===n?"x":"y"]));const s=Math.floor(t.length/2),o=new vt(t[s],n);return o.left=this.buildTree(t.slice(0,s),e+1),o.right=this.buildTree(t.slice(s+1),e+1),o}findNearestX(t,e=10){let n=null,s=1/0;return function o(i){if(null===i)return;const r=Math.abs(Math.floor(i.point.x)-t);r<s&&r<e&&(n=i.point.x,s=r);const h=t<i.point.x?i.left:i.right;if(o(h),Math.abs(t-i.point.x)<s){const e=t<i.point.x?i.right:i.left;o(e)}}(this.root),n?Math.floor(n):null}findNearestY(t){let e=null,n=1/0;return function s(o){if(null===o)return;const i=Math.abs(Math.floor(o.point.y)-t);i<n&&i<10&&(e=o.point.y,n=i);const r=t<o.point.y?o.left:o.right;if(s(r),Math.abs(t-o.point.y)<n){const e=t<o.point.y?o.right:o.left;s(e)}}(this.root),e?Math.floor(e):null}findPointsOnX(t){const e=[];return this.findAllPointsWithSameX(this.root,t,e),e}findAllPointsWithSameX(t,e,n){null!==t&&(t.point.x===e&&n.push(t.point),this.findAllPointsWithSameX(t.left,e,n),this.findAllPointsWithSameX(t.right,e,n))}findPointsOnY(t){const e=[];return this.findPointsWithSameY(this.root,t,e),e}findPointsWithSameY(t,e,n){null!==t&&(t.point.y===e&&n.push(t.point),this.findPointsWithSameY(t.left,e,n),this.findPointsWithSameY(t.right,e,n))}findNearestPoint(t,e=5){let n=null,s=1/0;const o=(t,i,r)=>{if(null===t)return;const h=t.point.distanceTo(i);h<s&&h<=e&&(n=t.point,s=h);const l=r%2,a=()=>0===l?"x":"y",c=i[a()]<t.point[a()]?t.left:t.right;if(o(c,i,r+1),Math.abs(i[a()]-t.point[a()])<s){const e=i[a()]<t.point[a()]?t.right:t.left;o(e,i,r+1)}};return o(this.root,t,0),n}}class vt{constructor(t,e){this.point=t,this.left=null,this.right=null,this.axis=e}}class Pt{constructor(t){this.tree=new wt(t??[])}build(t){this.tree.build(t)}findNearestX(t,e=5){return this.tree.findNearestX(t)}findNearestY(t,e=5){return this.tree.findNearestY(t)}findPointsOnX(t){return this.tree.findPointsOnX(t)}findPointsOnY(t){return this.tree.findPointsOnY(t)}}class St{constructor(t){this.points=[],this.color=t??"blue"}render(t,e){e.save(),e.strokeStyle=this.color,e.fillStyle=this.color;for(let t=0;t<this.points.length;t++){const n=this.points[t];e.circle(n.x,n.y,5),e.fill()}if(this.points.length>1){const t=this.points[0],n=this.points[this.points.length-1];e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.closePath(),e.lineWidth=2,e.stroke()}e.restore()}}class Tt{constructor(){this.collinearPointsOnX=new Map,this.collinearPointsOnY=new Map}clear(){this.collinearPointsOnX.clear(),this.collinearPointsOnY.clear()}addCollinearPointsOnX(t,e){if(!e||0===e.length)return;t=Math.floor(t);const n=this.getOrCreateCollinearX(t);n.points.push(...e),n.points.sort(((t,e)=>t.y-e.y))}getOrCreateCollinearX(t){let e=this.collinearPointsOnX.get(t);return e||(e=new St,this.collinearPointsOnX.set(t,e)),e}addCollinearPointsOnY(t,e){if(0===e.length)return;t=Math.floor(t);const n=this.getOrCreateCollinearY(t);n.points.push(...e),n.points.sort(((t,e)=>t.x-e.x))}getOrCreateCollinearY(t){let e=this.collinearPointsOnY.get(t);return e||(e=new St,this.collinearPointsOnY.set(t,e)),e}render(t,e){e.save(),this.#w(t,e),this.#v(t,e),e.restore()}#w(t,e){this.collinearPointsOnX.forEach(((n,s)=>{n.render(t,e)}))}#v(t,e){this.collinearPointsOnY.forEach(((n,s)=>{n.render(t,e)}))}}class bt extends Q{constructor(t){super(),this.control=t.control,this.handler=t.handler,this.render=new Tt,this.coordinate=new Pt}#P(t){const e=t.getCurrentFloor();return e?e.getAllPoints().filter((t=>!this.control.isPointInControl(t)&&!this.control.isPointInSegment(t))):[]}onDragStart(t,e){this.coordinate.build(this.#P(t)),t.addSelectControl(this.render),this.handler.onDragStart(t,e)}onDrag(t,e){this.handler.onDrag(t,e);const n=this.#S(e);n&&this.handler.onDrag(t,n),this.#T()}onDragStop(t,e){this.handler.onDragStop(t,e);const n=this.#S(e);n&&this.handler.onDragStop(t,n),t.removeSelectControl(this.render)}#S(t){const e=this.#b(),n=this.#A();return null===e.x&&null===n.y?null:(t.x=e.x?t.x-e.distance:t.x,t.y=n.y?t.y-n.distance:t.y,t)}#b(){const t={x:null,distance:1/0};return this.getPoints().forEach((e=>{const n=this.coordinate.findNearestX(e.x);if(n){const s=e.x-n;Math.abs(t.distance)>Math.abs(s)&&(t.distance=s,t.x=n)}})),t}#A(){const t={y:null,distance:1/0};return this.getPoints().forEach((e=>{const n=this.coordinate.findNearestY(e.y);if(n){const s=e.y-n;Math.abs(t.distance)>Math.abs(s)&&(t.distance=s,t.y=n)}})),t}#T(){this.render.clear(),this.#O(),this.#D()}#O(){this.getPoints().forEach((t=>{const e=this.coordinate.findPointsOnX(t.x);e&&this.render.addCollinearPointsOnX(t.x,[...e,t])}))}#D(){this.getPoints().forEach((t=>{const e=this.coordinate.findPointsOnY(t.y);e&&this.render.addCollinearPointsOnY(t.y,[...e,t])}))}getPoints(){return this.control.getPoints()}}class At{static split(t,e){const n=this.#E(t,e);return n?n.intersections.length<=1?[]:this.#M(n):[]}static#E(t,e){const{points:n}=t,s=new Ot;for(let t=0;t<n.length;t++){const o=n[t],i=n[(t+1)%n.length],r=s.addPoint(o),h=new G(o,i);if(e.start.isEqualTo(o)||e.end.isEqualTo(o))r.intersected=!0;else{if(h.isPointInSegment(e.start)&&h.isPointInSegment(e.end))return null;if(h.isPointInSegment(e.start))s.addIntersection(e.start);else if(h.isPointInSegment(e.end))s.addIntersection(e.end);else{const t=e.getIntersectionPoint(h);t&&s.addIntersection(t)}}}return this.#R(s,t,e),s}static#R(t,e,n){const{intersections:s}=t;if(!(s.length<=1)){s.sort(((t,e)=>n.start.distanceTo(t.point)-n.start.distanceTo(e.point)));for(let t=0;t<s.length-1;t++){const n=s[t],o=s[t+1],i=new c((n.point.x+o.point.x)/2,(n.point.y+o.point.y)/2);e.isPointInside(i)&&(n.link=o,o.link=n)}}}static#M(t){const e=[];for(const n of t.nodes){if(n.visited||n.intersected)continue;const t=this.#B(n);t&&e.push(t)}return e}static#B(t){const e=[],n=t;let s=!1;for(;t&&(t.visited=!0,e.push(t.point.copy()),!s&&t.intersected?(s=!0,t=t.link??t.next):(s=!1,t=t.next),n!==t););return e.length>=3?new gt(e):null}}class Ot{constructor(){this.head=null,this.tail=null,this.nodes=[],this.intersections=[]}addPoint(t){const e=new Dt(t);return this.#H(e)}addIntersection(t){const e=new Dt(t,!0);return this.#H(e)}#H(t){return t&&(this.head||(this.head=null),this.nodes.push(t),t.intersected&&this.intersections.push(t),this.tail&&(this.tail.next=t),this.tail=t),t}}class Dt{constructor(t,e=!1){this.point=t.copy(),this.intersected=e,this.link=null}}class Et extends Q{constructor(t){super(),this.handler=t,this.downPoint=new c,this.dragging=!1}onDragStart(t,e){this.downPoint.x=e.x,this.downPoint.y=e.y}onDrag(t,e){this.dragging?this.handler.onDrag(t,e):this.downPoint.distanceTo(e)>5&&(this.dragging=!0,this.handler.onDragStart(t,e))}onDragStop(t,e){this.dragging&&this.handler.onDragStop(t,e)}}class Mt extends yt{constructor(t,e){super(t),this.fillColor=null,this.label=e,this.transparent=!0}get type(){return"room"}duplicate(){const t=new Mt(this.polygon.duplicate(),this.label);return t.fillColor=this.fillColor,t.label=this.label,t.transparent=this.transparent,this.segments.forEach(((e,n)=>{t.segments[n].thick=e.thick,t.segments[n].color=e.color})),t}hitControl(t,e){const n=this.findHoles(t.getCurrentFloor());return this.isPointInControl(e)?{control:this,render:new Ct(this,n)}:null}getControlsInsideRoom(t){const e=[];this.segments.forEach((n=>{const s=t.getControlsInsideSegment(n);s&&e.push(...s)}));let n=t.getControlsInsidePolygon(this.polygon);if(n)for(const t of n)"room"===t.type?this.calculateArea()>t.calculateArea()&&e.push(t):e.push(t);return e.filter(((t,n)=>e.indexOf(t)===n))}render(t,e){this.polygon.points.length<=0||(e.save(),this.#F(t,e),this.#k(t,e),this.#I(t,e),e.restore())}#I(t,e){if(!(this.segments.length<=0))for(const t of this.segments)t.thick>0&&(e.beginPath(),e.lineWidth=t.thick,e.strokeStyle=t.color,e.moveTo(t.start.x,t.start.y),e.lineTo(t.end.x,t.end.y),e.closePath(),e.stroke())}#F(t,e){const{points:n}=this.polygon;if(n.length>0&&this.fillColor){e.beginPath(),e.moveTo(n[0].x,n[0].y);for(let t=1;t<n.length;t++)e.lineTo(n[t].x,n[t].y);e.closePath(),e.fillStyle=this.transparent?ut.toTransparent(this.fillColor):this.fillColor,e.fill()}}#k(t,e){const n=this.polygon.getVisualCenterPoint();if(this.label&&n){const s=(t.config&&t.config.text&&t.config.text.size)??10;e.font=`${s}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="#000000",e.fillText(this.label,n.x,n.y)}}createControlHandler(t,e){if(!this.isPointInControl(e))return null;const n=t.getCurrentFloor(),s=this.getControlsInsideRoom(n),o=new lt;return o.addHandler(new Et(new bt({handler:new lt(new ot(this),new ot(s)),control:this}))),{control:this,handler:o}}hasNestedRoom(t){for(const e of t)if(e!==this&&this.isRoomContained(e))return!0;return!1}findHoles(t){const e=[];for(const n of t.getRooms())n!==this&&this.isRoomContained(n)&&this.calculateArea()>n.calculateArea()&&e.push(n);const n=[];for(const s of e)n.push(...s.findHoles(t));return e.filter((t=>!n.includes(t)))}isRoomContained(t){return this.polygon.isPolygonContained(t.polygon)}calculateArea(){return this.polygon.calculateArea()}split(t){const e=[],n=At.split(this.polygon,t);for(const t of n)if(t.calculateArea()>1){const n=new Mt(t.points);n.fillColor=this.fillColor,n.label=this.label,n.transparent=this.transparent,e.push(n)}return e}}class Rt extends Q{constructor(t){super(),this.door=t,this.started=!1,this.render=new Bt(this.door)}useSnap(){return!1}onDragStart(t,e){t.addSelectControl(this.render)}onDrag(t,e){const{segment:n}=this.door;let s=n.crossProductToStart(e);this.door.direction=s>0?"right":"left",this.door.hinge=n.start.distanceTo(e)<n.end.distanceTo(e)?"start":"end"}onDragStop(t,e){t.removeSelectControl(this.render)}}class Bt{constructor(t){this.door=t}render(t,e){this.door.getHingePoints().forEach((t=>{this.#X(e,t,"blue")}))}#X(t,e,n){t.beginPath(),t.arc(e.x,e.y,5,0,2*Math.PI),t.fillStyle=n,t.fill(),t.closePath()}}class Ht extends st{constructor(t,e){super(t,e),this.hinge="start",this.direction="right"}get type(){return"door"}duplicate(){const t=new Ht(this.start.copy(),this.end.copy());return t.hinge=this.hinge,t.direction=this.direction,t}findHitPoint(t,e){let n=super.findHitPoint(t,e);if(!n){const t=this.getChangeHingePoint();if(t.distanceTo(e)<10)return{point:t}}return n}createPointHandler(t,e){const n=this.findHitPoint(t,e);return n&&this.getChangeHingePoint().isEqualTo(n.point)?{control:this,handler:new Rt(this),point:n.point}:super.createPointHandler(t,e)}getChangeHingePoint(){return this.#Y(this.direction,this.hinge)}getHingePoints(){const t=[];return t.push(this.#Y("right","start")),t.push(this.#Y("right","end")),t.push(this.#Y("left","start")),t.push(this.#Y("left","end")),t}#Y(t,e){const n=this.length,s=this.segment.angle-270*Math.PI/180;let o=0,i=0;return"right"===t?"start"===e?(o=this.start.x+n*Math.cos(s),i=this.start.y+n*Math.sin(s)):(o=this.end.x+n*Math.cos(s),i=this.end.y+n*Math.sin(s)):"start"===e?(o=this.start.x-n*Math.cos(s),i=this.start.y-n*Math.sin(s)):(o=this.end.x-n*Math.cos(s),i=this.end.y-n*Math.sin(s)),new c(o,i)}render(t,e){e.save(),e.lineWidth=1,e.translate(this.start.x,this.start.y),e.rotate(this.segment.angle),this.#W(e),this.#N(e),e.restore()}#W(t){const e=this.length,n=10/3,s=new Path2D;s.rect(0,-5,e,10);for(let t=0;t<3;t++)s.rect(5,n*t-5,e-10,n);t.fillStyle="#ffffff",t.strokeStyle="#000000",t.fill(s),t.stroke(s)}#N(t){const e=this.length,n=new Path2D,s=Math.PI/2,o=Math.PI,i=0+e;"start"===this.hinge?"right"===this.direction?(n.arc(0,0,e,0,s,!1),n.moveTo(0,0),n.lineTo(0,e)):(n.arc(0,0,e,-s,0,!1),n.moveTo(0,0),n.lineTo(0,-e)):"right"===this.direction?(n.arc(i,0,e,s,o,!1),n.moveTo(i,0),n.lineTo(i,e)):(n.arc(i,0,e,o,-s,!1),n.moveTo(i,0),n.lineTo(i,-e)),t.stroke(n)}}class Ft extends st{constructor(t,e){super(t,e)}get type(){return"window"}duplicate(){return new Ft(this.start.copy(),this.end.copy())}render(t,e){const{start:n,end:s}=this.segment,o=this.segment.angle,i=this.segment.length,r=this.#z(i,10);e.save(),e.translate(n.x,n.y),e.rotate(o),e.lineWidth=1,e.strokeStyle="#000000",e.fillStyle="#ffffff",e.fill(r),e.stroke(r),e.restore()}#z(t,e){const n=e/3,s=new Path2D;s.rect(0,-5,t,e);for(let e=0;e<3;e++)s.rect(5,n*e-5,t-10,n);return s}}class kt extends yt{constructor(t){super(t)}get type(){return"outline"}hitControl(t,e){return null}render(t,e){this.segments.length<=0||(e.save(),this.renderLines(e,10,"#000000"),e.restore())}renderLines(t,e,n){for(const s of this.segments)t.lineWidth=e,t.strokeStyle=n,t.beginPath(),t.moveTo(s.start.x,s.start.y),t.lineTo(s.end.x,s.end.y),t.closePath(),t.stroke()}}class It{constructor(t){t?this.load(t):(this.rooms=[],this.walls=[],this.windows=[],this.doors=[],this.outlines=[]),this.onChange=null}getRooms(){return this.rooms}addRoom(t){t&&(this.rooms.push(t),this.fireOnChange())}removeRoom(t){const e=this.rooms.indexOf(t);-1!==e&&(this.rooms.splice(e,1),this.fireOnChange())}removeAllRooms(){this.rooms=[],this.fireOnChange()}getWalls(){return this.walls}addWall(t){t&&(this.walls.push(t),this.fireOnChange())}removeWall(t){const e=this.walls.indexOf(t);-1!==e&&this.walls.splice(e,1)}removeAllWalls(){this.walls=[],this.fireOnChange()}getWindows(){return this.windows}addWindow(t){t&&(this.windows.push(t),this.fireOnChange())}removeWindow(t){const e=this.windows.indexOf(t);-1!==e&&this.windows.splice(e,1)}removeAllWindows(){this.windows=[]}getDoors(){return this.doors}addDoor(t){t&&(this.doors.push(t),this.fireOnChange())}removeDoor(t){const e=this.doors.indexOf(t);-1!==e&&this.doors.splice(e,1)}addOutline(t){t&&(this.outlines.push(t),this.fireOnChange())}getOutlines(){return this.outlines}removeAllDoors(){this.doors=[],this.fireOnChange()}clear(){this.removeAllRooms(),this.removeAllWalls(),this.removeAllDoors(),this.removeAllWindows(),this.outlines=[]}load(t){this.clear(),t.outlines&&this.#L(t.outlines),t.rooms&&this.#V(t.rooms),t.walls&&this.#_(t.walls),t.windows&&this.#j(t.windows),t.doors&&this.#G(t.doors)}#L(t){for(const e of t)if(e.polygon&&e.polygon.points){const t=e.polygon.points.map((t=>new c(t.x,t.y))),n=new kt(t,e.label);for(let t=0;t<n.segments.length;t++){const s=n.segments[t];s.thick=e.segments[t].thick,s.color=e.segments[t].color}n.fillColor=e.fillColor,this.outlines.push(n)}}#V(t){for(const e of t)if(e.polygon&&e.polygon.points){const t=e.polygon.points.map((t=>new c(t.x,t.y))),n=new Mt(t,e.label);for(let t=0;t<n.segments.length;t++){const s=n.segments[t];s.thick=e.segments[t].thick,s.color=e.segments[t].color}n.fillColor=e.fillColor,n.label=e.label,n.transparent=e.transparent,this.rooms.push(n)}}#_(t){for(const e of t){const{start:t,end:n}=e.segment,s=new dt(new c(t.x,t.y),new c(n.x,n.y));this.walls.push(s)}}#j(t){for(const e of t){const{start:t,end:n}=e.segment,s=new Ft(new c(t.x,t.y),new c(n.x,n.y));this.windows.push(s)}}#G(t){for(const e of t){const{start:t,end:n}=e.segment,s=new Ht(new c(t.x,t.y),new c(n.x,n.y));s.hinge=e.hinge,s.direction=e.direction,this.doors.push(s)}}render(t,e,n){n??={},n.isRoomVisible=()=>n.visible?.room??!0,n.isWallVisible=()=>n.visible?.wall??!0,n.isOutlineVisible=()=>n.visible?.outline??!0,n.isDoorVisible=()=>n.visible?.door??!0,n.isWindowVisible=()=>n.visible?.window??!0,this.#U(t,e,n)}#U(t,e,n){n.isRoomVisible()&&this.#q(t,e),n.isWallVisible()&&this.#Q(t,e),n.isOutlineVisible()&&this.#K(t,e),n.isDoorVisible()&&this.#$(t,e),n.isWindowVisible()&&this.#J(t,e)}#q(t,e){const n=this.rooms.slice().sort(((t,e)=>e.calculateArea()-t.calculateArea()));for(const s of n)s.render(t,e)}#Q(t,e){for(const n of this.walls)n.render(t,e)}#K(t,e){for(const n of this.outlines)n.render(t,e)}#$(t,e){for(const n of this.doors)n.render(t,e)}#J(t,e){for(const n of this.windows)n.render(t,e)}removeControl(t){let e=this.walls.indexOf(t);if(-1!==e&&this.walls.splice(e,1),e=this.windows.indexOf(t),-1!==e&&this.windows.splice(e,1),e=this.doors.indexOf(t),-1!==e&&this.doors.splice(e,1),e=this.rooms.indexOf(t),-1!==e){this.rooms.splice(e,1);for(const e of t.getControlsInsideRoom(this))this.removeControl(e)}}getControlsInsideSegment(t){return[...this.windows,...this.doors,...this.walls].filter((e=>t.isPointInSegment(e.start)||t.isPointInSegment(e.end)))}getControlsInsidePolygon(t){const e=[];return e.push(...[...this.windows,...this.doors,...this.walls].filter((e=>{const n=e.getPoints();return t.isPointsInside(n)}))),e.push(...this.rooms.filter((e=>{const n=e.getSegments();for(const e of n)if(!t.isPointsInside([e.start,e.end,e.getMidPoint()]))return!1;return!0}))),e}getSegments(){const t=[];return t.push(...this.rooms.flatMap((t=>[...t.getSegments()]))),t.push(...this.walls.flatMap((t=>[...t.getSegments()]))),t}getBoundRect(){let t={minX:0,minY:0,maxX:0,maxY:0};const e=this.getAllControls();return 0===e.length||e.forEach(((e,n)=>{const s=e.getBoundRect();0===n?t=s:(t.minX=Math.min(t.minX,s.minX),t.minY=Math.min(t.minY,s.minY),t.maxX=Math.max(t.maxX,s.maxX),t.maxY=Math.min(t.maxY,s.maxY))})),t}existSameSegment(t,e){const n=new G(t,e);for(const t of this.getAllControls())for(const e of t.getSegments())if(e.isEqualTo(n))return!0;return!1}findNearestSegmentAtPoint(t){let e=null,n=null,s=1/0;for(const o of this.getAllConnectableSegments()){const i=o.getNearestPointOnSegment(t);if(i){const r=i.distanceTo(t);r<s&&(e=o,s=r,n=i)}}return{segment:e,point:n}}findControlsAtPoint(t,e){return this.getControls(e).filter((e=>e.isPointInControl(t)))}findControlsAtSegment(t,e){return this.getControls(e).filter((e=>e.isSegmentInControl(t)))}findSegmentAtPoint(t,e){for(const n of this.getConnectableSegments(e))if(n.isPointInSegment(t))return n;return null}isPointInSegment(t){const e=this.getControls();for(const n of e)if(n.isPointInSegment(t))return!0;return!1}isSegmentInSegment(t){this.getControls();for(const e of this.getConnectableSegments())if(e.isPointInSegment(t.start)&&e.isPointInSegment(t.end))return!0;return!1}getAllControls(){return[...this.outlines.slice().reverse(),...this.doors.slice().reverse(),...this.windows.slice().reverse(),...this.walls.slice().reverse(),...this.rooms.slice().reverse()]}getControls(t){return t??=()=>!0,this.getAllControls().filter(t)}getAllPoints(t){const e=[];for(const n of this.getAllControls())for(const s of n.getPoints())t&&t(s),e.push(s);return e}getPointsFromControls(t){const e=[];for(const n of t)for(const t of n.getPoints())e.push(t);return e}getAllConnectableSegments(){const t=[];for(const e of this.getAllControls())t.push(...e.getConnectableSegments());return t}getConnectableSegments(t){const e=[];for(const n of this.getControls(t))e.push(...n.getConnectableSegments());return e}splitRoom(t){const e=[],n=[];for(const s of this.getRooms()){const o=s.split(t);o.length>0&&(n.push(...o),e.push(s))}for(const t of e)this.removeRoom(t);for(const t of n)this.addRoom(t)}fireOnChange(){this.onChange&&this.onChange()}}class Xt{static importData(t,e,n){(new Wt).importData(t,e,new Yt(n))}static exportData(t,e){return(new Nt).export(t,e)}}class Yt{constructor(t){this.config=t,this.defaultRoomFillColor="rgba(131,208,221,0.5)",this.create={room:!0,wall:!0,door:!0,window:!0},t.create&&(this.create.room=t.create.room??!0,this.create.wall=t.create.wall??!0,this.create.door=t.create.door??!0,this.create.window=t.create.window??!0)}getScale(){return this.config.scale??4}getRoomFillColor(t){return this.config&&this.config.room&&this.config.room.colors&&this.config.room.colors.length>t?this.config.room.colors[t]:this.defaultRoomFillColor}isCreateDoor(){return this.create.door}isCreateWindow(){return this.create.window}isCreateWall(){return this.create.wall}isCreateRoom(){return this.create.room}getWallThick(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.thick?e.thick:1}getWallColor(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.color?e.color:"#000000"}getRoomColor(t){const{themes:e}=this.config,n=e?.room.find((e=>e.category===t));return n?.color??null}getRoomLabel(t){const{themes:e}=this.config,n=e?.room.find((e=>e.category===t));return n?.label??null}}class Wt{constructor(){this.scale=4}importData(t,e,n){this.scale=n.getScale();for(const s of e)"SPA"===s.type&&this.importSPA(t,s.categories,n);for(const s of e)"STR"===s.type&&this.importSTR(t,s.categories,n)}importSTR(t,e,n){for(const s of e)0!==s.category&&1!==s.category&&2!==s.category&&3!==s.category||this.importObjectFromSTR(t,s.category,s.objects,n)}importObjectFromSTR(t,e,n,s){new kt;const o=[];for(const i of n)if("line"===i.type){const n=i.data[0][0],r=i.data[0][1],h=i.data[1][0],l=i.data[1][1],a=new c(J.meterToPixel(n),J.meterToPixel(r)),d=new c(J.meterToPixel(h),J.meterToPixel(l));if(0!==e&&1!==e||!s.isCreateWall()){if(3===e&&s.isCreateDoor()){const e=new Ht(a,d);e.hinge=i.hinge??"start",e.direction=i.direction??"right",t.doors.push(e)}else if(2===e&&s.isCreateWindow()){const e=new Ft(a,d);t.windows.push(e)}}else if(0===e)0===o.length?o.push(a,d):o.push(d);else if(t.existSameSegment(a,d));else{const n=new dt(a,d);n.thick=s.getWallThick(e),n.color=s.getWallColor(e),t.walls.push(n)}}o.length>0&&t.addOutline(new kt(o))}importSPA(t,e,n){for(const s of e)11!==s.category&&this.importObjectFromSPA(t,s.category,s.objects,n)}importObjectFromSPA(t,e,n,s){for(const o of n)if("Polygon"===o.type&&s.isCreateRoom()){const n=[];for(const t of o.data)n.push(new c(J.meterToPixel(t[0]),J.meterToPixel(t[1])));const i=new Mt(n,"");i&&(i.category=e,i.label=s.getRoomLabel(e),i.fillColor=s.getRoomColor(e),t.rooms.push(i))}}}class Nt{constructor(){}export(t,e){const n={};return n.floor=e??1,n.datas=[],n.datas.push(this.#Z(t)),n.datas.push(this.#tt(t)),n}#Z(t){const e={type:"STR",categories:[]},n=t=>{t&&e.categories.push(t)};return n(this.#et(t)),n(this.#nt(t)),n(this.#st(t)),n(this.#ot(t)),e}#tt(t){const e={type:"SPA",categories:[]};return this.#it(t,e.categories),e}#et(t){const e={category:0,objects:[]};for(const n of t.getOutlines())for(const t of n.segments)e.objects.push({type:"line",data:this.#rt(t),radius:0});return e}#nt(t){const e={category:1,objects:[]};for(const n of t.getWalls())e.objects.push({type:"line",data:this.#rt(n.segment),radius:0});return e}#it(t,e){for(const n of t.getRooms()){const t={};t.category=n.category??0,t.objects=[],t.objects.push({type:"Polygon",data:this.#ht(n.polygon.points),radius:0}),e.push(t)}}#st(t){const e={category:2,objects:[]};for(const n of t.getWindows())e.objects.push({type:"line",data:this.#rt(n.segment),radius:0});return e}#ot(t){const e={category:3,objects:[]};for(const n of t.getDoors())e.objects.push({type:"line",data:this.#rt(n.segment),radius:0});return e}#rt(t){const e=t=>J.pixelToMeter(t);return t?[[e(t.start.x),e(t.start.y)],[e(t.end.x),e(t.end.y)]]:[]}#ht(t){const e=t=>J.pixelToMeter(t);return t.map((t=>[e(t.x),e(t.y)]))}}class zt{constructor(t){this.editor=t,this.floors=[new It],this.index=0}clear(){this.floors=[]}loadFloorFromPublicAi(t,e,n){this.floors=[],t.floors.forEach((t=>{const e=new It;Xt.importData(e,t.datas,n),this.floors.push(e)})),this.index=e?e-1:0}saveFloorToPublicAi(){const t={floors:[]};return this.floors.forEach(((e,n)=>{(e=>{e&&t.floors.push(e)})(Xt.exportData(e,n+1))})),JSON.stringify(t,null,2)}saveFloor(){const t={};return t.floors=this.floors,t.floor=this.index,JSON.stringify(t,null,2)}loadFloor(t){this.floors=[];const e=JSON.parse(t);this.floors=e.floors?e.floors.map((t=>new It(t))):[],this.index=e.floor??0}getCurrentFloor(){return this.index>=0&&this.index<this.floors.length?this.floors[this.index]:null}}class Lt{onCommandActive(t){}onCommandDeActive(t){}}class Vt{constructor(){}onClick(t){}onKeyDown(t,e){}onMouseDown(t){}onMouseMove(t){}onMouseUp(t){}onContextMenu(t){}}class _t extends Q{constructor(t,e){super(),this.point=t,this.handlers=e??[],this.render=new Tt,this.coordinate=new Pt}getAllPointsExceptGivenPoint(t){const e=t.getCurrentFloor();return e?e.getAllPoints().filter((t=>t!==this.point)):[]}onDragStart(t,e){this.coordinate.build(this.getAllPointsExceptGivenPoint(t)),t.addSelectControl(this.render),this.handlers.forEach((n=>{n.onDragStart(t,e)}))}onDrag(t,e){e=this.findNearestPoint(e),this.handlers.forEach((n=>{n.onDrag(t,e)})),this.createCollinearPoints(e)}onDragStop(t,e){t.removeSelectControl(this.render),e=this.findNearestPoint(e),this.handlers.forEach((n=>{n.onDragStop(t,e)}))}findNearestPoint(t){return t.x=this.coordinate.findNearestX(t.x)??t.x,t.y=this.coordinate.findNearestY(t.y)??t.y,t}createCollinearPoints(t){this.render.clear(),this.createCollinearPointsOnX(t),this.createCollinearPointsOnY(t)}createCollinearPointsOnX(t){const e=this.coordinate.findPointsOnX(t.x);e&&this.render.addCollinearPointsOnX(t.x,[...e,t])}createCollinearPointsOnY(t){const e=this.coordinate.findPointsOnY(t.y);e&&this.render.addCollinearPointsOnY(t.y,[...e,t])}}class jt extends Q{constructor({segment:t,handler:e}){super(),this.segment=t,this.handler=e,this.render=new Tt,this.coordinate=new Pt}getAllPointsExceptGivenSegment(t){const e=t.getCurrentFloor();return e?e.getAllPoints().filter((t=>this.segment.start!==t&&this.segment.end!==t)):[]}onDragStart(t,e){this.coordinate.build(this.getAllPointsExceptGivenSegment(t)),t.addSelectControl(this.render),this.handler.onDragStart(t,e)}onDrag(t,e){this.handler.onDrag(t,e),(this.segment.isHorizontal()||this.segment.isVertical())&&(e=this.findNearestPoint(e),this.handler.onDrag(t,e)),this.createCollinearPoints(e)}onDragStop(t,e){t.removeSelectControl(this.render),this.handler.onDragStop(t,e)}findNearestPoint(t){const e=this.findNearestX(),n=this.findNearestY();return null===e.x&&null===n.y?null:(t.x=e.x?t.x-e.distance:t.x,t.y=n.y?t.y-n.distance:t.y,t)}findNearestX(){const t={x:null,distance:1/0};return[this.segment.start,this.segment.end].forEach((e=>{const n=this.coordinate.findNearestX(e.x);if(n){const s=e.x-n;Math.abs(t.distance)>Math.abs(s)&&(t.distance=s,t.x=n)}})),t}findNearestY(){const t={y:null,distance:1/0};return[this.segment.start,this.segment.end].forEach((e=>{const n=this.coordinate.findNearestY(e.y);if(n){const s=e.y-n;Math.abs(t.distance)>Math.abs(s)&&(t.distance=s,t.y=n)}})),t}createCollinearPoints(){this.render.clear(),[this.segment.start,this.segment.end].forEach((t=>{this.createCollinearPointsOnX(t),this.createCollinearPointsOnY(t)}))}createCollinearPointsOnX(t){const e=this.coordinate.findPointsOnX(t.x);e&&this.render.addCollinearPointsOnX(t.x,[...e,t])}createCollinearPointsOnY(t){const e=this.coordinate.findPointsOnY(t.y);e&&this.render.addCollinearPointsOnY(t.y,[...e,t])}}class Gt extends Lt{constructor(t){super(),this.handler=new Ut(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Ut extends Vt{constructor(t){super(),this.editor=t,this.handler=null,this.isDgragging=!1,this.offset=new c,this.downPoint=new c}onKeyDown(t,e){"Backspace"===t||"Escape"===t&&this.editor.hideContextToolbar()}onMouseDown(t){this.downPoint.x=t.x,this.downPoint.y=t.y,this.editor.setSelectControls([]),this.isDgragging=!0,this.editor.hideContextToolbar(),this.handler=this.createDragHandler(this.downPoint),this.handler?this.handler.onDragStart(this.editor,this.downPoint):(this.offset.x=t.clientX,this.offset.y=t.clientY),this.editor.render()}onMouseMove(t){const e=new c(t.x,t.y);if(this.isDgragging)if(this.handler)this.handler.onDrag(this.editor,e);else{const e=t.clientX-this.offset.x,n=t.clientY-this.offset.y;this.editor.translateContext(e,n),this.offset.x=t.clientX,this.offset.y=t.clientY}else this.renderAvailableHandler(e);this.editor.render()}onMouseUp(t){const e=new c(t.x,t.y);this.isDgragging&&this.handler&&(this.handler.onDragStop(this.editor,e),this.editor.getCurrentFloor().fireOnChange()),this.isDgragging=!1,this.handler=null,this.editor.setSelectControls([]),this.editor.render()}onContextMenu(t){this.showToolbar(t)}showToolbar(t){const e=this.editor.getCurrentFloor(),n=e.findControlsAtPoint(this.downPoint),s=e.findSegmentAtPoint(this.downPoint);this.editor.showContextToolbar(t,{control:(t=>0===(t=t.filter((t=>"outline"!==t.type))).length?null:1===t.length?t[0]:t.reduce(((t,e)=>"window"===t.type||"door"===t.type?t:"window"===e.type||"door"===e.type?e:t)))(n),segment:s})}createDragHandler(t){const e=this.finAllDragHandlersAtPoint(t);if(e.points.length>0)return 1!==e.points.length||e.points[0].handler.useSnap()?new _t(e.points[0].point,e.points.map((t=>t.handler))):e.points[0].handler;if(e.controls.length>0)for(const t of e.controls)if("window"===t.control.type||"door"===t.control.type)return t.handler;if(e.segments.length>0)return new jt(e.segments[0]);if(e.controls.length>0){return(t=>{const e=t.map((t=>t.control));for(const n of t)if(!n.control.hasNestedRoom(e))return n;return t[0]})(e.controls).handler}return null}finAllDragHandlersAtPoint(t){const e=this.editor.getCurrentFloor().getAllControls(),n={points:[],segments:[],controls:[]};for(const s of e){let e=s.createPointHandler(this.editor,t);e&&n.points.push(e),e=s.createSegmentHandler(this.editor,t),e&&n.segments.push(e),e=s.createControlHandler(this.editor,t),e&&n.controls.push(e)}return n.segments.length>0&&n.segments.sort(((e,n)=>e.segment.start.distanceTo(t)-n.segment.start.distanceTo(t))),n}renderAvailableHandler(t){this.editor.setSelectControls([]);const e=this.editor.getCurrentFloor();for(const n of e.getAllControls()){const e=n.hitPoint(this.editor,t);if(e&&e.render)return void this.editor.setSelectControls([e.render])}const n=[];for(const s of e.getAllControls()){const e=s.hitSegment(this.editor,t);e&&e.render&&(e.distance=t.distanceTo(e.segment.start),n.push(e))}if(n.length>0)return n.sort(((t,e)=>t.distance-e.distance)),void this.editor.setSelectControls([n[0].render]);for(const n of e.getAllControls()){const e=n.hitControl(this.editor,t);if(e&&e.render)return void this.editor.setSelectControls([e.render])}}}class qt extends Lt{constructor(t){super(),this.handler=new Qt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Qt extends Vt{constructor(t){super(),this.editor=t,this.window=new Ft(new c(0,0),new c(50,50)),this.render=new Kt,this.render.window=this.window,this.editor.addSelectControl(this.render)}onMouseDown(t){const e=this.editor.getCurrentFloor();e&&(e.addWindow(this.window),this.editor.removeSelectControl(this.render),this.editor.tools.select(),this.editor.render())}onMouseMove(t){const e=this.editor.getCurrentFloor();if(e){const{segment:n,point:s}=e.findNearestSegmentAtPoint(new c(t.x,t.y));if(n){const t=n.getPointAtDistance(s,-25),e=n.getPointAtDistance(s,25);this.render.updateWindow(t,e),this.render.updateSegment(n)}else{const e=new c(t.x-25,t.y),n=new c(t.x+25,t.y);this.render.updateWindow(e,n),this.render.updateSegment(null)}this.editor.render()}}}class Kt{constructor(){this.window=null,this.measure=new Z}updateWindow(t,e){const{segment:n}=this.window;n.start.copyFrom(t),n.end.copyFrom(e)}updateSegment(t){this.measure.segments=t?[t,this.window.segment]:[this.window.segment]}render(t,e){e.save(),this.window.render(t,e),this.measure.render(t,e),e.restore()}}class $t extends Lt{constructor(t){super(),this.handler=new Jt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Jt extends Vt{constructor(t){super(),this.editor=t,this.door=new Ht(new c(0,0),new c(50,50)),this.render=new Zt,this.render.door=this.door,this.editor.addSelectControl(this.render)}onMouseDown(t){const e=this.editor.getCurrentFloor();e&&e.addDoor(this.door),this.editor.removeSelectControl(this.render),this.editor.tools.select()}onMouseMove(t){const e=this.editor.getCurrentFloor();if(e){const{segment:n,point:s}=e.findNearestSegmentAtPoint(new c(t.x,t.y));if(n){const t=n.getPointAtDistance(s,-25),e=n.getPointAtDistance(s,25);this.render.updateDoor(t,e),this.render.updateSegment(n)}else{const e=new c(t.x-25,t.y),n=new c(t.x+25,t.y);this.render.updateDoor(e,n),this.render.updateSegment(null)}this.editor.render()}}}class Zt{constructor(){this.door=null,this.measure=new Z}updateDoor(t,e){const{segment:n}=this.door;n.start.copyFrom(t),n.end.copyFrom(e)}updateSegment(t){this.measure.segments=t?[t,this.door.segment]:[this.door.segment]}render(t,e){e.save(),this.door.render(t,e),this.measure.render(t,e),e.restore()}}class te extends Lt{constructor(t,e){super(),this.editor=t,this.scale=e}onCommandActive(t){1===this.scale?this.editor.zoomDefault():this.editor.zoom(this.scale,this.scale),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class ee extends Lt{constructor(t){super(),this.editor=t}onCommandActive(t){this.editor.clear(),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class ne extends Lt{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.historyManager.undo();e&&this.editor.loadFloor(e),this.editor.tools.select()}onCommandDeActive(t){}}class se extends Lt{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.historyManager.redo();e&&this.editor.loadFloor(e),this.editor.tools.select()}onCommandDeActive(t){}}class oe extends Lt{constructor(t,e){super(),this.handler=new ie(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class ie extends Vt{constructor(t,e){super(),this.editor=t,this.room=new Mt,this.room.label=e?.label,this.room.fillColor=e?.color,this.room.category=e?.category,this.render=new re,this.start=new c,this.end=new c,this.started=!1,this.render.room=this.room,this.editor.addSelectControl(this.render)}get defaultSize(){return 100}onMouseDown(t){this.started=!0,this.start.x=t.snapX,this.start.y=t.snapY}onMouseMove(t){this.started?(this.end.x=t.snapX,this.end.y=t.snapY):(this.start.x=t.snapX,this.start.y=t.snapY,this.end.x=this.start.x+this.defaultSize,this.end.y=this.start.y+this.defaultSize),this.updateRoom(),this.editor.render()}onMouseUp(t){if(this.editor.removeSelectControl(this.render),this.started){this.start.distanceTo(this.end)<10&&(this.end.x=this.start.x+this.defaultSize,this.end.y=this.start.y+this.defaultSize),this.updateRoom(),this.addRoom()}this.started=!1,this.editor.render(),this.editor.tools.select()}updateRoom(){const t=new c(this.start.x,this.start.y),e=new c(this.end.x,this.start.y),n=new c(this.end.x,this.end.y),s=new c(this.start.x,this.end.y);this.room.setPoints([t,e,n,s]),this.render.measures[0].getFirstSegment().start=t,this.render.measures[0].getFirstSegment().end=e,this.render.measures[1].getFirstSegment().start=e,this.render.measures[1].getFirstSegment().end=n}addRoom(){const t=this.editor.getCurrentFloor();t&&t.addRoom(this.room)}}class re extends j{constructor(){super(),this.room=null,this.measures=[],this.measures[0]=new Z(new G),this.measures[1]=new Z(new G)}render(t,e){this.room?.render(t,e),this.measures[0].render(t,e),this.measures[1].render(t,e)}}class he extends Lt{constructor(t){super(),this.handler=new le(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class le extends Vt{constructor(t){super(),this.editor=t,this.outline=new kt,this.render=new ae(this.outline),this.isDragging=!1,this.start=new c,this.end=new c}onMouseDown(t){this.isDragging=!0,this.start.x=t.snapX,this.start.y=t.snapY,this.end.x=t.snapX,this.end.y=t.snapY,this.outline.setPoints(this.createOutlinePoints()),this.editor.addSelectControl(this.render)}onMouseMove(t){this.isDragging&&(this.end.x=t.snapX,this.end.y=t.snapY,this.render.setPoints(this.createOutlinePoints()),this.editor.render())}onMouseUp(t){if(this.editor.removeSelectControl(this.render),this.isDragging){const e=this.editor.getCurrentFloor();e&&(this.end.x=t.snapX,this.end.y=t.snapY,this.render.setPoints(this.createOutlinePoints()),e.addOutline(this.outline),this.editor.render())}this.isDragging=!1,this.editor.tools.select()}createOutlinePoints(){const t=[];return t.push(new c(this.start.x,this.start.y)),t.push(new c(this.end.x,this.start.y)),t.push(new c(this.end.x,this.end.y)),t.push(new c(this.start.x,this.end.y)),t}}class ae{constructor(t){this.outline=t,this.measureTop=new Z(new G),this.measureRight=new Z(new G)}setPoints(t){this.outline.setPoints(t),this.measureTop.getFirstSegment().start=t[0],this.measureTop.getFirstSegment().end=t[1],this.measureRight.getFirstSegment().start=t[1],this.measureRight.getFirstSegment().end=t[2]}render(t,e){this.outline?.render(t,e),this.measureTop.render(t,e),this.measureRight.render(t,e)}}class ce extends Lt{constructor(t){super(),this.handler=new de(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class de extends Vt{constructor(t){super(),this.editor=t,this.started=!1,this.wall=new dt,this.wall.thick=1,this.render=new ue,this.render.segment=this.wall.segment,this.editor.addSelectControl(this.render)}onMouseDown(t){this.started=!0,this.wall.segment.end.x=t.snapX,this.wall.segment.end.y=t.snapY}onMouseMove(t){const e=this.editor.getCurrentFloor();if(this.started){const n=e.findNearestSegmentAtPoint(new c(t.snapX,t.snapY));n?(this.wall.segment.end.x=n.point.x,this.wall.segment.end.y=n.point.y):(this.wall.segment.end.x=t.snapX,this.wall.segment.end.y=t.snapY),this.render.setIntersectionPoints(this.findIntersectionPoints(this.editor))}else{this.wall.segment.end.x=t.snapX,this.wall.segment.end.y=t.snapY;const n=e.findNearestSegmentAtPoint(new c(t.snapX,t.snapY));n&&(this.wall.segment.start.x=n.point.x,this.wall.segment.start.y=n.point.y)}this.editor.render()}onMouseUp(t){this.editor.removeSelectControl(this.render),this.editor.getCurrentFloor().splitRoom(this.wall.segment),this.started=!1,this.editor.render(),this.editor.tools.select()}addWalls(){const t=this.editor.getCurrentFloor(),e=[this.wall.segment.start,...this.findIntersectionPoints(this.editor),this.wall.segment.end];for(let n=0;n<e.length-1;n++){const s=e[n],o=e[n+1];if(!t.isSegmentInSegment(new G(s,o))){const e=new dt(s.copy(),o.copy());e.thick=10,t.addWall(e)}}}findIntersectionPoints(t){const e=t.getCurrentFloor(),n=[];for(const t of e.getRooms())n.push(...t.findIntersectionPoints(this.wall.segment));return n.sort(((t,e)=>t.distanceTo(this.wall.segment.start)-e.distanceTo(this.wall.segment.start))),n}}class ue{constructor(){this.intersectionPoints=[],this.segment=null}setSegment(t){this.segment=t}setIntersectionPoints(t){this.intersectionPoints=t}render(t,e){e.save(),this.#I(e),this.#lt(e),e.restore()}#I(t){t.beginPath(),t.lineWidth=1,t.strokeStyle="black",t.moveTo(this.segment.start.x,this.segment.start.y),t.lineTo(this.segment.end.x,this.segment.end.y),t.closePath(),t.stroke(),this.#X(t,this.segment.start,K.primaryRedColor),this.#X(t,this.segment.end,K.primaryRedColor)}#lt(t){for(const e of this.intersectionPoints)this.#X(t,e,K.primaryRedColor)}#X(t,e,n){t.beginPath(),t.arc(e.x,e.y,5,0,2*Math.PI),t.fillStyle=n,t.fill(),t.closePath()}}class ge{constructor(){this.vertices=[]}addEdge(t,e){this.addVertex(t.x,t.y).connect(this.addVertex(e.x,e.y))}addVertex(t,e){let n=this.findVertex(t,e);return n||(n=new me(t,e),this.vertices.push(n)),n}findVertex(t,e){return this.vertices.find((n=>n.x===t&&n.y===e))}}class me{constructor(t,e){this.x=t,this.y=e,this.adjacents=[]}addAdjacent(t){if(t){if(this.findAdjacent(t))return;this.adjacents.push(t)}}removeAdjacent(t){this.adjacents=this.adjacents.filter((e=>e!==t))}connect(t){return t&&(this.addAdjacent(t),t.addAdjacent(this)),this}disconnect(t){return t&&(this.removeAdjacent(t),t.removeAdjacent(this)),this}findAdjacent(t){return this.adjacents.find((e=>e===t))}vector({x:t,y:e}){return new fe(this.x-t,this.y-e)}}class fe{constructor(t,e){this.x=t,this.y=e}crossProduct({x:t,y:e}){return this.x*e-this.y*t}dotProduct({x:t,y:e}){return this.x*t+this.y*e}}class pe{constructor(){}extractCycles(t){let e=[];for(;t.length>0;){let n=this.getLeftBottomVertex(t),s=this.closedWalkFrom(n),o=this.reduceWalk(s);o.length>2&&e.push(o),this.removeEdge(o[0],o[1]),t=this.removeFilamentAt(o[0],t),t=this.removeFilamentAt(o[1],t)}return e}closedWalkFrom(t){let e=[],n=t,s=null;do{e.push(n),[n,s]=this.getNext(n,s)}while(n!==t);return e}reduceWalk(t){for(let e=1;e<t.length;e++){let n=t.lastIndexOf(t[e]);n>e&&t.splice(e+1,n-e)}return t}removeFilamentAt(t,e){let n,s=t;const o=t=>{e=e.filter((e=>e!==t))};for(;s&&s.adjacents.length<2;)o(s),n=s.adjacents[0],n&&n.removeAdjacent(s),s=n;return e}removeEdge(t,e){t&&t.removeAdjacent(e),e&&e.removeAdjacent(t)}getNext(t,e){let n=null;return 0===t.adjacents.length?n=t:1===t.adjacents.length?n=t.adjacents[0]:e?(t.removeAdjacent(e),n=this.getCounterClockWiseMostVertex(e,t),t.addAdjacent(e)):n=this.getClockWiseMostVertex(e,t),[n,t]}getCounterClockWiseMostVertex(t,e){return this.getBestVertex(t,e,"ccw")}getClockWiseMostVertex(t,e){return this.getBestVertex(t,e,"cw")}getBestVertex(t,e,n){const s=t?e.vector(t):new fe(0,-1),o=[],i=[],r=[];for(const t of e.adjacents){const n=t.vector(e),h=s.crossProduct(n);0===h?r.push(t):h>0?i.push(t):o.push(t)}const h=(t,n)=>{const s=t.vector(e),o=n.vector(e);return s.crossProduct(o)>0?-1:1},l=(t,e)=>-1*h(t,e);let a=[];return"ccw"===n?(a=o.length>0?o:i,a.push(...r),a.sort(h)):(a=i.length>0?i:o,a.push(...r),a.sort(l)),a[0]}getLeftBottomVertex(t){return t.reduce(((t,e)=>{let n=e.x-t.x;return n<0?e:n>0||e.y-t.y<0?t:e}))}}class xe{constructor(){this.graph=new ge}addSegment(t){t&&this.graph.addEdge(t.start,t.end)}build(){return(new pe).extractCycles(this.graph.vertices).map((t=>this.createPolygon(t)))}createPolygon(t){const e=new gt;for(const n of t)e.addPoint(new c(n.x,n.y));return e}}class ye{constructor(t=Ce){this.data=[],this.comparator=t}get length(){return this.data.length}peek(){return 0===this.length?null:this.data[0]}push(...t){t.forEach((t=>{this.data.push(t)})),this.sort()}pop(){if(0===this.length)return null;const t=this.data[0];return this.data=this.data.slice(1),t}sort(){this.data.sort(((t,e)=>this.comparator(t,e)))}}function Ce(t,e){return t-e}class we{constructor(){this.events=this.createEventQueue()}addSegment(t){const e=new ve(t.start.copy()),n=new ve(t.end.copy());this.comparePoint(t.start,t.end)<=0?(e.start=!0,n.start=!1):(e.start=!1,n.start=!0),e.other=n,n.other=e,this.events.push(e),this.events.push(n)}scan(){const t=[];let e=[];const n=t=>{e=e.filter((e=>e!==t.other))},s=e=>{e&&(e.length<=0||t.some((t=>t.isEqualTo(e)))||t.push(e))};for(;this.events.length>0;){const t=this.events.pop();if(t.isStart()){const n=t.createSegment();for(const s of e){const e=s.createSegment();if(!e.isEqualTo(n))if(this.isPointOnSegment(e,n.start))s.addIntersectionPoint(n.start);else if(this.isPointOnSegment(e,n.end))s.addIntersectionPoint(n.end);else{const o=e.getIntersectionPoint(n);o&&(s.addIntersectionPoint(o),t.addIntersectionPoint(o))}}e.push(t)}else n(t),t.createSegments().forEach((t=>{s(t)}))}return t}isPointOnSegment(t,e){return!t.start.isEqualTo(e)&&!t.end.isEqualTo(e)&&t.isPointInSegment(e,.1)}comparePoint(t,e){return t.x!==e.x?t.x-e.x:t.y-e.y}createEventQueue(){return new ye(((t,e)=>this.comparePoint(t.point,e.point)))}}class ve{constructor(t,e){this.point=t,this.start=e??!0,this.other=null,this.intersections=[]}isStart(){return this.start}createSegment(){return this.start?new G(this.point.copy(),this.other.point.copy()):new G(this.other.point.copy(),this.point.copy())}createSegments(){const t=[],e=[this.other.point,...this.other.intersections,this.point];e.sort(((t,e)=>this.point.distanceTo(t)-this.point.distanceTo(e)));for(let n=0;n<e.length-1;n++)t.push(new G(e[n],e[n+1]));return t}addIntersectionPoint(t){t&&(this.intersections.some((e=>e.isEqualTo(t)))||this.intersections.push(t))}}class Pe extends Lt{constructor(t,e){super(),this.handler=new Se(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Se extends Vt{constructor(t,e){super(),this.room=new Mt,this.room.label=e?.label,this.room.fillColor=e?.color,this.room.category=e?.category,this.editor=t,this.point=null,this.editor.addSelectControl(this),this.builder=new xe,this.polygons=this.#at()}onMouseDown(t){}#at(){const t=this.#ct().scan();for(const e of t)this.builder.addSegment(e);return this.builder.build()}#ct(){const t=new we,e=this.editor.getCurrentFloor();return[...e.getOutlines(),...e.getRooms()].forEach((e=>{if("polygon"in e)for(const n of e.polygon.createSegments())t.addSegment(n)})),e.getWalls().forEach((e=>{t.addSegment(e.segment)})),t}onMouseMove(t){this.point=new c(t.x,t.y),this.editor.render()}onMouseUp(t){const e=new c(t.x,t.y);if(!this.#dt(e)){const e=this.#ut(new c(t.x,t.y));if(e){const t=this.editor.getCurrentFloor();this.room.setPoints(e.points),t.addRoom(this.room)}}this.editor.removeSelectControl(this),this.editor.tools.select(),this.editor.render()}render(t,e){if(this.point)if(this.#dt(this.point))this.#g(e,this.point,"빈 공간을 선택하세요");else{const t=this.#ut(this.point);t&&(this.#y(e,t),this.#gt(e,t))}}#dt(t){return this.editor.getCurrentFloor().findControlsAtPoint(t,(t=>"outline"!==t.type)).length>0}#y(t,e){this.room.setPoints(e.points),this.room.render(this.editor,t)}#gt(t,e){const{points:n}=e;if(n.length>0){t.beginPath(),t.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++)t.lineTo(n[e].x,n[e].y);t.closePath(),t.strokeStyle=K.activeColor,t.lineWidth=10,t.stroke()}}#g(t,e,n,s="white"){const o=t.measureText(n).width+10,i=e.x,r=e.y+30;t.fillStyle="black",t.fillRect(i-o/2,r-7.5,o,15),t.fillStyle=s,t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(n,i,r)}#ut(t){return this.polygons.find((e=>e.isPointInside(t)))}}class Te extends Lt{constructor(t){super(),this.handler=new be(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class be extends Vt{constructor(t){super(),this.editor=t,this.wall=new dt,this.wall.thick=1,this.render=new Ae(this.wall),this.started=!1}onMouseDown(t){this.started=!0,this.wall.start.x=t.snapX,this.wall.start.y=t.snapY,this.editor.addSelectControl(this.render)}onMouseMove(t){this.started&&(this.wall.end.x=t.snapX,this.wall.end.y=t.snapY,this.editor.render())}onMouseUp(t){if(this.started){t.snapX,t.snapY;this.wall.segment.length>10&&this.editor.getCurrentFloor()?.addWall(this.wall),this.editor.removeSelectControl(this.render),this.editor.render(),this.editor.tools.select()}this.started=!1}}class Ae{constructor(t){this.wall=t,this.measure=new Z(t?.segment)}render(t){this.wall?.render(t),this.measure.render(t)}}class Oe extends Lt{constructor(t,e){super(),this.editor=t,this.size=e,this.minSize=5,this.maxSize=50}onCommandActive(t){this.editor.config??={},this.editor.config.text??={},this.editor.config.text.size??=10,this.editor.config.text.size+=this.size;const e=this.editor.config.text.size;e<this.minSize&&(this.editor.config.text.size=this.minSize),e>this.maxSize&&(this.editor.config.text.size=this.maxSize),this.editor.tools.select(),this.editor.render()}onCommandDeActive(t){}}class De{constructor(t){this.editor=t}undo(){this.deActiveCommand(),this.editor.activeCommand=new ne(this.editor),this.activeCommand()}redo(){this.deActiveCommand(),this.editor.activeCommand=new se(this.editor),this.activeCommand()}select(){this.deActiveCommand(),this.editor.activeCommand=new Gt(this.editor),this.activeCommand()}findRoom(t){this.deActiveCommand(),this.editor.activeCommand=new Pe(this.editor,t),this.activeCommand()}createRoom(t){this.deActiveCommand(),t.isFind?this.editor.activeCommand=new Pe(this.editor,t):this.editor.activeCommand=new oe(this.editor,t),this.activeCommand()}createOutline(){this.deActiveCommand(),this.editor.activeCommand=new he(this.editor),this.activeCommand()}createWall(){this.deActiveCommand(),this.editor.activeCommand=new ce(this.editor),this.activeCommand()}createWallOld(){this.deActiveCommand(),this.editor.activeCommand=new Te(this.editor),this.activeCommand()}createDoor(){this.deActiveCommand(),this.editor.activeCommand=new $t(this.editor),this.activeCommand()}createWindow(){this.deActiveCommand(),this.editor.activeCommand=new qt(this.editor),this.activeCommand()}zoomIn(){this.deActiveCommand(),this.editor.activeCommand=new te(this.editor,.1),this.activeCommand()}zoomDefault(){this.deActiveCommand(),this.editor.activeCommand=new te(this.editor,1),this.activeCommand()}zoomOut(){this.deActiveCommand(),this.editor.activeCommand=new te(this.editor,-.1),this.activeCommand()}clear(){this.deActiveCommand(),this.editor.activeCommand=new ee(this.editor),this.activeCommand()}increaseTextSize(){this.deActiveCommand(),this.editor.activeCommand=new Oe(this.editor,2),this.activeCommand()}decreaseTextSize(){this.deActiveCommand(),this.editor.activeCommand=new Oe(this.editor,-2),this.activeCommand()}deActiveCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandDeActive(this.editor),this.editor.activeCommand=null}activeCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandActive(this.editor)}}class Ee{constructor(){this.canvas=null,this.container=null,this.context=null,this.tools=new De(this),this.editorRender=null,this.transform=new _,this.contextToolbar=null,this.mainToolbar=null,this.activeCommand=null,this.eventController=new u(this),this.config={},this.selects=[],this.historyManager=new V,this.floorManager=new zt(this)}edit(t,e){if(this.config=e,this.historyManager.clear(),window&&document){const n=document.querySelector(t);this.container=this.#mt(),n?(n.tabIndex=1,n.style.outline="none",n.appendChild(this.container),this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.canvas.tabindex=2,this.canvas.style.outline="none",this.context=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.canvas.focus()):document.appendChild(this.container);let s=(window.devicePixelRatio||1)/(this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1);this.#ft(s),this.#pt(),this.#xt(),this.#yt(),this.#Ct(),this.saveFloorToHistory(),this.render(),this.tools.select()}}clear(){this.selects=[],this.floorManager.clear(),this.transform.clear()}load(t,e,n){if(!t)return;this.clear(),this.transform.resetTransform(this.context),this.floorManager.loadFloorFromPublicAi(t,e,n);const s=this.getCurrentFloor();if(s){const t=s.getBoundRect();this.translateContext(100-t.minX,100-t.minY)}this.context.lineJoin="round",this.context.lineCap="square",this.context.imageSmoothingEnabled=!0,this.#yt(),this.#Ct(),this.saveFloorToHistory(),this.render()}save(){return this.floorManager.saveFloorToPublicAi()}saveFloorToHistory(){this.historyManager.push(this.floorManager.saveFloor())}getCurrentFloor(){return this.floorManager.getCurrentFloor()}loadFloor(t){this.floorManager.loadFloor(t),this.#yt(),this.#Ct(),this.render()}saveFloor(){return this.floorManager.saveFloor()}#ft(t){const e=()=>{const e=this.canvas.width,n=this.canvas.height;t?(this.canvas.width=e*t,this.canvas.height=n*t):(this.canvas.width=e*this.transform.defaultScaleX,this.canvas.height=n*this.transform.defaultScaleY),this.canvas.style.width=e+"px",this.canvas.style.height=n+"px"},n=()=>{t?(this.context.scale(t,t),this.transform.defaultScaleX=t,this.transform.defaultScaleY=t):(this.context.setTransform(1,0,0,1,0,0),this.context.translate(this.transform.translateX,this.transform.translateY),this.context.scale(this.transform.currentScaleX,this.transform.currentScaleY))};this.canvas&&this.context&&(this.context.line=g.createLine(this.context),this.context.arrow=g.createArrow(this.context),this.context.text=g.createText(this.context),this.context.circle=g.createCircle(this.context),this.context.lineJoin="round",this.context.lineCap="square",this.context.imageSmoothingEnabled=!0,e(),n(),this.transform.from(this.context))}#pt(){this.container&&this.canvas&&this.eventController.initialize(this,this.container,this.canvas)}#xt(){this.container&&(this.contextToolbar=new F(this,this.container),this.mainToolbar=new L(this,this.container),this.contextToolbar.hide())}#yt(){const t=this.getCurrentFloor();t&&(t.onChange=()=>{this.saveFloorToHistory()})}#Ct(){this.editorRender=s.createRender(this)}#mt(){const t=document.createElement("div");return t.tabIndex=1,t.style.outline="none",t.style.width="100%",t.style.height="100%",t.style.position="relative",t}resize(){this.#ft(),this.render()}translateContext(t,e){this.context.translate(t,e),this.transform.from(this.context)}zoom(t,e){t>0?t+=1:t=1+t,e>0?e+=1:e=1+e,this.context.scale(t,e),this.transform.from(this.context)}zoomDefault(){this.transform.applyDefaultScale(this.context)}addEventHandler(t){this.eventController.addHandler(t)}removeEventHandler(t){this.eventController.removeHandler(t)}addSelectControl(t){t&&this.selects.push(t)}removeSelectControl(t){this.selects=this.selects.filter((e=>e!==t))}setSelectControls(t){t&&(this.selects=t)}render(){this.editorRender.render(this,this.context)}showContextToolbar(t,e){this.contextToolbar.show(t,e)}hideContextToolbar(){this.contextToolbar.hide()}}PlaceIn=e})();

var PlaceIn;(()=>{"use strict";var t={d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Editor:()=>Pe});class s{static arrow(t,e,s,n,o){switch(o){case"up":t.beginPath(),t.moveTo(e,s),t.lineTo(e-n,s+n),t.lineTo(e+n,s+n),t.closePath(),t.fill();break;case"right":t.beginPath(),t.moveTo(e,s),t.lineTo(e-n,s-n),t.lineTo(e-n,s+n),t.closePath(),t.fill();break;case"down":t.beginPath(),t.moveTo(e,s),t.lineTo(e-n,s-n),t.lineTo(e+n,s-n),t.closePath(),t.fill();break;case"left":t.beginPath(),t.moveTo(e,s),t.lineTo(e+n,s-n),t.lineTo(e+n,s+n),t.closePath(),t.fill()}}static circle(t,e,s,n,o=!0){t.beginPath(),t.arc(e,s,n,0,2*Math.PI),t.closePath(),o?t.fill():t.stroke()}}class n{render(t){}static createRender(t){const e=new o;e.addRender(new i(t.config.backgroundColor,t.canvas)),e.addRender(new r(t,t.config.grid,t.canvas));const s=t.floorManager;return s.floors.forEach((t=>{s.getCurrentFloor()!==t&&e.addRender(new l(t,{alpha:.1,visible:{room:!1,wall:!1,outline:!0,door:!1,window:!1}}))})),s.floors.forEach((t=>{s.getCurrentFloor()===t&&e.addRender(new l(t))})),e.addRender(new h(s.getCurrentFloor())),e.addRender(new a(t)),e}}class o{constructor(){this.renders=[]}addRender(t){this.renders.push(t)}render(t){for(const e of this.renders)e.render(t)}}class i extends n{constructor(t,e){super(),this.canvas=e,this.backgroundColor=t??"#ffffff"}render(t){t.save(),t.setTransform(1,0,0,1,0,0),t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore()}}class r extends n{constructor(t,e,s){super(),this.editor=t,this.canvas=s,this.display=e?.display??!0,this.size=e?.size??50,this.color=e?.color??"#c2c1c1",this.thick=e?.thick??1}render(t){const e=e=>e*(1/t.getTransform().a);if(this.display){t.save();const s=this.getTransform(t);t.setTransform(s.scaleX,0,0,s.scaleY,0,0),t.strokeStyle=this.color,t.lineWidth=this.thick;const n=e(this.canvas.width),o=e(this.canvas.height),i=e(s.translateX),r=e(s.translateY);let l=i%this.size,h=r%this.size,a=n+this.size,c=o+this.size;l-=this.size,h-=this.size;for(let e=l;e<a;e+=this.size)t.beginPath(),t.moveTo(e,h),t.lineTo(e,c),t.closePath(),t.stroke();for(let e=h;e<c;e+=this.size)t.beginPath(),t.moveTo(l,e),t.lineTo(a,e),t.closePath(),t.stroke();t.restore()}}getTransform(t){const e=t.getTransform();return{scaleX:e.a,scaleY:e.d,translateX:e.e,translateY:e.f}}}class l extends n{constructor(t,e){super(),this.floor=t,this.config=e}render(t){t.save(),this.config&&this.config.alpha&&(t.globalAlpha=this.config.alpha),this.floor.render(t,this.config),t.restore()}}class h extends n{constructor(t){super(),this.floor=t}render(t){let e=1/0,s=1/0,n=-1/0,o=-1/0;for(const t of this.floor.getAllControls()){const i=t.getBoundRect();e=Math.min(e,i.minX),s=Math.min(s,i.minY),n=Math.max(n,i.maxX),o=Math.max(o,i.maxY)}const i=50;this.renderLine(t,e,s-i,n,s-i),this.renderArrow(t,e,s-i,5,"left"),this.renderArrow(t,n,s-i,5,"right"),this.renderLine(t,n+i,s,n+i,o),this.renderArrow(t,n+i,s,5,"up"),this.renderArrow(t,n+i,o,5,"down")}renderLine(t,e,s,n,o){t.beginPath(),t.strokeStyle="#666666",t.fillStyle="#666666",t.lineWidth=1,t.moveTo(e,s),t.lineTo(n,o),t.stroke()}renderArrow(t,e,n,o,i){s.arrow(t,e,n,o,i)}}class a extends n{constructor(t){super(),this.editor=t}render(t){for(const e of this.editor.selects)e&&e.render(t)}}class c{constructor(t,e){this.x=t??0,this.y=e??0}translate(t,e){this.x+=t,this.y+=e}copy(){return new c(this.x,this.y)}copyFrom(t){t&&(this.x=t.x,this.y=t.y)}distanceTo(t){const e=t.x-this.x,s=t.y-this.y;return Math.sqrt(e**2+s**2)}isEqualTo(t){return Math.floor(this.x)===Math.floor(t.x)&&Math.floor(this.y)===Math.floor(t.y)}}class d{constructor(){this.clientX=0,this.clientY=0,this.snapX=0,this.snapY=0,this.offsetX=0,this.offsetY=0,this.x=0,this.y=0}}class u{constructor(t){this.handlers=[],this.snapToGrid=!0,this.editor=t,this.downPoint=new c}initialize(t,e,s){if(s){const e=e=>{const n=new d;n.clientX=e?.clientX,n.clientY=e?.clientY,n.pageX=e?.pageX,n.pageY=e?.pageY;const o=s.getBoundingClientRect(),i=s.width/o.width,r=s.height/o.height;return n.x=(n.clientX-o.left)*i/t.transform.currentScaleX,n.y=(n.clientY-o.top)*r/t.transform.currentScaleY,n.x=n.x-t.transform.unscaledTranslateX,n.y=n.y-t.transform.unscaledTranslateY,n};s.onmousedown=t=>{const s=e(t);this.onMouseDown(s)},s.onmousemove=t=>{const s=e(t);this.onMouseMove(s)},s.onmouseup=t=>{const s=e(t);this.onMouseUp(s)},document.addEventListener("mouseup",(t=>{s.onmouseup(t)})),s.ontouchstart=t=>{t.preventDefault();const e=t.touches[0];s.onmousedown(e)},s.ontouchmove=t=>{t.preventDefault();const e=t.touches[0];s.onmousemove(e)},s.ontouchend=t=>{t.preventDefault();const e=t.changedTouches[0];s.onmouseup(e)}}e&&e.addEventListener("keydown",(t=>{this.onKeyDown(t)}))}addHandler(t){t&&this.handlers.push(t)}removeHandler(t){t&&(this.handlers=this.handlers.filter((e=>e!==t)))}onClick(t){for(const e of this.handlers)e.onClick(t)}onKeyDown(t){(t=>(t.ctrlKey||t.metaKey)&&!t.shiftKey&&"z"===t.key)(t)?(t.preventDefault(),this.editor.tools.undo()):(t=>(t.ctrlKey||t.metaKey)&&("y"===t.key||t.shiftKey&&"z"===t.key))(t)?(t.preventDefault(),this.editor.tools.redo()):this.handlers.forEach((e=>e.onKeyDown(t.key,t.code)))}onMouseDown(t){this.downPoint.x=t.clientX,this.downPoint.y=t.clientY,this.initEvent(t);for(const e of this.handlers)e.onMouseDown(t)}onMouseMove(t){this.initEvent(t);for(const e of this.handlers)e.onMouseMove(t)}onMouseUp(t){this.initEvent(t);for(const e of this.handlers)e.onMouseUp(t)}initEvent(t){const e=this.snapPoint(t);t.snapX=e.x,t.snapY=e.y,t.offsetX=t.clientX-this.downPoint.x,t.offsetY=t.clientY-this.downPoint.y}snap(t){return this.snapToGrid?15*Math.round(t/15):t}snapPoint(t){return{x:this.snap(t.x),y:this.snap(t.y)}}}class g{static createLine(t){return(e,s,n,o)=>{t.beginPath(),t.moveTo(e,s),t.lineTo(n,o),t.closePath(),t.stroke()}}static createText(t){return(e,s,n)=>{t.measureText(n).width;t.fillText(n,e,s)}}static createCircle(t){return(e,s,n)=>{t.beginPath(),t.arc(e,s,n,0,2*Math.PI),t.closePath()}}static createArrow(t){return(e,s,n,o)=>{switch(o){case"up":t.beginPath(),t.moveTo(e,s),t.lineTo(e-n,s+n),t.lineTo(e+n,s+n),t.closePath(),t.fill();break;case"right":t.beginPath(),t.moveTo(e,s),t.lineTo(e-n,s-n),t.lineTo(e-n,s+n),t.closePath(),t.fill();break;case"down":t.beginPath(),t.moveTo(e,s),t.lineTo(e-n,s-n),t.lineTo(e+n,s-n),t.closePath(),t.fill();break;case"left":t.beginPath(),t.moveTo(e,s),t.lineTo(e+n,s-n),t.lineTo(e+n,s+n),t.closePath(),t.fill()}}}}class m{static create(t,e){const s=document.createElement(t);return s&&e&&Object.assign(s.style,e),s}}class f{constructor(t){this.element=m.create("div"),this.element.style.display="flex",this.element.style.position="absolute",this.element.style.flexDirection="row",this.element.style.backgroundColor="#1f1f1f",this.element.style.boxShadow="5px 5px 10px rgba(0, 0, 0, 0.5)",this.element.style.borderRadius="10px",this.element.style.textAlign="center",this.element.style.cursor="pointer",this.element.style.alignItems="center",this.element.style.padding="5px",this.element.style.zIndex="9999",this.buttons=new Map,t?t.appendChild(this.element):document.body.appendChild(this.element)}addButton(t,e){return e&&(e.toolbar=this,this.element.appendChild(e.element),this.buttons.set(t,e)),e}getButton(t){return this.buttons.get(t)}hide(){this.element.style.display="none",this.collapse()}hideAllButtons(){this.buttons.forEach(((t,e)=>{t.hide()}))}collapse(){this.buttons.forEach(((t,e)=>{t.collapse()}))}show(t,e){this.collapse();const{style:s}=this.element;s.display="flex",s.left=t+"px",s.top=e+"px";const n=this.getAbsoluteBoundingClientRect(),o=window.innerWidth;n.right>o&&(t=o-n.width,s.left=`${t}px`)}show2(t,e){this.collapse();const{style:s}=this.element;s.display="flex",s.left=t+"px",s.top=e+"px";const n=this.element.getBoundingClientRect(),o=n.left+n.width,i=window.innerWidth;o>i&&(t-=o-i,s.left=`${t}px`)}getAbsoluteBoundingClientRect(){const t=this.element.getBoundingClientRect();let e=t.left+document.documentElement.scrollLeft,s=t.left+t.width,n=t.top+document.documentElement.scrollTop,o=n+t.height;return{top:n,bottom:o,left:e,right:s,width:Math.abs(s-e),height:Math.abs(o-n)}}}class p{constructor(t){this.element=document.createElement("div"),this.element.style.id="tooltip",this.element.style.display="flex",this.element.style.flexDirection="row",this.element.style.alignItems="center",this.element.style.position="absolute",this.element.style.backgroundColor="#1f1f1f",this.element.style.borderRadius="10%",this.element.appendChild(this.createLabelElement()),t?t.appendChild(this.element):document.body.appendChild(this.element)}createLabelElement(){return this.text=document.createElement("p"),this.text.style.color="#ffffff",this.text.style.paddingLeft="10px",this.text.style.paddingRight="10px",this.text.style.fontSize="10px",this.text.style.whiteSpace="nowrap",this.text.textContent="",this.text}show(t,e,s){s?(this.changeLabel(s),this.moveCenter(t,e)):this.hide()}moveCenter(t,e){this.element.style.display="flex";const s=this.element.getBoundingClientRect();this.element.style.left=t-s.width/2+"px",this.element.style.top=e+"px"}changeLabel(t){this.text.style.color="white",this.text.textContent=t}hide(){this.element.style.display="none"}}class x{static create(t){t??={};const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width",t.width??"100%"),e.setAttribute("height",t.width??"100%"),e.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.viewBox&&e.setAttribute("viewBox",t.viewBox);const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("fill",t.fill??"#ffffff"),s.setAttribute("d",t.d??""),e.appendChild(s),e}}class y{constructor(t,e,s){this.element=m.create("div",s),this.element.style.display="flex",this.element.style.flexDirection="row",this.element.style.alignItems="center",this.element.style.width="20px",this.element.style.height="20px",this.element.style.borderRadius="50px",this.element.style.cursor="pointer",this.element.style.padding="5px",this.element.style.margin="5px 10px 5px 5px",this.element.style.overflow="hidden",this.element.style.minWidth="max-content",this.element.style.maxWidth="max-content",this.tooltipText="",this.tooltip=new p(this.element,"tooltip"),this.tooltip.hide(),this.element.onmouseenter=()=>{this.onMouseEnter()},this.onClick=e,this.element.onmouseleave=()=>{this.onMouseLeave()},this.element.onclick=()=>{this.fireOnClick()}}setTooltipText(t){this.tooltipText=t}appendChild(t){this.element.appendChild(t)}hide(){this.element.style.display="none"}show(){this.element.style.display="flex"}expand(){}collapse(){}onMouseEnter(){this.backgroundColor=this.element.style.backgroundColor,this.element.style.backgroundColor="#ffffff80";const t=this.element.getBoundingClientRect(),e=this.element.offsetLeft+t.width/2;this.tooltip.show(e,60,this.tooltipText)}onMouseLeave(){this.element.style.backgroundColor=this.backgroundColor,this.tooltip.hide()}fireOnClick(){this.toolbar?.collapse(),this.onClick&&this.onClick()}getAbsoluteBoundingClientRect(){const t=this.element.getBoundingClientRect();let e=t.left+document.documentElement.scrollLeft,s=t.left+t.width,n=t.top+document.documentElement.scrollTop,o=n+t.height;return{top:n,bottom:o,left:e,right:s,width:Math.abs(s-e),height:Math.abs(o-n)}}addSvgIcon(t){const e=x.create(t);this.appendChild(e)}}class w extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 512 512",d:"M.3 89.5C.1 91.6 0 93.8 0 96V224 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64V224 96c0-35.3-28.7-64-64-64H64c-2.2 0-4.4 .1-6.5 .3c-9.2 .9-17.8 3.8-25.5 8.2C21.8 46.5 13.4 55.1 7.7 65.5c-3.9 7.3-6.5 15.4-7.4 24zM48 224H464l0 192c0 8.8-7.2 16-16 16L64 432c-8.8 0-16-7.2-16-16l0-192z"}),this.setTooltipText("창문 생성")}}class C extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 576 512",d:"M96 64c0-35.3 28.7-64 64-64H416c35.3 0 64 28.7 64 64V448h64c17.7 0 32 14.3 32 32s-14.3 32-32 32H432 144 32c-17.7 0-32-14.3-32-32s14.3-32 32-32H96V64zM384 288a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"}),this.setTooltipText("문 생성")}}class v extends y{constructor(t){super(t),this.text=m.create("p",{display:"block",color:"#ffffff",padding:"5px",margin:"5px"}),this.appendChild(this.text),this.element.style.width=null,this.roomToolbar=this.createRoomToolbar(this.element),this.roomToolbar.hide(),this.setTooltipText("방 유형 변경")}createRoomToolbar(t){const e=new f(t);return[{category:0,label:"다목적공간",color:"#d83d1b"},{category:12,label:"거실",color:"#ec9126"},{category:13,label:"침실",color:"#e9ba1f"},{category:14,label:"주방",color:"#1c8a4f"},{category:15,label:"현관",color:"#0e88e0"},{category:16,label:"발코니",color:"#8639eb"},{category:17,label:"화장실",color:"#f5bfbb"},{category:19,label:"드레스룸",color:"#f2c997"},{category:21,label:"기타",color:"#f3df9e"}].forEach((s=>{e.addButton(0,new P(t,s)).onClick=()=>{this.hide(),this.onClick&&this.onClick(s)}})),e}setLabel(t){this.text.textContent=t}expand(){const t=this.element.offsetLeft;this.roomToolbar.show2(t,-70)}collapse(){this.roomToolbar.hide()}fireOnClick(){this.toolbar?.collapse(),this.expand()}}class P extends y{constructor(t,e,s){super(t,(()=>{s&&s(e)})),this.room=e,this.element.style.width=null,this.element.style.backgroundColor=this.room.color;const n=m.create("p",{display:"block",color:"#fff",padding:"5px",margin:"5px",whiteSpace:"nowrap"});n.textContent=this.room.label,this.element.appendChild(n)}}class S extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 448 512",d:"M384 80c8.8 0 16 7.2 16 16V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16H384zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64z"}),this.setTooltipText("방 생성"),this.roomToolbar=this.createRoomToolbar(this.element),this.roomToolbar.hide()}createRoomToolbar(t){const e=new f(t);return[{category:0,label:"다목적공간",color:"#d83d1b"},{category:12,label:"거실",color:"#ec9126"},{category:13,label:"침실",color:"#e9ba1f"},{category:14,label:"주방",color:"#1c8a4f"},{category:15,label:"현관",color:"#0e88e0"},{category:16,label:"발코니",color:"#8639eb"},{category:17,label:"화장실",color:"#f5bfbb"},{category:19,label:"드레스룸",color:"#f2c997"},{category:21,label:"기타",color:"#f3df9e"}].forEach((s=>{e.addButton(0,new P(t,s)).onClick=()=>{this.hide(),this.onClick&&this.onClick(s)}})),e}expand(){const t=this.element.offsetLeft;this.roomToolbar.show2(t,-70)}collapse(){this.roomToolbar.hide()}fireOnClick(){this.toolbar?.collapse(),this.expand()}}class T extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 448 512",d:"M135.2 17.7C140.6 6.8 151.7 0 163.8 0H284.2c12.1 0 23.2 6.8 28.6 17.7L320 32h96c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 96 0 81.7 0 64S14.3 32 32 32h96l7.2-14.3zM32 128H416V448c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V128zm96 64c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16zm96 0c-8.8 0-16 7.2-16 16V432c0 8.8 7.2 16 16 16s16-7.2 16-16V208c0-8.8-7.2-16-16-16z"}),this.setTooltipText("삭제")}}class b extends y{constructor(t,e,s){super(t,(()=>{this.expand()}),s),this.addSvgIcon({viewBox:"0 0 12 12",d:"M0 0h12v1H0V0zm0 4h12v2H0V4zm12 5H0v3h12V9z"}),this.setTooltipText("두께 변경"),this.thickToolbar=this.createThickToolbar(this.element,e),this.thickToolbar.hide()}createThickToolbar(t,e){const s=new f(t);return[1,5,10].forEach((n=>{s.addButton(0,new A(t,n,(t=>{this.hide(),this.toolbar?.hide(),e&&e(n)})))})),s}hide(){this.element.style.display="none",this.collapse()}expand(){const t=this.element.offsetLeft;this.thickToolbar.show2(t,-70)}collapse(){this.thickToolbar.hide()}}class A extends y{constructor(t,e,s){super(t,null),this.thick=e,this.onChangeThick=s;const n=m.create("div",{display:"block",backgroundColor:"white",width:"100%",height:`${this.thick}px`});this.element.appendChild(n)}onClick(){this.onChangeThick?.(this.thick)}}class O extends y{constructor(t){super(t);const e=m.create("div");e.style.display="block",e.style.background="radial-gradient(50% 50% at 50% 50%,#ffffff 0%,transparent 100%),conic-gradient(from 0deg at 50% 50%,#ff0000 0deg,#ffa800 47.73deg,#ffff00 79.56deg,#00ff00 121.33deg,#00ffff 180.99deg,#0000ff 238.67deg,#ff00ff 294.36deg,#ff0000 360deg),#c4c4c4",e.style.width="radial-gradient(50% 50% at 50% 50%,#ffffff 0%,transparent 100%),conic-gradient(from 0deg at 50% 50%,#ff0000 0deg,#ffa800 47.73deg,#ffff00 79.56deg,#00ff00 121.33deg,#00ffff 180.99deg,#0000ff 238.67deg,#ff00ff 294.36deg,#ff0000 360deg),#c4c4c4",e.style.width="20px",e.style.height="20px",e.style.borderRadius="50%",this.appendChild(e),this.setTooltipText("색상 변경"),this.colorToolbar=this.createColorToolbar(this.element),this.colorToolbar.hide()}createColorToolbar(t){const e=new f(t);return["#ffffff","#121213","#717171","#d83d1b","#ec9126","#e9ba1f","#1c8a4f","#0e88e0","#8639eb"].forEach((s=>{e.addButton(0,new D(t,s)).onClick=()=>{this.hide(),this.onClick&&this.onClick(s)}})),e}expand(){const t=this.element.offsetLeft;this.colorToolbar.show2(t,-70)}collapse(){this.colorToolbar.hide()}fireOnClick(){this.toolbar?.collapse(),this.expand()}}class D extends y{constructor(t,e){super(t);const s=m.create("div",{display:"block",background:e,width:"20px",height:"20px",borderRadius:"50%"});this.appendChild(s)}}class E extends y{constructor(t){super(t),this.text=m.create("p",{display:"block",color:"#ffffff",padding:"5px",margin:"5px"}),this.appendChild(this.text)}setLabel(t){this.text.textContent=t}}class M{constructor(){}get type(){return""}translate(t,e,s){}duplicate(){return null}render(t){}getBoundRect(){const t=this.getPoints();return{minX:Math.min(...t.map((t=>t.x))),minY:Math.min(...t.map((t=>t.y))),maxX:Math.max(...t.map((t=>t.x))),maxY:Math.max(...t.map((t=>t.y)))}}getSegments(){return[]}getConnectableSegments(){return[]}getPoints(){return[]}hitPoint(t,e){return null}hitSegment(t,e){return null}hitControl(t,e){return null}createPointHandler(t,e){return null}createSegmentHandler(t,e){return null}createControlHandler(t,e){return null}isPointInControl(t){return!1}isPointInSegment(t){return!1}isSegmentInControl(t){return!1}}class R{constructor(t,e,s,n){this.start=t??new c,this.end=e??new c,this.thick=s??1,this.color=n??"#000000"}isEqualTo(t){return!!t&&(!(!this.start.isEqualTo(t.start)||!this.end.isEqualTo(t.end))||!(!this.start.isEqualTo(t.end)||!this.end.isEqualTo(t.start)))}translate(t,e){this.start.x+=t,this.start.y+=e,this.end.x+=t,this.end.y+=e}getMidPoint(){const t=(this.start.x+this.end.x)/2,e=(this.start.y+this.end.y)/2;return new c(t,e)}duplicate(){return new R(this.start.copy(),this.end.copy(),this.thick,this.color)}crossProductToStart(t){const e=this.end.x-this.start.x,s=this.end.y-this.start.y,n=t.x-this.start.x;return e*(t.y-this.start.y)-s*n}isParallel(t){if(!t)return!1;const e=this.toVector(),s=t.toVector(),n=e.x*s.y-e.y*s.x;return Math.abs(n)<Number.EPSILON}toVector(t){return{x:t?Math.floor(this.end.x)-Math.floor(this.start.x):Math.floor(this.start.x)-Math.floor(this.end.x),y:t?Math.floor(this.end.y)-Math.floor(this.start.y):Math.floor(this.start.y)-Math.floor(this.end.y)}}getPoints(){return[this.start,this.end]}get length(){return Math.sqrt(Math.pow(this.end.x-this.start.x,2)+Math.pow(this.end.y-this.start.y,2))}get angle(){return Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x)}getNearestPointOnSegment(t){return this.getNearestPoint(t,!0)}getNearestPointOnLine(t){return this.getNearestPoint(t,!1)}getNearestPoint(t,e){const s=this.end.x-this.start.x,n=this.end.y-this.start.y,o=s*s+n*n;if(0===o)return new c(this.start.x,this.start.y);const i=((t.x-this.start.x)*s+(t.y-this.start.y)*n)/o,r=new c;return i<0&&e?(r.x=this.start.x,r.y=this.start.y):i>1&&e?(r.x=this.end.x,r.y=this.end.y):(r.x=this.start.x+i*s,r.y=this.start.y+i*n),r}isPointBetween(t){const e={x:t.x-this.start.x,y:t.y-this.start.y},s={x:this.end.x-this.start.x,y:this.end.y-this.start.y},n=(t,e)=>t.x*e.x+t.y*e.y,o=n(e,s);if(o<Number.EPSILON)return!1;return!(o-n(s,s)>-Number.EPSILON)}isPointInSegment(t,e=1){const s=this.start.distanceTo(t),n=this.end.distanceTo(t);return s+n>=this.length-e&&s+n<=this.length+e}getPointAtDistance(t,e){const s=this.getNearestPointOnSegment(t),n=Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x);return new c(s.x+e*Math.cos(n),s.y+e*Math.sin(n))}getOffsetPointFromStart(t){const e=Math.atan2(this.end.y-this.start.y,this.end.x-this.start.x),s=this.start.x+t*Math.cos(e),n=this.start.y+t*Math.sin(e);return new c(s,n)}getIntersectionPoint(t){if(!t)return null;if(this.start.isEqualTo(t.start)||this.start.isEqualTo(t.end)||this.end.isEqualTo(t.start)||this.end.isEqualTo(t.end))return null;const e=(t.end.y-t.start.y)*(this.end.x-this.start.x)-(t.end.x-t.start.x)*(this.end.y-this.start.y);if(0===e)return null;const s=((t.end.x-t.start.x)*(this.start.y-t.start.y)-(t.end.y-t.start.y)*(this.start.x-t.start.x))/e,n=((this.end.x-this.start.x)*(this.start.y-t.start.y)-(this.end.y-this.start.y)*(this.start.x-t.start.x))/e;if(s>=0&&s<=1&&n>=0&&n<=1){const t=this.start.x+s*(this.end.x-this.start.x),e=this.start.y+s*(this.end.y-this.start.y);return new c(t,e)}return null}getIntersectionPointOnSegment(t){return this.getIntersectionPointOnVector(t.start,t.end)}getIntersectionPointOnVector(t,e){const s=e.x-t.x,n=e.y-t.y,o=this.end.x-this.start.x,i=this.end.y-this.start.y,r=s*i-n*o;if(0===r)return null;const l=(o*(t.y-this.start.y)-i*(t.x-this.start.x))/r,h=(t.y,this.start.y,t.x,this.start.x,t.x+l*s),a=t.y+l*n;return new c(h,a)}isRightDirection(){return this.angle>=-Math.PI/2&&this.angle<=Math.PI/2}isLeftDirection(){return!this.isRightDirection()}isVertical(){return this.start.x===this.end.x}isHorizontal(){return this.start.y===this.end.y}makeVerticalOrHorizontal(t=5){Math.abs(this.start.x-this.end.y)<t&&(this.end.x=this.start.x),Math.abs(this.start.y-this.end.y)<t&&(this.end.y=this.start.y)}toString(){return`(${this.start.x}, ${this.start.y})-(${this.end.x}, ${this.end.y})`}}class B{constructor(t,e){this.points=t?Array.isArray(t)?t:[t]:[],this.color=e??"rgb(0, 151, 197, 0.7)"}render(t){t.save(),this.renderPoints(t),t.restore()}renderPoints(t){t.fillStyle=this.color;for(const e of this.points)t.circle(e.x,e.y,10),t.fill()}}class F{constructor(t,e,s,n,o){this.segment=t,this.thick=n??5,this.color=o??"rgb(0, 151, 197, 0.7)",this.point=e,this.angle=s,this.text="벽 이동"}render(t){this.point&&(t.save(),this.renderSegments(t),this.renderResize(t),t.restore())}renderSegments(t){this.segment.thick>0&&(t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(this.segment.start.x,this.segment.start.y),t.lineTo(this.segment.end.x,this.segment.end.y),t.closePath(),t.stroke())}renderResize(t){this.renderResizePoint(t),this.renderResizeText(t)}renderResizePoint(t){const e=this.segment.getNearestPointOnSegment(this.point);e&&(t.save(),t.fillStyle="black",t.translate(e.x,e.y),t.rotate(this.segment.angle),s.arrow(t,0,15,5,"down"),s.arrow(t,0,-15,5,"up"),t.restore())}renderResizeText(t){const e=t.measureText(this.text).width+10,s=this.point.x,n=this.point.y+30;t.fillStyle="black",t.fillRect(s-e/2,n-7.5,e,15),t.fillStyle="white",t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,s,n)}}class H{onDragStart(t,e){}onDrag(t,e){}onDragStop(t,e){}onCancel(){}}class k{static Colors={Blue10:"#E5F2FF",Blue20:"#CCE4FF",Blue30:"#99CAFF",Blue40:"#66AFFF",Blue50:"#3395FF",Blue60:"#007AFF",Blue70:"#0062CC",Blue80:"#004999",Blue90:"#003166",Blue100:"#001833",BlueHover10:"#DAE6F2",BlueHover20:"#C2D9F2",BlueHover30:"#91C0F2",BlueHover40:"#61A6F2",BlueHover50:"#308EF2",BlueHover60:"#0D81FF",BlueHover70:"#0D6ACF",BlueHover80:"#0D529E",BlueHover90:"#0D3B6E",BlueHover100:"#0D243D",Purple10:"#F7EEFC",Purple20:"#EFDCF8",Purple30:"#DFBAF2",Purple40:"#CF97EB",Purple50:"#BF75E5",Purple60:"#AF52DE",Purple70:"#8C42B2",Purple80:"#693185",Purple90:"#462159",Purple100:"#23102C",PurpleHorver10:"#EBE2EF",PurpleHorver20:"#E3D1EC",PurpleHorver30:"#D4B1E6",PurpleHorver40:"#C58FDF",PurpleHorver50:"#B56FDA",PurpleHorver60:"#B35BE0",PurpleHorver70:"#924BB6",PurpleHorver80:"#713B8B",PurpleHorver90:"#4F2C61",PurpleHorver100:"#2E1C37",Cyan10:"#EAF7FC",Cyan20:"#D6EFFA",Cyan30:"#ADDEF5",Cyan40:"#84CEF0",Cyan50:"#5BBDEB",Cyan60:"#32ADE6",Cyan70:"#288AB8",Cyan80:"#1E688A",Cyan90:"#14455C",Cyan100:"#0A232E",CyanHover10:"#DEEBEF",CyanHover20:"#CBE3ED",CyanHover30:"#A4D3E9",CyanHover40:"#7DC4E4",CyanHover50:"#56B4DF",CyanHover60:"#3CB1E7",CyanHover70:"#3390BC",CyanHover80:"#297090",CyanHover90:"#204E64",CyanHover100:"#162E38",Teal10:"#EAF7F9",Teal20:"#D6EFF4",Teal30:"#ACDFE9",Teal40:"#83D0DD",Teal50:"#59C0D2",Teal60:"#30B0C7",Teal70:"#268D9F",Teal80:"#1D6A77",Teal90:"#134650",Teal100:"#0A2328",TealHover10:"#DEEBED",TealHover20:"#CBE3E8",TealHover30:"#A3D4DD",TealHover40:"#7CC6D2",TealHover50:"#55B6C7",TealHover60:"#3AB4CA",TealHover70:"#3193A4",TealHover80:"#28717E",TealHover90:"#1F4F59",TealHover100:"#162E33",Manneta10:"#FAE9F1",Manneta20:"#F6D4E3",Manneta30:"#EDA9C6",Manneta40:"#E37DAA",Manneta50:"#DA528D",Manneta60:"#D12771",Manneta70:"#A71F5A",Manneta80:"#7D1744",Manneta90:"#54102D",Manneta100:"#2A0817",MannetaHover10:"#EDDDE5",MannetaHover20:"#EAC9D8",MannetaHover30:"#E1A1BC",MannetaHover40:"#D877A1",MannetaHover50:"#CF4E86",MannetaHover60:"#D33278",MannetaHover70:"#AB2A62",MannetaHover80:"#83234D",MannetaHover90:"#5D1C38",MannetaHover100:"#351423",Red10:"#FFEBEA",Red20:"#FFD8D6",Red30:"#FFB1AC",Red40:"#FF8983",Red50:"#FF6259",Red60:"#FF3B30",Red70:"#CC2F26",Red80:"#99231D",Red90:"#661813",Red100:"#330C0A",RedHover10:"#F2DFDE",RedHover20:"#F2CDCB",RedHover30:"#F2A8A3",RedHover40:"#F2827C",RedHover50:"#F25D55",RedHover60:"#FF453A",RedHover70:"#CF3931",RedHover80:"#9E2E28",RedHover90:"#6E241F",RedHover100:"#3D1816",Green10:"#EBF9EE",Green20:"#D6F4DE",Green30:"#AEE9BD",Green40:"#85DD9B",Green50:"#5DD27A",Green60:"#34C759",Green70:"#2A9F47",Green80:"#1F7735",Green90:"#155024",Green100:"#0A2812",GreenHover10:"#DFEDE2",GreenHover20:"#CBE8D3",GreenHover30:"#A5DDB4",GreenHover40:"#7ED293",GreenHover50:"#58C774",GreenHover60:"#3ECA61",GreenHover70:"#35A450",GreenHover80:"#2A7E3F",GreenHover90:"#21592F",GreenHover100:"#16331E",Orange10:"#FFF4E5",Orange20:"#FFEACC",Orange30:"#FFD599",Orange40:"#FFBF66",Orange50:"#FFAA33",Orange60:"#FF9500",Orange70:"#CC7700",Orange80:"#995900",Orange90:"#663C00",Orange100:"#331E00",OrangeHover10:"#F2E8DA",OrangeHover20:"#F2DEC2",OrangeHover30:"#F2CA91",OrangeHover40:"#F2B561",OrangeHover50:"#F2A130",OrangeHover60:"#FF9A0D",OrangeHover70:"#CF7E0D",OrangeHover80:"#9E610D",OrangeHover90:"#6E460D",OrangeHover100:"#3D290D"};static get activeColor(){return"rgb(0,151,197)"}static get activeColor(){return"rgb(0,151,197)"}static get primaryRedColor(){return k.Colors.Red50}static get primaryRed50Color(){return this.primaryRedColor+"80"}static get primaryOrangeColor(){return k.Colors.Orange50}static get primaryOrange50Color(){return k.Colors.Orange50+"80"}static get activeColorTransparent(){return"rgb(0, 151, 197, 0.5)"}static get selectColor(){return"rgba(0,151,197,0.5)"}}class I{constructor(t){this.x=t?.x??0,this.y=t?.y??0,this.width=t?.width??0,this.height=t?.height??0,this.color=t?.color??k.activeColor,this.text=t?.text??""}render(t){t.save(),t.lineWidth=1,t.strokeStyle=this.color,t.fillStyle=this.color,this.renderVerticalLines(t),this.renderHorizontalLine(t),this.renderArrows(t),this.renderText(t),t.restore()}renderVerticalLines(t){t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x,this.y+this.height),t.moveTo(this.x+this.width,this.y),t.lineTo(this.x+this.width,this.y+this.height),t.closePath(),t.stroke()}renderHorizontalLine(t){t.beginPath(),t.moveTo(this.x,this.y+this.height/2),t.lineTo(this.x+this.width,this.y+this.height/2),t.closePath(),t.stroke()}renderArrows(t){s.arrow(t,this.x,this.y+this.height/2,5,"left"),s.arrow(t,this.x+this.width,this.y+this.height/2,5,"right")}renderText(t){const e=t.measureText(this.text).width+10,s=this.x+this.width/2,n=this.y-this.height/2;t.fillRect(s-e/2,n-7.5,e,15),t.fillStyle="white",t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,s,n)}}class L{static get unitMeter(){return 10}static get unitPixel(){return 50}static meterToPixel(t){return Math.floor(t/L.unitMeter*L.unitPixel)}static pixelToMeter(t){return t/L.unitPixel}}class X{constructor(t){t?(this.segments=Array.isArray(t)?t:[t],this.segments=this.segments.filter((t=>null!==t))):this.segments=[],this.mininumSize=0}getFirstSegment(){return this.segments[0]}render(t){if(!(this.segments.length<=0)){t.save(),this.rotateContext(t,this.segments[0]);for(const e of this.createMeasures())e.render(t);t.restore()}}rotateContext(t,e){e.isRightDirection()?(t.translate(e.start.x,e.start.y),t.rotate(e.angle)):(t.translate(e.end.x,e.end.y),t.rotate(Math.PI+e.angle))}createMeasures(){const t=[];let e=this.getSortedPoints();this.segments[0].isLeftDirection()&&(e=e.reverse());let s=0;for(let n=0;n<e.length-1;n++){const o=e[n],i=e[n+1],r=o.distanceTo(i);if(r>this.mininumSize){const e=new I({x:s,y:-30,width:r,height:15,text:`${L.pixelToMeter(r).toFixed(2)} m`});t.push(e)}s+=r}return t}getSortedPoints(){const t=[];for(const e of this.segments)t.push(e.start,e.end);const e=t[0];return t.sort(((t,s)=>t.distanceTo(e)-s.distanceTo(e))),t}}class Y extends H{constructor(t,e,s){super(),this.segment=t,this.point=s,this.control=e,this.render=new X([this.segment,this.control.segment]),this.cancelSnapshot={segment:t,point:s.copy()}}onDragStart(t,e){t.addSelectControl(this.render)}onDrag(t,e){if(this.segment){const t=this.segment.getNearestPointOnSegment(e);this.point.copyFrom(t)}else this.point.copyFrom(e)}onDragStop(t,e){this.removeControlsUnderThreshold(10),t.removeSelectControl(this.render)}onCancel(){this.started=!1,this.point.copyFrom(this.cancelSnapshot.point)}removeControlsUnderThreshold(t){this.control.length<t&&this.floor.removeControl(this.control)}}class N{constructor(t){this.renders=t?Array.isArray(t)?t:[t]:[]}addRender(t){t&&this.renders.push(t)}render(t){for(const e of this.renders)e&&e.render(t)}}class W extends H{constructor(t){super(),this.control=t,this.render=new X,this.started=!1,this.leftLength=0,this.rightLength=0}onDragStart(t,e){t.getCurrentFloor().findNearestSegmentAtPoint(e)&&(this.leftLength=e.distanceTo(this.control.start),this.rightLength=e.distanceTo(this.control.end),t.addSelectControl(this.render),this.started=!0)}onDrag(t,e){if(!this.started)return;const s=t.getCurrentFloor().findNearestSegmentAtPoint(e);if(s&&s.segment){const t=new R;this.calculateDotProductBetweenSegmentAndControl(s.segment,this.control)<0?(t.start=s.segment.getPointAtDistance(e,this.leftLength),t.end=s.segment.getPointAtDistance(e,-this.rightLength)):(t.start=s.segment.getPointAtDistance(e,-this.leftLength),t.end=s.segment.getPointAtDistance(e,this.rightLength)),s.segment.isPointInSegment(t.start)&&s.segment.isPointInSegment(t.end)&&(this.render.segments=[s.segment,this.control],this.updateControl(t.start,t.end))}}onDragStop(t,e){t.removeSelectControl(this.render),this.started=!1}calculateDotProductBetweenSegmentAndControl(t,e){const s=t.end.x-t.start.x,n=t.end.y-t.start.y;return s*(e.end.x-e.start.x)+n*(e.end.y-e.end.y)}onCancel(){this.isDragging=!1,this.updateControl(this.cancelSnapshot.start,this.cancelSnapshot.end)}updateControl(t,e){this.control.start.copyFrom(t),this.control.end.copyFrom(e)}}class z extends M{constructor(t=new c,e=new c){super(),this.segment=new R(t,e),this.thick=10,this.color="#000000"}get start(){return this.segment.start}set start(t){this.segment.start=t}get end(){return this.segment.end}set end(t){this.segment.end=t}translate(t,e){this.segment.translate(t,e)}getPoints(){return[this.start,this.end]}getSegments(){return[this.segment]}getConnectableSegments(){return[]}hitPoint(t,e){let s=this.findHitPoint(t,e);return s?{point:s.point,render:new B(s.point)}:null}findHitPoint(t,e){const{start:s,end:n}=this.segment,o=s.distanceTo(e),i=n.distanceTo(e);return o<10?{point:s}:i<10?{point:n}:null}hitSegment(t,e){const s=this.findHitSegment(t,e);return s?{segment:s.segment,render:new N([new F(s.segment),new X(s.segment)])}:null}findHitSegment(t,e){return this.segment.isPointInSegment(e)?{segment:this.segment}:null}createPointHandler(t,e){const s=this.hitPoint(t,e);if(!s)return null;const n=t.getCurrentFloor().findSegmentAtPoint(s.point);return{control:this,handler:new Y(n,this,s.point),point:s.point}}createSegmentHandler(t,e){return this.isPointInControl(e)?{control:this,segment:this.segment,handler:new W(this)}:null}get length(){return this.segment.length}isPointInControl(t){return this.segment.isPointInSegment(t)}isPointInSegment(t){return this.isPointInControl(t)}isSegmentInControl(t){return this.isPointInControl(t.start)&&this.isPointInControl(t.end)}}class V extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 448 512",d:"M432 256c0 17.7-14.3 32-32 32L48 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l352 0c17.7 0 32 14.3 32 32z"}),this.setTooltipText("벽 생성")}}class _ extends y{constructor(t,e){super(t,e),this.addSvgIcon({viewBox:"0 0 576 512",d:"M234.7 42.7L197 56.8c-3 1.1-5 4-5 7.2s2 6.1 5 7.2l37.7 14.1L248.8 123c1.1 3 4 5 7.2 5s6.1-2 7.2-5l14.1-37.7L315 71.2c3-1.1 5-4 5-7.2s-2-6.1-5-7.2L277.3 42.7 263.2 5c-1.1-3-4-5-7.2-5s-6.1 2-7.2 5L234.7 42.7zM46.1 395.4c-18.7 18.7-18.7 49.1 0 67.9l34.6 34.6c18.7 18.7 49.1 18.7 67.9 0L529.9 116.5c18.7-18.7 18.7-49.1 0-67.9L495.3 14.1c-18.7-18.7-49.1-18.7-67.9 0L46.1 395.4zM484.6 82.6l-105 105-23.3-23.3 105-105 23.3 23.3zM7.5 117.2C3 118.9 0 123.2 0 128s3 9.1 7.5 10.8L64 160l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L128 160l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L128 96 106.8 39.5C105.1 35 100.8 32 96 32s-9.1 3-10.8 7.5L64 96 7.5 117.2zm352 256c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L416 416l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L480 416l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L480 352l-21.2-56.5c-1.7-4.5-6-7.5-10.8-7.5s-9.1 3-10.8 7.5L416 352l-56.5 21.2z"}),this.setTooltipText("방 찾기"),this.roomToolbar=this.createRoomToolbar(this.element),this.roomToolbar.hide()}createRoomToolbar(t){const e=new f(t);return[{category:0,label:"다목적공간",color:"#d83d1b"},{category:12,label:"거실",color:"#ec9126"},{category:13,label:"침실",color:"#e9ba1f"},{category:14,label:"주방",color:"#1c8a4f"},{category:15,label:"현관",color:"#0e88e0"},{category:16,label:"발코니",color:"#8639eb"},{category:17,label:"화장실",color:"#f5bfbb"},{category:19,label:"드레스룸",color:"#f2c997"},{category:21,label:"기타",color:"#f3df9e"}].forEach((s=>{e.addButton(0,new P(t,s)).onClick=()=>{this.hide(),this.onClick&&this.onClick(s)}})),e}expand(){const t=this.element.offsetLeft;this.roomToolbar.show2(t,-70)}collapse(){this.roomToolbar.hide()}fireOnClick(){this.toolbar?.collapse(),this.expand()}}class G{constructor(t,e){this.editor=t,this.control=null,this.container=e,this.TOOLBAR_BUTTONS={REMOVE:0,CREATE_WALL:1,CREATE_WINDOW:2,CREATE_DOOR:3,CREATE_ROOM:4,CHANGE_ROOM:5,CHANGE_THICK:6,CHANGE_COLOR:7,MEASURE:8,FIND_ROOM:9},this.toolbar=this.createToolbar()}createToolbar(){const t=new f(this.container);return t.addButton(this.TOOLBAR_BUTTONS.REMOVE,new T(this.container)),t.addButton(this.TOOLBAR_BUTTONS.FIND_ROOM,new _(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_WALL,new V(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_WINDOW,new w(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_DOOR,new C(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CREATE_ROOM,new S(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CHANGE_ROOM,new v(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CHANGE_THICK,new b(this.container)),t.addButton(this.TOOLBAR_BUTTONS.CHANGE_COLOR,new O(this.container)),t.addButton(this.TOOLBAR_BUTTONS.MEASURE,new E(this.container)),t.getButton(this.TOOLBAR_BUTTONS.REMOVE).onClick=()=>{if(this.control){const t=this.editor.getCurrentFloor();t.removeControl(this.control),t.fireOnChange(),this.editor.setSelectControls([]),this.editor.render()}this.toolbar.hide()},t.getButton(this.TOOLBAR_BUTTONS.FIND_ROOM).onClick=t=>{this.editor.tools.findRoom(t),this.toolbar.hide(),this.toolbar.hide()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_WALL).onClick=()=>{this.editor.tools.createWall(),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_WINDOW).onClick=()=>{this.editor.tools.createWindow(),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_DOOR).onClick=()=>{this.editor.tools.createDoor(),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CREATE_ROOM).onClick=t=>{this.editor.tools.createRoom(t),this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CHANGE_ROOM).onClick=t=>{this.control.label=t.label,this.control.fillColor=t.color,this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CHANGE_THICK).onClick=()=>{this.toolbar.hide(),this.editor.render()},t.getButton(this.TOOLBAR_BUTTONS.CHANGE_COLOR).onClick=t=>{this.control.fillColor=t,this.toolbar.hide(),this.editor.render()},t.hide(),t}hide(){this.toolbar?.hide()}show(t,{control:e,segment:s}){this.control=e;const n=new c(t.x,t.y);this.initToolbar({control:e,segment:s},n);const o=this.container.getBoundingClientRect(),i=this.toolbar.element.offsetWidth/2,r=this.toolbar.element.offsetHeight/2,l=t.clientX-o.left-i,h=t.clientY-o.top-(r+50);this.toolbar?.show(l,h)}initToolbar({control:t,segment:e},s){t||e?t&&"door"===t.type?this.initToolbarOnDor(t,s):t&&"window"===t.type?this.initToolbarOnWindow(t,s):t&&"room"===t.type?this.initToolbarOnRoom(t,s):e?this.initToolbarOnWall(t,s):this.initToolbarOnFloor():this.initToolbarOnFloor()}initToolbarOnFloor(t,e){this.toolbar.hideAllButtons(),this.showFindRoomButton(),this.showCreateRoomButton(),this.showCreateDoorButton(),this.showCreateWindowButton()}initToolbarOnRoom(t,e){const s=t.findSegmentAtPoint(this.editor,e);if(s)this.initToolbarOnWall(s.segment,e);else{this.toolbar.hideAllButtons();const e=t.polygon.calculateArea(),s=4e-4;this.showRemoveButton(),this.showCreateRoomButton(),this.showCreateWallButton(),this.showChangeRoomButton(t.label),this.showChangeColorButton(),this.showMeasureButton(`${Math.floor(e*s)} ㎡`)}}initToolbarOnWindow(t,e){this.toolbar.hideAllButtons();const s=t.segment.length;this.showRemoveButton(),this.showMeasureButton(`${Math.floor(.02*s)} m`)}initToolbarOnDor(t,e){this.toolbar.hideAllButtons();const s=t.segment.length;this.showRemoveButton(),this.showMeasureButton(`${Math.floor(.02*s)} m`)}initToolbarOnWall(t,e){this.toolbar.hideAllButtons();let s=0;t instanceof z?s=t.segment.length:t instanceof R&&(s=t.length);this.showCreateWindowButton(),this.showCreateDoorButton(),this.showMeasureButton(`${Math.floor(.02*s)} m`)}showRemoveButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.REMOVE).show()}showCreateWallButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_WALL).show()}showCreateDoorButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_DOOR).show()}showCreateWindowButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_WINDOW).show()}showCreateRoomButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CREATE_ROOM).show()}showFindRoomButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.FIND_ROOM).show()}showChangeRoomButton(t){const e=this.toolbar.getButton(this.TOOLBAR_BUTTONS.CHANGE_ROOM);e.setLabel(t),e.show()}showChangeColorButton(){this.toolbar.getButton(this.TOOLBAR_BUTTONS.CHANGE_COLOR).show()}showMeasureButton(t){const e=this.toolbar.getButton(this.TOOLBAR_BUTTONS.MEASURE);e.show(),e.setLabel(t)}}class U extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M48.5 224H40c-13.3 0-24-10.7-24-24V72c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2L98.6 96.6c87.6-86.5 228.7-86.2 315.8 1c87.5 87.5 87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3c-62.2-62.2-162.7-62.5-225.3-1L185 183c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8H48.5z"})}}class j extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"})}}class q extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM184 296c0 13.3 10.7 24 24 24s24-10.7 24-24V232h64c13.3 0 24-10.7 24-24s-10.7-24-24-24H232V120c0-13.3-10.7-24-24-24s-24 10.7-24 24v64H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h64v64z"})}}class Q extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM136 184c-13.3 0-24 10.7-24 24s10.7 24 24 24H280c13.3 0 24-10.7 24-24s-10.7-24-24-24H136z"})}}class $ extends y{constructor(t){super(t),this.addSvgIcon({viewBox:"0 0 512 512",d:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"})}}class K extends f{constructor(t,e){super(e),this.element.style.top="30px",this.element.style.left="50px",this.element.style.flexDirection="column",this.addButton(0,new U(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.undo()},this.addButton(1,new j(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.redo()},this.addButton(2,new q(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.zoomIn()},this.addButton(3,new $(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.zoomDefault()},this.addButton(4,new Q(this.container)).onClick=()=>{t.hideContextToolbar(),t.tools.zoomOut()}}}class J{constructor(t){this.undoQueue=[],this.redoQueue=[],this.maxQueueSize=100,t&&(this.maxQueueSize=t.maxQueueSize??100)}clear(){this.undoQueue=[],this.redoQueue=[]}push(t){this.undoQueue.push(t),this.undoQueue.length>this.maxQueueSize&&this.undoQueue.shift()}undo(){return this.undoQueue.length>0&&this.redoQueue.push(this.undoQueue.pop()),this.undoQueue.length>0?this.undoQueue[this.undoQueue.length-1]:null}redo(){if(this.redoQueue.length>0){const t=this.redoQueue.pop();return this.undoQueue.push(t),t}return null}}class Z{constructor(){this.defaultScaleX=1,this.defaultScaleY=1,this.currentScaleX=1,this.currentScaleY=1,this.translateX=0,this.translateY=0}get unscaledTranslateX(){return 0===this.translateX?this.translateX:this.translateX/this.currentScaleX}get unscaledTranslateY(){return 0===this.translateY?this.translateY:this.translateY/this.currentScaleY}clear(){this.currentScaleX=1,this.currentScaleY=1,this.translateX=0,this.translateY=0}from(t){const e=t.getTransform();e&&(this.currentScaleX=e.a,this.currentScaleY=e.d,this.translateX=e.e,this.translateY=e.f)}applyDefaultScale(t){t.setTransform(1,0,0,1,0,0),t.scale(this.defaultScaleX,this.defaultScaleY),this.currentScaleX=this.defaultScaleX,this.currentScaleY=this.defaultScaleY,t.translate(this.unscaledTranslateX,this.unscaledTranslateY)}}class tt extends H{constructor(t){super(),this.controls=[],this.offset=null,this.controls=t?Array.isArray(t)?t:[t]:[]}onDragStart(t,e){this.offset=e.copy()}onDrag(t,e){this.moveControls(e)}onDragStop(t,e){this.moveControls(e)}moveControls(t){const e=t.x-this.offset.x,s=t.y-this.offset.y;this.controls.forEach((t=>{t.translate(e,s)})),this.offset=t.copy()}}class et extends H{constructor(t,e){super(),this.control=t,this.handler=e,this.render=new st}onDragStart(t,e){const s=this.findPointOnSegment(t,e);this.render.update(s),this.handler?.onDragStart(t,s.point),t.addSelectControl(this.render)}onDrag(t,e){const s=this.findPointOnSegment(t,e);this.render.update(s),this.handler?.onDrag(t,s.point)}onDragStop(t,e){const s=this.findPointOnSegment(t,e);this.render.update(s),this.handler?.onDragStop(t,s.point),t.removeSelectControl(this.render)}findPointOnSegment(t,e){const s=t.getCurrentFloor().findSegmentAtPoint(e,(t=>t!==this.control));return s?{segment:s,point:s.getNearestPointOnSegment(e)}:{segment:null,point:e}}}class st{constructor(){this.measure=new X}update({segment:t,point:e}){t?t.isRightDirection()?this.measure.segments=[new R(t.start,e),new R(e,t.end)]:this.measure.segments=[new R(t.end,e),new R(e,t.start)]:this.measure.segments=[]}render(t){this.measure&&this.measure.render(t)}}class nt extends H{constructor(t,e){super(),this.segment=t,this.rotates=[];for(const t of e)this.rotates.push({control:t,start:this.segment.start.distanceTo(t.start),end:this.segment.start.distanceTo(t.end)})}onDragStart(t,e){this.started=!0}onDrag(t,e){for(const{control:t,start:e,end:s}of this.rotates)t.start=this.segment.getOffsetPointFromStart(e),t.end=this.segment.getOffsetPointFromStart(s)}onDragStop(t,e){this.started&&(this.started=!1)}onCancel(){this.started=!1}}class ot extends H{constructor(...t){super(),this.handlers=t??[]}addHandler(t){t&&this.handlers.push(t)}onDragStart(t,e){this.handlers.forEach((s=>{s.onDragStart(t,e)}))}onDrag(t,e){this.handlers.forEach((s=>{s.onDrag(t,e)}))}onDragStop(t,e){this.handlers.forEach((s=>{s.onDragStop(t,e)}))}}class it extends H{constructor(t,e){super(),this.measure=new X(t,e)}onDragStart(t,e){t.addSelectControl(this.measure)}onDragStop(t,e){t.removeSelectControl(this.measure)}}class rt extends H{constructor(t,e){super(),this.wall=t,this.point=e}onDragStart(t,e){}onDrag(t,e){this.point.x=e.x,this.point.y=e.y}onDragStop(t,e){this.wall.split(t)}}class lt extends z{constructor(t,e){super(t,e),this.thick=1}get type(){return"wall"}getConnectableSegments(){return[this.segment]}duplicate(){const t=new lt(this.start.copy(),this.end.copy());return t.thick=this.thick,t.color=this.color,t}render(t){t.save(),t.beginPath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.closePath(),t.stroke(),t.restore()}createPointHandler(t,e){const s=this.hitPoint(t,e);if(!s)return null;const n=t.getCurrentFloor(),o=new ot;return o.addHandler(new et(this,new rt(this,s.point))),o.addHandler(new nt(this.segment,this.getAllWindowAndDoorOnSegment(n))),o.addHandler(new it(this.segment)),{control:this,handler:o,point:s.point}}createSegmentHandler(t,e){if(!this.isPointInControl(e))return null;const s=t.getCurrentFloor(),n=new ot;return n.addHandler(new tt(this)),n.addHandler(new nt(this.segment,this.getAllWindowAndDoorOnSegment(s))),n.addHandler(new it(this.segment)),{control:this,segment:this.segment,handler:n}}getAllWindowAndDoorOnSegment(t){return t.getControlsInsideSegment(this.segment).filter((t=>"window"===t.type||"door"===t.type))}split(t){this.splitRooms(t),this.addWalls(t)}splitRooms(t){const e=[],s=[],n=t.getCurrentFloor();for(const t of n.getRooms()){const n=t.split(this.segment);n.length>0&&(s.push(...n),e.push(t))}for(const t of e)n.removeRoom(t);for(const t of s)n.addRoom(t)}addWalls(t){const e=t.getCurrentFloor(),s=[this.segment.start,...this.findIntersectionPoints(t),this.segment.end];for(let t=0;t<s.length-1;t++){const n=s[t],o=s[t+1];if(!e.isSegmentInSegment(new R(n,o))){const t=new lt(n.copy(),o.copy());t.thick=10,e.addWall(t)}}}findIntersectionPoints(t){const e=t.getCurrentFloor(),s=[];for(const t of e.getRooms())s.push(...t.findIntersectionPoints(this.segment));return s.sort(((t,e)=>t.distanceTo(this.segment.start)-e.distanceTo(this.segment.start))),s}}class ht{static applyOpacityToColor(t,e){return function(t,e){return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${e})`}(function(t){let e=parseInt(t.replace("#",""),16);return[e>>16&255,e>>8&255,255&e]}(t),e)}static isRGBorRGBA(t){return/^(rgb|rgba)/.test(t)}static toHexColor(t){if(!t)return t;let e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(\.\d+)?))?\)/);if(!e)return null;let s="";void 0!==e[4]&&(s=Math.round(255*parseFloat(e[4])).toString(16),1===s.length&&(s="0"+s));let n="#";for(let t=1;t<=3;t++){let s=parseInt(e[t],10).toString(16);1===s.length&&(s="0"+s),n+=s}return""!==s&&(n+=s),n}static reverseTransparent(t){if(!t)return t;let e=1;9===t.length&&(e=parseInt(t.slice(7,9),16)/255),e=1===e?.5:1;let s=Math.round(255*e).toString(16);return 1===s.length&&(s="0"+s),t.slice(0,7)+s}static toTransparent(t){if(!t)return t;ht.isRGBorRGBA(t)&&(t=ht.toHexColor(t));let e=1;9===t.length&&(e=parseInt(t.slice(7,9),16)/255),1===e&&(e=.5);let s=Math.round(255*e).toString(16);return 1===s.length&&(s="0"+s),t.slice(0,7)+s}}class at{constructor(t){this.points=t??[]}setPoints(t){this.points=t??[]}get count(){return this.points.length}duplicate(){return this.points.map((t=>t.copy()))}getBoundRect(){const t={minX:0,minY:0,maxX:0,maxY:0};if(0===this.points.length)return t;let e=this.points[0].x,s=this.points[0].y,n=this.points[0].x,o=this.points[0].y;for(let t=1;t<this.points.length;t++){const i=this.points[t];i.x<e&&(e=i.x),i.x>n&&(n=i.x),i.y<s&&(s=i.y),i.y>o&&(o=i.y)}return t.minX=e,t.maxX=n,t.minY=s,t.maxY=o,t}getCenterPoint(){let t=0,e=0;for(const s of this.points)t+=s.x,e+=s.y;const s=new c(t/this.points.length,e/this.points.length);if(!this.isPointInside(s)){let t=this.points[0],e=s.distanceTo(t);for(let n=1;n<this.points.length;n++){const o=s.distanceTo(this.points[n]);o<e&&(t=this.points[n],e=o)}return t.copy()}return s}getVisualCenterPoint(){const t=this.generateGridPoints(this.getBoundRect(),10);return this.findCenterPoint(t,this.createSegments())}generateGridPoints(t,e){const s=this.getCenterPoint(),n=[],o=t.maxX-t.minX,i=t.maxY-t.minY,r=Math.floor(o/e),l=Math.floor(i/e);for(let o=0;o<e;o++)for(let i=0;i<e;i++){const e=t.minX+i*r,h=t.minY+o*l,a=new c(e,h);this.isPointInside(a)&&(n.push(a),a.radius=s.distanceTo(a))}return n}findCenterPoint(t,e){let s=null;for(const s of t){let t=1/0;for(const n of e){const e=n.getNearestPointOnSegment(s),o=s.distanceTo(e);t=Math.min(o,t)}s.distance=t}for(const e of t)s?s.distance===e.distance?s.radius>e.radius&&(s=e):s.distance<e.distance&&(s=e):s=e;return s}addPoint(t){this.existPoint(t)||this.points.push(t)}insertPoint(t,e){const s=this.points.indexOf(e);return-1!==s&&(this.points.splice(s+1,0,t),!0)}existPoint(t){return this.points.some((e=>{return s=e,n=t,Math.floor(s.x)===Math.floor(n.x)&&Math.floor(s.y)===Math.floor(n.y);var s,n}))}first(){return this.count>1?this.points[0]:null}isPointInside(t){let e=!1;const{x:s,y:n}=t;for(let t=0,o=this.points.length-1;t<this.points.length;o=t++){const i=this.points[t].x,r=this.points[t].y,l=this.points[o].x,h=this.points[o].y;r>n!=h>n&&s<(l-i)*(n-r)/(h-r)+i&&(e=!e)}return e}isPointsInside(t){const e=this.createSegments();for(const s of t){if(!(this.isPointInsideSegments(e,s)||this.isPointInside(s)))return!1}return!0}isPointInsideSegments(t,e){return t.some((t=>t.isPointInSegment(e)))}isPolygonContained(t){return this.isPointsInside(t.points)}calculateArea(){const t=this.points.length;let e=0;for(let s=0;s<t;s++){const n=this.points[s],o=this.points[(s+1)%t];e+=n.x*o.y-o.x*n.y}return Math.abs(e)/2}getPrevPoint(t){const{points:e}=this,s=e.indexOf(t);return e[(s-1+e.length)%e.length]}getNextPoint(t){const{points:e}=this,s=e.indexOf(t);return e[(s+1)%e.length]}createSegments(){const t=[],{points:e}=this;for(let s=0;s<e.length;s++){const n=e[s],o=e[(s+1)%e.length];t.push(new R(n,o))}return t}removeSamePoints(){const t=[];for(let e=0;e<this.points.length-1;e++){const s=this.points[e],n=this.points[e+1];s.distanceTo(n)<5&&t.push(s)}return this.points=this.points.filter((e=>!t.includes(e))),t.length}removeCollinearPoints(){const t=[];for(let e=0;e<this.points.length-2;e++){const s=this.points[e],n=this.points[e+1],o=this.points[e+2];this.isCollinear(s,n,o)&&(t.push(n),e++)}return this.points=this.points.filter((e=>!t.includes(e))),t.length}isCollinear(t,e,s){return(t.y-e.y)*(t.x-s.x)==(t.y-s.y)*(t.x-e.x)}}class ct{constructor(t){this.length=0,this.first=null,this.last=null,t&&t.forEach((t=>this.add(t)))}forEach(t){if(0===this.length||"function"!=typeof t)return;let e=0;for(let s=this.first;s;s=s.next,e++)t(s.value,e)}map(t){if("function"!=typeof t)return[];const e=[];return this.forEach(((s,n)=>{e.push(t(s,n))})),e}find(t){if(!t)return null;for(let e=this.first;e;e=e.next)if(e.value===t)return e;return null}add(t){const e=new dt(t);0===this.length?this.first=e:this.last.next=e,this.last=e,this.length++}}class dt{constructor(t){this.value=t,this.next=null}}class ut{static split(t,e){const s=new ct,{points:n}=t;let o=[];for(let t=0;t<n.length;t++){const i=n[t],r=n[(t+1)%n.length];s.add(new gt(i));const l=e.getIntersectionPoint(new R(i,r));if(l){const t=new gt(l);t.type="intersection",s.add(t),o.push(t)}}return 0===this.pairIntersectionVertexes(t,e,o)?[]:this.toPolygons(s)}static pairIntersectionVertexes(t,e,s){if(s.length<=1)return 0;s.sort(((t,s)=>e.start.distanceTo(t.point)-e.start.distanceTo(s.point)));let n=0;for(let e=0;e<s.length-1;e++){const o=s[e],i=s[e+1],r=new c((o.point.x+i.point.x)/2,(o.point.y+i.point.y)/2);let l=!1;t.isPointInside(r)&&(o.pair=i,i.pair=o,n++,l=!0)}return n}static toPolygons(t){const e=[];for(let s=t.first;s;s=s.next)if(!s.visited){const n=this.toPolygon(t,s);n&&e.push(n)}return e}static toPolygon(t,e){const s=[];let n=!1,o=e;for(;o;){o.visited=!0;const i=o.value;if(s.push(i.point.copy()),!n&&"intersection"===i.type&&i.pair?(o=t.find(i.pair),n=!0):(o=o.next,n=!1),o===e)break}return s.length>=3?new at(s):null}}class gt{constructor(t){this.point=t,this.type=null,this.pair=null}}class mt extends H{constructor(t,e){super(),this.segment=t,this.config=e??{},this.start=new c,this.segment.makeVerticalOrHorizontal()}onDragStart(t,e){this.start.x=e.x,this.start.y=e.y}onDrag(t,e){const s=e.x-this.start.x,n=e.y-this.start.y;this.config.onTransform?this.config.onTransform(s,n,e):this.segment.translate(s,n),this.start.x=e.x,this.start.y=e.y}onDragStop(t,e){this.config.onDragStop?.(this.segment)}}class ft extends H{constructor(t,e){super(),this.point=t,"function"==typeof e&&(this.onDone=e)}onDragStart(t,e){}onDrag(t,e){this.point.x=e.x,this.point.y=e.y}onDragStop(t,e){this.onDone&&this.onDone(this.point)}}class pt{constructor(t,e,s){this.polygons=t?Array.isArray(t)?t:[t]:[],this.thick=e??15,this.color=s??"rgb(0, 151, 197, 0.7)"}render(t){t.save(),this.renderPolygons(t),t.restore()}renderPolygons(t){if(!(this.polygons.length<=0))for(const e of this.polygons){const{points:s}=e;if(s.length>0){t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let e=1;e<s.length;e++)t.lineTo(s[e].x,s[e].y);t.closePath(),t.lineWidth=this.thick,t.strokeStyle=this.color,t.stroke()}}}}class xt{constructor(t){this.config=t??{},this.angle=this.config.angle??0,this.point=this.config.point??new c,this.color=k.primaryRedColor,this.text="벽 분리"}render(t){this.point&&(this.renderDivideArrow(t),this.renderDividePoint(t),this.renderDivideText(t))}renderDividePoint(t){t.save(),t.fillStyle=this.color,s.circle(t,this.point.x,this.point.y,5,!0),t.restore()}renderDivideArrow(t){t.save(),t.fillStyle=this.color,t.translate(this.point.x,this.point.y),t.rotate(this.angle),s.arrow(t,0,15,5,"down"),s.arrow(t,0,-15,5,"up"),t.restore()}renderDivideText(t){const e=t.measureText(this.text).width+10,s=this.point.x,n=this.point.y+30;t.fillStyle="black",t.fillRect(s-e/2,n-7.5,e,15),t.fillStyle="white",t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,s,n)}}class yt extends M{constructor(t){super(),this.polygon=new at(t??[]),this.segments=this.polygon.createSegments()}get type(){return"polygon"}setPoints(t){this.polygon.setPoints(t),this.segments=this.polygon.createSegments()}hitPoint(t,e){let s=this.findVertexPoint(t,e);return s?{point:s.point,render:new B(s.point)}:(s=this.findDividePoint(t,e),s?{point:s.point,render:new xt({point:s.point,angle:s.segment.angle})}:null)}findVertexPoint(t,e){const s=this.polygon.points.find((t=>t.distanceTo(e)<10));return s?{point:s}:null}findDividePoint(t,e){if(this.isWindowOrDoorExist(t,e))return null;const s=this.segments.find((t=>t.length>50&&t.getMidPoint().distanceTo(e)<10));return s?{point:s.getMidPoint(),segment:s}:null}isWindowOrDoorExist(t,e){return t.getCurrentFloor().findControlsAtPoint(e,(t=>"window"===t.type||"door"===t.type)).length>0}divideSegment(t,e){this.polygon.insertPoint(e,t.start),this.segments=this.polygon.createSegments()}hitSegment(t,e){const s=this.findSegmentAtPoint(t,e);if(!s)return null;const n=new N;return n.addRender(new F(s.segment,e)),n.addRender(new X(s.segment)),{segment:s.segment,render:n}}hitControl(t,e){return this.isPointInControl(e)?{control:this,render:new pt(this.polygon)}:null}findSegmentAtPoint(t,e){const s=this.segments.find((t=>t.isPointInSegment(e)));return s?{segment:s}:null}getSegments(){return this.segments}getConnectableSegments(){return this.segments}getPoints(){return this.polygon.points}addPoint(t){this.polygon.addPoint(t)}translate(t,e){this.polygon.points.forEach((s=>{s.x+=t,s.y+=e}))}isPointInControl(t){return!!this.polygon.points.some((e=>e.isEqualTo(t)))||this.polygon.isPointInside(t)}isPointInSegment(t){for(const e of this.segments)if(e.isPointInSegment(t,0))return!0;return!1}isSegmentInControl(t){if(!(this.isPointInSegment(t.start)&&this.isPointInSegment(t.end)||this.isPointInSegment(t.start)&&this.isPointInSegment(t.end)))return!1;const e=this.findIntersectionPoints(t);for(let t=0;t<e.length-1;t++){const s=e[t],n=e[t+1];if(!this.isPointInControl(new c((s.x+n.x)/2,(s.y+n.y)/2)))return!1}return!0}findIntersectionPoints(t){const e=[];for(const s of this.segments){const n=s.getIntersectionPoint(t);n&&e.push(n)}return e}createPointHandler(t,e){let s=this.findVertexPoint(t,e);if(s||(s=this.findDividePoint(t,e),s&&this.divideSegment(s.segment,s.point)),s){const e=t.getCurrentFloor();if(e){const t=this.polygon.getPrevPoint(s.point),n=this.polygon.getNextPoint(s.point),o=new R(t,s.point),i=new R(n,s.point),r=e.getControlsInsideSegment(o),l=e.getControlsInsideSegment(i),h=new ot;return h.addHandler(new ft(s.point,(()=>{(this.polygon.removeSamePoints()>0||this.polygon.removeCollinearPoints()>0)&&(this.segments=this.polygon.createSegments())}))),h.addHandler(new nt(o,r)),h.addHandler(new nt(i,l)),{control:this,handler:h,point:s.point}}}return null}createSegmentHandler(t,e){const s=this.findAdjacentSegmentsAtPoint(e);if(!s)return null;const n=new ot;return n.addHandler(this.createMoveSegmentHandler(t,s.segment)),n.addHandler(this.createMoveCollinearControlHandler(t,s.segment)),n.addHandler(this.createMoveCollinearSegmentHandler(t,s.segment)),n.addHandler(new it(s.prevSegment)),n.addHandler(new it(s.segment)),n.addHandler(new it(s.nextSegment)),{control:this,segment:s.segment,handler:n}}createMoveSegmentHandler(t,e){const s={},n=this.segments.indexOf(e),o=this.segments.length;s.onDragStop=()=>{this.polygon.removeSamePoints()>0&&(this.segments=this.polygon.createSegments())};const i=this.segments[(n-1+o)%o].duplicate(),r=this.segments[(n+1)%o].duplicate();return s.onTransform=(t,s,n)=>{e.translate(t,s),e.start.copyFrom(i.getIntersectionPointOnSegment(e)),e.end.copyFrom(r.getIntersectionPointOnSegment(e)),e.isVertical()?(e.start.x=n.x,e.end.x=n.x):e.isHorizontal()&&(e.start.y=n.y,e.end.y=n.y)},new mt(e,s)}insertPoint(t,e){this.polygon.insertPoint(t,e)&&(this.segments=this.polygon.createSegments())}createMoveCollinearControlHandler(t,e){const s=t.getCurrentFloor().getControlsInsideSegment(e);return new nt(e,s)}createMoveCollinearSegmentHandler(t,e){const s=t.getCurrentFloor(),n=(t,s)=>{t.copyFrom(e.getNearestPointOnLine(t)),s.copyFrom(e.getNearestPointOnLine(s))},o=new ot;for(const t of s.getAllControls())if(t!==this&&"room"===t.type)for(const i of t.getSegments()){let{start:r,end:l}=i;if(e.isPointInSegment(r)&&e.isPointInSegment(l))n(r,l),o.addHandler(t.createMoveSegmentHandler(s,i));else{const h=e.isParallel(i);(e.isPointInSegment(r)||e.isPointInSegment(l))&&h&&(n(r,l),o.addHandler(t.createMoveSegmentHandler(s,i)))}}return o}findAdjacentSegmentsAtPoint(t){const e=this.segments.length;for(let s=0;s<e;s++){const n=this.segments[s],o=this.segments[(s-1+e)%e],i=this.segments[(s+1)%e];if(n.isPointInSegment(t))return{prevSegment:o,segment:n,nextSegment:i}}return null}}class wt{constructor(t,e,s){this.config=s??{},this.room=t,this.holes=e??[],this.config.room??={},this.config.holes??={},this.config.room.color??=k.activeColorTransparent,this.config.room.thick??=15}render(t){t.save();const{color:e,thick:s}=this.config.room;this.renderRoom(t,this.room,e,s),this.renderHoles(t),t.restore()}renderRoom(t,e,s,n){if(!e)return;const{points:o}=e.polygon;if(o.length>0){t.beginPath(),t.moveTo(o[0].x,o[0].y);for(let e=1;e<o.length;e++)t.lineTo(o[e].x,o[e].y);t.closePath(),t.strokeStyle=s,t.lineWidth=n,t.stroke()}}renderHoles(t){const{color:e,thick:s}=this.config.room;for(const n of this.holes)this.renderRoom(t,n,e,s)}}class Ct{constructor(t){t&&this.build(t)}build(t){t=this.removeDuplicates(t),this.root=this.buildTree(t,0)}removeDuplicates(t){return[...new Set(t.map((t=>JSON.stringify([t.x,t.y]))))].map((t=>JSON.parse(t))).map((t=>new c(t[0],t[1])))}buildTree(t,e){if(0===t.length)return null;const s=e%2;t.sort(((t,e)=>t[0===s?"x":"y"]-e[0===s?"x":"y"]));const n=Math.floor(t.length/2),o=new vt(t[n],s);return o.left=this.buildTree(t.slice(0,n),e+1),o.right=this.buildTree(t.slice(n+1),e+1),o}findNearestX(t,e=10){let s=null,n=1/0;return function o(i){if(null===i)return;const r=Math.abs(Math.floor(i.point.x)-t);r<n&&r<e&&(s=i.point.x,n=r);const l=t<i.point.x?i.left:i.right;if(o(l),Math.abs(t-i.point.x)<n){const e=t<i.point.x?i.right:i.left;o(e)}}(this.root),s?Math.floor(s):null}findNearestY(t){let e=null,s=1/0;return function n(o){if(null===o)return;const i=Math.abs(Math.floor(o.point.y)-t);i<s&&i<10&&(e=o.point.y,s=i);const r=t<o.point.y?o.left:o.right;if(n(r),Math.abs(t-o.point.y)<s){const e=t<o.point.y?o.right:o.left;n(e)}}(this.root),e?Math.floor(e):null}findPointsOnX(t){const e=[];return this.findAllPointsWithSameX(this.root,t,e),e}findAllPointsWithSameX(t,e,s){null!==t&&(t.point.x===e&&s.push(t.point),this.findAllPointsWithSameX(t.left,e,s),this.findAllPointsWithSameX(t.right,e,s))}findPointsOnY(t){const e=[];return this.findPointsWithSameY(this.root,t,e),e}findPointsWithSameY(t,e,s){null!==t&&(t.point.y===e&&s.push(t.point),this.findPointsWithSameY(t.left,e,s),this.findPointsWithSameY(t.right,e,s))}findNearestPoint(t,e=5){let s=null,n=1/0;const o=(t,i,r)=>{if(null===t)return;const l=t.point.distanceTo(i);l<n&&l<=e&&(s=t.point,n=l);const h=r%2,a=()=>0===h?"x":"y",c=i[a()]<t.point[a()]?t.left:t.right;if(o(c,i,r+1),Math.abs(i[a()]-t.point[a()])<n){const e=i[a()]<t.point[a()]?t.right:t.left;o(e,i,r+1)}};return o(this.root,t,0),s}}class vt{constructor(t,e){this.point=t,this.left=null,this.right=null,this.axis=e}}class Pt{constructor(t){this.tree=new Ct(t??[])}build(t){this.tree.build(t)}findNearestX(t,e=5){return this.tree.findNearestX(t)}findNearestY(t,e=5){return this.tree.findNearestY(t)}findPointsOnX(t){return this.tree.findPointsOnX(t)}findPointsOnY(t){return this.tree.findPointsOnY(t)}}class St{constructor(t){this.points=[],this.color=t??"blue"}render(t){t.save(),t.strokeStyle=this.color,t.fillStyle=this.color;for(let e=0;e<this.points.length;e++){const s=this.points[e];t.circle(s.x,s.y,5),t.fill()}if(this.points.length>1){const e=this.points[0],s=this.points[this.points.length-1];t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(s.x,s.y),t.closePath(),t.lineWidth=2,t.stroke()}t.restore()}}class Tt{constructor(){this.collinearPointsOnX=new Map,this.collinearPointsOnY=new Map}clear(){this.collinearPointsOnX.clear(),this.collinearPointsOnY.clear()}addCollinearPointsOnX(t,e){if(!e||0===e.length)return;t=Math.floor(t);const s=this.getOrCreateCollinearX(t);s.points.push(...e),s.points.sort(((t,e)=>t.y-e.y))}getOrCreateCollinearX(t){let e=this.collinearPointsOnX.get(t);return e||(e=new St,this.collinearPointsOnX.set(t,e)),e}addCollinearPointsOnY(t,e){if(0===e.length)return;t=Math.floor(t);const s=this.getOrCreateCollinearY(t);s.points.push(...e),s.points.sort(((t,e)=>t.x-e.x))}getOrCreateCollinearY(t){let e=this.collinearPointsOnY.get(t);return e||(e=new St,this.collinearPointsOnY.set(t,e)),e}render(t){t.save(),this.renderCollinearPointsToX(t),this.renderCollinearPointsToY(t),t.restore()}renderCollinearPointsToX(t){this.collinearPointsOnX.forEach(((e,s)=>{e.render(t)}))}renderCollinearPointsToY(t){this.collinearPointsOnY.forEach(((e,s)=>{e.render(t)}))}}class bt extends H{constructor(t){super(),this.control=t.control,this.handler=t.handler,this.render=new Tt,this.coordinate=new Pt}getAllPointsExceptGivenControls(t){const e=t.getCurrentFloor();return e?e.getAllPoints().filter((t=>!this.control.isPointInControl(t)&&!this.control.isPointInSegment(t))):[]}onDragStart(t,e){this.coordinate.build(this.getAllPointsExceptGivenControls(t)),t.addSelectControl(this.render),this.handler.onDragStart(t,e)}onDrag(t,e){this.handler.onDrag(t,e);const s=this.findNearestPoint(e);s&&this.handler.onDrag(t,s),this.createCollinearPoints()}onDragStop(t,e){this.handler.onDragStop(t,e);const s=this.findNearestPoint(e);s&&this.handler.onDragStop(t,s),t.removeSelectControl(this.render)}findNearestPoint(t){const e=this.findNearestX(),s=this.findNearestY();return null===e.x&&null===s.y?null:(t.x=e.x?t.x-e.distance:t.x,t.y=s.y?t.y-s.distance:t.y,t)}findNearestX(){const t={x:null,distance:1/0};return this.getPoints().forEach((e=>{const s=this.coordinate.findNearestX(e.x);if(s){const n=e.x-s;Math.abs(t.distance)>Math.abs(n)&&(t.distance=n,t.x=s)}})),t}findNearestY(){const t={y:null,distance:1/0};return this.getPoints().forEach((e=>{const s=this.coordinate.findNearestY(e.y);if(s){const n=e.y-s;Math.abs(t.distance)>Math.abs(n)&&(t.distance=n,t.y=s)}})),t}createCollinearPoints(){this.render.clear(),this.createCollinearPointsOnX(),this.createCollinearPointsOnY()}createCollinearPointsOnX(){this.getPoints().forEach((t=>{const e=this.coordinate.findPointsOnX(t.x);e&&this.render.addCollinearPointsOnX(t.x,[...e,t])}))}createCollinearPointsOnY(){this.getPoints().forEach((t=>{const e=this.coordinate.findPointsOnY(t.y);e&&this.render.addCollinearPointsOnY(t.y,[...e,t])}))}getPoints(){return this.control.getPoints()}}class At extends yt{constructor(t,e){super(t),this.fillColor=null,this.label=e,this.transparent=!0}get type(){return"room"}duplicate(){const t=new At(this.polygon.duplicate(),this.label);return t.fillColor=this.fillColor,t.label=this.label,t.transparent=this.transparent,this.segments.forEach(((e,s)=>{t.segments[s].thick=e.thick,t.segments[s].color=e.color})),t}hitControl(t,e){const s=this.findHoles(t.getCurrentFloor());return this.isPointInControl(e)?{control:this,render:new wt(this,s)}:null}getControlsInsideRoom(t){const e=[];this.segments.forEach((s=>{const n=t.getControlsInsideSegment(s);n&&e.push(...n)}));let s=t.getControlsInsidePolygon(this.polygon);if(s)for(const t of s)"room"===t.type?this.calculateArea()>t.calculateArea()&&e.push(t):e.push(t);return e.filter(((t,s)=>e.indexOf(t)===s))}render(t){this.polygon.points.length<=0||(t.save(),this.renderSpace(t),this.renderLabel(t),this.renderSegment(t),t.restore())}renderSegment(t){if(!(this.segments.length<=0))for(const e of this.segments)e.thick>0&&(t.beginPath(),t.lineWidth=e.thick,t.strokeStyle=e.color,t.moveTo(e.start.x,e.start.y),t.lineTo(e.end.x,e.end.y),t.closePath(),t.stroke())}renderSpace(t){const{points:e}=this.polygon;if(e.length>0&&this.fillColor){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y);t.closePath(),t.fillStyle=this.transparent?ht.toTransparent(this.fillColor):this.fillColor,t.fill()}}renderLabel(t){const e=this.polygon.getVisualCenterPoint();this.label&&e&&(t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillStyle="#000000",t.fillText(this.label,e.x,e.y))}createControlHandler(t,e){if(!this.isPointInControl(e))return null;const s=t.getCurrentFloor(),n=this.getControlsInsideRoom(s),o=new ot;return o.addHandler(new bt({handler:new ot(new tt(this),new tt(n)),control:this})),{control:this,handler:o}}hasNestedRoom(t){for(const e of t)if(e!==this&&this.isRoomContained(e))return!0;return!1}findHoles(t){const e=[];for(const s of t.getRooms())s!==this&&this.isRoomContained(s)&&this.calculateArea()>s.calculateArea()&&e.push(s);const s=[];for(const n of e)s.push(...n.findHoles(t));return e.filter((t=>!s.includes(t)))}isRoomContained(t){return this.polygon.isPolygonContained(t.polygon)}calculateArea(){return this.polygon.calculateArea()}split(t){const e=[],s=ut.split(this.polygon,t);for(const t of s)if(t.calculateArea()>1){const s=new At(t.points);s.fillColor=this.fillColor,s.label=this.label,s.transparent=this.transparent,e.push(s)}return e}}class Ot extends H{constructor(t){super(),this.door=t,this.started=!1}onDrag(t,e){const{segment:s}=this.door;let n=s.crossProductToStart(e);this.door.direction=n>0?"right":"left",this.door.hinge=s.start.distanceTo(e)<s.end.distanceTo(e)?"start":"end"}}class Dt extends z{constructor(t,e){super(t,e),this.hinge="start",this.direction="right"}get type(){return"door"}duplicate(){const t=new Dt(this.start.copy(),this.end.copy());return t.hinge=this.hinge,t.direction=this.direction,t}findHitPoint(t,e){let s=super.findHitPoint(t,e);if(!s){const t=this.getChangeHingePoint();if(t.distanceTo(e)<10)return{point:t}}return s}createPointHandler(t,e){const s=this.findHitPoint(t,e);return s&&this.getChangeHingePoint().isEqualTo(s.point)?{control:this,handler:new Ot(this),point:s.point}:super.createPointHandler(t,e)}getChangeHingePoint(){const t=this.length,e=this.segment.angle-270*Math.PI/180;let s=0,n=0;return"right"===this.direction?"start"===this.hinge?(s=this.start.x+t*Math.cos(e),n=this.start.y+t*Math.sin(e)):(s=this.end.x+t*Math.cos(e),n=this.end.y+t*Math.sin(e)):"start"===this.hinge?(s=this.start.x-t*Math.cos(e),n=this.start.y-t*Math.sin(e)):(s=this.end.x-t*Math.cos(e),n=this.end.y-t*Math.sin(e)),new c(s,n)}render(t){t.save(),t.lineWidth=1,t.translate(this.start.x,this.start.y),t.rotate(this.segment.angle),this.renderRect(t),this.renderDoor(t),t.restore()}renderRect(t){const e=this.length,s=10/3,n=new Path2D;n.rect(0,-5,e,10);for(let t=0;t<3;t++)n.rect(5,s*t-5,e-10,s);t.fillStyle="#ffffff",t.strokeStyle="#000000",t.fill(n),t.stroke(n)}renderDoor(t){const e=this.length,s=new Path2D,n=Math.PI/2,o=Math.PI,i=0+e;"start"===this.hinge?"right"===this.direction?(s.arc(0,0,e,0,n,!1),s.moveTo(0,0),s.lineTo(0,e)):(s.arc(0,0,e,-n,0,!1),s.moveTo(0,0),s.lineTo(0,-e)):"right"===this.direction?(s.arc(i,0,e,n,o,!1),s.moveTo(i,0),s.lineTo(i,e)):(s.arc(i,0,e,o,-n,!1),s.moveTo(i,0),s.lineTo(i,-e)),t.stroke(s)}}class Et extends z{constructor(t,e){super(t,e)}get type(){return"window"}duplicate(){return new Et(this.start.copy(),this.end.copy())}render(t){const{start:e,end:s}=this.segment,n=this.segment.angle,o=this.segment.length,i=this.createWindowPath(o,10);t.save(),t.translate(e.x,e.y),t.rotate(n),t.lineWidth=1,t.strokeStyle="#000000",t.fillStyle="#ffffff",t.fill(i),t.stroke(i),t.restore()}createWindowPath(t,e){const s=e/3,n=new Path2D;n.rect(0,-5,t,e);for(let e=0;e<3;e++)n.rect(5,s*e-5,t-10,s);return n}}class Mt extends yt{constructor(t){super(t)}get type(){return"outline"}hitControl(t,e){return null}render(t){this.segments.length<=0||(t.save(),this.renderLines(t,10,"#000000"),t.restore())}renderLines(t,e,s){for(const n of this.segments)t.lineWidth=e,t.strokeStyle=s,t.beginPath(),t.moveTo(n.start.x,n.start.y),t.lineTo(n.end.x,n.end.y),t.closePath(),t.stroke()}}class Rt{constructor(t){t?this.load(t):(this.rooms=[],this.walls=[],this.windows=[],this.doors=[],this.outlines=[]),this.onChange=null}getRooms(){return this.rooms}addRoom(t){t&&(this.rooms.push(t),this.fireOnChange())}removeRoom(t){const e=this.rooms.indexOf(t);-1!==e&&(this.rooms.splice(e,1),this.fireOnChange())}removeAllRooms(){this.rooms=[],this.fireOnChange()}getWalls(){return this.walls}addWall(t){t&&(this.walls.push(t),this.fireOnChange())}removeWall(t){const e=this.walls.indexOf(t);-1!==e&&this.walls.splice(e,1)}removeAllWalls(){this.walls=[],this.fireOnChange()}getWindows(){return this.windows}addWindow(t){t&&(this.windows.push(t),this.fireOnChange())}removeWindow(t){const e=this.windows.indexOf(t);-1!==e&&this.windows.splice(e,1)}removeAllWindows(){this.windows=[]}getDoors(){return this.doors}addDoor(t){t&&(this.doors.push(t),this.fireOnChange())}removeDoor(t){const e=this.doors.indexOf(t);-1!==e&&this.doors.splice(e,1)}addOutline(t){t&&(this.outlines.push(t),this.fireOnChange())}getOutlines(){return this.outlines}removeAllDoors(){this.doors=[],this.fireOnChange()}clear(){this.removeAllRooms(),this.removeAllWalls(),this.removeAllDoors(),this.removeAllWindows(),this.outlines=[]}load(t){this.clear(),t.outlines&&this.loadOutlines(t.outlines),t.rooms&&this.loadRooms(t.rooms),t.walls&&this.loadWalls(t.walls),t.windows&&this.loadWindows(t.windows),t.doors&&this.loadDoors(t.doors)}loadOutlines(t){for(const e of t)if(e.polygon&&e.polygon.points){const t=e.polygon.points.map((t=>new c(t.x,t.y))),s=new Mt(t,e.label);for(let t=0;t<s.segments.length;t++){const n=s.segments[t];n.thick=e.segments[t].thick,n.color=e.segments[t].color}s.fillColor=e.fillColor,this.outlines.push(s)}}loadRooms(t){for(const e of t)if(e.polygon&&e.polygon.points){const t=e.polygon.points.map((t=>new c(t.x,t.y))),s=new At(t,e.label);for(let t=0;t<s.segments.length;t++){const n=s.segments[t];n.thick=e.segments[t].thick,n.color=e.segments[t].color}s.fillColor=e.fillColor,s.label=e.label,s.transparent=e.transparent,this.rooms.push(s)}}loadWalls(t){for(const e of t){const{start:t,end:s}=e.segment,n=new lt(new c(t.x,t.y),new c(s.x,s.y));this.walls.push(n)}}loadWindows(t){for(const e of t){const{start:t,end:s}=e.segment,n=new Et(new c(t.x,t.y),new c(s.x,s.y));this.windows.push(n)}}loadDoors(t){for(const e of t){const{start:t,end:s}=e.segment,n=new Dt(new c(t.x,t.y),new c(s.x,s.y));n.hinge=e.hinge,n.direction=e.direction,this.doors.push(n)}}render(t,e){e??={},e.isRoomVisible=()=>e.visible?.room??!0,e.isWallVisible=()=>e.visible?.wall??!0,e.isOutlineVisible=()=>e.visible?.outline??!0,e.isDoorVisible=()=>e.visible?.door??!0,e.isWindowVisible=()=>e.visible?.window??!0,this.renderFloor(t,e)}renderFloor(t,e){e.isRoomVisible()&&this.renderRooms(t),e.isWallVisible()&&this.renderWalls(t),e.isOutlineVisible()&&this.renderOutlines(t),e.isDoorVisible()&&this.renderDoors(t),e.isWindowVisible()&&this.renderWindows(t)}renderRooms(t){const e=this.rooms.slice().sort(((t,e)=>e.calculateArea()-t.calculateArea()));for(const s of e)s.render(t)}renderWalls(t){for(const e of this.walls)e.render(t)}renderOutlines(t){for(const e of this.outlines)e.render(t)}renderDoors(t){for(const e of this.doors)e.render(t)}renderWindows(t){for(const e of this.windows)e.render(t)}removeControl(t){let e=this.walls.indexOf(t);if(-1!==e&&this.walls.splice(e,1),e=this.windows.indexOf(t),-1!==e&&this.windows.splice(e,1),e=this.doors.indexOf(t),-1!==e&&this.doors.splice(e,1),e=this.rooms.indexOf(t),-1!==e){this.rooms.splice(e,1);for(const e of t.getControlsInsideRoom(this))this.removeControl(e)}}getControlsInsideSegment(t){return[...this.windows,...this.doors,...this.walls].filter((e=>t.isPointInSegment(e.start)||t.isPointInSegment(e.end)))}getControlsInsidePolygon(t){const e=[];return e.push(...[...this.windows,...this.doors,...this.walls].filter((e=>{const s=e.getPoints();return t.isPointsInside(s)}))),e.push(...this.rooms.filter((e=>{const s=e.getSegments();for(const e of s)if(!t.isPointsInside([e.start,e.end,e.getMidPoint()]))return!1;return!0}))),e}getSegments(){const t=[];return t.push(...this.rooms.flatMap((t=>[...t.getSegments()]))),t.push(...this.walls.flatMap((t=>[...t.getSegments()]))),t}getBoundRect(){let t={minX:0,minY:0,maxX:0,maxY:0};const e=this.getAllControls();return 0===e.length||e.forEach(((e,s)=>{const n=e.getBoundRect();0===s?t=n:(t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.min(t.maxY,n.maxY))})),t}existSameSegment(t,e){const s=new R(t,e);for(const t of this.getAllControls())for(const e of t.getSegments())if(e.isEqualTo(s))return!0;return!1}findNearestSegmentAtPoint(t){let e=null,s=null,n=1/0;for(const o of this.getAllConnectableSegments()){const i=o.getNearestPointOnSegment(t);if(i){const r=i.distanceTo(t);r<n&&(e=o,n=r,s=i)}}return{segment:e,point:s}}findControlsAtPoint(t,e){return this.getControls(e).filter((e=>e.isPointInControl(t)))}findControlsAtSegment(t,e){return this.getControls(e).filter((e=>e.isSegmentInControl(t)))}findSegmentAtPoint(t,e){for(const s of this.getConnectableSegments(e))if(s.isPointInSegment(t))return s;return null}isPointInSegment(t){const e=this.getControls();for(const s of e)if(s.isPointInSegment(t))return!0;return!1}isSegmentInSegment(t){this.getControls();for(const e of this.getConnectableSegments())if(e.isPointInSegment(t.start)&&e.isPointInSegment(t.end))return!0;return!1}getAllControls(){return[...this.outlines.slice().reverse(),...this.doors.slice().reverse(),...this.windows.slice().reverse(),...this.walls.slice().reverse(),...this.rooms.slice().reverse()]}getControls(t){return t??=()=>!0,this.getAllControls().filter(t)}getAllPoints(t){const e=[];for(const s of this.getAllControls())for(const n of s.getPoints())t&&t(n),e.push(n);return e}getPointsFromControls(t){const e=[];for(const s of t)for(const t of s.getPoints())e.push(t);return e}getAllConnectableSegments(){const t=[];for(const e of this.getAllControls())t.push(...e.getConnectableSegments());return t}getConnectableSegments(t){const e=[];for(const s of this.getControls(t))e.push(...s.getConnectableSegments());return e}splitRoom(t){const e=[],s=[];for(const n of this.getRooms()){const o=n.split(t);o.length>0&&(s.push(...o),e.push(n))}for(const t of e)this.removeRoom(t);for(const t of s)this.addRoom(t)}fireOnChange(){this.onChange&&this.onChange()}}class Bt{static importData(t,e,s){(new Ht).importData(t,e,new Ft(s))}static exportData(t){}}class Ft{constructor(t){this.config=t,this.defaultRoomFillColor="rgba(131,208,221,0.5)",this.create={room:!0,wall:!0,door:!0,window:!0},t.create&&(this.create.room=t.create.room??!0,this.create.wall=t.create.wall??!0,this.create.door=t.create.door??!0,this.create.window=t.create.window??!0)}getScale(){return this.config.scale??4}getRoomFillColor(t){return this.config&&this.config.room&&this.config.room.colors&&this.config.room.colors.length>t?this.config.room.colors[t]:this.defaultRoomFillColor}isCreateDoor(){return this.create.door}isCreateWindow(){return this.create.window}isCreateWall(){return this.create.wall}isCreateRoom(){return this.create.room}getWallThick(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.thick?e.thick:1}getWallColor(t){if(!this.config.themes||!this.config.themes.wall)return 1;const e=this.config.themes.wall.find((e=>e.category===t));return e&&e.color?e.color:"#000000"}getRoomColor(t){const{themes:e}=this.config,s=e?.room.find((e=>e.category===t));return s?.color??null}getRoomLabel(t){const{themes:e}=this.config,s=e?.room.find((e=>e.category===t));return s?.label??null}}class Ht{constructor(){this.scale=4}importData(t,e,s){this.scale=s.getScale();for(const n of e)"SPA"===n.type&&this.importSPA(t,n.categories,s);for(const n of e)"STR"===n.type&&this.importSTR(t,n.categories,s)}importSTR(t,e,s){for(const n of e)0!==n.category&&1!==n.category&&2!==n.category&&3!==n.category||this.importObjectFromSTR(t,n.category,n.objects,s)}importObjectFromSTR(t,e,s,n){new Mt;const o=[];for(const i of s)if("line"===i.type){const s=i.data[0][0],r=i.data[0][1],l=i.data[1][0],h=i.data[1][1],a=new c(L.meterToPixel(s),L.meterToPixel(r)),d=new c(L.meterToPixel(l),L.meterToPixel(h));a.distanceTo(d);if(0!==e&&1!==e||!n.isCreateWall()){if(3===e&&n.isCreateDoor()){const e=new Dt(a,d);e.hinge=i.hinge??"start",e.direction=i.direction??"right",t.doors.push(e)}else if(2===e&&n.isCreateWindow()){const e=new Et(a,d);t.windows.push(e)}}else if(0===e)0===o.length?o.push(a,d):o.push(d);else if(t.existSameSegment(a,d));else{const s=new lt(a,d);s.thick=n.getWallThick(e),s.color=n.getWallColor(e),t.walls.push(s)}}o.length>0&&t.addOutline(new Mt(o))}importSPA(t,e,s){for(const n of e)11!==n.category&&this.importObjectFromSPA(t,n.category,n.objects,s)}importObjectFromSPA(t,e,s,n){for(const o of s)if("Polygon"===o.type&&n.isCreateRoom()){const s=[];for(const t of o.data)s.push(new c(L.meterToPixel(t[0]),L.meterToPixel(t[1])));const i=new At(s,"");i&&(i.label=n.getRoomLabel(e),i.fillColor=n.getRoomColor(e),t.rooms.push(i))}}}class kt{constructor(t){this.editor=t,this.floors=[new Rt],this.index=0}clear(){this.floors=[]}loadFloorFromPublicAi(t,e,s){this.floors=[],t.floors.forEach((t=>{const e=new Rt;Bt.importData(e,t.datas,s),this.floors.push(e)})),this.index=e?e-1:0}saveFloor(){const t={};return t.floors=this.floors,t.floor=this.index,JSON.stringify(t,null,2)}loadFloor(t){this.floors=[];const e=JSON.parse(t);this.floors=e.floors?e.floors.map((t=>new Rt(t))):[],this.index=e.floor??0}getCurrentFloor(){return this.index>=0&&this.index<this.floors.length?this.floors[this.index]:null}}class It{onCommandActive(t){}onCommandDeActive(t){}}class Lt{constructor(){}onClick(t){}onKeyDown(t,e){}onMouseDown(t){}onMouseMove(t){}onMouseUp(t){}}class Xt extends H{constructor(t,e){super(),this.point=t,this.handlers=e??[],this.render=new Tt,this.coordinate=new Pt}getAllPointsExceptGivenPoint(t){const e=t.getCurrentFloor();return e?e.getAllPoints().filter((t=>t!==this.point)):[]}onDragStart(t,e){this.coordinate.build(this.getAllPointsExceptGivenPoint(t)),t.addSelectControl(this.render),this.handlers.forEach((s=>{s.onDragStart(t,e)}))}onDrag(t,e){e=this.findNearestPoint(e),this.handlers.forEach((s=>{s.onDrag(t,e)})),this.createCollinearPoints(e)}onDragStop(t,e){t.removeSelectControl(this.render),e=this.findNearestPoint(e),this.handlers.forEach((s=>{s.onDragStop(t,e)}))}findNearestPoint(t){return t.x=this.coordinate.findNearestX(t.x)??t.x,t.y=this.coordinate.findNearestY(t.y)??t.y,t}createCollinearPoints(t){this.render.clear(),this.createCollinearPointsOnX(t),this.createCollinearPointsOnY(t)}createCollinearPointsOnX(t){const e=this.coordinate.findPointsOnX(t.x);e&&this.render.addCollinearPointsOnX(t.x,[...e,t])}createCollinearPointsOnY(t){const e=this.coordinate.findPointsOnY(t.y);e&&this.render.addCollinearPointsOnY(t.y,[...e,t])}}class Yt extends H{constructor({segment:t,handler:e}){super(),this.segment=t,this.handler=e,this.render=new Tt,this.coordinate=new Pt}getAllPointsExceptGivenSegment(t){const e=t.getCurrentFloor();return e?e.getAllPoints().filter((t=>this.segment.start!==t&&this.segment.end!==t)):[]}onDragStart(t,e){this.coordinate.build(this.getAllPointsExceptGivenSegment(t)),t.addSelectControl(this.render),this.handler.onDragStart(t,e)}onDrag(t,e){this.handler.onDrag(t,e),(this.segment.isHorizontal()||this.segment.isVertical())&&(e=this.findNearestPoint(e),this.handler.onDrag(t,e)),this.createCollinearPoints(e)}onDragStop(t,e){t.removeSelectControl(this.render),this.handler.onDragStop(t,e)}findNearestPoint(t){const e=this.findNearestX(),s=this.findNearestY();return null===e.x&&null===s.y?null:(t.x=e.x?t.x-e.distance:t.x,t.y=s.y?t.y-s.distance:t.y,t)}findNearestX(){const t={x:null,distance:1/0};return[this.segment.start,this.segment.end].forEach((e=>{const s=this.coordinate.findNearestX(e.x);if(s){const n=e.x-s;Math.abs(t.distance)>Math.abs(n)&&(t.distance=n,t.x=s)}})),t}findNearestY(){const t={y:null,distance:1/0};return[this.segment.start,this.segment.end].forEach((e=>{const s=this.coordinate.findNearestY(e.y);if(s){const n=e.y-s;Math.abs(t.distance)>Math.abs(n)&&(t.distance=n,t.y=s)}})),t}createCollinearPoints(){this.render.clear(),[this.segment.start,this.segment.end].forEach((t=>{this.createCollinearPointsOnX(t),this.createCollinearPointsOnY(t)}))}createCollinearPointsOnX(t){const e=this.coordinate.findPointsOnX(t.x);e&&this.render.addCollinearPointsOnX(t.x,[...e,t])}createCollinearPointsOnY(t){const e=this.coordinate.findPointsOnY(t.y);e&&this.render.addCollinearPointsOnY(t.y,[...e,t])}}class Nt extends It{constructor(t){super(),this.handler=new Wt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Wt extends Lt{constructor(t){super(),this.editor=t,this.handler=null,this.isDgragging=!1,this.offset=new c,this.downPoint=new c}onKeyDown(t,e){"Backspace"===t||"Escape"===t&&this.editor.hideContextToolbar()}onMouseDown(t){this.downPoint.x=t.x,this.downPoint.y=t.y,this.editor.setSelectControls([]),this.isDgragging=!0,this.editor.hideContextToolbar(),this.handler=this.createDragHandler(this.downPoint),this.handler?this.handler.onDragStart(this.editor,this.downPoint):(this.offset.x=t.clientX,this.offset.y=t.clientY),this.editor.render()}onMouseMove(t){const e=new c(t.x,t.y);if(this.isDgragging)if(this.handler)this.handler.onDrag(this.editor,e);else{const e=t.clientX-this.offset.x,s=t.clientY-this.offset.y;this.editor.translateContext(e,s),this.offset.x=t.clientX,this.offset.y=t.clientY}else this.renderAvailableHandler(e);this.editor.render()}onMouseUp(t){const e=new c(t.x,t.y);this.isDgragging&&(this.handler&&(this.handler.onDragStop(this.editor,e),this.editor.getCurrentFloor().fireOnChange()),this.isClicked(t)&&this.showToolbar(t)),this.isDgragging=!1,this.handler=null,this.editor.setSelectControls([]),this.editor.render()}isClicked(t){return Math.abs(t.offsetX)<5&&Math.abs(t.offsetY)<5}showToolbar(t){const e=this.editor.getCurrentFloor(),s=e.findControlsAtPoint(this.downPoint),n=e.findSegmentAtPoint(this.downPoint);this.editor.showContextToolbar(t,{control:(t=>0===(t=t.filter((t=>"outline"!==t.type))).length?null:1===t.length?t[0]:t.reduce(((t,e)=>"window"===t.type||"door"===t.type?t:"window"===e.type||"door"===e.type?e:t)))(s),segment:n})}createDragHandler(t){const e=this.finAllDragHandlersAtPoint(t);if(e.points.length>0)return new Xt(e.points[0].point,e.points.map((t=>t.handler)));if(e.controls.length>0)for(const t of e.controls)if("window"===t.control.type||"door"===t.control.type)return t.handler;if(e.segments.length>0)return new Yt(e.segments[0]);if(e.controls.length>0){return(t=>{const e=t.map((t=>t.control));for(const s of t)if(!s.control.hasNestedRoom(e))return s;return t[0]})(e.controls).handler}return null}finAllDragHandlersAtPoint(t){const e=this.editor.getCurrentFloor().getAllControls(),s={points:[],segments:[],controls:[]};for(const n of e){let e=n.createPointHandler(this.editor,t);e&&s.points.push(e),e=n.createSegmentHandler(this.editor,t),e&&s.segments.push(e),e=n.createControlHandler(this.editor,t),e&&s.controls.push(e)}return s.segments.length>0&&s.segments.sort(((e,s)=>e.segment.start.distanceTo(t)-s.segment.start.distanceTo(t))),s}renderAvailableHandler(t){this.editor.setSelectControls([]);const e=this.editor.getCurrentFloor();for(const s of e.getAllControls()){const e=s.hitPoint(this.editor,t);if(e&&e.render)return void this.editor.setSelectControls([e.render])}const s=[];for(const n of e.getAllControls()){const e=n.hitSegment(this.editor,t);e&&e.render&&(e.distance=t.distanceTo(e.segment.start),s.push(e))}if(s.length>0)return s.sort(((t,e)=>t.distance-e.distance)),void this.editor.setSelectControls([s[0].render]);for(const s of e.getAllControls()){const e=s.hitControl(this.editor,t);if(e&&e.render)return void this.editor.setSelectControls([e.render])}}}class zt extends It{constructor(t){super(),this.handler=new Vt(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Vt extends Lt{constructor(t){super(),this.editor=t,this.window=new Et(new c(0,0),new c(50,50)),this.render=new _t,this.render.window=this.window,this.editor.addSelectControl(this.render)}onMouseDown(t){const e=this.editor.getCurrentFloor();e&&(e.addWindow(this.window),this.editor.removeSelectControl(this.render),this.editor.tools.select(),this.editor.render())}onMouseMove(t){const e=this.editor.getCurrentFloor();if(e){const{segment:s,point:n}=e.findNearestSegmentAtPoint(new c(t.x,t.y));if(s){const t=s.getPointAtDistance(n,-25),e=s.getPointAtDistance(n,25);this.render.updateWindow(t,e),this.render.updateSegment(s)}else{const e=new c(t.x-25,t.y),s=new c(t.x+25,t.y);this.render.updateWindow(e,s),this.render.updateSegment(null)}this.editor.render()}}}class _t{constructor(){this.window=null,this.measure=new X}updateWindow(t,e){const{segment:s}=this.window;s.start.copyFrom(t),s.end.copyFrom(e)}updateSegment(t){this.measure.segments=t?[t,this.window.segment]:[this.window.segment]}render(t){t.save(),this.window.render(t),this.measure.render(t),t.restore()}}class Gt extends It{constructor(t){super(),this.handler=new Ut(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Ut extends Lt{constructor(t){super(),this.editor=t,this.door=new Dt(new c(0,0),new c(50,50)),this.render=new jt,this.render.door=this.door,this.editor.addSelectControl(this.render)}onMouseDown(t){const e=this.editor.getCurrentFloor();e&&e.addDoor(this.door),this.editor.removeSelectControl(this.render),this.editor.tools.select()}onMouseMove(t){const e=this.editor.getCurrentFloor();if(e){const{segment:s,point:n}=e.findNearestSegmentAtPoint(new c(t.x,t.y));if(s){const t=s.getPointAtDistance(n,-25),e=s.getPointAtDistance(n,25);this.render.updateDoor(t,e),this.render.updateSegment(s)}else{const e=new c(t.x-25,t.y),s=new c(t.x+25,t.y);this.render.updateDoor(e,s),this.render.updateSegment(null)}this.editor.render()}}}class jt{constructor(){this.door=null,this.measure=new X}updateDoor(t,e){const{segment:s}=this.door;s.start.copyFrom(t),s.end.copyFrom(e)}updateSegment(t){this.measure.segments=t?[t,this.door.segment]:[this.door.segment]}render(t){t.save(),this.door.render(t),this.measure.render(t),t.restore()}}class qt extends It{constructor(t,e){super(),this.editor=t,this.scale=e}onCommandActive(t){1===this.scale?this.editor.zoomDefault():this.editor.zoom(this.scale,this.scale),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class Qt extends It{constructor(t){super(),this.editor=t}onCommandActive(t){this.editor.clear(),this.editor.render(),this.editor.tools.select()}onCommandDeActive(t){}}class $t extends It{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.historyManager.undo();e&&this.editor.loadFloor(e),this.editor.tools.select()}onCommandDeActive(t){}}class Kt extends It{constructor(t){super(),this.editor=t}onCommandActive(t){const e=t.historyManager.redo();e&&this.editor.loadFloor(e),this.editor.tools.select()}onCommandDeActive(t){}}class Jt extends It{constructor(t,e){super(),this.handler=new Zt(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class Zt extends Lt{constructor(t,e){super(),this.editor=t,this.room=new At,this.room.label=e?.label,this.room.fillColor=e?.color,this.room.category=e?.category,this.render=new te,this.start=new c,this.end=new c,this.started=!1,this.render.room=this.room,this.editor.addSelectControl(this.render)}get defaultSize(){return 100}onMouseDown(t){this.started=!0,this.start.x=t.snapX,this.start.y=t.snapY}onMouseMove(t){this.started?(this.end.x=t.snapX,this.end.y=t.snapY):(this.start.x=t.snapX,this.start.y=t.snapY,this.end.x=this.start.x+this.defaultSize,this.end.y=this.start.y+this.defaultSize),this.updateRoom(),this.editor.render()}onMouseUp(t){if(this.editor.removeSelectControl(this.render),this.started){this.start.distanceTo(this.end)<10&&(this.end.x=this.start.x+this.defaultSize,this.end.y=this.start.y+this.defaultSize),this.updateRoom(),this.addRoom()}this.started=!1,this.editor.render(),this.editor.tools.select()}updateRoom(){const t=new c(this.start.x,this.start.y),e=new c(this.end.x,this.start.y),s=new c(this.end.x,this.end.y),n=new c(this.start.x,this.end.y);this.room.setPoints([t,e,s,n]),this.render.measures[0].getFirstSegment().start=t,this.render.measures[0].getFirstSegment().end=e,this.render.measures[1].getFirstSegment().start=e,this.render.measures[1].getFirstSegment().end=s}addRoom(){const t=this.editor.getCurrentFloor();t&&t.addRoom(this.room)}}class te extends M{constructor(){super(),this.room=null,this.measures=[],this.measures[0]=new X(new R),this.measures[1]=new X(new R)}render(t){this.room?.render(t),this.measures[0].render(t),this.measures[1].render(t)}}class ee extends It{constructor(t){super(),this.handler=new se(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class se extends Lt{constructor(t){super(),this.editor=t,this.outline=new Mt,this.render=new ne(this.outline),this.isDragging=!1,this.start=new c,this.end=new c}onMouseDown(t){this.isDragging=!0,this.start.x=t.snapX,this.start.y=t.snapY,this.end.x=t.snapX,this.end.y=t.snapY,this.outline.setPoints(this.createOutlinePoints()),this.editor.addSelectControl(this.render)}onMouseMove(t){this.isDragging&&(this.end.x=t.snapX,this.end.y=t.snapY,this.render.setPoints(this.createOutlinePoints()),this.editor.render())}onMouseUp(t){if(this.editor.removeSelectControl(this.render),this.isDragging){const e=this.editor.getCurrentFloor();e&&(this.end.x=t.snapX,this.end.y=t.snapY,this.render.setPoints(this.createOutlinePoints()),e.addOutline(this.outline),this.editor.render())}this.isDragging=!1,this.editor.tools.select()}createOutlinePoints(){const t=[];return t.push(new c(this.start.x,this.start.y)),t.push(new c(this.end.x,this.start.y)),t.push(new c(this.end.x,this.end.y)),t.push(new c(this.start.x,this.end.y)),t}}class ne{constructor(t){this.outline=t,this.measureTop=new X(new R),this.measureRight=new X(new R)}setPoints(t){this.outline.setPoints(t),this.measureTop.getFirstSegment().start=t[0],this.measureTop.getFirstSegment().end=t[1],this.measureRight.getFirstSegment().start=t[1],this.measureRight.getFirstSegment().end=t[2]}render(t){this.outline?.render(t),this.measureTop.render(t),this.measureRight.render(t)}}class oe extends It{constructor(t){super(),this.handler=new ie(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class ie extends Lt{constructor(t){super(),this.editor=t,this.started=!1,this.wall=new lt,this.wall.thick=1,this.render=new re,this.render.segment=this.wall.segment,this.editor.addSelectControl(this.render)}onMouseDown(t){this.started=!0,this.wall.segment.end.x=t.snapX,this.wall.segment.end.y=t.snapY}onMouseMove(t){const e=this.editor.getCurrentFloor();if(this.started){const s=e.findNearestSegmentAtPoint(new c(t.snapX,t.snapY));s?(this.wall.segment.end.x=s.point.x,this.wall.segment.end.y=s.point.y):(this.wall.segment.end.x=t.snapX,this.wall.segment.end.y=t.snapY),this.render.setIntersectionPoints(this.findIntersectionPoints(this.editor))}else{this.wall.segment.end.x=t.snapX,this.wall.segment.end.y=t.snapY;const s=e.findNearestSegmentAtPoint(new c(t.snapX,t.snapY));s&&(this.wall.segment.start.x=s.point.x,this.wall.segment.start.y=s.point.y)}this.editor.render()}onMouseUp(t){this.editor.removeSelectControl(this.render),this.editor.getCurrentFloor().splitRoom(this.wall.segment),this.started=!1,this.editor.render(),this.editor.tools.select()}addWalls(){const t=this.editor.getCurrentFloor(),e=[this.wall.segment.start,...this.findIntersectionPoints(this.editor),this.wall.segment.end];for(let s=0;s<e.length-1;s++){const n=e[s],o=e[s+1];if(!t.isSegmentInSegment(new R(n,o))){const e=new lt(n.copy(),o.copy());e.thick=10,t.addWall(e)}}}findIntersectionPoints(t){const e=t.getCurrentFloor(),s=[];for(const t of e.getRooms())s.push(...t.findIntersectionPoints(this.wall.segment));return s.sort(((t,e)=>t.distanceTo(this.wall.segment.start)-e.distanceTo(this.wall.segment.start))),s}}class re{constructor(){this.intersectionPoints=[],this.segment=null}setSegment(t){this.segment=t}setIntersectionPoints(t){this.intersectionPoints=t}render(t){t.save(),this.renderSegment(t),this.renderIntersectionPoints(t),t.restore()}renderSegment(t){t.beginPath(),t.lineWidth=1,t.strokeStyle="black",t.moveTo(this.segment.start.x,this.segment.start.y),t.lineTo(this.segment.end.x,this.segment.end.y),t.closePath(),t.stroke(),this.renderPoint(t,this.segment.start,k.primaryRedColor),this.renderPoint(t,this.segment.end,k.primaryRedColor)}renderIntersectionPoints(t){for(const e of this.intersectionPoints)this.renderPoint(t,e,k.primaryRedColor)}renderPoint(t,e,s){t.beginPath(),t.arc(e.x,e.y,5,0,2*Math.PI),t.fillStyle=s,t.fill(),t.closePath()}}class le{constructor(){this.vertices=[]}addEdge(t,e){this.addVertex(t.x,t.y).connect(this.addVertex(e.x,e.y))}addVertex(t,e){let s=this.findVertex(t,e);return s||(s=new he(t,e),this.vertices.push(s)),s}findVertex(t,e){return this.vertices.find((s=>s.x===t&&s.y===e))}}class he{constructor(t,e){this.x=t,this.y=e,this.adjacents=[]}addAdjacent(t){if(t){if(this.findAdjacent(t))return;this.adjacents.push(t)}}removeAdjacent(t){this.adjacents=this.adjacents.filter((e=>e!==t))}connect(t){return t&&(this.addAdjacent(t),t.addAdjacent(this)),this}disconnect(t){return t&&(this.removeAdjacent(t),t.removeAdjacent(this)),this}findAdjacent(t){return this.adjacents.find((e=>e===t))}vector({x:t,y:e}){return new ae(this.x-t,this.y-e)}}class ae{constructor(t,e){this.x=t,this.y=e}crossProduct({x:t,y:e}){return this.x*e-this.y*t}dotProduct({x:t,y:e}){return this.x*t+this.y*e}}class ce{constructor(){}extractCycles(t){let e=[];for(;t.length>0;){let s=this.getLeftBottomVertex(t),n=this.closedWalkFrom(s),o=this.reduceWalk(n);o.length>2&&e.push(o),this.removeEdge(o[0],o[1]),t=this.removeFilamentAt(o[0],t),t=this.removeFilamentAt(o[1],t)}return e}closedWalkFrom(t){let e=[],s=t,n=null;do{e.push(s),[s,n]=this.getNext(s,n)}while(s!==t);return e}reduceWalk(t){for(let e=1;e<t.length;e++){let s=t.lastIndexOf(t[e]);s>e&&t.splice(e+1,s-e)}return t}removeFilamentAt(t,e){let s,n=t;const o=t=>{e=e.filter((e=>e!==t))};for(;n&&n.adjacents.length<2;)o(n),s=n.adjacents[0],s&&s.removeAdjacent(n),n=s;return e}removeEdge(t,e){t&&t.removeAdjacent(e),e&&e.removeAdjacent(t)}getNext(t,e){let s=null;return 0===t.adjacents.length?s=t:1===t.adjacents.length?s=t.adjacents[0]:e?(t.removeAdjacent(e),s=this.getCounterClockWiseMostVertex(e,t),t.addAdjacent(e)):s=this.getClockWiseMostVertex(e,t),[s,t]}getCounterClockWiseMostVertex(t,e){return this.getBestVertex(t,e,"ccw")}getClockWiseMostVertex(t,e){return this.getBestVertex(t,e,"cw")}getBestVertex(t,e,s){const n=t?e.vector(t):new ae(0,-1),o=[],i=[],r=[];for(const t of e.adjacents){const s=t.vector(e),l=n.crossProduct(s);0===l?r.push(t):l>0?i.push(t):o.push(t)}const l=(t,s)=>{const n=t.vector(e),o=s.vector(e);return n.crossProduct(o)>0?-1:1},h=(t,e)=>-1*l(t,e);let a=[];return"ccw"===s?(a=o.length>0?o:i,a.push(...r),a.sort(l)):(a=i.length>0?i:o,a.push(...r),a.sort(h)),a[0]}getLeftBottomVertex(t){return t.reduce(((t,e)=>{let s=e.x-t.x;return s<0?e:s>0||e.y-t.y<0?t:e}))}}class de{constructor(){this.graph=new le}addSegment(t){t&&this.graph.addEdge(t.start,t.end)}build(){return(new ce).extractCycles(this.graph.vertices).map((t=>this.createPolygon(t)))}createPolygon(t){const e=new at;for(const s of t)e.addPoint(new c(s.x,s.y));return e}}class ue{constructor(t=ge){this.data=[],this.comparator=t}get length(){return this.data.length}peek(){return 0===this.length?null:this.data[0]}push(...t){t.forEach((t=>{this.data.push(t)})),this.sort()}pop(){if(0===this.length)return null;const t=this.data[0];return this.data=this.data.slice(1),t}sort(){this.data.sort(((t,e)=>this.comparator(t,e)))}}function ge(t,e){return t-e}class me{constructor(){this.events=this.createEventQueue()}addSegment(t){const e=new fe(t.start.copy()),s=new fe(t.end.copy());this.comparePoint(t.start,t.end)<=0?(e.start=!0,s.start=!1):(e.start=!1,s.start=!0),e.other=s,s.other=e,this.events.push(e),this.events.push(s)}scan(){const t=[];let e=[];const s=t=>{e=e.filter((e=>e!==t.other))},n=e=>{e&&(e.length<=0||t.some((t=>t.isEqualTo(e)))||t.push(e))};for(;this.events.length>0;){const t=this.events.pop();if(t.isStart()){const s=t.createSegment();for(const n of e){const e=n.createSegment();if(!e.isEqualTo(s))if(this.isPointOnSegment(e,s.start))n.addIntersectionPoint(s.start);else if(this.isPointOnSegment(e,s.end))n.addIntersectionPoint(s.end);else{const o=e.getIntersectionPoint(s);o&&(n.addIntersectionPoint(o),t.addIntersectionPoint(o))}}e.push(t)}else s(t),t.createSegments().forEach((t=>{n(t)}))}return t}isPointOnSegment(t,e){return!t.start.isEqualTo(e)&&!t.end.isEqualTo(e)&&t.isPointInSegment(e,.1)}comparePoint(t,e){return t.x!==e.x?t.x-e.x:t.y-e.y}createEventQueue(){return new ue(((t,e)=>this.comparePoint(t.point,e.point)))}}class fe{constructor(t,e){this.point=t,this.start=e??!0,this.other=null,this.intersections=[]}isStart(){return this.start}createSegment(){return this.start?new R(this.point.copy(),this.other.point.copy()):new R(this.other.point.copy(),this.point.copy())}createSegments(){const t=[],e=[this.other.point,...this.other.intersections,this.point];e.sort(((t,e)=>this.point.distanceTo(t)-this.point.distanceTo(e)));for(let s=0;s<e.length-1;s++)t.push(new R(e[s],e[s+1]));return t}addIntersectionPoint(t){t&&(this.intersections.some((e=>e.isEqualTo(t)))||this.intersections.push(t))}}class pe extends It{constructor(t,e){super(),this.handler=new xe(t,e)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class xe extends Lt{constructor(t,e){super(),this.room=new At,this.room.label=e?.label,this.room.fillColor=e?.color,this.room.category=e?.category,this.editor=t,this.point=null,this.editor.addSelectControl(this),this.builder=new de,this.polygons=this.#t()}onMouseDown(t){}#t(){const t=this.#e().scan();for(const e of t)this.builder.addSegment(e);return this.builder.build()}#e(){const t=new me,e=this.editor.getCurrentFloor();return[...e.getOutlines(),...e.getRooms()].forEach((e=>{if("polygon"in e)for(const s of e.polygon.createSegments())t.addSegment(s)})),e.getWalls().forEach((e=>{t.addSegment(e.segment)})),t}onMouseMove(t){this.point=new c(t.x,t.y),this.editor.render()}onMouseUp(t){const e=new c(t.x,t.y);if(!this.#s(e)){const e=this.#n(new c(t.x,t.y));if(e){const t=this.editor.getCurrentFloor();this.room.setPoints(e.points),t.addRoom(this.room)}}this.editor.removeSelectControl(this),this.editor.tools.select(),this.editor.render()}render(t){if(this.point)if(this.#s(this.point))this.#o(t,this.point,"빈 공간을 선택하세요");else{const e=this.#n(this.point);e&&(this.#i(t,e),this.#r(t,e))}}#s(t){return this.editor.getCurrentFloor().findControlsAtPoint(t,(t=>"outline"!==t.type)).length>0}#i(t,e){this.room.setPoints(e.points),this.room.render(t)}#r(t,e){const{points:s}=e;if(s.length>0){t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let e=1;e<s.length;e++)t.lineTo(s[e].x,s[e].y);t.closePath(),t.strokeStyle=k.activeColor,t.lineWidth=10,t.stroke()}}#o(t,e,s,n="white"){const o=t.measureText(s).width+10,i=e.x,r=e.y+30;t.fillStyle="black",t.fillRect(i-o/2,r-7.5,o,15),t.fillStyle=n,t.font="10px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(s,i,r)}#n(t){return this.polygons.find((e=>e.isPointInside(t)))}}class ye extends It{constructor(t){super(),this.handler=new we(t)}onCommandActive(t){t.addEventHandler(this.handler)}onCommandDeActive(t){t.removeEventHandler(this.handler)}}class we extends Lt{constructor(t){super(),this.editor=t,this.wall=new lt,this.wall.thick=1,this.render=new Ce(this.wall),this.started=!1}onMouseDown(t){this.started=!0,this.wall.start.x=t.snapX,this.wall.start.y=t.snapY,this.editor.addSelectControl(this.render)}onMouseMove(t){this.started&&(this.wall.end.x=t.snapX,this.wall.end.y=t.snapY,this.editor.render())}onMouseUp(t){if(this.started){t.snapX,t.snapY;this.wall.segment.length>10&&this.editor.getCurrentFloor()?.addWall(this.wall),this.editor.removeSelectControl(this.render),this.editor.render(),this.editor.tools.select()}this.started=!1}}class Ce{constructor(t){this.wall=t,this.measure=new X(t?.segment)}render(t){this.wall?.render(t),this.measure.render(t)}}class ve{constructor(t){this.editor=t}undo(){this.deActiveCommand(),this.editor.activeCommand=new $t(this.editor),this.activeCommand()}redo(){this.deActiveCommand(),this.editor.activeCommand=new Kt(this.editor),this.activeCommand()}select(){this.deActiveCommand(),this.editor.activeCommand=new Nt(this.editor),this.activeCommand()}findRoom(t){this.deActiveCommand(),this.editor.activeCommand=new pe(this.editor,t),this.activeCommand()}createRoom(t){this.deActiveCommand(),this.editor.activeCommand=new Jt(this.editor,t),this.activeCommand()}createOutline(){this.deActiveCommand(),this.editor.activeCommand=new ee(this.editor),this.activeCommand()}createWall(){this.deActiveCommand(),this.editor.activeCommand=new oe(this.editor),this.activeCommand()}createWallOld(){this.deActiveCommand(),this.editor.activeCommand=new ye(this.editor),this.activeCommand()}createDoor(){this.deActiveCommand(),this.editor.activeCommand=new Gt(this.editor),this.activeCommand()}createWindow(){this.deActiveCommand(),this.editor.activeCommand=new zt(this.editor),this.activeCommand()}zoomIn(){this.deActiveCommand(),this.editor.activeCommand=new qt(this.editor,.1),this.activeCommand()}zoomDefault(){this.deActiveCommand(),this.editor.activeCommand=new qt(this.editor,1),this.activeCommand()}zoomOut(){this.deActiveCommand(),this.editor.activeCommand=new qt(this.editor,-.1),this.activeCommand()}clear(){this.deActiveCommand(),this.editor.activeCommand=new Qt(this.editor),this.activeCommand()}deActiveCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandDeActive(this.editor),this.editor.activeCommand=null}activeCommand(){this.editor.activeCommand&&this.editor.activeCommand.onCommandActive(this.editor)}}class Pe{constructor(){this.canvas=null,this.container=null,this.context=null,this.tools=new ve(this),this.editorRender=null,this.transform=new Z,this.contextToolbar=null,this.mainToolbar=null,this.activeCommand=null,this.eventController=new u(this),this.config=null,this.selects=[],this.historyManager=new J,this.floorManager=new kt(this)}edit(t,e){if(this.config=e,this.historyManager.clear(),window&&document){const s=document.querySelector(t);this.container=this.#l(),s?(s.tabIndex=1,s.style.outline="none",s.appendChild(this.container),this.canvas=document.createElement("canvas"),this.canvas.width=e.width,this.canvas.height=e.height,this.canvas.tabindex=2,this.canvas.style.outline="none",this.context=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.canvas.focus()):document.appendChild(this.container);let n=(window.devicePixelRatio||1)/(this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1);this.#h(n),this.#a(),this.#c(),this.#d(),this.#u(),this.saveFloorToHistory(),this.render(),this.tools.select()}}clear(){this.selects=[],this.floorManager.clear(),this.transform.clear()}load(t,e,s){if(!t)return;this.clear(),this.floorManager.loadFloorFromPublicAi(t,e,s);const n=this.getCurrentFloor();if(n){const t=n.getBoundRect();this.translateContext(100-t.minX,100-t.minY)}this.#d(),this.#u(),this.saveFloorToHistory(),this.render()}saveFloorToHistory(){this.historyManager.push(this.floorManager.saveFloor())}getCurrentFloor(){return this.floorManager.getCurrentFloor()}loadFloor(t){this.floorManager.loadFloor(t),this.#d(),this.#u(),this.render()}saveFloor(){return this.floorManager.saveFloor()}#h(t){const e=()=>{const e=this.canvas.width,s=this.canvas.height;t?(this.canvas.width=e*t,this.canvas.height=s*t):(this.canvas.width=e*this.transform.defaultScaleX,this.canvas.height=s*this.transform.defaultScaleY),this.canvas.style.width=e+"px",this.canvas.style.height=s+"px"},s=()=>{t?(this.context.scale(t,t),this.transform.defaultScaleX=t,this.transform.defaultScaleY=t):(this.context.setTransform(1,0,0,1,0,0),this.context.translate(this.transform.translateX,this.transform.translateY),this.context.scale(this.transform.currentScaleX,this.transform.currentScaleY))};this.canvas&&this.context&&(this.context.line=g.createLine(this.context),this.context.arrow=g.createArrow(this.context),this.context.text=g.createText(this.context),this.context.circle=g.createCircle(this.context),this.context.lineJoin="round",this.context.lineCap="square",this.context.imageSmoothingEnabled=!0,e(),s(),this.transform.from(this.context))}#a(){this.container&&this.canvas&&this.eventController.initialize(this,this.container,this.canvas)}#c(){this.container&&(this.contextToolbar=new G(this,this.container),this.mainToolbar=new K(this,this.container),this.contextToolbar.hide())}#d(){const t=this.getCurrentFloor();t&&(t.onChange=()=>{this.saveFloorToHistory()})}#u(){this.editorRender=n.createRender(this)}#l(){const t=document.createElement("div");return t.tabIndex=1,t.style.outline="none",t.style.width="100%",t.style.height="100%",t.style.position="relative",t}resize(){this.#h(),this.render()}translateContext(t,e){this.context.translate(t,e),this.transform.from(this.context)}zoom(t,e){t>0?t+=1:t=1+t,e>0?e+=1:e=1+e,this.context.scale(t,e),this.transform.from(this.context)}zoomDefault(){this.transform.applyDefaultScale(this.context)}addEventHandler(t){this.eventController.addHandler(t)}removeEventHandler(t){this.eventController.removeHandler(t)}addSelectControl(t){t&&this.selects.push(t)}removeSelectControl(t){this.selects=this.selects.filter((e=>e!==t))}setSelectControls(t){t&&(this.selects=t)}render(){this.editorRender.render(this.context)}showContextToolbar(t,e){this.contextToolbar.show(t,e)}hideContextToolbar(){this.contextToolbar.hide()}}PlaceIn=e})();